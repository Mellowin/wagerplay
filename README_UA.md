# WagerPlay Backend

–ë–∞–≥–∞—Ç–æ–∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∞ –≥—Ä–∞ "–ö–∞–º—ñ–Ω—å-–ù–æ–∂–∏—Ü—ñ-–ü–∞–ø—ñ—Ä" –∑ –º–∞—Ç—á–º–µ–π–∫—ñ–Ω–≥–æ–º, —Å–∏—Å—Ç–µ–º–æ—é —Å—Ç–∞–≤–æ–∫, —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—î—é –±–æ—Ç—ñ–≤ —Ç–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∏–º–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∏–º–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏.

[![NestJS](https://img.shields.io/badge/NestJS-E0234E?style=flat&logo=nestjs&logoColor=white)](https://nestjs.com/)
[![TypeScript](https://img.shields.io/badge/TypeScript-3178C6?style=flat&logo=typescript&logoColor=white)](https://www.typescriptlang.org/)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-4169E1?style=flat&logo=postgresql&logoColor=white)](https://www.postgresql.org/)
[![Redis](https://img.shields.io/badge/Redis-DC382D?style=flat&logo=redis&logoColor=white)](https://redis.io/)
[![Socket.io](https://img.shields.io/badge/Socket.io-010101?style=flat&logo=socket.io&logoColor=white)](https://socket.io/)
[![Docker](https://img.shields.io/badge/Docker-2496ED?style=flat&logo=docker&logoColor=white)](https://www.docker.com/)

## –î–µ–º–æ-–≤—ñ–¥–µ–æ

[![WagerPlay Demo](https://img.youtube.com/vi/s5ViycpnBDM/0.jpg)](https://www.youtube.com/watch?v=s5ViycpnBDM)

## –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ

### –û—Å–Ω–æ–≤–Ω–∏–π –≥–µ–π–º–ø–ª–µ–π
- **–ú–∞—Ç—á–º–µ–π–∫—ñ–Ω–≥** - 20-—Å–µ–∫—É–Ω–¥–Ω–∞ —á–µ—Ä–≥–∞ –∑ –∞–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è–º –±–æ—Ç–∞–º–∏
- **–¢—É—Ä–Ω—ñ—Ä–Ω–∞ —Å–∏—Å—Ç–µ–º–∞** - 2-5 –≥—Ä–∞–≤—Ü—ñ–≤, —Å–∏—Å—Ç–µ–º–∞ –≤–∏–±—É–≤–∞–Ω–Ω—è
- **Real-time –≥–µ–π–º–ø–ª–µ–π** - WebSocket –ø–æ–¥—ñ—ó –¥–ª—è —Ö–æ–¥—ñ–≤, —Ç–∞–π–º–µ—Ä—ñ–≤, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
- **–°–∏—Å—Ç–µ–º–∞ —Ä–∞—É–Ω–¥—ñ–≤** - 12-—Å–µ–∫—É–Ω–¥–Ω—ñ —Ö–æ–¥–∏, –∞–≤—Ç–æ—Ö—ñ–¥ –ø—Ä–∏ AFK
- **F5 Recovery** - –ø–æ–≤–Ω–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏

### –§—ñ–Ω–∞–Ω—Å–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞
- **–ì–∞–º–∞–Ω—Ü—ñ** - —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –±–∞–ª–∞–Ω—Å–æ–º VP (Virtual Points)
- **–ó–∞–º–æ—Ä–æ–∂—É–≤–∞–Ω–Ω—è —Å—Ç–∞–≤–æ–∫** - –±–µ–∑–ø–µ—á–Ω–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–≤–æ–∫ –ø—ñ–¥ —á–∞—Å –º–∞—Ç—á—É
- **–°–∏—Å—Ç–µ–º–∞ –∫–æ–º—ñ—Å—ñ—ó** - 5% –∫–æ–º—ñ—Å—ñ—è house –Ω–∞ –∫–æ–∂–Ω–æ–º—É –º–∞—Ç—á—ñ
- **–í–∏–ø–ª–∞—Ç–∏** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Ä–æ–∑–ø–æ–¥—ñ–ª –≤–∏–≥—Ä–∞—à—ñ–≤
- **–ó–≤—ñ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å—É** - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ —á–µ—Ä–µ–∑ —ñ—Å—Ç–æ—Ä—ñ—é

### –°–∏—Å—Ç–µ–º–∞ –ª—ñ–¥–µ—Ä—ñ–≤
- **5 –∫–∞—Ç–µ–≥–æ—Ä—ñ–π**: –ü–µ—Ä–µ–º–æ–≥–∏, –í—ñ–Ω—Ä–µ–π—Ç, –ü—Ä–∏–±—É—Ç–æ–∫, –ü–æ—Ç–æ—á–Ω–∞ —Å–µ—Ä—ñ—è, –ú–∞–∫—Å. —Å–µ—Ä—ñ—è
- **–ü–∞–≥—ñ–Ω–∞—Ü—ñ—è** - –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è –ø–æ —Ç–æ–ø—É –≥—Ä–∞–≤—Ü—ñ–≤
- **–ü–æ–∑–∏—Ü—ñ—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ** - –≤–∏–¥–Ω–æ —Å–≤—ñ–π —Ä–µ–π—Ç–∏–Ω–≥ –≤ –∫–æ–∂–Ω—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä–∞–≤—Ü—ñ–≤** - –¥–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–∂–Ω–æ–º—É –≥—Ä–∞–≤—Ü—é

### –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è** - JWT —Ç–æ–∫–µ–Ω–∏ + –≥–æ—Å—Ç—å–æ–≤–∏–π –≤—Ö—ñ–¥
- **–ü—Ä–æ—Ñ—ñ–ª—ñ** - –∫–∞—Å—Ç–æ–º–Ω—ñ –Ω—ñ–∫–Ω–µ–π–º–∏, –∞–≤–∞—Ç–∞—Ä–∫–∏
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - —ñ–≥—Ä–∏, –ø–µ—Ä–µ–º–æ–≥–∏/–ø–æ—Ä–∞–∑–∫–∏, –∑–∞—Ä–æ–±–ª–µ–Ω–æ/–≤—Ç—Ä–∞—á–µ–Ω–æ VP
- **–ß–∞—Ç** - –≥–ª–æ–±–∞–ª—å–Ω–∏–π —Ç–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—ñ–≥—Ä–æ–≤–∏–π —á–∞—Ç

### –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å
- **–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –±–∞–ª–∞–Ω—Å–æ–º** - –¥–æ–¥–∞–≤–∞–Ω–Ω—è/–≤–∏–¥–∞–ª–µ–Ω–Ω—è VP —É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- **–°–∏—Å—Ç–µ–º–∞ –±–∞–Ω—ñ–≤** - –±–∞–Ω/—Ä–æ–∑–±–∞–Ω –∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è–º –ø—Ä–∏—á–∏–Ω
- **–ë–µ–∑–ø–µ–∫–∞**:
  - IP Whitelist - –¥–æ—Å—Ç—É–ø –∞–¥–º—ñ–Ω–∞ –ø—Ä–∏–≤'—è–∑–∞–Ω–∏–π –¥–æ IP –ø–µ—Ä—à–æ–≥–æ –≤—Ö–æ–¥—É
  - –¢–∞–π–º–∞—É—Ç —Å–µ—Å—ñ—ó - –∞–≤—Ç–æ–≤–∏—Ö—ñ–¥ —á–µ—Ä–µ–∑ 30 —Ö–≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
  - Email Whitelist - —Ç—ñ–ª—å–∫–∏ —Å—Ö–≤–∞–ª–µ–Ω—ñ email –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∞–¥–º—ñ–Ω–∞–º–∏
- **–ó–º—ñ–Ω—é–≤–∞–Ω–∏–π —Ä–æ–∑–º—ñ—Ä** - —Ä–µ–≥—É–ª—å–æ–≤–∞–Ω–∏–π —Ä–æ–∑–º—ñ—Ä –≤—ñ–∫–Ω–∞ –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ
- **–ê—É–¥–∏—Ç –ª–æ–≥–∏** - –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –¥—ñ–π –∞–¥–º—ñ–Ω–∞

### –ë–µ–∑–ø–µ–∫–∞ —Ç–∞ –∞—É–¥–∏—Ç
- **IDOR –∑–∞—Ö–∏—Å—Ç** - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ —Ä–µ—Å—É—Ä—Å—ñ–≤
- **–ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –º–∞—Å–æ–≤–æ–≥–æ –ø—Ä–∏–≤–ª–∞—Å–Ω–µ–Ω–Ω—è** - –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –≤—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö
- **–ê—É–¥–∏—Ç –ª–æ–≥—É–≤–∞–Ω–Ω—è** - –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π
- **–û–±—Ä–æ–±–∫–∞ race conditions** - PostgreSQL Advisory Locks + Redis locks
- **–ó–∞—Ö–∏—Å—Ç –∑–∞–≤–∏—Å–ª–∏—Ö —Å—Ç–∞–≤–æ–∫** - –∞–≤—Ç–æ–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 5 —Ö–≤–∏–ª–∏–Ω —Ç–∞–π–º–∞—É—Ç—É
- **JWT –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è** - –±–µ–∑–ø–µ—á–Ω–∞ —Ç–æ–∫–µ–Ω-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –∑ –≥–ª–æ–±–∞–ª—å–Ω–∏–º –º–æ–¥—É–ª–µ–º

### DevOps —Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
- **Swagger API Docs** - —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –∑–∞ –∞–¥—Ä–µ—Å–æ—é `/api/docs`
- **Docker** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–æ–≤–∞–Ω–µ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è
- **CI/CD Pipeline** - GitHub Actions –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
- **Health Checks** - endpoint –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞–Ω—É —Å–µ—Ä–≤–µ—Ä–∞

## –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—á–Ω–∏–π —Å—Ç–µ–∫

| –†—ñ–≤–µ–Ω—å | –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—è |
|--------|------------|
| **Backend** | NestJS + TypeScript |
| **–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö** | PostgreSQL + TypeORM |
| **–ö–µ—à/–ß–µ—Ä–≥–∏** | Redis (ioredis) |
| **Real-time** | Socket.io |
| **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è** | Jest + Supertest + k6 (–Ω–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞–ª—å–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è) |
| **DevOps** | Docker + Docker Compose + GitHub Actions |
| **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è** | Swagger/OpenAPI |

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É

```
src/
‚îú‚îÄ‚îÄ matchmaking/          # –Ü–≥—Ä–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ —Ç–∞ WebSocket
‚îÇ   ‚îú‚îÄ‚îÄ matchmaking.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ matchmaking.gateway.ts
‚îÇ   ‚îî‚îÄ‚îÄ matchmaking.controller.ts
‚îú‚îÄ‚îÄ wallets/              # –§—ñ–Ω–∞–Ω—Å–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞
‚îú‚îÄ‚îÄ auth/                 # JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
‚îÇ   ‚îú‚îÄ‚îÄ jwt-auth.module.ts    # –ì–ª–æ–±–∞–ª—å–Ω–∏–π JWT –º–æ–¥—É–ª—å
‚îÇ   ‚îú‚îÄ‚îÄ jwt-auth.guard.ts
‚îÇ   ‚îî‚îÄ‚îÄ auth.service.ts
‚îú‚îÄ‚îÄ leaderboard/          # –°–∏—Å—Ç–µ–º–∞ –ª—ñ–¥–µ—Ä—ñ–≤
‚îÇ   ‚îú‚îÄ‚îÄ leaderboard.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ leaderboard.controller.ts
‚îú‚îÄ‚îÄ admin/                # –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å —Ç–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
‚îú‚îÄ‚îÄ users/                # –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏
‚îú‚îÄ‚îÄ audit/                # –ê—É–¥–∏—Ç –ª–æ–≥—É–≤–∞–Ω–Ω—è
‚îî‚îÄ‚îÄ house/                # House –±–∞–Ω–∫

test/e2e/                 # E2E —Ç–µ—Å—Ç–∏
‚îú‚îÄ‚îÄ race-conditions/
‚îú‚îÄ‚îÄ financial-security/
‚îú‚îÄ‚îÄ idor/
‚îî‚îÄ‚îÄ state-machine/
```

## –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç

### –í–∏–º–æ–≥–∏
- Node.js 18+
- Docker & Docker Compose

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è

```bash
# –ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è
git clone https://github.com/Mellowin/wagerplay.git
cd wagerplay

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è
npm install

# –ó–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
cp .env.example .env
# –í—ñ–¥—Ä–µ–¥–∞–≥—É–π .env –∑—ñ —Å–≤–æ—ó–º–∏ –¥–∞–Ω–∏–º–∏

# –Ü–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
docker-compose up -d

# –†–æ–∑—Ä–æ–±–∫–∞
npm run start:dev
```

### –ó–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞

```env
DATABASE_URL=postgres://postgres:postgres@localhost:5432/wagerplay
REDIS_URL=redis://localhost:6379
JWT_SECRET=your-secret-key
PORT=3000
NODE_ENV=development
ADMIN_TOKEN=your-admin-token
```

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

```bash
# –ó–∞–ø—É—Å–∫ E2E —Ç–µ—Å—Ç—ñ–≤
npm run test:e2e

# –ü–æ—Ç–æ—á–Ω–µ –ø–æ–∫—Ä–∏—Ç—Ç—è: 80+ —Ç–µ—Å—Ç—ñ–≤
# –¢–µ—Å—Ç–∏ –ø–æ–∫—Ä–∏–≤–∞—é—Ç—å: –º–∞—Ç—á–º–µ–π–∫—ñ–Ω–≥, —ñ–≥—Ä–æ–≤–∏–π –ø—Ä–æ—Ü–µ—Å, —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó, –±–µ–∑–ø–µ–∫—É,
# –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó –≥—Ä–∞–≤—Ü—ñ–≤ (2-5), race conditions, IDOR –∑–∞—Ö–∏—Å—Ç
```

### –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó —Ç–µ—Å—Ç—ñ–≤
- **Race Conditions** - –æ–±—Ä–æ–±–∫–∞ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
- **Financial Security** - –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –±–∞–ª–∞–Ω—Å—É, –∑–≤—ñ—Ä–∫–∞
- **IDOR** - –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø—É –¥–æ —Ä–µ—Å—É—Ä—Å—ñ–≤
- **State Machine** - –∂–∏—Ç—Ç—î–≤–∏–π —Ü–∏–∫–ª –º–∞—Ç—á—É, –ø–µ—Ä–µ—Ö–æ–¥–∏

## API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –¥–æ—Å—Ç—É–ø–Ω–∞ –∑–∞ –∞–¥—Ä–µ—Å–æ—é: `http://localhost:3000/api/docs`

### REST Endpoints

#### –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è
```
POST   /auth/guest              # –ì–æ—Å—Ç—å–æ–≤–∏–π –≤—Ö—ñ–¥
POST   /auth/register           # –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
POST   /auth/login              # –í—Ö—ñ–¥
GET    /auth/me                 # –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
PATCH  /auth/profile            # –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é
```

#### –ú–∞—Ç—á–º–µ–π–∫—ñ–Ω–≥
```
POST   /matchmaking/quickplay           # –í—Å—Ç—É–ø–∏—Ç–∏ –≤ —á–µ—Ä–≥—É
POST   /matchmaking/match/:id/move      # –ó—Ä–æ–±–∏—Ç–∏ —Ö—ñ–¥
GET    /matchmaking/match/:id           # –î–µ—Ç–∞–ª—ñ –º–∞—Ç—á—É
GET    /matchmaking/history             # –Ü—Å—Ç–æ—Ä—ñ—è –º–∞—Ç—á—ñ–≤
GET    /matchmaking/online              # –ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ–Ω–ª–∞–π–Ω –≥—Ä–∞–≤—Ü—ñ–≤
```

#### –ì–∞–º–∞–Ω–µ—Ü—å
```
GET    /wallet                   # –û—Ç—Ä–∏–º–∞—Ç–∏ –±–∞–ª–∞–Ω—Å
POST   /wallet/reset-frozen     # –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω—É —Å—Ç–∞–≤–∫—É
GET    /wallet/reconcile         # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å
```

#### –õ—ñ–¥–µ—Ä–±–æ—Ä–¥
```
GET    /leaderboard              # –¢–æ–ø –≥—Ä–∞–≤—Ü—ñ–≤
GET    /leaderboard/me           # –ú–æ—è –ø–æ–∑–∏—Ü—ñ—è
GET    /leaderboard/categories   # –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
```

#### –ê–¥–º—ñ–Ω (–ü–æ—Ç—Ä–µ–±—É—é—Ç—å –ø—Ä–∞–≤ –∞–¥–º—ñ–Ω–∞)
```
GET    /admin/users              # –°–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
POST   /admin/users/balance      # –û–Ω–æ–≤–∏—Ç–∏ –±–∞–ª–∞–Ω—Å
POST   /admin/users/ban          # –ó–∞–±–∞–Ω–∏—Ç–∏
POST   /admin/users/unban        # –†–æ–∑–±–∞–Ω–∏—Ç–∏
```

### WebSocket –ø–æ–¥—ñ—ó
```
# –ü–æ–¥—ñ—ó —á–µ—Ä–≥–∏
queue:join          # –í—Å—Ç—É–ø –¥–æ —á–µ—Ä–≥–∏
queue:sync          # –°—Ç–∞—Ç—É—Å —á–µ—Ä–≥–∏
queue:error         # –ü–æ–º–∏–ª–∫–∞ —á–µ—Ä–≥–∏

# –ü–æ–¥—ñ—ó –º–∞—Ç—á—É  
match:found         # –ú–∞—Ç—á —Å—Ç–≤–æ—Ä–µ–Ω–æ
match:start         # –ú–∞—Ç—á —Ä–æ–∑–ø–æ—á–∞—Ç–æ
match:state         # –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É
match:timer         # –¢–∞–π–º–µ—Ä –∑–≤–æ—Ä–æ—Ç–Ω—å–æ–≥–æ –≤—ñ–¥–ª—ñ–∫—É
match:round_result  # –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥—É
match:elimination   # –ì—Ä–∞–≤–µ—Ü—å –≤–∏–±—É–≤
match:end           # –ú–∞—Ç—á –∑–∞–≤–µ—Ä—à–µ–Ω–æ

# –ß–∞—Ç –ø–æ–¥—ñ—ó
chat:global         # –ì–ª–æ–±–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
chat:game           # –Ü–≥—Ä–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
```

## –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î

### Flow –º–∞—Ç—á—É
1. –ì—Ä–∞–≤–µ—Ü—å –Ω–∞—Ç–∏—Å–∫–∞—î "–ì—Ä–∞—Ç–∏" ‚Üí –ø–æ—Ç—Ä–∞–ø–ª—è—î –≤ Redis —á–µ—Ä–≥—É
2. 20-—Å–µ–∫—É–Ω–¥–Ω–∏–π —Ç–∞–π–º–µ—Ä –¥–ª—è –∑–±–æ—Ä—É –≥—Ä–∞–≤—Ü—ñ–≤
3. –Ø–∫—â–æ < 2 –≥—Ä–∞–≤—Ü—ñ–≤ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞—é—Ç—å—Å—è –±–æ—Ç–∏
4. –ó–≤–æ—Ä–æ—Ç–Ω—ñ–π –≤—ñ–¥–ª—ñ–∫ 5-4-3-2-1 ‚Üí –º–∞—Ç—á —Ä–æ–∑–ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è
5. 12-—Å–µ–∫—É–Ω–¥–Ω—ñ —Ä–∞—É–Ω–¥–∏ (–ö–∞–º—ñ–Ω—å/–ù–æ–∂–∏—Ü—ñ/–ü–∞–ø—ñ—Ä)
6. AFK –≥—Ä–∞–≤—Ü—ñ –æ—Ç—Ä–∏–º—É—é—Ç—å –∞–≤—Ç–æ—Ö—ñ–¥
7. –í–∏–±—É–≤–∞–Ω–Ω—è –¥–æ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–µ—Ä–µ–º–æ–∂—Ü—è

### –§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π flow
```
–°—Ç–∞–≤–∫–∞: 100 VP
  ‚Üì
–ó–∞–º–æ—Ä–æ–∂—É–≤–∞–Ω–Ω—è: 100 VP (–∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –¥–ª—è –º–∞—Ç—á—É)
  ‚Üì
[–Ø–∫—â–æ –º–∞—Ç—á –Ω–µ —Ä–æ–∑–ø–æ—á–Ω–µ—Ç—å—Å—è –∑–∞ 5 —Ö–≤ ‚Üí –∞–≤—Ç–æ–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è]
  ‚Üì
–ë–∞–Ω–∫: 200 VP (2 –≥—Ä–∞–≤—Ü—ñ)
  ‚Üì
–ö–æ–º—ñ—Å—ñ—è: 10 VP (5% house)
  ‚Üì
–í–∏–ø–ª–∞—Ç–∞: 190 VP ‚Üí –ø–µ—Ä–µ–º–æ–∂—Ü—é
```

### –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó –ª—ñ–¥–µ—Ä–±–æ—Ä–¥—É
- **–ü–µ—Ä–µ–º–æ–≥–∏** - –í—Å—å–æ–≥–æ –ø–µ—Ä–µ–º–æ–≥
- **–í—ñ–Ω—Ä–µ–π—Ç** - –í—ñ–¥—Å–æ—Ç–æ–∫ –ø–µ—Ä–µ–º–æ–≥ (–º—ñ–Ω. 10 –º–∞—Ç—á—ñ–≤)
- **–ü—Ä–∏–±—É—Ç–æ–∫** - –í—Å—å–æ–≥–æ –∑–∞—Ä–æ–±–ª–µ–Ω–æ VP
- **–ü–æ—Ç–æ—á–Ω–∞ —Å–µ—Ä—ñ—è** - –ü–æ—Ç–æ—á–Ω–∞ —Å–µ—Ä—ñ—è –ø–µ—Ä–µ–º–æ–≥
- **–ú–∞–∫—Å. —Å–µ—Ä—ñ—è** - –†–µ–∫–æ—Ä–¥–Ω–∞ —Å–µ—Ä—ñ—è –ø–µ—Ä–µ–º–æ–≥

### –°–∏—Å—Ç–µ–º–∞ –±–æ—Ç—ñ–≤
–ë–æ—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø–æ–≤–Ω—é—é—Ç—å –Ω–µ–ø–æ–≤–Ω—ñ –º–∞—Ç—á—ñ:
- **–¢—Ä–∏–≥–µ—Ä**: –Ø–∫—â–æ –≤ —á–µ—Ä–∑—ñ –º–µ–Ω—à–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –ø—ñ—Å–ª—è 20—Å
- **–ü–æ–≤–µ–¥—ñ–Ω–∫–∞**: –†–µ–∞–ª—ñ—Å—Ç–∏—á–Ω—ñ –Ω—ñ–∫–∏, –≤–∏–ø–∞–¥–∫–æ–≤—ñ —Ö–æ–¥–∏
- **–ö–æ–º–±—ñ–Ω–∞—Ü—ñ—ó**: 1+ –±–æ—Ç, 2+ –±–æ—Ç–∞, 3+ –±–æ—Ç–∞, 4+ –±–æ—Ç–∞, 5 —Ä–µ–∞–ª—å–Ω–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤

### –ë–µ–∑–ø–µ–∫–∞ –∞–¥–º—ñ–Ω–∫–∏
```typescript
// 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ email whitelist
const whitelistedEmails = ['admin@example.com'];

// 2. –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è IP –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –≤—Ö–æ–¥—ñ
if (!user.adminIp) user.adminIp = currentIp;
if (user.adminIp !== currentIp) throw Forbidden;

// 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç—É —Å–µ—Å—ñ—ó
if (now - user.lastAdminActivity > 30min) throw Unauthorized;

// 4. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –≤–∏–∫–ª–∏–∫—É
user.lastAdminActivity = now;
```

### –°–∏—Å—Ç–µ–º–∞ –±–∞–Ω—ñ–≤
```typescript
// –ó–∞–±–∞–Ω–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
POST /admin/users/ban
{
  "userId": "uuid",
  "reason": "–ß–∏—Ç–µ—Ä—Å—Ç–≤–æ"
}

// –ó–∞–±–∞–Ω–µ–Ω–∏–π –Ω–µ –º–æ–∂–µ —É–≤—ñ–π—Ç–∏
// –ü—Ä–∏—á–∏–Ω–∞ –±–∞–Ω—É –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –¥–ª—è –∞—É–¥–∏—Ç—É
```

## –ö–ª—é—á–æ–≤—ñ —Ç–µ—Ö–Ω—ñ—á–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è

### –ß–æ–º—É Redis –¥–ª—è –º–∞—Ç—á–º–µ–π–∫—ñ–Ω–≥—É?
- O(1) –æ–ø–µ—Ä–∞—Ü—ñ—ó –∑ —á–µ—Ä–≥–∞–º–∏
- –í–±—É–¥–æ–≤–∞–Ω–∏–π TTL –¥–ª—è –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —Ç—ñ–∫–µ—Ç—ñ–≤
- –ê—Ç–æ–º–∞—Ä–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ Lua —Å–∫—Ä–∏–ø—Ç–∏
- –Ü–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ç–∏–º—á–∞—Å–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É –º–∞—Ç—á—ñ–≤
- –ö–ª—é—á—ñ: `queue:{players}:{stake}`, `ticket:{id}`, `match:{id}`

### –ì–ª–æ–±–∞–ª—å–Ω–∏–π JWT –º–æ–¥—É–ª—å
```typescript
@Global()
@Module({
  imports: [JwtModule.registerAsync({...})],
  exports: [JwtModule, JwtAuthGuard],
})
export class JwtAuthModule {}
```
- –Ñ–¥–∏–Ω–∞ JWT –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –¥–ª—è –≤—Å—ñ—Ö –º–æ–¥—É–ª—ñ–≤
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è —Ç–æ–∫–µ–Ω—ñ–≤
- –ù–µ–º–∞—î –¥—É–±–ª—é–≤–∞–Ω–Ω—è —ñ–º–ø–æ—Ä—Ç—ñ–≤ JwtModule

### –ó–∞—Ö–∏—Å—Ç –∑–∞–≤–∏—Å–ª–∏—Ö —Å—Ç–∞–≤–æ–∫
```typescript
// 1. –ü—Ä–∏ –∑–∞–º–æ—Ä–æ–∂—É–≤–∞–Ω–Ω—ñ —Å—Ç–∞–≤–∫–∏ - –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ Redis –∑ timestamp
await redis.set(`frozen:${userId}`, JSON.stringify({
  userId, stakeVp, frozenAt: Date.now()
}), 'EX', 600);

// 2. Cleanup job –∫–æ–∂–Ω—ñ 5 —Ö–≤–∏–ª–∏–Ω
if (frozenTime > 5 * 60 * 1000 && !hasActiveMatch) {
  await unfreezeStake(userId, stakeVp); // –ê–≤—Ç–æ–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è
}

// 3. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤—Ä—É—á–Ω—É
POST /wallet/reset-frozen
```

### –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ race conditions
```typescript
// PostgreSQL Advisory Lock (–æ—Å–Ω–æ–≤–Ω–∏–π)
const lock = await dataSource.query(
  `SELECT pg_try_advisory_lock($1)`, [lockId]
);

// Redis Lock (—Ä–µ–∑–µ—Ä–≤–Ω–∏–π)
const lock = await redis.set(lockKey, '1', 'EX', 5, 'NX');

// Double-check pattern
const existing = await hasExistingTicket(userId);
if (existing) return { status: 'ALREADY_IN_QUEUE' };
```

### F5 Recovery
```typescript
// –ü—Ä–∏ WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ:
// 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ orphaned –º–∞—Ç—á—ñ–≤ ‚Üí cleanup
// 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—ó —á–µ—Ä–≥–∏ ‚Üí –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è
// 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Ç—á—É ‚Üí –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
```

## –†–æ–∑—Ä–æ–±–∫–∞

```bash
# –ó–∞–ø—É—Å–∫ –∑ watch mode
npm run start:dev

# –ó–±—ñ—Ä–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É
npm run build

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É
npm run start:prod

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤
npm run test:e2e
```

## –î–µ–º–æ

–í—ñ–¥–∫—Ä–∏–π `http://localhost:3000/ws-test.html` –ø—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞.

**–¢–µ—Å—Ç–æ–≤–∏–π flow:**
1. –ù–∞—Ç–∏—Å–Ω–∏ "–ì–æ—Å—Ç—å–æ–≤–∏–π –≤—Ö—ñ–¥"
2. –í–∏–±–µ—Ä–∏ 2 –≥—Ä–∞–≤—Ü—ñ–≤, —Å—Ç–∞–≤–∫–∞ 100 VP
3. –ù–∞—Ç–∏—Å–Ω–∏ "–ì—Ä–∞—Ç–∏"
4. –í—ñ–¥–∫—Ä–∏ –¥—Ä—É–≥—É –≤–∫–ª–∞–¥–∫—É ‚Üí —ñ–Ω—à–∏–π –≥—ñ—Å—Ç—å
5. –°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞–π –º–∞—Ç—á–º–µ–π–∫—ñ–Ω–≥ (20—Å –∞–±–æ 2 –≥—Ä–∞–≤—Ü—ñ)
6. –†–æ–±–∏ —Ö–æ–¥–∏ –ø—Ä–æ—Ç—è–≥–æ–º 12 —Å–µ–∫—É–Ω–¥
7. –û–Ω–æ–≤–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É (F5) ‚Üí —Å—Ç–∞–Ω –≤—ñ–¥–Ω–æ–≤–∏—Ç—å—Å—è
8. –ù–∞—Ç–∏—Å–Ω–∏ "üèÜ –¢–æ–ø" ‚Üí –ø–µ—Ä–µ–≥–ª—è–¥ –ª—ñ–¥–µ—Ä–±–æ—Ä–¥—É

## –õ—ñ—Ü–µ–Ω–∑—ñ—è

–ü—Ä–æ—î–∫—Ç –¥–ª—è –ø–æ—Ä—Ç—Ñ–æ–ª—ñ–æ —Ç–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó –Ω–∞–≤–∏—á–æ–∫.
