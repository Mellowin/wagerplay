# WagerPlay Backend

Многопользовательская игра "Камень-Ножницы-Бумага" с матчмейкингом, real-time геймплеем и системой ставок.

> Проект создан для практики full-stack разработки. Backend на NestJS + PostgreSQL + Redis + Socket.io.

## Что реализовано

- **Матчмейкинг** - очередь игроков с таймаутом 20 секунд, автодозаполнение ботами
- **Real-time игровой процесс** - WebSocket события для ходов, таймеров, результатов раундов
- **Система раундов** - автоматические ходы при таймауте, определение победителя по правилам КНБ
- **Кошельки** - баланс VP (virtual points), заморозка ставок, выплаты победителям
- **Аудит** - логирование финансовых операций для отладки
- **Авторизация** - JWT токены + guest login без регистрации
- **Чат** - глобальный и внутри матча

## Стек технологий

- **Backend:** NestJS + TypeScript
- **База данных:** PostgreSQL + TypeORM
- **Кэш/Очереди:** Redis (ioredis)
- **Real-time:** Socket.io
- **Контейнеризация:** Docker + Docker Compose

## Быстрый старт

### 1. Установка

```bash
git clone https://github.com/Mellowin/wagerplay.git
cd wagerplay/backend
npm install
```

### 2. Переменные окружения

Создай `.env`:

```env
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/wagerplay
REDIS_URL=redis://localhost:6379
JWT_SECRET=your-secret-key
PORT=3000
NODE_ENV=development
```

### 3. Запуск

```bash
# Инфраструктура (PostgreSQL + Redis)
docker-compose up -d

# Сервер разработки
npm run start:dev
```

Открой `http://localhost:3000/ws-test.html` для тестирования.

## Как работает игра

### Flow матча

1. Игрок нажимает "Quick Play" → попадает в очередь
2. Система ждёт 20 секунд чтобы набрать игроков
3. Если игроков меньше 5 - добавляются боты
4. Отсчёт 5-4-3-2-1 → матч начинается
5. Раунды по 12 секунд (камень/ножницы/бумага)
6. Проигравшие выбывают, последний оставшийся - победитель

### Финансовый flow

```
1. Ставка замораживается (balance → frozen)
2. Матч идёт
3. Победитель получает pot - fee (10% комиссия)
4. История операций сохраняется в audit_logs
```

## API

### REST Endpoints

| Метод | Эндпоинт | Описание |
|-------|----------|----------|
| POST | `/auth/guest` | Создать гостевой аккаунт |
| POST | `/auth/login` | Войти (JWT) |
| GET | `/wallet` | Баланс |
| GET | `/wallet/reconcile` | Сверка баланса |
| GET | `/matchmaking/match/:id` | Получить матч |
| GET | `/matchmaking/match/:id/audit` | История событий матча |

### WebSocket Events

**Client → Server:**
- `quickplay` - начать поиск матча
- `move` - сделать ход
- `chat:global`, `chat:game` - отправить сообщение

**Server → Client:**
- `queue:sync` - обновление очереди
- `match:found` - матч найден (отсчёт 5 сек)
- `match:start` - начало игры
- `match:update` - результат раунда
- `match:timer` - синхронизация таймера

## Структура проекта

```
src/
├── auth/           # Авторизация (JWT, guest)
├── matchmaking/    # Логика игры, очереди, WebSocket
├── wallets/        # Балансы, ставки, выплаты
├── audit/          # Логирование операций
└── house/          # Системный "банк"
```

## Что я узнал/практиковал

- **WebSocket синхронизация:** как синхронизировать таймеры между клиентом и сервером
- **Race conditions:** проверка round/deadline перед обработкой хода
- **Транзакционность:** заморозка → списание → выплата (атомарные операции)
- **Redis:** использование для очередей и временных данных матчей
- **NestJS:** модули, guards, gateways, TypeORM интеграция

## Тестирование

```bash
# Многопользовательский тест
1. Открыть 3 вкладки браузера
2. Войти как Guest в каждой
3. Нажать Quick Play с одинаковыми параметрами
4. Через 20 сек создастся матч

# Проверка баланса
GET /wallet/reconcile - сравнивает actual vs expected
```

## Ограничения / Что можно улучшить

- Нет нагрузочного тестирования (неизвестно поведение под 100+ игроками)
- WebSocket без Redis Pub/Sub (не масштабируется на несколько серверов)
- Нет reconnect при обрыве соединения
- Email верификация требует SMTP конфигурации

## Лицензия

MIT - для портфолио и обучения.
