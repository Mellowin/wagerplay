# WagerPlay Backend

–ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∏–≥—Ä–∞ "–ö–∞–º–µ–Ω—å-–ù–æ–∂–Ω–∏—Ü—ã-–ë—É–º–∞–≥–∞" —Å –º–∞—Ç—á–º–µ–π–∫–∏–Ω–≥–æ–º, —Å–∏—Å—Ç–µ–º–æ–π —Å—Ç–∞–≤–æ–∫, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –±–æ—Ç–æ–≤ –∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏.

[![NestJS](https://img.shields.io/badge/NestJS-E0234E?style=flat&logo=nestjs&logoColor=white)](https://nestjs.com/)
[![TypeScript](https://img.shields.io/badge/TypeScript-3178C6?style=flat&logo=typescript&logoColor=white)](https://www.typescriptlang.org/)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-4169E1?style=flat&logo=postgresql&logoColor=white)](https://www.postgresql.org/)
[![Redis](https://img.shields.io/badge/Redis-DC382D?style=flat&logo=redis&logoColor=white)](https://redis.io/)
[![Socket.io](https://img.shields.io/badge/Socket.io-010101?style=flat&logo=socket.io&logoColor=white)](https://socket.io/)
[![Docker](https://img.shields.io/badge/Docker-2496ED?style=flat&logo=docker&logoColor=white)](https://www.docker.com/)

## –î–µ–º–æ-–≤–∏–¥–µ–æ

[![WagerPlay Demo](https://img.youtube.com/vi/s5ViycpnBDM/0.jpg)](https://www.youtube.com/watch?v=s5ViycpnBDM)

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –û—Å–Ω–æ–≤–Ω–æ–π –≥–µ–π–º–ø–ª–µ–π
- **–ú–∞—Ç—á–º–µ–π–∫–∏–Ω–≥** - 20-—Å–µ–∫—É–Ω–¥–Ω–∞—è –æ—á–µ—Ä–µ–¥—å —Å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º –±–æ—Ç–∞–º–∏
- **–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞** - 2-5 –∏–≥—Ä–æ–∫–æ–≤, —Å–∏—Å—Ç–µ–º–∞ –≤—ã–±—ã–≤–∞–Ω–∏—è
- **Real-time –≥–µ–π–º–ø–ª–µ–π** - WebSocket —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Ö–æ–¥–æ–≤, —Ç–∞–π–º–µ—Ä–æ–≤, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **–°–∏—Å—Ç–µ–º–∞ —Ä–∞—É–Ω–¥–æ–≤** - 12-—Å–µ–∫—É–Ω–¥–Ω—ã–µ —Ö–æ–¥—ã, –∞–≤—Ç–æ—Ö–æ–¥ –ø—Ä–∏ AFK
- **F5 Recovery** - –ø–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã

### –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
- **–ö–æ—à–µ–ª—å–∫–∏** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º VP (Virtual Points)
- **–ó–∞–º–æ—Ä–æ–∑–∫–∞ —Å—Ç–∞–≤–æ–∫** - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞–≤–æ–∫ –≤–æ –≤—Ä–µ–º—è –º–∞—Ç—á–∞
- **–°–∏—Å—Ç–µ–º–∞ –∫–æ–º–∏—Å—Å–∏–∏** - 5% –∫–æ–º–∏—Å—Å–∏—è house –Ω–∞ –∫–∞–∂–¥–æ–º –º–∞—Ç—á–µ
- **–í—ã–ø–ª–∞—Ç—ã** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–µ–π
- **–°–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –∏—Å—Ç–æ—Ä–∏—é

### –°–∏—Å—Ç–µ–º–∞ –ª–∏–¥–µ—Ä–æ–≤
- **5 –∫–∞—Ç–µ–≥–æ—Ä–∏–π**: –ü–æ–±–µ–¥—ã, –í–∏–Ω—Ä–µ–π—Ç, –ü—Ä–∏–±—ã–ª—å, –¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è, –ú–∞–∫—Å. —Å–µ—Ä–∏—è
- **–ü–∞–≥–∏–Ω–∞—Ü–∏—è** - –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–æ–ø—É –∏–≥—Ä–æ–∫–æ–≤
- **–ü–æ–∑–∏—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏** - –≤–∏–¥–Ω–æ —Å–≤–æ–π —Ä–∞–Ω–≥ –≤ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–æ–≤** - –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –∏–≥—Ä–æ–∫—É

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - JWT —Ç–æ–∫–µ–Ω—ã + –≥–æ—Å—Ç–µ–≤–æ–π –≤—Ö–æ–¥
- **–ü—Ä–æ—Ñ–∏–ª–∏** - –∫–∞—Å—Ç–æ–º–Ω—ã–µ –Ω–∏–∫–Ω–µ–π–º—ã, –∞–≤–∞—Ç–∞—Ä–∫–∏
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - –∏–≥—Ä—ã, –ø–æ–±–µ–¥—ã/–ø–æ—Ä–∞–∂–µ–Ω–∏—è, –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ/–ø–æ—Ç–µ—Ä—è–Ω–æ VP
- **–ß–∞—Ç** - –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏ –≤–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤–æ–π —á–∞—Ç

### –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º** - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ VP —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–°–∏—Å—Ç–µ–º–∞ –±–∞–Ω–æ–≤** - –±–∞–Ω/—Ä–∞–∑–±–∞–Ω —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø—Ä–∏—á–∏–Ω
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
  - IP Whitelist - –¥–æ—Å—Ç—É–ø –∞–¥–º–∏–Ω–∞ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ IP –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞
  - –¢–∞–π–º–∞—É—Ç —Å–µ—Å—Å–∏–∏ - –∞–≤—Ç–æ–≤—ã—Ö–æ–¥ —á–µ—Ä–µ–∑ 30 –º–∏–Ω –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  - Email Whitelist - —Ç–æ–ª—å–∫–æ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–µ email –º–æ–≥—É—Ç –±—ã—Ç—å –∞–¥–º–∏–Ω–∞–º–∏
- **–ò–∑–º–µ–Ω—è–µ–º—ã–π —Ä–∞–∑–º–µ—Ä** - —Ä–µ–≥—É–ª–∏—Ä—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
- **–ê—É–¥–∏—Ç –ª–æ–≥–∏** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∞

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∞—É–¥–∏—Ç
- **IDOR –∑–∞—â–∏—Ç–∞** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å–∞–º
- **–ó–∞—â–∏—Ç–∞ –æ—Ç –º–∞—Å—Å–æ–≤–æ–≥–æ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–ê—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ race conditions** - PostgreSQL Advisory Locks + Redis locks
- **–ó–∞—â–∏—Ç–∞ –∑–∞–≤–∏—Å—à–∏—Ö —Å—Ç–∞–≤–æ–∫** - –∞–≤—Ç–æ–≤–æ–∑–≤—Ä–∞—Ç —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç —Ç–∞–π–º–∞—É—Ç–∞
- **JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ç–æ–∫–µ–Ω-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º –º–æ–¥—É–ª–µ–º

### DevOps –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **Swagger API Docs** - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∞–¥—Ä–µ—Å—É `/api/docs`
- **Docker** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ
- **CI/CD Pipeline** - GitHub Actions –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **Health Checks** - endpoint –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

| –£—Ä–æ–≤–µ–Ω—å | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è |
|---------|------------|
| **Backend** | NestJS + TypeScript |
| **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** | PostgreSQL + TypeORM |
| **–ö—ç—à/–û—á–µ—Ä–µ–¥–∏** | Redis (ioredis) |
| **Real-time** | Socket.io |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | Jest + Supertest + k6 (–Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ) |
| **DevOps** | Docker + Docker Compose + GitHub Actions |
| **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** | Swagger/OpenAPI |

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
‚îú‚îÄ‚îÄ matchmaking/          # –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏ WebSocket
‚îÇ   ‚îú‚îÄ‚îÄ matchmaking.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ matchmaking.gateway.ts
‚îÇ   ‚îî‚îÄ‚îÄ matchmaking.controller.ts
‚îú‚îÄ‚îÄ wallets/              # –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
‚îú‚îÄ‚îÄ auth/                 # JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ jwt-auth.module.ts    # –ì–ª–æ–±–∞–ª—å–Ω—ã–π JWT –º–æ–¥—É–ª—å
‚îÇ   ‚îú‚îÄ‚îÄ jwt-auth.guard.ts
‚îÇ   ‚îî‚îÄ‚îÄ auth.service.ts
‚îú‚îÄ‚îÄ leaderboard/          # –°–∏—Å—Ç–µ–º–∞ –ª–∏–¥–µ—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ leaderboard.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ leaderboard.controller.ts
‚îú‚îÄ‚îÄ admin/                # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ users/                # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îú‚îÄ‚îÄ audit/                # –ê—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îî‚îÄ‚îÄ house/                # House –±–∞–Ω–∫

test/e2e/                 # E2E —Ç–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ race-conditions/
‚îú‚îÄ‚îÄ financial-security/
‚îú‚îÄ‚îÄ idor/
‚îî‚îÄ‚îÄ state-machine/
```

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Node.js 18+
- Docker & Docker Compose

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
git clone https://github.com/Mellowin/wagerplay.git
cd wagerplay

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞
npm install

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π .env —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏

# –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
docker-compose up -d

# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
npm run start:dev
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
DATABASE_URL=postgres://postgres:postgres@localhost:5432/wagerplay
REDIS_URL=redis://localhost:6379
JWT_SECRET=your-secret-key
PORT=3000
NODE_ENV=development
ADMIN_TOKEN=your-admin-token
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ E2E —Ç–µ—Å—Ç–æ–≤
npm run test:e2e

# –¢–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ: 80+ —Ç–µ—Å—Ç–æ–≤
# –¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç: –º–∞—Ç—á–º–µ–π–∫–∏–Ω–≥, –∏–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å,
# –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∏–≥—Ä–æ–∫–æ–≤ (2-5), race conditions, IDOR –∑–∞—â–∏—Ç–∞
```

### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ—Å—Ç–æ–≤
- **Race Conditions** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **Financial Security** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞, —Å–≤–µ—Ä–∫–∞
- **IDOR** - –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å–∞–º
- **State Machine** - –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –º–∞—Ç—á–∞, –ø–µ—Ä–µ—Ö–æ–¥—ã

## API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:3000/api/docs`

### REST Endpoints

#### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
```
POST   /auth/guest              # –ì–æ—Å—Ç–µ–≤–æ–π –≤—Ö–æ–¥
POST   /auth/register           # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
POST   /auth/login              # –í—Ö–æ–¥
GET    /auth/me                 # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
PATCH  /auth/profile            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
```

#### –ú–∞—Ç—á–º–µ–π–∫–∏–Ω–≥
```
POST   /matchmaking/quickplay           # –í—Å—Ç—É–ø–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å
POST   /matchmaking/match/:id/move      # –°–¥–µ–ª–∞—Ç—å —Ö–æ–¥
GET    /matchmaking/match/:id           # –î–µ—Ç–∞–ª–∏ –º–∞—Ç—á–∞
GET    /matchmaking/history             # –ò—Å—Ç–æ—Ä–∏—è –º–∞—Ç—á–µ–π
GET    /matchmaking/online              # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω –∏–≥—Ä–æ–∫–æ–≤
```

#### –ö–æ—à–µ–ª—ë–∫
```
GET    /wallet                   # –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å
POST   /wallet/reset-frozen     # –í–µ—Ä–Ω—É—Ç—å –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—É—é —Å—Ç–∞–≤–∫—É
GET    /wallet/reconcile         # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å
```

#### –õ–∏–¥–µ—Ä–±–æ—Ä–¥
```
GET    /leaderboard              # –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤
GET    /leaderboard/me           # –ú–æ—è –ø–æ–∑–∏—Ü–∏—è
GET    /leaderboard/categories   # –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
```

#### –ê–¥–º–∏–Ω (–¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞)
```
GET    /admin/users              # –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
POST   /admin/users/balance      # –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
POST   /admin/users/ban          # –ó–∞–±–∞–Ω–∏—Ç—å
POST   /admin/users/unban        # –†–∞–∑–±–∞–Ω–∏—Ç—å
```

### WebSocket —Å–æ–±—ã—Ç–∏—è
```
# –°–æ–±—ã—Ç–∏—è –æ—á–µ—Ä–µ–¥–∏
queue:join          # –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å
queue:sync          # –°—Ç–∞—Ç—É—Å –æ—á–µ—Ä–µ–¥–∏
queue:error         # –û—à–∏–±–∫–∞ –æ—á–µ—Ä–µ–¥–∏

# –°–æ–±—ã—Ç–∏—è –º–∞—Ç—á–∞  
match:found         # –ú–∞—Ç—á —Å–æ–∑–¥–∞–Ω
match:start         # –ú–∞—Ç—á –Ω–∞—á–∞—Ç
match:state         # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
match:timer         # –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞
match:round_result  # –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥–∞
match:elimination   # –ò–≥—Ä–æ–∫ –≤—ã–±—ã–ª
match:end           # –ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω

# –ß–∞—Ç —Å–æ–±—ã—Ç–∏—è
chat:global         # –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
chat:game           # –ò–≥—Ä–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
```

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### Flow –º–∞—Ç—á–∞
1. –ò–≥—Ä–æ–∫ –Ω–∞–∂–∏–º–∞–µ—Ç "–ò–≥—Ä–∞—Ç—å" ‚Üí –ø–æ–ø–∞–¥–∞–µ—Ç –≤ Redis –æ—á–µ—Ä–µ–¥—å
2. 20-—Å–µ–∫—É–Ω–¥–Ω—ã–π —Ç–∞–π–º–µ—Ä –¥–ª—è —Å–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–æ–≤
3. –ï—Å–ª–∏ < 2 –∏–≥—Ä–æ–∫–æ–≤ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –±–æ—Ç—ã
4. –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç 5-4-3-2-1 ‚Üí –º–∞—Ç—á –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è
5. 12-—Å–µ–∫—É–Ω–¥–Ω—ã–µ —Ä–∞—É–Ω–¥—ã (–ö–∞–º–µ–Ω—å/–ù–æ–∂–Ω–∏—Ü—ã/–ë—É–º–∞–≥–∞)
6. AFK –∏–≥—Ä–æ–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –∞–≤—Ç–æ—Ö–æ–¥
7. –í—ã–±—ã–≤–∞–Ω–∏–µ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è

### –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π flow
```
–°—Ç–∞–≤–∫–∞: 100 VP
  ‚Üì
–ó–∞–º–æ—Ä–æ–∑–∫–∞: 100 VP (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –º–∞—Ç—á–∞)
  ‚Üì
[–ï—Å–ª–∏ –º–∞—Ç—á –Ω–µ –Ω–∞—á–Ω—ë—Ç—Å—è –∑–∞ 5 –º–∏–Ω ‚Üí –∞–≤—Ç–æ–≤–æ–∑–≤—Ä–∞—Ç]
  ‚Üì
–ë–∞–Ω–∫: 200 VP (2 –∏–≥—Ä–æ–∫–∞)
  ‚Üì
–ö–æ–º–∏—Å—Å–∏—è: 10 VP (5% house)
  ‚Üì
–í—ã–ø–ª–∞—Ç–∞: 190 VP ‚Üí –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
```

### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
- **–ü–æ–±–µ–¥—ã** - –í—Å–µ–≥–æ –ø–æ–±–µ–¥
- **–í–∏–Ω—Ä–µ–π—Ç** - –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–±–µ–¥ (–º–∏–Ω. 10 –º–∞—Ç—á–µ–π)
- **–ü—Ä–∏–±—ã–ª—å** - –í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ VP
- **–¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è** - –¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è –ø–æ–±–µ–¥
- **–ú–∞–∫—Å. —Å–µ—Ä–∏—è** - –†–µ–∫–æ—Ä–¥–Ω–∞—è —Å–µ—Ä–∏—è –ø–æ–±–µ–¥

### –°–∏—Å—Ç–µ–º–∞ –±–æ—Ç–æ–≤
–ë–æ—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç –Ω–µ–ø–æ–ª–Ω—ã–µ –º–∞—Ç—á–∏:
- **–¢—Ä–∏–≥–≥–µ—Ä**: –ï—Å–ª–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ –º–µ–Ω—å—à–µ —Ç—Ä–µ–±—É–µ–º–æ–≥–æ –ø–æ—Å–ª–µ 20—Å
- **–ü–æ–≤–µ–¥–µ–Ω–∏–µ**: –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –Ω–∏–∫–∏, —Å–ª—É—á–∞–π–Ω—ã–µ —Ö–æ–¥—ã
- **–ö–æ–º–±–∏–Ω–∞—Ü–∏–∏**: 1+ –±–æ—Ç, 2+ –±–æ—Ç–∞, 3+ –±–æ—Ç–∞, 4+ –±–æ—Ç–∞, 5 —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∞–¥–º–∏–Ω–∫–∏
```typescript
// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ email whitelist
const whitelistedEmails = ['admin@example.com'];

// 2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ IP –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
if (!user.adminIp) user.adminIp = currentIp;
if (user.adminIp !== currentIp) throw Forbidden;

// 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞ —Å–µ—Å—Å–∏–∏
if (now - user.lastAdminActivity > 30min) throw Unauthorized;

// 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ
user.lastAdminActivity = now;
```

### –°–∏—Å—Ç–µ–º–∞ –±–∞–Ω–æ–≤
```typescript
// –ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
POST /admin/users/ban
{
  "userId": "uuid",
  "reason": "–ß–∏—Ç–µ—Ä—Å—Ç–≤–æ"
}

// –ó–∞–±–∞–Ω–µ–Ω–Ω—ã–π –Ω–µ –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏
// –ü—Ä–∏—á–∏–Ω–∞ –±–∞–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞
```

## –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è

### –ü–æ—á–µ–º—É Redis –¥–ª—è –º–∞—Ç—á–º–µ–π–∫–∏–Ω–≥–∞?
- O(1) –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –æ—á–µ—Ä–µ–¥—è–º–∏
- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π TTL –¥–ª—è –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–∏–∫–µ—Ç–æ–≤
- –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Lua —Å–∫—Ä–∏–ø—Ç—ã
- –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞—Ç—á–µ–π
- –ö–ª—é—á–∏: `queue:{players}:{stake}`, `ticket:{id}`, `match:{id}`

### –ì–ª–æ–±–∞–ª—å–Ω—ã–π JWT –º–æ–¥—É–ª—å
```typescript
@Global()
@Module({
  imports: [JwtModule.registerAsync({...})],
  exports: [JwtModule, JwtAuthGuard],
})
export class JwtAuthModule {}
```
- –ï–¥–∏–Ω–∞—è JWT –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏–º–ø–æ—Ä—Ç–æ–≤ JwtModule

### –ó–∞—â–∏—Ç–∞ –∑–∞–≤–∏—Å—à–∏—Ö —Å—Ç–∞–≤–æ–∫
```typescript
// 1. –ü—Ä–∏ –∑–∞–º–æ—Ä–æ–∑–∫–µ —Å—Ç–∞–≤–∫–∏ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Redis —Å timestamp
await redis.set(`frozen:${userId}`, JSON.stringify({
  userId, stakeVp, frozenAt: Date.now()
}), 'EX', 600);

// 2. Cleanup job –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
if (frozenTime > 5 * 60 * 1000 && !hasActiveMatch) {
  await unfreezeStake(userId, stakeVp); // –ê–≤—Ç–æ–≤–æ–∑–≤—Ä–∞—Ç
}

// 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –≤—Ä—É—á–Ω—É—é
POST /wallet/reset-frozen
```

### –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions
```typescript
// PostgreSQL Advisory Lock (–æ—Å–Ω–æ–≤–Ω–æ–π)
const lock = await dataSource.query(
  `SELECT pg_try_advisory_lock($1)`, [lockId]
);

// Redis Lock (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π)
const lock = await redis.set(lockKey, '1', 'EX', 5, 'NX');

// Double-check pattern
const existing = await hasExistingTicket(userId);
if (existing) return { status: 'ALREADY_IN_QUEUE' };
```

### F5 Recovery
```typescript
// –ü—Ä–∏ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏:
// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ orphaned –º–∞—Ç—á–µ–π ‚Üí cleanup
// 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
// 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Ç—á–∞ ‚Üí –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
```

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –ó–∞–ø—É—Å–∫ —Å watch mode
npm run start:dev

# –°–±–æ—Ä–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
npm run build

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
npm run start:prod

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
npm run test:e2e
```

## –î–µ–º–æ

–û—Ç–∫—Ä–æ–π `http://localhost:3000/ws-test.html` –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.

**–¢–µ—Å—Ç–æ–≤—ã–π flow:**
1. –ù–∞–∂–º–∏ "–ì–æ—Å—Ç–µ–≤–æ–π –≤—Ö–æ–¥"
2. –í—ã–±–µ—Ä–∏ 2 –∏–≥—Ä–æ–∫–æ–≤, —Å—Ç–∞–≤–∫–∞ 100 VP
3. –ù–∞–∂–º–∏ "–ò–≥—Ä–∞—Ç—å"
4. –û—Ç–∫—Ä–æ–π –≤—Ç–æ—Ä—É—é –≤–∫–ª–∞–¥–∫—É ‚Üí –¥—Ä—É–≥–æ–π –≥–æ—Å—Ç—å
5. –°–º–æ—Ç—Ä–∏ –º–∞—Ç—á–º–µ–π–∫–∏–Ω–≥ (20—Å –∏–ª–∏ 2 –∏–≥—Ä–æ–∫–∞)
6. –î–µ–ª–∞–π —Ö–æ–¥—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 12 —Å–µ–∫—É–Ω–¥
7. –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5) ‚Üí —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è
8. –ù–∞–∂–º–∏ "üèÜ –¢–æ–ø" ‚Üí –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞

## –õ–∏—Ü–µ–Ω–∑–∏—è

–ü—Ä–æ–µ–∫—Ç –¥–ª—è –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞–≤—ã–∫–æ–≤.
