<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WagerPlay - Rock Paper Scissors</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23667eea'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3E%F0%9F%8E%AE%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ==========================================
           ðŸŽ¨ CSS Variables for Theming
           ========================================== */
        :root {
            /* Dark theme (default) */
            --bg-gradient-start: #1e3c72;
            --bg-gradient-end: #2a5298;
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.8);
            --card-bg: rgba(255,255,255,0.1);
            --card-border: rgba(255,255,255,0.2);
            --btn-primary-gradient-start: #667eea;
            --btn-primary-gradient-end: #764ba2;
            --btn-primary-shadow: rgba(102,126,234,0.4);
            --btn-secondary-bg: rgba(255,255,255,0.2);
            --input-bg: rgba(255,255,255,0.1);
            --input-border: rgba(255,255,255,0.3);
            --chat-bg: rgba(0,0,0,0.2);
            --modal-overlay: rgba(0,0,0,0.8);
            --success-color: #4ade80;
            --danger-color: #f87171;
            --warning-color: #fbbf24;
            --gold-color: #ffd700;
        }

        [data-theme="light"] {
            /* Light blue theme */
            --bg-gradient-start: #e0f2fe;
            --bg-gradient-end: #bae6fd;
            --text-primary: #0c4a6e;
            --text-secondary: rgba(12,74,110,0.7);
            --card-bg: rgba(255,255,255,0.7);
            --card-border: rgba(56,189,248,0.3);
            --btn-primary-gradient-start: #0284c7;
            --btn-primary-gradient-end: #0369a1;
            --btn-primary-shadow: rgba(2,132,199,0.3);
            --btn-secondary-bg: rgba(186,230,253,0.5);
            --input-bg: rgba(255,255,255,0.9);
            --input-border: rgba(56,189,248,0.4);
            --chat-bg: rgba(224,242,254,0.8);
            --modal-overlay: rgba(12,74,110,0.5);
            --success-color: #059669;
            --danger-color: #dc2626;
            --warning-color: #d97706;
            --gold-color: #b45309;
        }

        /* ðŸž Toast Notifications */
        .toast {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 16px 20px;
            min-width: 280px;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: toastSlideIn 0.3s ease;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        .toast.warning {
            border-left: 4px solid var(--warning-color);
        }

        .toast.info {
            border-left: 4px solid var(--btn-primary-gradient-start);
        }

        .toast-icon {
            font-size: 1.5em;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 0.95em;
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-close:hover {
            opacity: 1;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast.hiding {
            animation: toastSlideOut 0.3s ease forwards;
        }

        /* Light theme button overrides */
        [data-theme="light"] .btn {
            box-shadow: 0 2px 8px rgba(2,132,199,0.2);
        }

        [data-theme="light"] .btn-primary {
            box-shadow: 0 4px 15px rgba(2,132,199,0.35);
        }

        [data-theme="light"] .btn-secondary {
            border: 1px solid rgba(56,189,248,0.5);
            color: #0369a1;
        }

        [data-theme="light"] .balance-card {
            box-shadow: 0 4px 20px rgba(2,132,199,0.15);
        }

        [data-theme="light"] .game-log {
            background: rgba(186,230,253,0.4);
            border: 1px solid rgba(56,189,248,0.3);
        }

        [data-theme="light"] .stats-tab {
            color: var(--text-secondary);
        }

        [data-theme="light"] .stats-tab.active {
            color: var(--gold-color);
            border-bottom-color: var(--gold-color);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Header with theme toggle */
        .header-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        h1 {
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .theme-toggle {
            position: absolute;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.3em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            background: var(--btn-secondary-bg);
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        /* Balance Card */
        .balance-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid var(--card-border);
            transition: background 0.3s ease, border 0.3s ease;
        }

        .balance-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--gold-color);
            text-shadow: 0 0 20px rgba(234, 179, 8, 0.5);
        }

        .balance-frozen {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Control Buttons */
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--btn-primary-gradient-start) 0%, var(--btn-primary-gradient-end) 100%);
            color: white;
            box-shadow: 0 4px 15px var(--btn-primary-shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--btn-primary-shadow);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(17,153,142,0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(17,153,142,0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Game Area */
        .game-area {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            min-height: 300px;
        }

        .game-status {
            text-align: center;
            margin-bottom: 30px;
        }

        .status-text {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .match-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        /* Move Buttons */
        .moves-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .move-btn {
            width: 120px;
            height: 140px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 2px solid transparent;
        }

        .move-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.05);
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .move-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .move-btn.selected {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
            box-shadow: 0 0 30px rgba(255,215,0,0.5);
        }

        .move-emoji {
            font-size: 3em;
        }

        .move-text {
            font-size: 1.1em;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Players Grid */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .player-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .player-card.active {
            border-color: #38ef7d;
            background: rgba(56,239,125,0.1);
        }

        .player-card.eliminated {
            opacity: 0.4;
            border-color: #ff4757;
        }

        .player-card.winner {
            border-color: #ffd700;
            background: rgba(255,215,0,0.2);
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }

        .player-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .player-move {
            font-size: 2em;
            margin: 10px 0;
        }

        .player-status {
            font-size: 0.8em;
            opacity: 0.8;
        }

        /* Round Info */
        .round-info {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .round-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #ffd700;
        }

        /* Log */
        .log-container {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            opacity: 0.5;
            margin-right: 10px;
        }

        /* Waiting Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .waiting {
            animation: pulse 1.5s infinite;
            text-align: center;
            font-size: 1.2em;
            padding: 40px;
        }

        .hidden {
            display: none !important;
        }

        /* Sound toggle */
        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sound-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* Online Counter */
        .online-counter {
            position: fixed;
            top: 75px;
            right: 20px;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0,0,0,0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            color: white;
            backdrop-filter: blur(10px);
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Burger Menu */
        .burger-menu-container {
            position: fixed;
            top: 20px;
            right: 80px;
            z-index: 1000;
        }

        .burger-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            padding: 10px 15px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .burger-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .burger-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(30, 60, 114, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            overflow: hidden;
            min-width: 200px;
        }

        .burger-menu.show {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        /* History Styles */
        .history-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            border-left: 4px solid;
        }

        .history-item.win {
            border-left-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }

        .history-item.loss {
            border-left-color: #f87171;
            background: rgba(248, 113, 113, 0.1);
        }

        .history-result {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .history-item.win .history-result {
            color: #4ade80;
        }

        .history-item.loss .history-result {
            color: #f87171;
        }

        .history-details {
            font-size: 0.9em;
            color: rgba(255,255,255,0.8);
            line-height: 1.5;
        }

        .empty-state, .loading, .error {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.6);
        }

        .error {
            color: #f87171;
        }

        /* Language Dropdown Styles */
        .lang-dropdown-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .lang-dropdown-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .lang-dropdown-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .lang-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: rgba(30, 60, 114, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            overflow: hidden;
            min-width: 150px;
        }

        .lang-dropdown-menu.show {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        .lang-dropdown-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
        }

        .lang-dropdown-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .lang-dropdown-item.selected {
            background: rgba(255,215,0,0.3);
        }

        /* Player Selector */
        .player-selector {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .selector-label {
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .selector-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .selector-btn {
            padding: 10px 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .selector-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
        }

        .selector-btn.active {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
            color: #ffd700;
        }

        /* Game Controls Row */
        .game-controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }

        /* Dropdown Play Button */
        .dropdown-play {
            position: relative;
            display: flex;
            align-items: center;
        }

        .btn-play-main, .btn-stake-main {
            border-radius: 12px 0 0 12px;
            padding-right: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-play-arrow, .btn-stake-arrow {
            border-radius: 0 12px 12px 0;
            padding: 12px 10px;
            margin-left: 2px;
            font-size: 0.7em;
            min-width: 32px;
            transition: transform 0.3s ease;
        }

        .btn-play-arrow:hover, .btn-stake-arrow:hover {
            transform: translateY(-2px);
        }

        .btn-play-arrow.active, .btn-stake-arrow.active {
            background: rgba(255,215,0,0.5);
        }

        .player-count-badge {
            background: rgba(255,215,0,0.8);
            color: #1e3c72;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.85em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Stats Modal */
        .stats-tabs {
            display: flex;
            gap: 5px;
            padding: 0 20px;
            border-bottom: 1px solid var(--card-border);
            background: var(--card-bg);
        }

        .stats-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.95em;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .stats-tab:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.05);
        }

        .stats-tab.active {
            color: var(--gold-color);
            border-bottom-color: var(--gold-color);
            font-weight: 600;
        }

        .stats-tab-content {
            display: none;
        }

        .stats-tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .winrate-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .winrate-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #ffd700);
        }

        /* Leaderboard Styles */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .leaderboard-table th {
            background: rgba(255,255,255,0.1);
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--card-border);
        }

        .leaderboard-table td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--card-border);
        }

        .leaderboard-table tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .leaderboard-rank {
            font-weight: bold;
            font-size: 1.2em;
            width: 50px;
            text-align: center;
        }

        .leaderboard-rank.top-1 { color: #ffd700; }
        .leaderboard-rank.top-2 { color: #c0c0c0; }
        .leaderboard-rank.top-3 { color: #cd7f32; }

        .leaderboard-player {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .leaderboard-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
        }

        .leaderboard-value {
            font-weight: bold;
            color: var(--gold-color);
            text-align: right;
        }

        .leaderboard-stats {
            font-size: 0.85em;
            opacity: 0.8;
            text-align: right;
        }

        .leaderboard-loading {
            text-align: center;
            padding: 40px;
            font-size: 1.1em;
        }

        .leaderboard-empty {
            text-align: center;
            padding: 40px;
            opacity: 0.7;
        }

        .leaderboard-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 15px 20px;
            border-top: 1px solid var(--card-border);
        }

        .leaderboard-my-position {
            background: rgba(102, 126, 234, 0.2);
            border-left: 3px solid var(--btn-primary-gradient-start);
        }
            transition: width 0.5s ease;
        }

        .public-profile {
            text-align: center;
            padding: 20px;
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
        }

        .public-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .public-stat {
            text-align: center;
        }

        .public-stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        .public-stat-label {
            font-size: 0.75em;
            opacity: 0.7;
            margin-top: 3px;
        }

        .chat-author-clickable {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .chat-author-clickable:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .player-count-badge {
            background: rgba(255,215,0,0.8);
            color: #1e3c72;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: bold;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            background: rgba(30, 60, 114, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            overflow: hidden;
            z-index: 100;
            min-width: 150px;
        }

        .dropdown-menu.show {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .dropdown-item.selected {
            background: rgba(255,215,0,0.3);
        }

        .dropdown-players {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .dropdown-item.selected .dropdown-players {
            background: #ffd700;
            color: #1e3c72;
        }

        .dropdown-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Chat */
        .chat-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
            overflow: hidden;
            display: none;
        }

        .chat-container.active {
            display: block;
        }

        .chat-header {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .chat-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            max-width: 300px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }

        .chat-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .chat-tabs::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }

        .chat-tab {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-tab.active {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
            color: #ffd700;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .chat-message.system {
            background: rgba(255,215,0,0.2);
            text-align: center;
            font-style: italic;
        }

        .chat-author {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 3px;
        }

        .chat-time {
            font-size: 0.75em;
            opacity: 0.6;
            margin-left: 10px;
        }

        .chat-input-area {
            display: flex;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            outline: none;
        }

        .chat-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .chat-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-send:hover {
            transform: scale(1.1);
        }

        .chat-closed {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
            font-style: italic;
        }

        /* Auth Buttons */
        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.1);
            padding: 8px 20px;
            border-radius: 25px;
        }

        .user-email {
            font-weight: 600;
            color: #ffd700;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideUp 0.3s ease;
        }

        .modal-large {
            max-width: 500px;
            padding: 0;
            overflow: hidden;
        }

        .modal-large .modal-header {
            padding: 20px 30px;
            margin: 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .modal-large .modal-body {
            padding: 20px 30px;
            max-height: 500px;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1em;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .form-group input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        /* Password field with toggle */
        .password-field {
            position: relative;
        }
        
        .password-field input {
            width: 100%;
            padding-right: 40px;
        }
        
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 5px;
        }
        
        .password-toggle:hover {
            opacity: 1;
        }

        .btn-full {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
        }

        .form-links {
            text-align: center;
            margin-top: 20px;
        }

        .form-links a {
            color: #ffd700;
            text-decoration: none;
            font-size: 0.9em;
        }

        .form-links a:hover {
            text-decoration: underline;
        }

        .form-info {
            text-align: center;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        /* Profile Modal Styles */
        .profile-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .avatar-preview-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid #667eea;
            flex-shrink: 0;
        }

        .avatar-preview-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
        }

        .profile-info select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            color: white;
            font-size: 1em;
        }

        .profile-info select option {
            background: #2a5298;
            color: white;
        }

        .avatar-section {
            margin-bottom: 20px;
        }

        .avatar-section > label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .avatar-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .avatar-tab {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .avatar-tab.active {
            background: #667eea;
        }

        .avatar-tab:hover {
            background: rgba(255,255,255,0.2);
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .avatar-item {
            aspect-ratio: 1;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .avatar-item:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .avatar-item.selected {
            border-color: #00d9ff;
            box-shadow: 0 0 10px rgba(0,217,255,0.5);
        }

        .avatar-item img {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }

        .upload-area {
            grid-column: 1 / -1;
            height: 100px;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102,126,234,0.1);
        }

        .user-avatar-mini {
            transition: transform 0.3s;
        }

        .user-avatar-mini:hover {
            transform: scale(1.1);
        }

        .profile-link-email p {
            margin-bottom: 10px;
            opacity: 0.9;
        }

        /* ==========================================
           ðŸ“± MOBILE RESPONSIVE FIXES
           ========================================== */
        @media (max-width: 600px) {
            /* Header fixes */
            .header-row {
                flex-wrap: wrap;
                gap: 8px;
                padding: 0 10px;
                margin-top: 60px; /* Space for fixed top buttons */
            }
            
            .header-row h1 {
                font-size: 1.4em;
            }
            
            /* Language dropdown - move to top left */
            .lang-dropdown-container {
                top: 10px;
                left: 10px;
            }
            
            .lang-dropdown-btn {
                padding: 6px 10px;
                font-size: 0.85em;
            }
            
            /* Burger menu - move closer on mobile */
            .burger-menu-container {
                top: 10px;
                right: 60px;
            }
            
            .burger-btn {
                width: 36px;
                height: 36px;
                font-size: 1.2em;
            }
            
            /* Sound toggle - smaller on mobile */
            .sound-toggle {
                top: 10px;
                right: 10px;
                width: 36px;
                height: 36px;
                font-size: 1.2em;
            }
            
            /* Online counter - move below sound toggle */
            .online-counter {
                top: 50px;
                right: 10px;
                padding: 4px 8px;
                font-size: 0.8em;
            }
            
            /* Balance card */
            .balance-card {
                padding: 15px;
                margin: 10px;
            }
            
            .balance-display {
                font-size: 2em;
            }
            
            /* Controls - fix button overlap */
            .controls {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            
            .auth-buttons {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
                width: 100%;
            }
            
            .auth-buttons .btn {
                padding: 8px 12px;
                font-size: 0.85em;
                flex: 1;
                min-width: 100px;
                max-width: 150px;
            }
            
            /* User info row - fix button overlap */
            .user-info {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                justify-content: center;
                align-items: center;
                width: 100%;
            }
            
            .user-info .btn {
                padding: 6px 10px;
                font-size: 0.8em;
                flex: 1;
                min-width: 80px;
                max-width: 120px;
            }
            
            .user-email {
                font-size: 0.85em;
                width: 100%;
                text-align: center;
                margin-bottom: 5px;
                word-break: break-all;
            }
            
            /* User avatar mini */
            .user-avatar-mini {
                width: 28px;
                height: 28px;
            }
            
            /* Game controls row */
            .game-controls-row {
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
            }
            
            .dropdown-play {
                margin: 0 !important;
            }
            
            .btn-play-main, .btn-stake-main {
                padding: 10px 15px;
                font-size: 0.9em;
            }
            
            /* Theme toggle */
            .theme-toggle {
                width: 32px;
                height: 32px;
                font-size: 1em;
            }
            
            /* Container padding */
            .container {
                padding: 10px;
            }
            
            /* Game content */
            #gameContent {
                padding: 15px;
            }
            
            /* Chat */
            .chat-container {
                height: 200px;
            }
            
            .chat-header {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .chat-tabs {
                flex-wrap: wrap;
                gap: 3px;
            }
            
            .chat-tab {
                padding: 4px 8px;
                font-size: 0.8em;
            }
            
            /* Modal */
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                max-height: 90vh;
            }
            
            /* Buttons */
            .btn {
                padding: 8px 12px;
                font-size: 0.9em;
            }
            
            /* Player badge */
            .player-count-badge {
                width: 20px;
                height: 20px;
                font-size: 0.75em;
            }
            
            /* Waiting screen text */
            .waiting {
                padding: 20px;
            }
            
            .waiting div {
                font-size: 1.2em !important;
            }
        }
        
        /* ==========================================
           ðŸ“± PHONE-SPECIFIC BREAKPOINTS
           ========================================== */
        
        /* iPhone SE, Small Android (320px-360px) */
        @media (max-width: 360px) {
            .header-row {
                margin-top: 55px;
            }
            
            .header-row h1 {
                font-size: 1.1em;
            }
            
            .subtitle {
                font-size: 0.8em;
            }
            
            .balance-display {
                font-size: 1.4em;
            }
            
            .btn-play-main, .btn-stake-main {
                padding: 6px 8px;
                font-size: 0.75em;
            }
            
            .auth-buttons .btn {
                min-width: 85px;
                padding: 6px 8px;
                font-size: 0.8em;
            }
            
            .user-info .btn {
                min-width: 70px;
                padding: 5px 6px;
                font-size: 0.7em;
            }
            
            .lang-dropdown-btn {
                font-size: 0.75em;
                padding: 5px 8px;
            }
            
            .burger-btn {
                width: 32px;
                height: 32px;
                font-size: 1em;
            }
            
            .sound-toggle {
                width: 32px;
                height: 32px;
                font-size: 1em;
            }
        }
        
        /* iPhone 12/13/14, Standard Android (361px-390px) */
        @media (min-width: 361px) and (max-width: 390px) {
            .header-row h1 {
                font-size: 1.25em;
            }
            
            .balance-display {
                font-size: 1.5em;
            }
            
            .btn-play-main, .btn-stake-main {
                padding: 8px 10px;
                font-size: 0.8em;
            }
        }
        
        /* iPhone 14 Pro Max, Large Android (391px-430px) */
        @media (min-width: 391px) and (max-width: 430px) {
            .header-row h1 {
                font-size: 1.3em;
            }
            
            .balance-display {
                font-size: 1.7em;
            }
            
            .btn-play-main, .btn-stake-main {
                padding: 9px 12px;
                font-size: 0.85em;
            }
        }
        
        /* Tablets Portrait (601px-768px) */
        @media (min-width: 601px) and (max-width: 768px) {
            .container {
                max-width: 100%;
                padding: 15px;
            }
            
            .header-row {
                margin-top: 70px;
            }
            
            .game-controls-row {
                gap: 15px;
            }
        }
        
        /* Tablets Landscape, Small Desktops (769px-1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 700px;
            }
        }
        
        /* iPhone Safe Area (notch support) */
        @supports (padding-top: env(safe-area-inset-top)) {
            @media (max-width: 600px) {
                .lang-dropdown-container,
                .burger-menu-container {
                    top: calc(10px + env(safe-area-inset-top));
                }
                
                .sound-toggle {
                    top: calc(10px + env(safe-area-inset-top));
                }
                
                .online-counter {
                    top: calc(50px + env(safe-area-inset-top));
                }
                
                .header-row {
                    margin-top: calc(60px + env(safe-area-inset-top));
                }
                
                .container {
                    padding-bottom: env(safe-area-inset-bottom);
                }
            }
        }
        
        /* Landscape orientation on phones */
        @media (max-width: 896px) and (orientation: landscape) {
            .header-row {
                margin-top: 50px;
            }
            
            .lang-dropdown-container,
            .burger-menu-container,
            .sound-toggle {
                top: 5px;
            }
            
            .online-counter {
                top: 40px;
            }
            
            .game-controls-row {
                flex-wrap: nowrap;
            }
            
            .balance-card {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .chat-container {
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <button class="sound-toggle" onclick="toggleSound()" title="Ð’ÐºÐ»/Ð²Ñ‹ÐºÐ» Ð·Ð²ÑƒÐº">ðŸ”Š</button>

    <!-- Online Counter -->
    <div class="online-counter" id="onlineCounter">
        <div class="online-dot"></div>
        <span id="onlineCount">-</span>
    </div>

    <!-- Burger Menu -->
    <div class="burger-menu-container">
        <button class="burger-btn" onclick="toggleMenu()" title="ÐœÐµÐ½ÑŽ">â˜°</button>
        <div class="burger-menu" id="burgerMenu">
            <div class="dropdown-item" onclick="doCheckBalance(); closeMenu();">
                <span>ðŸ’³</span>
                <span id="burgerBalanceText">Ð‘Ð°Ð»Ð°Ð½Ñ</span>
            </div>
            <div class="dropdown-item" onclick="showStatsModal(); closeMenu();">
                <span>ðŸ“Š</span>
                <span id="burgerStatsText">Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°</span>
            </div>
            <div class="dropdown-item" onclick="showLeaderboard(); closeMenu();">
                <span>ðŸ†</span>
                <span id="burgerLeaderboardText">Ð¢Ð¾Ð¿</span>
            </div>
            <div class="dropdown-item" onclick="showLogsInChat(); closeMenu();">
                <span>ðŸ“‹</span>
                <span id="burgerLogsText">Ð›Ð¾Ð³Ð¸</span>
            </div>
            <!-- Admin Panel Button - Only for admins -->
            <div class="dropdown-item" id="adminMenuItem" onclick="showAdminPanel(); closeMenu();" style="display: none;">
                <span>âš™ï¸</span>
                <span id="burgerAdminText">ÐÐ´Ð¼Ð¸Ð½</span>
            </div>
        </div>
    </div>

    <!-- Language Dropdown -->
    <div class="lang-dropdown-container">
        <button class="lang-dropdown-btn" onclick="toggleLanguageDropdown()" id="langDropdownBtn">RU â–¼</button>
        <div class="lang-dropdown-menu" id="langDropdownMenu">
            <div class="lang-dropdown-item" onclick="setLang('ru')" data-lang="ru">
                <span>ðŸ‡·ðŸ‡º</span>
                <span>Ð ÑƒÑÑÐºÐ¸Ð¹</span>
            </div>
            <div class="lang-dropdown-item" onclick="setLang('en')" data-lang="en">
                <span>ðŸ‡ºðŸ‡¸</span>
                <span>English</span>
            </div>
            <div class="lang-dropdown-item" onclick="setLang('cn')" data-lang="cn">
                <span>ðŸ‡¨ðŸ‡³</span>
                <span>ä¸­æ–‡</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header-row">
            <h1>ðŸŽ® WagerPlay</h1>
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ñ‚ÐµÐ¼Ñƒ">
                <span id="themeIcon">â˜€ï¸</span>
            </button>
        </div>
        <p class="subtitle">Rock Paper Scissors - Ð˜Ð³Ñ€Ð°Ð¹ Ð¸ Ð²Ñ‹Ð¸Ð³Ñ€Ñ‹Ð²Ð°Ð¹!</p>

        <!-- Balance -->
        <div class="balance-card">
            <div class="balance-label">ðŸ’° Ð’ÐÐ¨ Ð‘ÐÐ›ÐÐÐ¡</div>
            <div class="balance-amount" id="balanceDisplay">0 VP</div>
            <div class="balance-frozen" id="frozenDisplay"></div>
        </div>

        <!-- Controls -->
        <div class="controls" id="authControls">
            <!-- Not logged in -->
            <div class="auth-buttons" id="authButtons">
                <button class="btn btn-success" onclick="showLoginModal()">ðŸ”‘ <span id="btnLoginText">Ð’Ð¾Ð¹Ñ‚Ð¸</span></button>
                <button class="btn btn-primary" onclick="showRegisterModal()">ðŸ“ <span id="btnRegisterText">Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ</span></button>
                <button class="btn btn-secondary" id="btnGuest" onclick="doGuest()">ðŸ‘¤ <span id="btnGuestText">Ð“Ð¾ÑÑ‚ÑŒ</span></button>
            </div>
            
            <!-- Logged in -->
            <div class="user-info" id="userInfo" style="display: none;">
                <span class="user-email" id="userEmail"></span>
                <img id="userAvatar" class="user-avatar-mini" src="" alt="avatar" onclick="showProfileModal()" style="cursor: pointer; width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; display: none;">
                <button class="btn btn-secondary" id="btnProfile" onclick="showProfileModal()">ðŸ‘¤ ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ</button>
                <button class="btn btn-secondary" id="btnLogout" onclick="logout()">ðŸšª Ð’Ñ‹Ð¹Ñ‚Ð¸</button>
            </div>
            
            <button class="btn btn-primary" id="btnConnect" onclick="doConnect()" disabled>ðŸ”— ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ</button>
            
            <!-- Game Controls Row -->
            <div class="game-controls-row" id="gameControlsRow">
                <!-- Play Button with Player Count -->
            <div class="dropdown-play" id="dropdownPlay">
                <button class="btn btn-primary btn-play-main" id="btnQuickplay" onclick="doQuickplay()" disabled>
                    ðŸŽ® <span id="playBtnText">Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ 2 | 100 VP</span> <span class="player-count-badge" id="playerBadge">2</span>
                </button>
                <button class="btn btn-primary btn-play-arrow" id="btnPlayArrow" onclick="togglePlayerDropdown()" disabled>
                    â–¼
                </button>
                <div class="dropdown-menu" id="playerDropdown">
                    <div class="dropdown-item" onclick="selectPlayersDropdown(2)">
                        <span class="dropdown-players">2</span>
                        <span class="dropdown-label">Ð¸Ð³Ñ€Ð¾ÐºÐ°</span>
                    </div>
                    <div class="dropdown-item" onclick="selectPlayersDropdown(3)">
                        <span class="dropdown-players">3</span>
                        <span class="dropdown-label">Ð¸Ð³Ñ€Ð¾ÐºÐ°</span>
                    </div>
                    <div class="dropdown-item" onclick="selectPlayersDropdown(4)">
                        <span class="dropdown-players">4</span>
                        <span class="dropdown-label">Ð¸Ð³Ñ€Ð¾ÐºÐ°</span>
                    </div>
                    <div class="dropdown-item" onclick="selectPlayersDropdown(5)">
                        <span class="dropdown-players">5</span>
                        <span class="dropdown-label">Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²</span>
                    </div>
                </div>
            </div>
            
            <!-- Stake Selection Dropdown -->
            <div class="dropdown-play" id="dropdownStake" style="margin-left: 8px;">
                <button class="btn btn-primary btn-stake-main" id="btnStake" onclick="toggleStakeDropdown()" disabled>
                    ðŸ’° <span id="stakeBtnText">100</span> VP
                </button>
                <button class="btn btn-primary btn-stake-arrow" id="btnStakeArrow" onclick="toggleStakeDropdown()" disabled>
                    â–¼
                </button>
                <div class="dropdown-menu" id="stakeDropdown">
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(100)">
                        <span class="dropdown-players">100</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(200)">
                        <span class="dropdown-players">200</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(500)">
                        <span class="dropdown-players">500</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(1000)">
                        <span class="dropdown-players">1K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(2500)">
                        <span class="dropdown-players">2.5K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(5000)">
                        <span class="dropdown-players">5K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(10000)">
                        <span class="dropdown-players">10K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" id="btnGoToProfile" onclick="goToProfileScreen()" disabled>ðŸ‘¤ Ð’ ÐŸÐ ÐžÐ¤Ð˜Ð›Ð¬</button>
            </div>
        </div>

        <!-- Game Area -->
        <div class="game-area">
            <div id="gameContent">
                <div class="waiting" id="waitingText">Press "Guest Login" to start</div>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <span>ðŸ’¬ Ð§ÐÐ¢</span>
                <div class="chat-tabs" id="chatTabsContainer">
                    <button class="chat-tab active" onclick="switchChatTab('global')" id="tab-global">ÐžÐ±Ñ‰Ð¸Ð¹</button>
                    <!-- Game tabs will be added here dynamically -->
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..." onkeypress="handleChatKeypress(event)">
                <button class="chat-send" onclick="sendChatMessage()">âž¤</button>
            </div>
        </div>

        <!-- Log -->
        <div class="log-container" id="log">
            <div class="log-entry"><span class="log-time">[System]</span> Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² WagerPlay!</div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // API Config
        const API_URL = window.location.origin; // ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ URL Ð´Ð»Ñ ngrok Ð¸ localhost
        
        // Game State
        let token = "";
        let userId = "";
        let matchId = "";
        let socket = null;
        let soundEnabled = true;
        let hasUserInteracted = false;  // ðŸŽµ Ð”Ð»Ñ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸ AudioContext Ð´Ð¾ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐºÐ°
        let currentMatch = null;
        const activeMatches = new Set();  // ðŸ›¡ï¸ ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°ÐµÐ¼ Ð’Ð¡Ð• Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¼Ð°Ñ‚Ñ‡Ð¸
        let countdownInterval = null;
        let matchCountdownInterval = null;  // ðŸŽ® ÐžÑ‚ÑÑ‡Ñ‘Ñ‚ Ð¿ÐµÑ€ÐµÐ´ Ð¼Ð°Ñ‚Ñ‡ÐµÐ¼
        let playerNames = {};  // ðŸ‘¤ Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ ID -> displayName
        let shownRounds = new Set();  // ðŸ›¡ï¸ Ð”ÐµÐ´ÑƒÐ¿Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Ñ€Ð°ÑƒÐ½Ð´Ð¾Ð² Ð² Ñ‡Ð°Ñ‚Ðµ
        let shownMoveWarningForRound = null;  // ðŸ›¡ï¸ Debounce Ð´Ð»Ñ "ÑƒÐ¶Ðµ ÑÐ´ÐµÐ»Ð°Ð»Ð¸ Ñ…Ð¾Ð´"
        let isProcessing = {
            guest: false,
            connect: false,
            quickplay: false,
            move: false
        };
        let currentLang = 'ru';

        // ðŸŽ¨ Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            
            // Play sound for feedback
            if (soundEnabled && hasUserInteracted) {
                sounds.click();
            }
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            }
        }

        // ðŸŽ‰ Confetti Animation
        const confettiCanvas = document.getElementById('confettiCanvas');
        const confettiCtx = confettiCanvas ? confettiCanvas.getContext('2d') : null;
        let confettiParticles = [];
        let confettiAnimationId = null;

        function resizeConfettiCanvas() {
            if (confettiCanvas) {
                confettiCanvas.width = window.innerWidth;
                confettiCanvas.height = window.innerHeight;
            }
        }

        window.addEventListener('resize', resizeConfettiCanvas);
        resizeConfettiCanvas();

        function createConfettiParticle() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#00b894'];
            return {
                x: Math.random() * confettiCanvas.width,
                y: -20,
                color: colors[Math.floor(Math.random() * colors.length)],
                size: Math.random() * 10 + 5,
                speedY: Math.random() * 3 + 2,
                speedX: Math.random() * 4 - 2,
                rotation: Math.random() * 360,
                rotationSpeed: Math.random() * 10 - 5
            };
        }

        function updateConfetti() {
            if (!confettiCtx) return;
            
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            
            confettiParticles.forEach((p, index) => {
                p.y += p.speedY;
                p.x += p.speedX;
                p.rotation += p.rotationSpeed;
                
                confettiCtx.save();
                confettiCtx.translate(p.x, p.y);
                confettiCtx.rotate((p.rotation * Math.PI) / 180);
                confettiCtx.fillStyle = p.color;
                confettiCtx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                confettiCtx.restore();
                
                if (p.y > confettiCanvas.height) {
                    confettiParticles.splice(index, 1);
                }
            });
            
            if (confettiParticles.length > 0) {
                confettiAnimationId = requestAnimationFrame(updateConfetti);
            }
        }

        function startConfetti() {
            if (!confettiCanvas || !confettiCtx) return;
            
            // Create 100 particles
            for (let i = 0; i < 100; i++) {
                confettiParticles.push(createConfettiParticle());
            }
            
            if (!confettiAnimationId) {
                updateConfetti();
            }
            
            // Stop after 5 seconds
            setTimeout(() => {
                confettiParticles = [];
                if (confettiAnimationId) {
                    cancelAnimationFrame(confettiAnimationId);
                    confettiAnimationId = null;
                }
                if (confettiCtx) {
                    confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
                }
            }, 5000);
        }

        // ðŸž Toast Notification System
        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || 'â„¹ï¸'}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
            `;
            
            container.appendChild(toast);
            
            // Play sound for important notifications
            if (soundEnabled && hasUserInteracted && (type === 'success' || type === 'error')) {
                sounds.click();
            }
            
            // Auto remove
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Translations
        const i18n = {
            ru: {
                title: 'WagerPlay - Rock Paper Scissors',
                subtitle: 'Ð˜Ð³Ñ€Ð°Ð¹ Ð¸ Ð²Ñ‹Ð¸Ð³Ñ€Ñ‹Ð²Ð°Ð¹!',
                balance: 'Ð’ÐÐ¨ Ð‘ÐÐ›ÐÐÐ¡',
                frozen: 'Ð—Ð°Ð¼Ð¾Ñ€Ð¾Ð¶ÐµÐ½Ð¾',
                guest: 'ðŸ‘¤ Guest Login',
                connect: 'ðŸ”— ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ',
                quickplay: 'ðŸŽ® Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ 4/100',
                balanceBtn: 'ðŸ’³ Ð‘Ð°Ð»Ð°Ð½Ñ',
            statsBtn: 'ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°',
                goToProfileBtn: 'ðŸ‘¤ Ð’ ÐŸÐ ÐžÐ¤Ð˜Ð›Ð¬',
                waitingGuest: 'ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "Guest Login" Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ',
                waitingQueue: 'Ð’ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸...',
                searching: 'Ð˜Ñ‰ÐµÐ¼ ÑÐ¾Ð¿ÐµÑ€Ð½Ð¸ÐºÐ¾Ð²...',
                yourTurn: 'ðŸŽ® Ð’ÐÐ¨ Ð¥ÐžÐ”!',
                waitingTurn: 'â³ ÐžÐ–Ð˜Ð”ÐÐÐ˜Ð•',
                victory: 'ðŸ† ÐŸÐžÐ‘Ð•Ð”Ð!',
                defeat: 'ðŸ’€ ÐŸÐžÐ ÐÐ–Ð•ÐÐ˜Ð•',
                round: 'Ð Ð°ÑƒÐ½Ð´',
                pot: 'Ð‘Ð°Ð½Ðº',
                stake: 'Ð¡Ñ‚Ð°Ð²ÐºÐ°',
                payout: 'Ð’Ñ‹Ð¿Ð»Ð°Ñ‚Ð°',
                winner: 'ÐŸÐ¾Ð±ÐµÐ´Ð¸Ñ‚ÐµÐ»ÑŒ',
                eliminated: 'Ð’Ñ‹Ð±Ñ‹Ð»',
                inGame: 'Ð’ Ð¸Ð³Ñ€Ðµ',
                rock: 'ÐšÐ°Ð¼ÐµÐ½ÑŒ',
                paper: 'Ð‘ÑƒÐ¼Ð°Ð³Ð°',
                scissors: 'ÐÐ¾Ð¶Ð½Ð¸Ñ†Ñ‹',
                victory: 'ÐŸÐ¾Ð±ÐµÐ´Ð°!',
                youWon: 'Ð’Ñ‹ Ð¿Ð¾Ð±ÐµÐ´Ð¸Ð»Ð¸!',
                gameOver: 'Ð˜Ð³Ñ€Ð° Ð¾ÐºÐ¾Ð½Ñ‡ÐµÐ½Ð°',
                betterLuck: 'Ð’ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ñ€Ð°Ð· Ð¿Ð¾Ð²ÐµÐ·ÐµÑ‚!',
                matchFound: 'ÐœÐ°Ñ‚Ñ‡ Ð½Ð°Ð¹Ð´ÐµÐ½!',
                gameStarting: 'Ð˜Ð³Ñ€Ð° Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ...',
                playAgain: 'ðŸ”„ Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ ÑÐ½Ð¾Ð²Ð°',
                tie: 'ðŸ¤ ÐÐ¸Ñ‡ÑŒÑ',
                elimination: 'âš”ï¸ Ð’Ñ‹Ð±Ñ‹Ð²Ð°Ð½Ð¸Ðµ',
                wonWith: 'ÐŸÐ¾Ð±ÐµÐ´Ð¸Ð»',
                chat: 'ðŸ’¬ Ð§ÐÐ¢',
                global: 'ÐžÐ±Ñ‰Ð¸Ð¹',
                game: 'Ð˜Ð³Ñ€Ð°',
                chatPlaceholder: 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ...',
                players2: '2 Ð¸Ð³Ñ€Ð¾ÐºÐ°',
                players3: '3 Ð¸Ð³Ñ€Ð¾ÐºÐ°',
                players4: '4 Ð¸Ð³Ñ€Ð¾ÐºÐ°',
                selectPlayers: 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ€ÐµÐ¶Ð¸Ð¼:',
                you: 'Ð’Ñ‹',
                alreadyInQueue: 'Ð’Ñ‹ ÑƒÐ¶Ðµ Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸!',
                chatWillClose: 'Ð§Ð°Ñ‚ Ð·Ð°ÐºÑ€Ð¾ÐµÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· 2 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹',
                gameStarted: 'Ð˜Ð³Ñ€Ð° Ð½Ð°Ñ‡Ð°Ð»Ð°ÑÑŒ! Ð£Ð´Ð°Ñ‡Ð¸!',
                login: 'Ð’Ð¾Ð¹Ñ‚Ð¸',
                loginTitle: 'ðŸ”‘ Ð’Ñ…Ð¾Ð´',
                register: 'Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ',
                logout: 'Ð’Ñ‹Ð¹Ñ‚Ð¸',
                guest: 'Ð“Ð¾ÑÑ‚ÑŒ',
                statsBtn: 'ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°',
                leaderboardBtn: 'ðŸ† Ð¢Ð¾Ð¿',
                goToProfileBtn: 'ðŸ‘¤ Ð’ ÐŸÐ ÐžÐ¤Ð˜Ð›Ð¬',
                logsBtn: 'ðŸ“‹ Ð›Ð¾Ð³Ð¸',
                auditBtn: 'ðŸ“œ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°',
                reconcileBtn: 'âš–ï¸ Ð¡Ð²ÐµÑ€ÐºÐ°',
                profileBtn: 'ðŸ‘¤ ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ',
                logoutBtn: 'ðŸšª Ð’Ñ‹Ð¹Ñ‚Ð¸',
                // Login modal
                emailLabel: 'Email',
                passwordLabel: 'ÐŸÐ°Ñ€Ð¾Ð»ÑŒ',
                forgotPassword: 'Ð—Ð°Ð±Ñ‹Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ?',
                // Profile modal
                displayNameLabel: 'ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÐ¼Ð¾Ðµ Ð¸Ð¼Ñ',
                genderLabel: 'ÐŸÐ¾Ð»',
                genderNotSpecified: 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½',
                genderMale: 'ÐœÑƒÐ¶ÑÐºÐ¾Ð¹',
                genderFemale: 'Ð–ÐµÐ½ÑÐºÐ¸Ð¹',
                selectAvatar: 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð°Ð²Ð°Ñ‚Ð°Ñ€ÐºÑƒ',
                avatarMale: 'ÐœÑƒÐ¶ÑÐºÐ¸Ðµ',
                avatarFemale: 'Ð–ÐµÐ½ÑÐºÐ¸Ðµ',
                avatarCustom: 'Ð¡Ð²Ð¾Ñ',
                saveBtn: 'ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ',
                profileModalTitle: 'ðŸ‘¤ ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ',
                profileGuestText: 'Ð’Ñ‹ Ð²Ð¾ÑˆÐ»Ð¸ ÐºÐ°Ðº Ð³Ð¾ÑÑ‚ÑŒ. ÐŸÑ€Ð¸Ð²ÑÐ¶Ð¸Ñ‚Ðµ email Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ°:',
                linkPasswordLabel: 'ÐŸÐ°Ñ€Ð¾Ð»ÑŒ (Ð¼Ð¸Ð½. 6 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²)',
                linkEmailBtn: 'ðŸ”— ÐŸÑ€Ð¸Ð²ÑÐ·Ð°Ñ‚ÑŒ email'
            },
            en: {
                title: 'WagerPlay - Rock Paper Scissors',
                subtitle: 'Play and Win!',
                balance: 'YOUR BALANCE',
                frozen: 'Frozen',
                guest: 'ðŸ‘¤ Guest Login',
                connect: 'ðŸ”— Connect',
                quickplay: 'ðŸŽ® Quickplay 4/100',
                balanceBtn: 'ðŸ’³ Balance',
                waitingGuest: 'Press "Guest Login" to start',
                waitingQueue: 'In queue...',
                searching: 'Searching for players...',
                yourTurn: 'ðŸŽ® YOUR TURN!',
                waitingTurn: 'â³ WAITING',
                victory: 'ðŸ† VICTORY!',
                defeat: 'ðŸ’€ DEFEAT',
                round: 'Round',
                pot: 'Pot',
                stake: 'Stake',
                payout: 'Payout',
                winner: 'Winner',
                eliminated: 'Eliminated',
                inGame: 'In game',
                rock: 'Rock',
                paper: 'Paper',
                scissors: 'Scissors',
                victory: 'Victory!',
                youWon: 'You won!',
                gameOver: 'Game Over',
                betterLuck: 'Better luck next time!',
                matchFound: 'Match Found!',
                gameStarting: 'Game is starting...',
                playAgain: 'ðŸ”„ Play Again',
                tie: 'ðŸ¤ Tie',
                elimination: 'âš”ï¸ Elimination',
                wonWith: 'Won with',
                chat: 'ðŸ’¬ CHAT',
                global: 'Global',
                game: 'Game',
                chatPlaceholder: 'Type message...',
                players2: '2 Players',
                players3: '3 Players',
                players4: '4 Players',
                selectPlayers: 'Select mode:',
                you: 'You',
                alreadyInQueue: 'Already in queue!',
                chatWillClose: 'Chat will close in 2 minutes',
                gameStarted: 'Game started! Good luck!',
                login: 'Login',
                loginTitle: 'ðŸ”‘ Login',
                register: 'Register',
                logout: 'Logout',
                guest: 'Guest',
                statsBtn: 'ðŸ“Š Stats',
                leaderboardBtn: 'ðŸ† Top',
                goToProfileBtn: 'ðŸ‘¤ TO PROFILE',
                logsBtn: 'ðŸ“‹ Logs',
                auditBtn: 'ðŸ“œ Audit',
                reconcileBtn: 'âš–ï¸ Reconcile',
                profileBtn: 'ðŸ‘¤ Profile',
                logoutBtn: 'ðŸšª Logout',
                // Login modal
                emailLabel: 'Email',
                passwordLabel: 'Password',
                forgotPassword: 'Forgot password?',
                // Profile modal
                displayNameLabel: 'Display Name',
                genderLabel: 'Gender',
                genderNotSpecified: 'Not specified',
                genderMale: 'Male',
                genderFemale: 'Female',
                selectAvatar: 'Select Avatar',
                avatarMale: 'Male',
                avatarFemale: 'Female',
                avatarCustom: 'Custom',
                saveBtn: 'ðŸ’¾ Save',
                profileModalTitle: 'ðŸ‘¤ Profile',
                profileGuestText: 'You are logged in as a guest. Link your email to save progress:',
                linkPasswordLabel: 'Password (min. 6 characters)',
                linkEmailBtn: 'ðŸ”— Link Email'
            },
            cn: {
                title: 'WagerPlay - çŸ³å¤´å‰ªåˆ€å¸ƒ',
                subtitle: 'çŽ©æ¸¸æˆï¼Œèµ¢å¤§å¥–ï¼',
                balance: 'æ‚¨çš„ä½™é¢',
                frozen: 'å†»ç»“',
                guest: 'ðŸ‘¤ æ¸¸å®¢ç™»å½•',
                connect: 'ðŸ”— è¿žæŽ¥',
                quickplay: 'ðŸŽ® å¿«é€Ÿæ¸¸æˆ 4/100',
                balanceBtn: 'ðŸ’³ ä½™é¢',
                waitingGuest: 'ç‚¹å‡»"æ¸¸å®¢ç™»å½•"å¼€å§‹',
                waitingQueue: 'æŽ’é˜Ÿä¸­...',
                searching: 'å¯»æ‰¾çŽ©å®¶...',
                yourTurn: 'ðŸŽ® è½®åˆ°æ‚¨ï¼',
                waitingTurn: 'â³ ç­‰å¾…ä¸­',
                victory: 'ðŸ† èƒœåˆ©ï¼',
                defeat: 'ðŸ’€ å¤±è´¥',
                round: 'å›žåˆ',
                pot: 'å¥–æ± ',
                stake: 'èµŒæ³¨',
                payout: 'å¥–é‡‘',
                winner: 'èµ¢å®¶',
                eliminated: 'å·²æ·˜æ±°',
                inGame: 'æ¸¸æˆä¸­',
                rock: 'çŸ³å¤´',
                paper: 'å¸ƒ',
                scissors: 'å‰ªåˆ€',
                victory: 'èƒœåˆ©!',
                youWon: 'ä½ èµ¢äº†!',
                gameOver: 'æ¸¸æˆç»“æŸ',
                betterLuck: 'ä¸‹æ¬¡å¥½è¿!',
                matchFound: 'æ‰¾åˆ°æ¯”èµ›!',
                gameStarting: 'æ¸¸æˆå¼€å§‹...',
                playAgain: 'ðŸ”„ å†çŽ©ä¸€æ¬¡',
                tie: 'ðŸ¤ å¹³å±€',
                elimination: 'âš”ï¸ æ·˜æ±°',
                wonWith: 'èŽ·èƒœ',
                chat: 'ðŸ’¬ èŠå¤©',
                global: 'å…¨å±€',
                game: 'æ¸¸æˆ',
                chatPlaceholder: 'è¾“å…¥æ¶ˆæ¯...',
                players2: '2äºº',
                players3: '3äºº',
                players4: '4äºº',
                selectPlayers: 'é€‰æ‹©æ¨¡å¼ï¼š',
                you: 'æ‚¨',
                alreadyInQueue: 'å·²ç»åœ¨é˜Ÿåˆ—ä¸­ï¼',
                chatWillClose: 'èŠå¤©å°†åœ¨2åˆ†é’ŸåŽå…³é—­',
                gameStarted: 'æ¸¸æˆå¼€å§‹ï¼ç¥ä½ å¥½è¿ï¼',
                login: 'ç™»å½•',
                loginTitle: 'ðŸ”‘ ç™»å½•',
                register: 'æ³¨å†Œ',
                logout: 'é€€å‡º',
                guest: 'æ¸¸å®¢',
                statsBtn: 'ðŸ“Š ç»Ÿè®¡',
                leaderboardBtn: 'ðŸ† æ¦œå•',
                goToProfileBtn: 'ðŸ‘¤ ä¸ªäººèµ„æ–™',
                logsBtn: 'ðŸ“‹ æ—¥å¿—',
                auditBtn: 'ðŸ“œ å®¡è®¡',
                reconcileBtn: 'âš–ï¸ å¯¹è´¦',
                profileBtn: 'ðŸ‘¤ èµ„æ–™',
                logoutBtn: 'ðŸšª é€€å‡º',
                // Login modal
                emailLabel: 'é‚®ç®±',
                passwordLabel: 'å¯†ç ',
                forgotPassword: 'å¿˜è®°å¯†ç ï¼Ÿ',
                // Profile modal
                displayNameLabel: 'æ˜¾ç¤ºåç§°',
                genderLabel: 'æ€§åˆ«',
                genderNotSpecified: 'æœªæŒ‡å®š',
                genderMale: 'ç”·',
                genderFemale: 'å¥³',
                selectAvatar: 'é€‰æ‹©å¤´åƒ',
                avatarMale: 'ç”·æ€§',
                avatarFemale: 'å¥³æ€§',
                avatarCustom: 'è‡ªå®šä¹‰',
                saveBtn: 'ðŸ’¾ ä¿å­˜',
                profileModalTitle: 'ðŸ‘¤ èµ„æ–™',
                profileGuestText: 'æ‚¨ä»¥è®¿å®¢èº«ä»½ç™»å½•ã€‚è¯·ç»‘å®šé‚®ç®±ä»¥ä¿å­˜è¿›åº¦ï¼š',
                linkPasswordLabel: 'å¯†ç ï¼ˆæœ€å°‘6ä¸ªå­—ç¬¦ï¼‰',
                linkEmailBtn: 'ðŸ”— ç»‘å®šé‚®ç®±'
            }
        };

        function t(key) {
            return i18n[currentLang][key] || key;
        }

        function setLang(lang) {
            currentLang = lang;
            const btnGuest = document.getElementById('btnGuest');
            const btnConnect = document.getElementById('btnConnect');
            const playBtnText = document.getElementById('playBtnText');
            const btnBalance = document.getElementById('btnBalance');
            const subtitle = document.querySelector('.subtitle');
            const balanceLabel = document.querySelector('.balance-label');
            
            const btnLoginText = document.getElementById('btnLoginText');
            const btnRegisterText = document.getElementById('btnRegisterText');
            const btnGuestText = document.getElementById('btnGuestText');
            
            // Auth buttons
            if (btnLoginText) btnLoginText.textContent = t('login');
            const loginTitle = document.getElementById('loginTitle');
            if (loginTitle) loginTitle.textContent = t('loginTitle');
            if (btnRegisterText) btnRegisterText.textContent = t('register');
            if (btnGuestText) btnGuestText.textContent = t('guest');
            if (btnConnect) btnConnect.textContent = t('connect');
            if (playBtnText) playBtnText.textContent = t('quickplay');
            if (btnBalance) btnBalance.textContent = t('balanceBtn');
            
            // Stats, Logs, Audit, Reconcile buttons
            const btnStats = document.getElementById('btnStats');
            if (btnStats) btnStats.textContent = t('statsBtn');
            const btnGoToProfile = document.getElementById('btnGoToProfile');
            if (btnGoToProfile) btnGoToProfile.textContent = t('goToProfileBtn');
            const btnLogs = document.getElementById('btnLogs');
            if (btnLogs) btnLogs.textContent = t('logsBtn');
            const btnAudit = document.getElementById('btnAudit');
            if (btnAudit) btnAudit.textContent = t('auditBtn');
            const btnReconcile = document.getElementById('btnReconcile');
            if (btnReconcile) btnReconcile.textContent = t('reconcileBtn');
            
            // Profile and Logout buttons
            const btnProfile = document.getElementById('btnProfile');
            if (btnProfile) btnProfile.textContent = t('profileBtn');
            const btnLogout = document.getElementById('btnLogout');
            if (btnLogout) btnLogout.textContent = t('logoutBtn');
            
            // Login modal labels
            const loginEmailLabel = document.getElementById('loginEmailLabel');
            if (loginEmailLabel) loginEmailLabel.textContent = t('emailLabel');
            const loginPasswordLabel = document.getElementById('loginPasswordLabel');
            if (loginPasswordLabel) loginPasswordLabel.textContent = t('passwordLabel');
            const loginSubmitBtn = document.getElementById('loginSubmitBtn');
            if (loginSubmitBtn) loginSubmitBtn.textContent = t('login');
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            if (forgotPasswordLink) forgotPasswordLink.textContent = t('forgotPassword');
            
            // Profile modal labels
            const profileDisplayNameLabel = document.getElementById('profileDisplayNameLabel');
            if (profileDisplayNameLabel) profileDisplayNameLabel.textContent = t('displayNameLabel');
            const profileGenderLabel = document.getElementById('profileGenderLabel');
            if (profileGenderLabel) profileGenderLabel.textContent = t('genderLabel');
            const profileAvatarLabel = document.getElementById('profileAvatarLabel');
            if (profileAvatarLabel) profileAvatarLabel.textContent = t('selectAvatar');
            const avatarTabMale = document.getElementById('avatarTabMale');
            if (avatarTabMale) avatarTabMale.textContent = t('avatarMale');
            const avatarTabFemale = document.getElementById('avatarTabFemale');
            if (avatarTabFemale) avatarTabFemale.textContent = t('avatarFemale');
            const avatarTabCustom = document.getElementById('avatarTabCustom');
            if (avatarTabCustom) avatarTabCustom.textContent = t('avatarCustom');
            const profileSaveBtn = document.getElementById('profileSaveBtn');
            if (profileSaveBtn) profileSaveBtn.textContent = t('saveBtn');
            
            // Gender options
            const genderNotSpecified = document.getElementById('genderNotSpecified');
            if (genderNotSpecified) genderNotSpecified.textContent = t('genderNotSpecified');
            const genderMale = document.getElementById('genderMale');
            if (genderMale) genderMale.textContent = t('genderMale');
            const genderFemale = document.getElementById('genderFemale');
            if (genderFemale) genderFemale.textContent = t('genderFemale');
            
            // Profile modal title and guest text
            const profileModalTitle = document.getElementById('profileModalTitle');
            if (profileModalTitle) profileModalTitle.textContent = t('profileModalTitle');
            const profileGuestText = document.getElementById('profileGuestText');
            if (profileGuestText) profileGuestText.textContent = t('profileGuestText');
            const linkPasswordLabel = document.getElementById('linkPasswordLabel');
            if (linkPasswordLabel) linkPasswordLabel.textContent = t('linkPasswordLabel');
            const linkPassword = document.getElementById('linkPassword');
            if (linkPassword) linkPassword.setAttribute('placeholder', t('linkPasswordLabel'));
            const linkEmailBtn = document.getElementById('linkEmailBtn');
            if (linkEmailBtn) linkEmailBtn.textContent = t('linkEmailBtn');
            
            if (subtitle) subtitle.textContent = t('subtitle');
            if (balanceLabel) balanceLabel.textContent = 'ðŸ’° ' + t('balance');
            
            // Update language dropdown
            const langDropdownBtn = document.getElementById('langDropdownBtn');
            if (langDropdownBtn) {
                const langNames = { ru: 'RU', en: 'EN', cn: 'CN' };
                langDropdownBtn.textContent = langNames[lang] + ' â–¼';
            }
            document.querySelectorAll('.lang-dropdown-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.lang === lang);
            });
            
            // Update burger menu texts
            const burgerBalanceText = document.getElementById('burgerBalanceText');
            const burgerStatsText = document.getElementById('burgerStatsText');
            const burgerLogsText = document.getElementById('burgerLogsText');
            if (burgerBalanceText) burgerBalanceText.textContent = t('balanceBtn').replace('ðŸ’³ ', '');
            if (burgerStatsText) burgerStatsText.textContent = t('statsBtn').replace('ðŸ“Š ', '');
            const burgerLeaderboardText = document.getElementById('burgerLeaderboardText');
            if (burgerLeaderboardText) burgerLeaderboardText.textContent = t('leaderboardBtn').replace('ðŸ† ', '');
            if (burgerLogsText) burgerLogsText.textContent = t('logsBtn').replace('ðŸ“‹ ', '');
            
            // Refresh match display if exists
            if (currentMatch) renderMatch(currentMatch);
            
            // Save preference
            localStorage.setItem('preferredLang', lang);
        }

        // Language Dropdown Functions
        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('langDropdownMenu');
            dropdown.classList.toggle('show');
        }

        function closeLanguageDropdown() {
            const dropdown = document.getElementById('langDropdownMenu');
            dropdown.classList.remove('show');
        }

        // Burger Menu Functions
        function toggleMenu() {
            const menu = document.getElementById('burgerMenu');
            menu.classList.toggle('show');
        }

        function closeMenu() {
            const menu = document.getElementById('burgerMenu');
            menu.classList.remove('show');
        }

        // Player Selection
        let selectedPlayers = 2;
        let selectedStake = 100; // Ð”ÐµÑ„Ð¾Ð»Ñ‚Ð½Ð°Ñ ÑÑ‚Ð°Ð²ÐºÐ°
        let currentChatTab = 'global';
        let currentGameChatId = null; // ID Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð° Ð¸Ð³Ñ€Ñ‹
        let gameChatTimeouts = {}; // Ð¢Ð°Ð¹Ð¼ÐµÑ€Ñ‹ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð¸Ð³Ñ€Ñ‹ { matchId: timeout }

        function selectPlayers(count) {
            if (isProcessing.quickplay) {
                sounds.error();
                return;
            }
            selectedPlayers = count;
            // Update badge on main button
            document.getElementById('playerBadge').textContent = count;
            // Update dropdown selection
            updateDropdownSelection(count);
            sounds.click();
            log(`${t('selectPlayers')} ${count}`);
        }

        function togglePlayerDropdown() {
            const dropdown = document.getElementById('playerDropdown');
            const arrow = document.getElementById('btnPlayArrow');
            dropdown.classList.toggle('show');
            arrow.classList.toggle('active');
            // Close stake dropdown if open
            document.getElementById('stakeDropdown').classList.remove('show');
            document.getElementById('btnStakeArrow').classList.remove('active');
            sounds.click();
        }
        
        function toggleStakeDropdown() {
            const dropdown = document.getElementById('stakeDropdown');
            const arrow = document.getElementById('btnStakeArrow');
            dropdown.classList.toggle('show');
            arrow.classList.toggle('active');
            // Close player dropdown if open
            document.getElementById('playerDropdown').classList.remove('show');
            document.getElementById('btnPlayArrow').classList.remove('active');
            sounds.click();
        }
        
        function selectStakeDropdown(stake) {
            selectedStake = stake;
            localStorage.setItem('selectedStake', stake); // ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸
            const stakeText = stake >= 1000 ? (stake/1000) + 'K' : stake;
            document.getElementById('stakeBtnText').textContent = stakeText;
            
            // Update selection visual
            document.querySelectorAll('.stake-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Close dropdown
            document.getElementById('stakeDropdown').classList.remove('show');
            document.getElementById('btnStakeArrow').classList.remove('active');
            
            sounds.click();
            log(`ðŸ’° Ð¡Ñ‚Ð°Ð²ÐºÐ°: ${stake} VP`);
        }

        function selectPlayersDropdown(count) {
            selectedPlayers = count;
            localStorage.setItem('selectedPlayers', count); // ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸
            document.getElementById('playerBadge').textContent = count;
            updateDropdownSelection(count);
            
            // Update button text with selected player count and stake
            const btnText = document.getElementById('playBtnText');
            const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
            if (btnText) {
                btnText.textContent = `Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ ${count} | ${stakeText} VP`;
            }
            
            // Close dropdown
            document.getElementById('playerDropdown').classList.remove('show');
            document.getElementById('btnPlayArrow').classList.remove('active');
            
            sounds.click();
            log(`${t('selectPlayers')} ${count}`);
        }

        function updateDropdownSelection(count) {
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('selected');
            });
            // Select the item (based on index 0=2, 1=3, 2=4, 3=5)
            const items = document.querySelectorAll('.dropdown-item');
            if (items[count - 2]) {
                items[count - 2].classList.add('selected');
            }
        }

        // Chat Functions - Each game has its own chat
        function switchChatTab(tab, gameId = null) {
            currentChatTab = tab;
            if (gameId) currentGameChatId = gameId;
            
            // Update UI tabs - remove active from all
            document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
            
            // Activate correct tab
            if (tab === 'global') {
                document.getElementById('tab-global').classList.add('active');
            } else if (tab === 'game' && currentGameChatId) {
                const tabId = `tab-game-${currentGameChatId}`;
                const gameTab = document.getElementById(tabId);
                if (gameTab) gameTab.classList.add('active');
            }
            
            // Update chat title
            const chatTitle = document.querySelector('.chat-header span');
            if (tab === 'global') {
                chatTitle.textContent = 'ðŸ’¬ ' + t('chat') + ' - ' + t('global');
            } else if (tab === 'game' && currentGameChatId) {
                const shortId = currentGameChatId.slice(0, 8);
                chatTitle.textContent = `ðŸ’¬ Game #${shortId}`;
            }
            
            renderChatMessages();
            sounds.click();
        }

        function showChat() {
            const chat = document.getElementById('chatContainer');
            chat.classList.add('active');
            chat.style.display = 'block';
        }

        function hideChat() {
            const chat = document.getElementById('chatContainer');
            chat.classList.remove('active');
            chat.style.display = 'none';
        }

        function createGameChat(gameMatchId) {
            console.log('Creating game chat for:', gameMatchId);
            if (!window.chatHistory) window.chatHistory = { global: [], games: {} };
            if (!window.chatHistory.games) window.chatHistory.games = {};
            if (!window.chatHistory.games[gameMatchId]) {
                window.chatHistory.games[gameMatchId] = [];
            }
            currentGameChatId = gameMatchId;
            
            // Create new tab for this game
            const tabsContainer = document.getElementById('chatTabsContainer');
            const tabId = `tab-game-${gameMatchId}`;
            
            // Check if tab already exists
            if (!document.getElementById(tabId)) {
                const newTab = document.createElement('button');
                newTab.className = 'chat-tab';
                newTab.id = tabId;
                newTab.textContent = '#' + gameMatchId.slice(0, 6);
                newTab.onclick = () => switchChatTab('game', gameMatchId);
                tabsContainer.appendChild(newTab);
            }
            
            // Add system message
            addChatMessage('system', 'System', `${t('gameStarted')} #${gameMatchId.slice(0, 8)}`, 'game', gameMatchId);
            
            // Switch to this game chat
            switchChatTab('game', gameMatchId);
            
            console.log('Game chat created. Current games:', Object.keys(window.chatHistory.games));
        }

        function closeGameChat(gameMatchId) {
            if (!gameMatchId) gameMatchId = currentGameChatId;
            if (!gameMatchId) return;
            
            // Mark chat as closed
            if (window.chatHistory.games && window.chatHistory.games[gameMatchId]) {
                window.chatHistory.games[gameMatchId].push({
                    type: 'system',
                    author: 'System',
                    text: t('chatClosed'),
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    closed: true
                });
            }
            
            // Find the specific tab for this game and add lock
            const tabId = `tab-game-${gameMatchId}`;
            const gameTab = document.getElementById(tabId);
            if (gameTab) {
                gameTab.textContent = '#' + gameMatchId.slice(0, 6) + ' ðŸ”’';
                gameTab.style.opacity = '0.5';
            }
            
            // If this is current game, refresh messages
            if (currentGameChatId === gameMatchId) {
                renderChatMessages();
            }
            
            // Schedule tab removal after 2 minutes (total 4 minutes from game end)
            setTimeout(() => {
                const tabToRemove = document.getElementById(tabId);
                if (tabToRemove) {
                    tabToRemove.remove();
                    // Clean up history
                    if (window.chatHistory.games[gameMatchId]) {
                        delete window.chatHistory.games[gameMatchId];
                    }
                }
            }, 120000); // Remove tab after additional 2 minutes
        }

        function handleChatKeypress(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            const author = currentProfile.displayName || (userId ? userId.slice(0,8) : 'Guest');

            if (currentChatTab === 'global') {
                if (socket) socket.emit('chat:global', { text });
                // Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑÑ Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð¾Ñ‚ ÑÐµÑ€Ð²ÐµÑ€Ð° (ÑƒÐ±Ñ€Ð°Ð»Ð¸ Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ)
            } else if (currentChatTab === 'game' && currentGameChatId) {
                if (socket) socket.emit('chat:game', { matchId: currentGameChatId, text });
                // Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑÑ Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð¾Ñ‚ ÑÐµÑ€Ð²ÐµÑ€Ð° (ÑƒÐ±Ñ€Ð°Ð»Ð¸ Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ)
            }

            input.value = '';
            sounds.click();
        }

        function addChatMessage(type, author, text, tab, gameId = null, avatarUrl = null) {
            if (!window.chatHistory) window.chatHistory = { global: [] };
            if (!window.chatHistory.games) window.chatHistory.games = {};
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const message = { type, author, text, time, avatarUrl };
            
            if (tab === 'global') {
                window.chatHistory.global.push(message);
            } else if (tab === 'game' && gameId) {
                if (!window.chatHistory.games[gameId]) window.chatHistory.games[gameId] = [];
                window.chatHistory.games[gameId].push(message);
            }
            
            if (currentChatTab === tab && (tab === 'global' || currentGameChatId === gameId)) {
                renderChatMessages();
            }
        }

        function renderChatMessages() {
            const messagesEl = document.getElementById('chatMessages');
            if (!messagesEl) return;
            messagesEl.innerHTML = '';
            
            let history = [];
            if (currentChatTab === 'global') {
                history = window.chatHistory?.global || [];
            } else if (currentChatTab === 'game' && currentGameChatId) {
                history = window.chatHistory?.games?.[currentGameChatId] || [];
            }
            
            if (history.length === 0) {
                messagesEl.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 20px;">No messages yet</div>';
            }
            
            history.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.className = `chat-message ${msg.type}`;
                if (msg.type === 'system') {
                    messageEl.textContent = msg.text;
                } else {
                    // Determine avatar and display name
                    let avatarSrc = msg.avatarUrl || `${API_URL}/avatars/male1.svg`; // default or from message
                    let displayAuthor = msg.author;
                    
                    // If message is from current user, show their display name and avatar
                    const isCurrentUser = msg.author === userId.slice(0,8) || msg.author === currentProfile.displayName;
                    if (isCurrentUser) {
                        displayAuthor = currentProfile.displayName || msg.author;
                        if (currentProfile.avatarUrl) {
                            avatarSrc = currentProfile.avatarUrl;
                        }
                    }
                    
                    // Make author name clickable if not current user
                    const authorClass = isCurrentUser ? 'chat-author' : 'chat-author chat-author-clickable';
                    const authorClick = isCurrentUser ? '' : `onclick="showPublicProfile('${msg.author}', '${displayAuthor}')"`;
                    
                    messageEl.innerHTML = `
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <img src="${avatarSrc}" style="width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0; cursor: ${isCurrentUser ? 'default' : 'pointer'};" ${authorClick}>
                            <div style="flex: 1;">
                                <div class="${authorClass}" ${authorClick}>${displayAuthor} <span class="chat-time">${msg.time}</span></div>
                                <div>${escapeHtml(msg.text)}</div>
                            </div>
                        </div>
                    `;
                }
                messagesEl.appendChild(messageEl);
            });
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal functions
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('show');
            sounds.click();
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('show');
            sounds.click();
        }

        function hideRegisterModal() {
            document.getElementById('registerModal').classList.remove('show');
        }

        function showForgotModal() {
            document.getElementById('forgotModal').classList.add('show');
            sounds.click();
        }

        function hideForgotModal() {
            document.getElementById('forgotModal').classList.remove('show');
        }

        function closeModal(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.classList.remove('show');
            }
        }

        // Global Enter handler for modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                // Check which modal is open
                const loginModal = document.getElementById('loginModal');
                const registerModal = document.getElementById('registerModal');
                const forgotModal = document.getElementById('forgotModal');
                
                if (loginModal && loginModal.classList.contains('show')) {
                    event.preventDefault();
                    doLogin();
                } else if (registerModal && registerModal.classList.contains('show')) {
                    event.preventDefault();
                    doRegister();
                } else if (forgotModal && forgotModal.classList.contains('show')) {
                    event.preventDefault();
                    doForgotPassword();
                }
            }
        });

        // Password toggle function
        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'ðŸ™ˆ';
            } else {
                input.type = 'password';
                btn.textContent = 'ðŸ‘ï¸';
            }
        }

        // Enter key handler
        function handleEnter(event, action) {
            if (event.key === 'Enter') {
                event.preventDefault();
                switch(action) {
                    case 'login':
                        doLogin();
                        break;
                    case 'register':
                        doRegister();
                        break;
                    case 'linkEmail':
                        linkEmail();
                        break;
                }
            }
        }

        // Auth API functions
        async function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ email Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ');
                return;
            }

            try {
                const r = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await r.json();

                if (r.ok) {
                    token = data.token;
                    userId = data.userId;
                    // ðŸ›¡ï¸ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐµÑÑÐ¸ÑŽ Ð´Ð»Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ»Ðµ F5
                    localStorage.setItem('token', token);
                    localStorage.setItem('userId', userId);
                    localStorage.setItem('isGuest', 'false');
                    currentProfile = {
                        displayName: data.displayName || data.username || email,
                        email: data.email || email,
                        gender: data.gender || '',
                        avatarUrl: data.avatarUrl || '',
                        isGuest: false
                    };
                    
                    // Check admin access
                    checkAdminAccess(data.email || email);
                    updateBalanceDisplay(data.balanceWp);
                    hideLoginModal();
                    showUserInfo(data.email || data.username);
                    log(`âœ… Ð’Ñ…Ð¾Ð´ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½: ${data.email || data.username}`);
                    // ðŸ›¡ï¸ ÐŸÐ¾ÑÐ»Ðµ Ð»Ð¾Ð³Ð¸Ð½Ð° Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ "ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ", Ð½Ðµ "Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ"
                    setButtons({ showAuth: false, showUser: true, showConnect: true, connect: true, quickplay: false, balance: false, logs: false });
                    
                    // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ Ñ Ð°Ð²Ð°Ñ‚Ð°Ñ€ÐºÐ¾Ð¹
                    await loadProfile();
                    updateUserInfoAfterLogin();
                } else {
                    // Ð•ÑÐ»Ð¸ email Ð½Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½ â€” Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÐ¼ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¸ÑÑŒÐ¼Ð¾ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾
                    if (data.message && data.message.includes('Email Ð½Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½')) {
                        if (confirm(data.message + '\n\nÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¸ÑÑŒÐ¼Ð¾ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾?')) {
                            await resendVerification(email);
                        }
                    } else {
                        alert(data.message || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ…Ð¾Ð´Ð°');
                    }
                }
            } catch (e) {
                alert('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ‚Ð¸: ' + e.message);
            }
        }

        // ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ð°Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¿Ð¸ÑÑŒÐ¼Ð° Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ
        async function resendVerification(email) {
            try {
                const r = await fetch(`${API_URL}/auth/resend-verification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await r.json();
                alert(data.message || 'ÐŸÐ¸ÑÑŒÐ¼Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾');
            } catch (e) {
                alert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸: ' + e.message);
            }
        }

        async function doRegister() {
            const email = document.getElementById('registerEmail').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!email || !password) {
                alert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ email Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ');
                return;
            }
            if (password.length < 6) {
                alert('ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 6 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²');
                return;
            }

            try {
                const r = await fetch('/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, username })
                });
                const data = await r.json();

                if (r.ok) {
                    hideRegisterModal();
                    alert('Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð°! ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ email Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ.');
                    log('âœ… Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ: ' + data.message);
                } else {
                    alert(data.message || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸');
                }
            } catch (e) {
                alert('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ‚Ð¸: ' + e.message);
            }
        }

        async function doForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();

            if (!email) {
                alert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ email');
                return;
            }

            try {
                const r = await fetch('/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await r.json();

                hideForgotModal();
                alert(data.message);
                log('ðŸ“§ ' + data.message);
            } catch (e) {
                alert('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ‚Ð¸: ' + e.message);
            }
        }

        function showUserInfo(email) {
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            const userEmail = document.getElementById('userEmail');
            if (authButtons) authButtons.style.display = 'none';
            if (userInfo) userInfo.style.display = 'flex';
            if (userEmail) userEmail.textContent = email;
        }

        function logout() {
            token = '';
            userId = '';
            // ðŸ›¡ï¸ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½ÑƒÑŽ ÑÐµÑÑÐ¸ÑŽ
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.removeItem('isGuest');
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            setButtons({ showAuth: true, showUser: false, showConnect: false, connect: false, quickplay: false, balance: false, logs: false });
            log('ðŸ‘‹ Ð’Ñ‹Ñ…Ð¾Ð´ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½');
            sounds.click();
        }

        // Initialize on load
        window.onload = function() {
            initTheme(); // ðŸŽ¨ Initialize theme
            
            // ðŸŽµ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð°ÑƒÐ´Ð¸Ð¾ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ ÐºÐ»Ð¸ÐºÐµ (Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ðµ Chrome)
            const initAudioOnFirstClick = () => {
                hasUserInteracted = true;
                initAudio().then(() => {
                    console.log('[Audio] Initialized on first user interaction');
                });
            };
            document.addEventListener('click', initAudioOnFirstClick, { once: true });
            
            // Load saved language or default to Russian
            const savedLang = localStorage.getItem('preferredLang') || 'ru';
            setLang(savedLang);
            
            // ðŸ”„ Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ dropdown Ð¿Ñ€Ð¸ ÐºÐ»Ð¸ÐºÐµ Ð²Ð½Ðµ
            document.addEventListener('click', function(e) {
                const langDropdown = document.querySelector('.lang-dropdown-container');
                const burgerMenu = document.querySelector('.burger-menu-container');
                if (langDropdown && !langDropdown.contains(e.target)) {
                    closeLanguageDropdown();
                }
                if (burgerMenu && !burgerMenu.contains(e.target)) {
                    closeMenu();
                }
            });
            
            // ðŸ›¡ï¸ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐµÑÑÐ¸ÑŽ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½
            const savedToken = localStorage.getItem('token');
            const savedUserId = localStorage.getItem('userId');
            // Restore displayName from localStorage for F5 recovery
            const savedDisplayName = localStorage.getItem('displayName');
            if (savedDisplayName) {
                currentProfile.displayName = savedDisplayName;
            }
            if (savedToken && savedUserId) {
                token = savedToken;
                userId = savedUserId;
                log(`ðŸ”„ Ð¡ÐµÑÑÐ¸Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°: ${userId.slice(0,8)}...`);
                
                // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ UI
                const savedUiState = localStorage.getItem('uiState');
                console.log('[window.onload] savedUiState:', savedUiState);
                
                // Load profile to get email and check admin access
                loadProfile();
                
                if (savedUiState === 'profile') {
                    console.log('[window.onload] Restoring PROFILE screen');
                    setButtons({ showAuth: false, showUser: true, showConnect: true, connect: true, quickplay: false, balance: false, logs: false });
                    updateUserInfoAfterLogin();
                    // Ð’ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ðµ ÐÐ• Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ WebSocket Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
                } else {
                    console.log('[window.onload] Restoring GAME screen (default)');
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    checkActiveMatchOrQueue();
                    // ðŸ”„ ÐŸÐµÑ€ÐµÐ¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ WebSocket Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð¸Ð³Ñ€Ðµ
                    console.log('[window.onload] Reconnecting WebSocket...');
                    setTimeout(() => doConnect(), 500);
                }
                doCheckBalance(false); // Ð‘ÐµÐ· Ð·Ð²ÑƒÐºÐ° Ð¿Ñ€Ð¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÐµÑÑÐ¸Ð¸
            } else {
                // Initialize button states - show auth buttons, hide others
                setButtons({ showAuth: true, showUser: false, showConnect: false, connect: false, quickplay: false, balance: false, logs: false });
            }
            // Initialize chat history structure
            window.chatHistory = { global: [], games: {} };
            gameChatTimeouts = {};
            // Add welcome message
            addChatMessage('system', 'System', 'Welcome to WagerPlay! Select language above.', 'global');
            // ðŸ”„ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¸Ð³Ñ€Ñ‹
            const savedPlayers = localStorage.getItem('selectedPlayers');
            const savedStake = localStorage.getItem('selectedStake');
            
            if (savedPlayers) {
                selectedPlayers = parseInt(savedPlayers);
                console.log('[window.onload] Restored selectedPlayers:', selectedPlayers);
            }
            if (savedStake) {
                selectedStake = parseInt(savedStake);
                console.log('[window.onload] Restored selectedStake:', selectedStake);
            }
            
            // Initialize button text with saved (or default) values
            const btnText = document.getElementById('playBtnText');
            const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
            if (btnText) {
                btnText.textContent = `Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ ${selectedPlayers} | ${stakeText} VP`;
            }
            // Initialize player badge
            const playerBadge = document.getElementById('playerBadge');
            if (playerBadge) {
                playerBadge.textContent = selectedPlayers;
            }
            // Initialize stake button text
            const stakeBtnText = document.getElementById('stakeBtnText');
            if (stakeBtnText) {
                stakeBtnText.textContent = stakeText;
            }
            // Initialize dropdown selection
            updateDropdownSelection(selectedPlayers);
            // Close all dropdowns
            document.getElementById('playerDropdown').classList.remove('show');
            document.getElementById('stakeDropdown').classList.remove('show');
            document.getElementById('btnPlayArrow').classList.remove('active');
            document.getElementById('btnStakeArrow').classList.remove('active');
        };

        // Audio Context for sounds (Ð»ÐµÐ½Ð¸Ð²Ð¾Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ)
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        let audioInitialized = false;

        // ðŸŽµ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð°ÑƒÐ´Ð¸Ð¾ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¸
        async function initAudio() {
            if (!hasUserInteracted) return false;  // ðŸŽµ Ð‘Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ Ð´Ð¾ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐºÐ°
            if (audioInitialized) return true;
            try {
                if (!audioCtx) {
                    audioCtx = new AudioContext();
                }
                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                }
                audioInitialized = true;
                return true;
            } catch (e) {
                // ÐÐµ Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Ð² ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ - Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð·Ð²ÑƒÐº
                return false;
            }
        }

        // Sound effects
        const sounds = {
            click: () => playTone(800, 0.1, 'square'),
            error: () => playMelody([200, 150], 0.1),
            matchFound: () => {
                // ðŸŽ® ÐœÐÐ¢Ð§ ÐÐÐ™Ð”Ð•Ð! - Ñ€Ð°Ð´Ð¾ÑÑ‚Ð½Ñ‹Ð¹ Ð·Ð²ÑƒÐº
                if (!audioCtx) return;
                const now = audioCtx.currentTime;
                const notes = [
                    { f: 440, d: 0.1, t: 0 },
                    { f: 554, d: 0.1, t: 0.1 },
                    { f: 659, d: 0.3, t: 0.2 },
                ];
                notes.forEach(n => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = n.f;
                    osc.type = 'triangle';
                    gain.gain.setValueAtTime(0.0, now + n.t);
                    gain.gain.linearRampToValueAtTime(0.4, now + n.t + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + n.t + n.d);
                    osc.start(now + n.t);
                    osc.stop(now + n.t + n.d);
                });
            },
            countdown: (num) => {
                // â±ï¸ Ð—Ð²ÑƒÐº Ð¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ð° (Ð±Ð¸Ð¿ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ñ†Ð¸Ñ„Ñ€Ñ‹)
                const freq = num <= 3 ? 880 : 660;
                playTone(freq, 0.15, 'square');
            },
            matchStart: () => playMelody([440, 554, 659, 880], 0.1),
            win: () => {
                // ðŸ† ÐŸÐ¾Ð±ÐµÐ´Ð½Ð°Ñ Ð¼ÐµÐ»Ð¾Ð´Ð¸Ñ (Ñ„Ð°Ð½Ñ„Ð°Ñ€Ñ‹)
                if (!audioCtx) return;
                const now = audioCtx.currentTime;
                const notes = [
                    { f: 523, d: 0.15, t: 0 },
                    { f: 659, d: 0.15, t: 0.15 },
                    { f: 784, d: 0.15, t: 0.30 },
                    { f: 1047, d: 0.50, t: 0.45 },
                    { f: 523, d: 0.10, t: 1.0 },
                    { f: 659, d: 0.10, t: 1.15 },
                    { f: 784, d: 0.10, t: 1.30 },
                    { f: 1047, d: 0.80, t: 1.45 }
                ];
                notes.forEach(n => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = n.f;
                    osc.type = 'triangle';
                    gain.gain.setValueAtTime(0.0, now + n.t);
                    gain.gain.linearRampToValueAtTime(0.4, now + n.t + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + n.t + n.d);
                    osc.start(now + n.t);
                    osc.stop(now + n.t + n.d);
                });
            },
            lose: () => playMelody([400, 350, 300], 0.15),
            tie: () => playTone(440, 0.2, 'sine'),
            move: () => playTone(600, 0.05, 'square'),
            matchStart: () => playMelody([440, 554, 659, 880], 0.1)
        };

        async function playTone(freq, duration, type = 'sine') {
            if (!soundEnabled) return;
            // ðŸŽµ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð°ÑƒÐ´Ð¸Ð¾ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð·Ð²ÑƒÐºÐµ (Ð¿Ð¾ÑÐ»Ðµ ÐºÐ»Ð¸ÐºÐ°)
            const ready = await initAudio();
            if (!ready || !audioCtx) return;
            
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.value = freq;
                osc.type = type;
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + duration);
            } catch (e) {
                // ÐœÐ¾Ð»Ñ‡Ð° Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð°ÑƒÐ´Ð¸Ð¾
            }
        }

        async function playMelody(frequencies, duration) {
            if (!soundEnabled) return;
            // ðŸŽµ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð°ÑƒÐ´Ð¸Ð¾ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð·Ð²ÑƒÐºÐµ
            const ready = await initAudio();
            if (!ready || !audioCtx) return;
            
            frequencies.forEach((freq, i) => {
                setTimeout(() => playTone(freq, duration), i * duration * 1000);
            });
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.querySelector('.sound-toggle').textContent = soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
        }

        // Online Counter
        async function updateOnlineCount() {
            try {
                const res = await fetch(`${API_URL}/matchmaking/online`);
                const data = await res.json();
                document.getElementById('onlineCount').textContent = data.count || 0;
            } catch (e) {
                console.log('Failed to update online count');
            }
        }
        
        // Update online count every 10 seconds
        setInterval(updateOnlineCount, 10000);
        // Initial update
        setTimeout(updateOnlineCount, 1000);

        // History Modal - now redirects to unified stats modal
        async function showHistoryModal() {
            await showStatsModal();
            await switchStatsTab('matches');
        }

        // Logging
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logEl.insertBefore(entry, logEl.firstChild);
        }

        // Get server logs from backend
        async function getServerLogs() {
            if (!matchId) {
                log('âŒ No active match');
                return;
            }
            try {
                const r = await fetch(`/matchmaking/match/${matchId}/audit`);
                const logs = await r.json();
                console.log('=== SERVER LOGS ===', logs);
                console.log('Full logs:', JSON.stringify(logs, null, 2));
                log(`ðŸ“‹ Server logs: ${logs.length} entries (see Console)`);
                return logs;
            } catch (e) {
                log(`âŒ Error getting logs: ${e.message}`);
            }
        }

        // View server logs in VS Code Terminal:
        // 1. Open VS Code
        // 2. Look at bottom panel (Terminal tab)
        // 3. All errors and logs are shown there
        // Or press Ctrl+` (backtick) to open terminal

        // Show server logs in chat
        function showLogsInChat() {
            getServerLogs().then(logs => {
                if (logs && logs.length > 0) {
                    addChatMessage('system', 'System', `ðŸ“‹ Match logs: ${logs.length} events`, 'game', matchId);
                    logs.slice(-5).forEach(l => {
                        const msg = `[${l.eventType}] ${l.actorId?.slice(0,8) || 'System'}`;
                        addChatMessage('system', 'Log', msg, 'game', matchId);
                    });
                }
            });
        }

        // Update UI
        function updateBalanceDisplay(balance, frozen = 0) {
            document.getElementById('balanceDisplay').textContent = `${balance} VP`;
            const frozenEl = document.getElementById('frozenDisplay');
            const isCurrentlyInMatch = activeMatches.size > 0;
            
            if (frozen > 0 && !isCurrentlyInMatch) {
                frozenEl.innerHTML = `Ð—Ð°Ð¼Ð¾Ñ€Ð¾Ð¶ÐµÐ½Ð¾: ${frozen} VP <button onclick="resetFrozen()" style="margin-left:10px;padding:4px 8px;font-size:0.8em;background:#ff6b6b;border:none;border-radius:4px;color:white;cursor:pointer;">Ð’ÐµÑ€Ð½ÑƒÑ‚ÑŒ</button>`;
            } else if (frozen > 0 && isCurrentlyInMatch) {
                frozenEl.innerHTML = `Ð—Ð°Ð¼Ð¾Ñ€Ð¾Ð¶ÐµÐ½Ð¾: ${frozen} VP <span style="margin-left:10px;font-size:0.8em;color:#fbbf24;">ðŸ”’ Ð’ Ð¸Ð³Ñ€Ðµ</span>`;
            } else {
                frozenEl.textContent = '';
            }
        }

        // ðŸ†• Ð¡Ð±Ñ€Ð¾Ñ frozen Ð±Ð°Ð»Ð°Ð½ÑÐ°
        async function resetFrozen() {
            if (!token) {
                showToast('error', 'ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ');
                return;
            }
            
            // Ð—Ð°Ð¿Ñ€ÐµÑ‚ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð° Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¼Ð°Ñ‚Ñ‡Ð°
            if (activeMatches.size > 0) {
                showToast('warning', 'âŒ ÐÐµÐ»ÑŒÐ·Ñ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð° Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¸Ð³Ñ€Ñ‹');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/wallet/reset-frozen`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (result.success && result.returnedVp > 0) {
                    showToast('success', `Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¾ ${result.returnedVp} VP Ð½Ð° Ð±Ð°Ð»Ð°Ð½Ñ!`);
                    loadBalance(); // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð±Ð°Ð»Ð°Ð½Ñ
                } else if (result.returnedVp === 0) {
                    showToast('info', 'ÐÐµÑ‚ Ð·Ð°Ð¼Ð¾Ñ€Ð¾Ð¶ÐµÐ½Ð½Ñ‹Ñ… ÑÑ€ÐµÐ´ÑÑ‚Ð²');
                } else {
                    showToast('error', result.message || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð°');
                }
            } catch (e) {
                console.error('resetFrozen error:', e);
                showToast('error', 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ‚Ð¸');
            }
        }

        function setButtons(state) {
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            const btnConnect = document.getElementById('btnConnect');
            const dropdownPlay = document.getElementById('dropdownPlay');
            const dropdownStake = document.getElementById('dropdownStake');
            const btnQuickplay = document.getElementById('btnQuickplay');
            const btnPlayArrow = document.getElementById('btnPlayArrow');
            const btnStake = document.getElementById('btnStake');
            const btnStakeArrow = document.getElementById('btnStakeArrow');
            const btnBalance = document.getElementById('btnBalance');
            const btnStats = document.getElementById('btnStats');
            const btnLogs = document.getElementById('btnLogs');
            const balanceCard = document.querySelector('.balance-card');
            
            // Phase 1: Auth (Login/Register/Guest visible)
            if (authButtons) authButtons.style.display = state.showAuth ? 'flex' : 'none';
            if (userInfo) userInfo.style.display = state.showUser ? 'flex' : 'none';
            
            // ðŸŽ® ÐšÐ½Ð¾Ð¿ÐºÐ° "Ðš Ð˜Ð“Ð Ð•" Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° ÑÐºÑ€Ð°Ð½Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ
            const btnBackToGame = document.getElementById('btnBackToGame');
            if (btnBackToGame) {
                btnBackToGame.style.display = state.showUser ? 'inline-block' : 'none';
            }
            
            // Phase 2: Connect (after login) - show Connect button, hide game buttons
            if (btnConnect) {
                btnConnect.style.display = state.showConnect ? 'inline-block' : 'none';
                btnConnect.disabled = !state.connect;
            }
            
            // Game controls row - show only after connect
            const gameControlsRow = document.getElementById('gameControlsRow');
            if (gameControlsRow) {
                gameControlsRow.style.display = state.quickplay ? 'flex' : 'none';
                gameControlsRow.style.flexWrap = 'wrap';
            }
            
            // Enable/disable game buttons
            // ðŸ›¡ï¸ Ð‘Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÑÑ‚Ð°Ð²ÐºÐ¸ Ð¸ Ð¸Ð³Ñ€Ñ‹ ÐµÑÐ»Ð¸ Ð¸Ð´ÐµÑ‚ Ð¿Ð¾Ð¸ÑÐº (isProcessing.quickplay) Ð˜Ð›Ð˜ ÑƒÐ¶Ðµ Ð² Ð¼Ð°Ñ‚Ñ‡Ðµ (activeMatches)
            // ðŸ›¡ï¸ ÐŸÐ ÐžÐ’Ð•Ð Ð¯Ð•Ðœ Ñ‚Ð°ÐºÐ¶Ðµ localStorage uiState Ð´Ð»Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ»Ðµ F5
            const savedUiState = localStorage.getItem('uiState');
            const isInMatch = activeMatches.size > 0 || savedUiState === 'in-match';
            const isSearching = isProcessing.quickplay || isInMatch || savedUiState === 'searching';
            console.log('[setButtons] isProcessing.quickplay:', isProcessing.quickplay, 'activeMatches:', Array.from(activeMatches), 'isInMatch:', isInMatch, 'isSearching:', isSearching, 'uiState:', savedUiState);
            if (btnQuickplay) btnQuickplay.disabled = !state.quickplay || isSearching;
            if (btnPlayArrow) btnPlayArrow.disabled = !state.quickplay || isSearching;
            if (btnStake) btnStake.disabled = !state.quickplay || isSearching;
            if (btnStakeArrow) btnStakeArrow.disabled = !state.quickplay || isSearching;
            // ðŸ›¡ï¸ Ð’Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ‡Ñ‚Ð¾ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹
            if (btnQuickplay) btnQuickplay.style.opacity = isSearching ? '0.5' : '1';
            if (btnStake) btnStake.style.opacity = isSearching ? '0.5' : '1';
            if (btnBalance) {
                btnBalance.style.display = state.quickplay ? 'inline-block' : 'none';
                btnBalance.disabled = !state.balance;
            }
            const btnGoToProfile = document.getElementById('btnGoToProfile');
            if (btnGoToProfile) {
                btnGoToProfile.style.display = state.quickplay ? 'inline-block' : 'none';
                // ðŸ›¡ï¸ Ð‘Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ "Ð’ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ" ÐµÑÐ»Ð¸ Ð¸Ð´Ñ‘Ñ‚ Ð¿Ð¾Ð¸ÑÐº Ð¸Ð»Ð¸ Ð¼Ð°Ñ‚Ñ‡
                btnGoToProfile.disabled = !state.quickplay || isSearching || isInMatch;
                btnGoToProfile.style.opacity = (isSearching || isInMatch) ? '0.5' : '1';
            }
            if (btnLogs) {
                btnLogs.style.display = state.quickplay ? 'inline-block' : 'none';
                btnLogs.disabled = !state.logs;
            }
            
            // Show balance card only after login
            if (balanceCard) balanceCard.style.display = (state.showUser || state.showConnect || state.quickplay) ? 'block' : 'none';
        }
        
        function updateWaitingText() {
            const waitingText = document.getElementById('waitingText');
            if (!waitingText) return;
            
            if (!token) {
                waitingText.textContent = t('waitingGuest');
            } else if (!socket) {
                waitingText.textContent = t('connect') + ' â†’';
            } else {
                waitingText.textContent = t('waitingQueue');
            }
        }

        // Guest Login
        async function doGuest() {
            if (isProcessing.guest) {
                sounds.error();
                return;
            }
            isProcessing.guest = true;
            sounds.click();
            
            try {
                const r = await fetch(`${API_URL}/auth/guest`, { method: "POST" });
                const j = await r.json();
                token = j.token;
                userId = j.userId;
                // ðŸ›¡ï¸ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐµÑÑÐ¸ÑŽ Ð´Ð»Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ»Ðµ F5
                localStorage.setItem('token', token);
                localStorage.setItem('userId', userId);
                localStorage.setItem('isGuest', 'true');
                const guestDisplayName = j.displayName || `Guest${userId.slice(0,6)}`;
                currentProfile = {
                    displayName: guestDisplayName,
                    email: '',
                    gender: '',
                    avatarUrl: '',
                    isGuest: true
                };
                
                // Hide admin menu for guests
                checkAdminAccess(null);
                // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ displayName Ð´Ð»Ñ F5 recovery
                localStorage.setItem('displayName', guestDisplayName);
                updateBalanceDisplay(j.balanceWp);
                log(`âœ… Guest login: ${userId.slice(0,8)}...`);
                setButtons({ showAuth: false, showUser: true, showConnect: true, connect: true, quickplay: false, balance: true, logs: false });
                updateUserInfoAfterLogin();
                updateWaitingText();
                doCheckBalance();
            } catch (e) {
                log(`âŒ Guest error: ${e.message}`);
            } finally {
                isProcessing.guest = false;
            }
        }

        // Check Balance
        async function doCheckBalance(playSound = true) {
            if (playSound) sounds.click();
            if (!token) {
                log('âŒ Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Guest');
                return;
            }
            try {
                const r = await fetch("/wallet", {
                    headers: { "Authorization": "Bearer " + token }
                });
                const j = await r.json();
                if (j.balanceWp !== undefined) {
                    updateBalanceDisplay(j.balanceWp, j.frozenWp);
                    log(`ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ: ${j.balanceWp} VP`);
                }
            } catch (e) {
                log(`âŒ Balance error: ${e.message}`);
            }
        }

        // ðŸ“Š ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ
        async function doShowStats() {
            sounds.click();
            if (!token) {
                log('âŒ Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Guest');
                return;
            }
            try {
                console.log('[doShowStats] Fetching stats...');
                const r = await fetch("/auth/stats", {
                    headers: { "Authorization": "Bearer " + token }
                });
                console.log('[doShowStats] Response status:', r.status);
                const s = await r.json();
                console.log('[doShowStats] Stats data:', s);
                
                log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
                log('â•‘       ðŸ“Š Ð’ÐÐ¨Ð Ð¡Ð¢ÐÐ¢Ð˜Ð¡Ð¢Ð˜ÐšÐ       â•‘');
                log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
                log(`â•‘ ðŸŽ® ÐœÐ°Ñ‚Ñ‡ÐµÐ¹: ${s.totalMatches.toString().padStart(3)}              â•‘`);
                log(`â•‘ âœ… ÐŸÐ¾Ð±ÐµÐ´: ${s.wins.toString().padStart(3)}  âŒ ÐŸÐ¾Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹: ${s.losses.toString().padStart(3)}  â•‘`);
                log(`â•‘ ðŸ“ˆ Ð’Ð¸Ð½Ñ€ÐµÐ¹Ñ‚: ${s.winRate.toString().padStart(3)}%              â•‘`);
                log(`â•‘ ðŸ”¥ Ð¡ÐµÑ€Ð¸Ñ: ${s.winStreak} (ÐœÐ°ÐºÑ: ${s.maxWinStreak})         â•‘`);
                log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
                log(`â•‘ ðŸ’° Ð’ÑÐµÐ³Ð¾ Ð²Ñ‹Ð¸Ð³Ñ€Ð°Ð½Ð¾: ${s.totalWonVp.toString().padStart(6)} VP   â•‘`);
                log(`â•‘ ðŸ’¸ Ð’ÑÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ð¸Ð³Ñ€Ð°Ð½Ð¾: ${s.totalLostVp.toString().padStart(5)} VP   â•‘`);
                log(`â•‘ ðŸŽ¯ ÐœÐ°ÐºÑ. Ð²Ñ‹Ð¸Ð³Ñ€Ñ‹Ñˆ: ${s.biggestWinVp.toString().padStart(6)} VP   â•‘`);
                log(`â•‘ ðŸŽ² ÐœÐ°ÐºÑ. ÑÑ‚Ð°Ð²ÐºÐ°: ${s.biggestStakeVp.toString().padStart(6)} VP   â•‘`);
                log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            } catch (e) {
                console.error('[doShowStats] Error:', e);
                log(`âŒ Stats error: ${e.message}`);
            }
        }

        // Connect WebSocket
        function doConnect() {
            if (isProcessing.connect) {
                sounds.error();
                return;
            }
            isProcessing.connect = true;
            // sounds.click() ÑƒÐ±Ñ€Ð°Ð½ - doConnect Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸ F5
            
            if (!token) {
                log('âŒ Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Guest token');
                isProcessing.connect = false;
                return;
            }

            socket = io(window.location.origin, { 
                auth: { 
                    token,
                    displayName: currentProfile.displayName || ''
                } 
            });

            socket.on("connected", (m) => {
                isProcessing.connect = false;
                log(`ðŸ”— WebSocket Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½: ${m.userId.slice(0,8)}...`);
                
                // ðŸ”„ ÐŸÐ¾ÑÐ»Ðµ F5 Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¸Ð³Ñ€Ñ‹/Ð¿Ð¾Ð¸ÑÐºÐ° ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
                const savedUiState = localStorage.getItem('uiState');
                if (savedUiState === 'in-match' && matchId) {
                    // ÐŸÐµÑ€ÐµÐ¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº Ð¼Ð°Ñ‚Ñ‡Ñƒ
                    socket.emit('match:join', { matchId });
                    socket.emit('match:get', { matchId });
                    log('ðŸ”„ ÐŸÐµÑ€ÐµÐ¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð¼Ð°Ñ‚Ñ‡Ñƒ Ð¿Ð¾ÑÐ»Ðµ F5');
                } else if (savedUiState === 'searching') {
                    // Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸
                    log('ðŸ”„ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð¸ÑÐºÐ° ÑÐ¾Ð¿ÐµÑ€Ð½Ð¸ÐºÐ¾Ð²...');
                } else if (activeMatches.size === 0 && !isProcessing.quickplay) {
                    // âœ… Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ uiState Ð² 'game' ÐºÐ¾Ð³Ð´Ð° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ð»Ð¸ÑÑŒ Ð¸ Ð½ÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð¸Ð³Ñ€Ñ‹
                    console.log('[socket.on connected] Setting uiState to game');
                    localStorage.setItem('uiState', 'game');
                }
                
                // ðŸ›¡ï¸ ÐÐµ Ñ€Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÐµÑÐ»Ð¸ Ð¸Ð³Ñ€Ð¾Ðº ÑƒÐ¶Ðµ Ð² Ð¼Ð°Ñ‚Ñ‡Ðµ
                if (activeMatches.size === 0 && savedUiState !== 'in-match' && savedUiState !== 'searching') {
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                }
                // sounds.matchStart() ÑƒÐ±Ñ€Ð°Ð½ - Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸ F5
            });

            socket.on("matches:cleanup", (data) => {
                log(`ðŸ’° Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¾ ${data.returnedVp} VP Ð¸Ð· Ð·Ð°Ð²Ð¸ÑÑˆÐ¸Ñ… Ð¼Ð°Ñ‚Ñ‡ÐµÐ¹`);
                if (data.returnedVp > 0) {
                    alert(`âœ… Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¾ ${data.returnedVp} VP Ð¸Ð· Ð·Ð°Ð²Ð¸ÑÑˆÐ¸Ñ… Ð¼Ð°Ñ‚Ñ‡ÐµÐ¹`);
                    loadBalance(); // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð±Ð°Ð»Ð°Ð½Ñ
                }
            });

            socket.on("quickplay:result", (m) => {
                log(`ðŸŽ® Quickplay: ${m.status}`);
                if (m.status === 'ALREADY_IN_QUEUE') {
                    log('âš ï¸ Already in queue!');
                    isProcessing.quickplay = false;
                    localStorage.removeItem('searchStartTime');
                    localStorage.setItem('uiState', 'game');
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    showWaiting(t('waitingQueue'), true, 5);
                    return;
                }
                if (m.ticketId) {
                    showWaiting(t('waitingQueue'), true, 20);  // 20 ÑÐµÐºÑƒÐ½Ð´ Ð½Ð° Ð¿Ð¾Ð¸ÑÐº
                    // Keep button disabled while in queue
                    const qpBtn2 = document.getElementById('btnQuickplay');
                    const pbt2 = document.getElementById('playBtnText');
                    if (qpBtn2) qpBtn2.disabled = true;
                    if (pbt2) pbt2.textContent = 'â³ ' + (t('searching') || 'Searching...');
                }
                if (m.matchId) {
                    matchId = m.matchId;
                    isProcessing.quickplay = false;
                    // ÐœÐ°Ñ‚Ñ‡ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ - uiState ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ Ð² 'in-match' Ð² match:start
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    // Reset button text
                    const pbt5 = document.getElementById('playBtnText');
                    const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
                    if (pbt5) pbt5.textContent = `Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ ${selectedPlayers} | ${stakeText} VP`;
                }
            });

            socket.on("queue:waiting", (m) => {
                log(`â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ: ${m.seconds} ÑÐµÐº`);
                showWaiting(`Ð˜Ñ‰ÐµÐ¼ ÑÐ¾Ð¿ÐµÑ€Ð½Ð¸ÐºÐ¾Ð² (${m.playersFound || 1}/${selectedPlayers})...`, true, m.seconds);
            });

            // Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð° Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸ (ÐºÐ¾Ð³Ð´Ð° Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÑ‚ÑÑ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¸Ð³Ñ€Ð¾Ðº Ð¸Ð»Ð¸ F5 Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ)
            socket.on("queue:sync", (m) => {
                console.log('[queue:sync]', m);
                
                // ðŸ”„ F5 Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ: ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾Ð¸ÑÐºÐ°
                if (m.reconnected) {
                    console.log('[queue:sync] Reconnected while in queue, restoring state');
                    isProcessing.quickplay = true;
                    localStorage.setItem('uiState', 'searching');
                    setButtons({ showAuth: false, showUser: false, showConnect: false, quickplay: true, cancel: true });
                }
                
                log(`ðŸ”„ Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ: ${m.playersFound}/${m.totalNeeded} Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð², Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ ${m.secondsLeft}ÑÐµÐº`);
                // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ UI Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½ÐµÐ¼
                showWaiting(`Ð˜Ñ‰ÐµÐ¼ ÑÐ¾Ð¿ÐµÑ€Ð½Ð¸ÐºÐ¾Ð² (${m.playersFound}/${m.totalNeeded})...`, true, m.secondsLeft);
            });

            socket.on("fallback:result", (m) => {
                stopCountdown();
                log(`ðŸ¤– Fallback: ${m.status}`);
                isProcessing.quickplay = false;
                localStorage.removeItem('searchStartTime');
                localStorage.setItem('uiState', 'game');
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                const pbt6 = document.getElementById('playBtnText');
                if (pbt6) pbt6.textContent = t('quickplay');
                if (m.matchId) {
                    matchId = m.matchId;
                    sounds.matchStart();
                }
            });

            socket.on("match:round", (data) => {
                // Ð—Ð²ÑƒÐºÐ¾Ð²Ð¾Ð¹ ÑÑ„Ñ„ÐµÐºÑ‚ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ñ€Ð°ÑƒÐ½Ð´Ð°
                sounds.click();
                log(`ðŸŽ® Ð Ð°ÑƒÐ½Ð´ ${data.round}, Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²: ${data.aliveCount}`);
            });

            // â±ï¸ Ð¢Ð°Ð¹Ð¼ÐµÑ€ Ñ…Ð¾Ð´Ð° (12 ÑÐµÐºÑƒÐ½Ð´)
            socket.on("match:timer", (data) => {
                console.log('[CLIENT match:timer]', data);
                if (data.type === 'move' && data.deadline) {
                    // ðŸ›¡ï¸ Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ… ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹: ÐµÑÐ»Ð¸ Ñ€Ð°ÑƒÐ½Ð´ Ð² ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¸ Ð¼ÐµÐ½ÑŒÑˆÐµ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾, Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼
                    if (data.round && currentMatch && data.round < currentMatch.round) {
                        console.log('[CLIENT match:timer] Skipping old timer for round', data.round, '(current:', currentMatch.round, ')');
                        return;
                    }
                    
                    // ðŸ›¡ï¸ Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ: ÐµÑÐ»Ð¸ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ð¶Ðµ Ñ€Ð°ÑƒÐ½Ð´Ð°
                    if (data.round && currentTimerRound === data.round && moveCountdownInterval) {
                        console.log('[CLIENT match:timer] Timer already running for round', data.round);
                        return;
                    }
                    
                    // Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ secondsLeft Ð½Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ðµ Ð¿Ð¾ deadline (Ð±Ð¾Ð»ÐµÐµ Ñ‚Ð¾Ñ‡Ð½Ð¾)
                    const now = Date.now();
                    const secondsLeft = Math.max(0, Math.ceil((data.deadline - now) / 1000));
                    console.log('[CLIENT match:timer] Calculated secondsLeft:', secondsLeft, 'round from server:', data.round);
                    
                    // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ€Ð°ÑƒÐ½Ð´ Ð¸Ð· ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ (Ñ‚ÐµÐ¿ÐµÑ€ÑŒ ÑÐµÑ€Ð²ÐµÑ€ Ð²ÑÐµÐ³Ð´Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ round)
                    const targetRound = data.round || currentMatch?.round;
                    
                    startMoveCountdown(secondsLeft, targetRound, data.deadline);
                }
            });

            // ðŸŽ® ÐœÐÐ¢Ð§ Ð“ÐžÐ¢ÐžÐ’! - Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð¼Ð°Ñ‚Ñ‡ ÑÑ€Ð°Ð·Ñƒ
            socket.on("match:ready", (data) => {
                log(`ðŸŽ® Match ready: ${data.matchId.slice(0,8)}...`);
                activeMatches.add(data.matchId);  // ðŸ›¡ï¸ Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¼Ð°Ñ‚Ñ‡ Ð² Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ
                console.log('[match:ready] Added to activeMatches:', data.matchId, 'Size:', activeMatches.size);
                isProcessing.quickplay = false;
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                stopCountdown();
                
                // ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÐ¼ÑÑ Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ Ð¼Ð°Ñ‚Ñ‡Ð° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ‡Ð°Ñ‚Ð° Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹
                socket.emit("match:join", { matchId: data.matchId });
                
                // âŒ ÐÐ• Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ match:get Ð·Ð´ÐµÑÑŒ - Ð¶Ð´Ñ‘Ð¼ match:start Ð¿Ð¾ÑÐ»Ðµ Ð¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ð°!
                // Ð˜Ð³Ñ€Ð° Ð¾Ñ‚ÐºÑ€Ð¾ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ match:start
            });

            // ðŸŽ® ÐœÐÐ¢Ð§ ÐÐÐ™Ð”Ð•Ð! - Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐºÑ€Ð°Ð½ Ñ Ð¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ð¾Ð¼
            socket.on("match:found", (data) => {
                showToast('success', t('matchFound') || 'ÐœÐ°Ñ‚Ñ‡ Ð½Ð°Ð¹Ð´ÐµÐ½!', t('gameStarting') || 'Ð˜Ð³Ñ€Ð° Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ...');
                
                // ðŸ§¹ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ð¿Ð¾Ð¸ÑÐºÐ° (Ð¿Ñ€Ð¸ F5 Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸)
                stopCountdown();
                
                // ðŸ§¹ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ð¾Ñ‚ÑÑ‡Ñ‘Ñ‚ Ð¼Ð°Ñ‚Ñ‡Ð° ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
                if (matchCountdownInterval) {
                    clearInterval(matchCountdownInterval);
                    matchCountdownInterval = null;
                }
                
                sounds.matchFound();
                log('ðŸŽ® ÐœÐÐ¢Ð§ ÐÐÐ™Ð”Ð•Ð!');
                
                // ðŸ›¡ï¸ Ð‘Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÑÑ€Ð°Ð·Ñƒ Ð¿Ñ€Ð¸ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ð¾Ð¼ Ð¼Ð°Ñ‚Ñ‡Ðµ (Ð´Ð¾ match:start)
                activeMatches.add(data.matchId);
                matchId = data.matchId;  // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð»Ñ F5 recovery
                console.log('[match:found] Added to activeMatches:', data.matchId, 'Size:', activeMatches.size);
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                
                // ðŸ”„ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð´Ð»Ñ F5 recovery (Ð¿Ñ€Ð¾Ð¼ÐµÐ¶ÑƒÑ‚Ð¾Ñ‡Ð½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¼ÐµÐ¶Ð´Ñƒ searching Ð¸ in-match)
                localStorage.setItem('uiState', 'in-match');
                
                // ðŸ”„ ÐŸÑ€Ð¸ RECONNECT Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ countdown Ð¾Ñ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°, Ð¸Ð½Ð°Ñ‡Ðµ 5
                const initialCount = (data.mode === 'RECONNECT' && data.countdown) ? data.countdown : 5;
                console.log(`[match:found] Starting countdown: ${initialCount}s (mode: ${data.mode || 'normal'})`);
                
                // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐºÑ€Ð°Ð½ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ð¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð¾Ð¼
                document.getElementById('gameContent').innerHTML = `
                    <div class="waiting">
                        <div style="font-size: 2em; color: #ffd700; margin-bottom: 20px;">ðŸŽ® ÐœÐÐ¢Ð§ ÐÐÐ™Ð”Ð•Ð!</div>
                        <div style="font-size: 4em; font-weight: bold; color: #00ff88;" id="matchCountdown">${initialCount}</div>
                        <div style="margin-top: 20px;">ÐŸÑ€Ð¸Ð³Ð¾Ñ‚Ð¾Ð²ÑŒÑ‚ÐµÑÑŒ Ðº Ð¸Ð³Ñ€Ðµ...</div>
                    </div>
                `;
                
                // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¾Ñ‚ÑÑ‡Ñ‘Ñ‚
                let count = initialCount;
                matchCountdownInterval = setInterval(() => {
                    count--;
                    const el = document.getElementById('matchCountdown');
                    if (el) {
                        el.textContent = count;
                        sounds.countdown(count);
                    }
                    if (count <= 0) {
                        clearInterval(matchCountdownInterval);
                        matchCountdownInterval = null;
                    }
                }, 1000);
            });

            // â±ï¸ ÐžÑ‚ÑÑ‡Ñ‘Ñ‚ Ð¾Ñ‚ ÑÐµÑ€Ð²ÐµÑ€Ð° (Ñ€ÐµÐ·ÐµÑ€Ð²)
            socket.on("match:countdown", (data) => {
                const el = document.getElementById('matchCountdown');
                if (el) {
                    el.textContent = data.seconds;
                }
                // ðŸ”Š Ð—Ð²ÑƒÐº Ð¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ð° (Ñ‡ÐµÐ¼ Ð¼ÐµÐ½ÑŒÑˆÐµ Ñ‡Ð¸ÑÐ»Ð¾, Ñ‚ÐµÐ¼ Ð²Ñ‹ÑˆÐµ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ð°)
                if (sounds.countdown) {
                    sounds.countdown(data.seconds);
                }
            });

            // ðŸš€ ÐœÐ°Ñ‚Ñ‡ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ
            socket.on("match:start", (m) => {
                console.log('[CLIENT match:start]', {matchId: m.matchId, round: m.round, deadline: m.moveDeadline});
                if (matchCountdownInterval) {
                    clearInterval(matchCountdownInterval);
                }
                sounds.matchStart();
                log('ðŸš€ Ð˜Ð³Ñ€Ð° Ð½Ð°Ñ‡Ð°Ð»Ð°ÑÑŒ! (match:start)');
                
                // ðŸ›¡ï¸ Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¼Ð°Ñ‚Ñ‡ Ð² Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ (ÐµÑÐ»Ð¸ ÐµÑ‰Ðµ Ð½Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð² match:ready)
                activeMatches.add(m.matchId);
                console.log('[match:start] Added to activeMatches:', m.matchId, 'Size:', activeMatches.size);
                
                // ðŸ›¡ï¸ Ð‘Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÑÑ€Ð°Ð·Ñƒ Ð¿Ñ€Ð¸ Ð½Ð°Ñ‡Ð°Ð»Ðµ Ð¼Ð°Ñ‚Ñ‡Ð°
                localStorage.setItem('uiState', 'in-match');
                localStorage.removeItem('searchStartTime'); // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð¿Ð¾Ð¸ÑÐºÐ°
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                
                // ðŸ§¹ Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð´ÐµÐ´ÑƒÐ¿Ð»Ð¸ÐºÐ°Ñ†Ð¸ÑŽ Ñ€Ð°ÑƒÐ½Ð´Ð¾Ð² Ð¸ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ð´Ð»Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¼Ð°Ñ‚Ñ‡Ð°
                shownRounds.clear();
                shownMoveWarningForRound = null;  // ðŸ›¡ï¸ Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ„Ð»Ð°Ð³è­¦å‘Š
                currentTimerRound = null;
                currentTimerDeadline = null;
                resetAutoMoveFlag();  // ðŸ›¡ï¸ Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ„Ð»Ð°Ð³ Ð°Ð²Ñ‚Ð¾Ñ…Ð¾Ð´Ð°
                console.log('[match:start] Cleared shownRounds, timers, and autoMove flag');
                
                // Ð ÐµÐ½Ð´ÐµÑ€Ð¸Ð¼ Ð¼Ð°Ñ‚Ñ‡ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‚Ð°Ð¹Ð¼ÐµÑ€
                currentMatch = m;
                matchId = m.matchId;
                // ðŸ‘¤ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð¼ÐµÐ½Ð° Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð² Ð¸Ð· Ð¼Ð°Ñ‚Ñ‡Ð°
                if (m.playerNames) {
                    Object.assign(playerNames, m.playerNames);
                }
                renderMatch(m);
                showChat();
                createGameChat(m.matchId);
                
                // â±ï¸ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ deadline
                if (m.moveDeadline) {
                    const now = Date.now();
                    const deadline = m.moveDeadline;
                    const secondsLeft = Math.max(0, Math.ceil((deadline - now) / 1000));
                    console.log('[match:start] Starting timer with secondsLeft:', secondsLeft, 'for round', m.round);
                    if (secondsLeft > 0) {
                        startMoveCountdown(secondsLeft, m.round, deadline);
                    }
                }
            });

            // ðŸ”„ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¼Ð°Ñ‚Ñ‡Ð° Ð¿Ð¾ÑÐ»Ðµ F5
            socket.on("match:get", (m) => {
                console.log('[CLIENT match:get]', {matchId: m.matchId, round: m.round, status: m.status, createdAt: m.createdAt});
                if (!m || m.status === 'FINISHED' || m.status === 'CANCELLED') {
                    log('âŒ ÐœÐ°Ñ‚Ñ‡ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ð¸Ð»Ð¸ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½');
                    localStorage.setItem('uiState', 'game');
                    isProcessing.quickplay = false;
                    activeMatches.delete(m?.matchId);
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    return;
                }
                
                // ðŸ†• ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½ Ð»Ð¸ Ð¼Ð°Ñ‚Ñ‡ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾ (< 5 ÑÐµÐº Ð½Ð°Ð·Ð°Ð´)
                const elapsedSec = m.createdAt ? Math.floor((Date.now() - m.createdAt) / 1000) : 999;
                if (elapsedSec < 5) {
                    const remainingSec = 5 - elapsedSec;
                    console.log(`[match:get] Match created ${elapsedSec}s ago, showing countdown (${remainingSec}s left)`);
                    log(`â³ ÐœÐ°Ñ‚Ñ‡ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· ${remainingSec}ÑÐµÐº...`);
                    
                    currentMatch = m;
                    matchId = m.matchId;
                    activeMatches.add(m.matchId);
                    localStorage.setItem('uiState', 'in-match');
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    
                    // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ñ‚ÑÑ‡Ñ‘Ñ‚ Ð²Ð¼ÐµÑÑ‚Ð¾ Ð¸Ð³Ñ€Ñ‹
                    document.getElementById('gameContent').innerHTML = `
                        <div class="waiting">
                            <div style="font-size: 2em; color: #ffd700; margin-bottom: 20px;">ðŸŽ® ÐœÐÐ¢Ð§ ÐÐÐ™Ð”Ð•Ð!</div>
                            <div style="font-size: 4em; color: #ffd700; margin: 20px 0;" id="reconnectCountdown">${remainingSec}</div>
                            <div>ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ðº Ð±Ð¾ÑŽ...</div>
                        </div>
                    `;
                    
                    // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¾Ñ‚ÑÑ‡Ñ‘Ñ‚
                    let count = remainingSec;
                    const countdownInterval = setInterval(() => {
                        count--;
                        const cdEl = document.getElementById('reconnectCountdown');
                        if (cdEl) cdEl.textContent = count;
                        if (count <= 0) {
                            clearInterval(countdownInterval);
                        }
                    }, 1000);
                    
                    // ÐŸÐ¾ÑÐ»Ðµ Ð¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ð° Ñ€ÐµÐ½Ð´ÐµÑ€Ð¸Ð¼ Ð¼Ð°Ñ‚Ñ‡
                    setTimeout(() => {
                        if (m.playerNames) Object.assign(playerNames, m.playerNames);
                        renderMatch(m);
                        showChat();
                        // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ñ…Ð¾Ð´Ð°
                        if (m.moveDeadline) {
                            const secondsLeft = Math.max(0, Math.ceil((m.moveDeadline - Date.now()) / 1000));
                            if (secondsLeft > 0) startMoveCountdown(secondsLeft, m.round, m.moveDeadline);
                        }
                    }, remainingSec * 1000);
                    return;
                }
                
                log('ðŸ”„ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¼Ð°Ñ‚Ñ‡Ð°');
                currentMatch = m;
                matchId = m.matchId;
                activeMatches.add(m.matchId);
                localStorage.setItem('uiState', 'in-match');
                
                // ðŸ›¡ï¸ Ð‘Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÐ¸
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                
                // Ð ÐµÐ½Ð´ÐµÑ€Ð¸Ð¼ Ð¼Ð°Ñ‚Ñ‡
                if (m.playerNames) {
                    Object.assign(playerNames, m.playerNames);
                }
                renderMatch(m);
                showChat();
                
                // â±ï¸ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ deadline
                if (m.moveDeadline) {
                    const now = Date.now();
                    const deadline = m.moveDeadline;
                    const secondsLeft = Math.max(0, Math.ceil((deadline - now) / 1000));
                    console.log('[match:get] Starting timer with secondsLeft:', secondsLeft, 'for round', m.round);
                    if (secondsLeft > 0) {
                        startMoveCountdown(secondsLeft, m.round, deadline);
                    }
                }
            });

            socket.on("match:update", (m) => {
                console.log('[CLIENT match:update]', {matchId: m.matchId, round: m.round, status: m.status, deadline: m.moveDeadline});
                stopCountdown();
                // ðŸ›¡ï¸ ÐÐ• Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ moveCountdown Ð·Ð´ÐµÑÑŒ - Ð¿ÑƒÑÑ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð¿Ð¾ÐºÐ° Ð½Ðµ Ð¿Ñ€Ð¸Ð´ÐµÑ‚ match:timer Ñ Ð½Ð¾Ð²Ñ‹Ð¼ Ñ€Ð°ÑƒÐ½Ð´Ð¾Ð¼
                // stopMoveCountdown();  // <-- Ð£Ð‘Ð ÐÐÐž
                
                // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ„Ð»Ð°Ð³ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ñ…Ð¾Ð´Ð°
                isProcessing.move = false;
                
                // â±ï¸ ÐÐ• Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ð·Ð´ÐµÑÑŒ - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡ÐµÑ€ÐµÐ· match:start Ð¸Ð»Ð¸ match:timer
                
                // If this is a new match (different from current game chat), create new chat
                if (m.matchId && m.matchId !== currentGameChatId) {
                    matchId = m.matchId;
                    showChat();
                    createGameChat(m.matchId);
                }
                
                currentMatch = m;
                // ðŸ‘¤ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð¼ÐµÐ½Ð° Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð² Ð¸Ð· Ð¼Ð°Ñ‚Ñ‡Ð°
                if (m.playerNames) {
                    Object.assign(playerNames, m.playerNames);
                }
                renderMatch(m);
                
                // â±ï¸ Ð¢Ð°Ð¹Ð¼ÐµÑ€ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡ÐµÑ€ÐµÐ· match:timer Ð¸Ð»Ð¸ match:start
                // ÐÐµ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸ match:update Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð¾Ð²
                
                // ðŸŽ® Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹ Ñ€Ð°ÑƒÐ½Ð´Ð°
                if (m.lastRound) {
                    const lr = m.lastRound;
                    const roundKey = `${m.matchId}:${lr.roundNo}`;
                    
                    // ðŸ›¡ï¸ Ð”ÐµÐ´ÑƒÐ¿Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ: Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐµÑÐ»Ð¸ ÑƒÐ¶Ðµ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ð»Ð¸ ÑÑ‚Ð¾Ñ‚ Ñ€Ð°ÑƒÐ½Ð´
                    if (shownRounds.has(roundKey)) {
                        console.log(`[match:update] Skipping duplicate round ${lr.roundNo}`);
                    } else {
                        shownRounds.add(roundKey);
                        console.log(`[match:update] Showing round ${lr.roundNo} for first time`);
                        
                        const moveEmoji = { 'ROCK': 'âœŠ', 'PAPER': 'âœ‹', 'SCISSORS': 'âœŒï¸' };
                        
                        // Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ñ€Ð°ÑƒÐ½Ð´Ð°
                        log(`ðŸ“¢ Ð ÐÐ£ÐÐ” ${lr.roundNo}`);
                    
                    // Ð¥Ð¾Ð´Ñ‹ Ð²ÑÐµÑ… Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²
                    if (lr.moves) {
                        Object.entries(lr.moves).forEach(([pid, move]) => {
                            const isBot = pid.startsWith('BOT');
                            const botName = isBot ? (m.botNames?.[pid] || pid) : null;
                            const name = isBot ? botName : (pid === userId ? 'Ð’Ñ‹' : pid.slice(0, 8));
                            const emoji = moveEmoji[move] || move;
                            log(`  ${name}: ${emoji} ${move}`);
                        });
                    }
                    
                    // Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ñ€Ð°ÑƒÐ½Ð´Ð°
                    if (lr.outcome === 'TIE') {
                        log(`ðŸ¤ ÐÐ¸Ñ‡ÑŒÑ! (${lr.reason === 'ALL_SAME' ? 'Ð²ÑÐµ Ð¾Ð´Ð¸Ð½Ð°ÐºÐ¾Ð²Ð¾' : 'Ð²ÑÐµ Ñ‚Ñ€Ð¸ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°'})`);
                    } else if (lr.outcome === 'ELIMINATION') {
                        const losers = lr.losers || [];
                        const winningMove = lr.winningMove || '';
                        const winEmoji = moveEmoji[winningMove] || '';
                        log(`âš”ï¸ ÐŸÐ¾Ð±ÐµÐ¶Ð´Ð°ÐµÑ‚: ${winEmoji} ${winningMove}`);
                        
                        losers.forEach(pid => {
                            const isBot = pid.startsWith('BOT');
                            const botName = isBot ? (m.botNames?.[pid] || pid) : null;
                            const name = isBot ? botName : (pid === userId ? 'Ð’Ñ‹' : pid.slice(0, 8));
                            const skull = isBot ? 'ðŸ¤–' : (pid === userId ? 'ðŸ’€' : 'ðŸ‘¤');
                            log(`  ${skull} ${name} Ð’Ð«Ð‘Ð«Ð’ÐÐ•Ð¢!`);
                        });
                    }
                    
                        log(`ðŸ‘¥ ÐžÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²: ${m.aliveIds?.length || 0}`);
                    } // end of else (new round)
                } // end of if (m.lastRound)
                
                // Reset move processing flag when match updates
                isProcessing.move = false;
                
                // Enable logs button when we have a match
                if (m.matchId) {
                    const logsBtn = document.getElementById('btnLogs');
                    if (logsBtn) logsBtn.disabled = false;
                }
                
                // If match is finished, schedule chat close and reset quickplay button
                if (m.status === 'FINISHED') {
                    isProcessing.quickplay = false;
                    activeMatches.delete(m.matchId);  // ðŸ›¡ï¸ Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ‹Ð¹ Ð¼Ð°Ñ‚Ñ‡ Ð¸Ð· Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ…
                    localStorage.setItem('uiState', 'game');  // ðŸ›¡ï¸ Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ UI
                    console.log('[match:update FINISHED] Removed from activeMatches:', m.matchId, 'Size:', activeMatches.size);
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    const qpBtn3 = document.getElementById('btnQuickplay');
                    const pbt3 = document.getElementById('playBtnText');
                    if (pbt3) pbt3.textContent = t('playAgain');
                    
                    // Schedule this specific game chat to close after 2 minutes
                    if (m.matchId && !gameChatTimeouts[m.matchId]) {
                        addChatMessage('system', 'System', t('chatWillClose'), 'game', m.matchId);
                        gameChatTimeouts[m.matchId] = setTimeout(() => {
                            closeGameChat(m.matchId);
                            delete gameChatTimeouts[m.matchId];
                        }, 120000); // 2 minutes
                    }
                }
            });

            socket.on("chat:message", (data) => {
                addChatMessage('user', data.author?.slice(0,8) || 'Unknown', data.text, data.channel || 'global');
            });

            socket.on("chat:global", (data) => {
                const displayName = data.displayName || data.author?.slice(0,8) || 'Unknown';
                // ðŸ‘¤ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð¼Ñ Ð¸Ð³Ñ€Ð¾ÐºÐ°
                if (data.author && data.displayName) {
                    playerNames[data.author] = data.displayName;
                }
                addChatMessage('user', displayName, data.text, 'global', null, data.avatarUrl);
            });

            socket.on("chat:game", (data) => {
                // Add to specific game chat if matchId provided
                const targetGameId = data.matchId || currentGameChatId;
                if (targetGameId) {
                    const displayName = data.displayName || data.author?.slice(0,8) || 'Unknown';
                    // ðŸ‘¤ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð¼Ñ Ð¸Ð³Ñ€Ð¾ÐºÐ°
                    if (data.author && data.displayName) {
                        playerNames[data.author] = data.displayName;
                    }
                    addChatMessage('user', displayName, data.text, 'game', targetGameId, data.avatarUrl);
                }
            });

            socket.on("error", (m) => {
                isProcessing.move = false;
                isProcessing.quickplay = false;
                localStorage.setItem('uiState', 'game');
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                const qpBtn4 = document.getElementById('btnQuickplay');
                const pbt4 = document.getElementById('playBtnText');
                const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
                if (pbt4) pbt4.textContent = `Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ ${selectedPlayers} | ${stakeText} VP`;
                log(`âŒ Error: ${m.message}`);
            });
        }

        // Quickplay
        function resetAndPlayAgain() {
            // Clear match state
            currentMatch = null;
            matchId = null;
            currentGameChatId = null;
            stopMoveCountdown();
            stopCountdown();
            
            // Start new game
            doQuickplay();
        }

        function doQuickplay() {
            if (isProcessing.quickplay) {
                sounds.error();
                return;
            }
            isProcessing.quickplay = true;
            localStorage.setItem('uiState', 'searching');
            localStorage.setItem('searchStartTime', Date.now().toString());
            sounds.click();
            
            // ðŸ›¡ï¸ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ UI Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÐ¸
            setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
            
            if (!socket) {
                log('âŒ Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÐµÑÑŒ');
                isProcessing.quickplay = false;
                localStorage.setItem('uiState', 'game');
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                return;
            }
            socket.emit("quickplay", { playersCount: selectedPlayers, stakeVp: selectedStake });
            log(`ðŸŽ® Quickplay: ${selectedPlayers} players, ${selectedStake} VP`);
            // Show game chat - will be initialized when match arrives
        }

        // Make Move
        function makeMove(move) {
            // âŒ ÐÐµ Ð´Ð°Ñ‘Ð¼ Ð²Ñ‹Ð±Ð¸Ñ‚Ñ‹Ð¼ Ð¸Ð³Ñ€Ð¾ÐºÐ°Ð¼ Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ
            if (currentMatch && !currentMatch.aliveIds?.includes(userId)) {
                log('âŒ Ð’Ñ‹ Ð²Ñ‹Ð±Ñ‹Ð»Ð¸ Ð¸Ð· Ð¼Ð°Ñ‚Ñ‡Ð°');
                return;
            }
            
            if (isProcessing.move) {
                sounds.error();
                return;
            }
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ ÑÐ´ÐµÐ»Ð°Ð»Ð¸ Ð»Ð¸ ÑƒÐ¶Ðµ Ñ…Ð¾Ð´ Ð² ÑÑ‚Ð¾Ð¼ Ñ€Ð°ÑƒÐ½Ð´Ðµ (ðŸ›¡ï¸ debounce - Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼è­¦å‘Š Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ€Ð°Ð· Ð·Ð° Ñ€Ð°ÑƒÐ½Ð´)
            if (currentMatch && currentMatch.moves && currentMatch.moves[userId]) {
                const roundKey = `${currentMatch.matchId}:${currentMatch.round}`;
                if (!shownMoveWarningForRound || shownMoveWarningForRound !== roundKey) {
                    shownMoveWarningForRound = roundKey;
                    log('âš ï¸ Ð’Ñ‹ ÑƒÐ¶Ðµ ÑÐ´ÐµÐ»Ð°Ð»Ð¸ Ñ…Ð¾Ð´ Ð² ÑÑ‚Ð¾Ð¼ Ñ€Ð°ÑƒÐ½Ð´Ðµ');
                }
                return;
            }
            // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ„Ð»Ð°Ð³è­¦å‘Š Ð¿Ñ€Ð¸ Ð½Ð¾Ð²Ð¾Ð¼ Ñ€Ð°ÑƒÐ½Ð´Ðµ
            if (currentMatch) {
                const roundKey = `${currentMatch.matchId}:${currentMatch.round}`;
                if (shownMoveWarningForRound && shownMoveWarningForRound !== roundKey) {
                    shownMoveWarningForRound = null;
                }
            }
            
            // ðŸ›¡ï¸ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ð¢ÐžÐ›Ð¬ÐšÐž ÐµÑÐ»Ð¸ Ñ…Ð¾Ð´ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½
            stopMoveCountdown();
            
            isProcessing.move = true;
            sounds.move();
            
            if (!socket || !matchId) {
                log('âŒ ÐÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð³Ð¾ Ð¼Ð°Ñ‚Ñ‡Ð° (socket: ' + !!socket + ', matchId: ' + matchId + ')');
                isProcessing.move = false;
                return;
            }
            
            console.log('[makeMove] Sending move:', { matchId, move, userId });
            
            // Disable all move buttons
            document.querySelectorAll('.move-btn').forEach(btn => {
                if (btn) btn.disabled = true;
            });
            
            socket.emit("move", { matchId, move });
            log(`ðŸ‘Š Ð¥Ð¾Ð´: ${move}`);
            
            // Visual feedback
            document.querySelectorAll('.move-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.move === move) {
                    btn.classList.add('selected');
                }
            });
            
            // Auto-reset after 5 seconds if server doesn't respond
            setTimeout(() => {
                if (isProcessing.move) {
                    isProcessing.move = false;
                    log('âš ï¸ Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð° ÑÐµÑ€Ð²ÐµÑ€Ð°');
                    // Buttons will be re-enabled by renderMatch on next update
                }
            }, 5000);
        }

        // Countdown Timer
        function startCountdown(seconds) {
            if (countdownInterval) clearInterval(countdownInterval);
            let remaining = seconds;
            
            const updateTimer = () => {
                const timerEl = document.getElementById('countdownTimer');
                if (timerEl) {
                    const searchingText = t('searching') || 'ÐŸÐ¾Ð¸ÑÐº';
                    timerEl.textContent = `${searchingText} ${remaining}s`;
                }
                remaining--;
                if (remaining < 0) {
                    clearInterval(countdownInterval);
                }
            };
            
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }

        function stopCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        // â±ï¸ Ð¢Ð°Ð¹Ð¼ÐµÑ€ Ð´Ð»Ñ Ñ…Ð¾Ð´Ð° (12 ÑÐµÐºÑƒÐ½Ð´)
        let moveCountdownInterval = null;
        let moveCountdownTimeout = null;  // ðŸ›¡ï¸ Ð”Ð»Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ñ‹ pending setTimeout
        let currentTimerRound = null;
        let currentTimerDeadline = null;
        let autoMoveTriggeredForRound = null;  // ðŸ›¡ï¸ Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð°Ð²Ñ‚Ð¾Ñ…Ð¾Ð´Ð°
        
        function startMoveCountdown(seconds, round = null, deadline = null) {
            if (seconds <= 0) return;
            
            const targetRound = round || currentMatch?.round;
            
            // ðŸ›¡ï¸ ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐµÑÐ»Ð¸ Ñ‚Ð¾Ñ‚ Ð¶Ðµ deadline Ñ ÑÐ²ÐµÐ¶Ð¸Ð¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð¾Ð¼
            if (deadline && deadline === currentTimerDeadline && currentTimerRound === targetRound && moveCountdownInterval && seconds >= 10) {
                console.log(`[startMoveCountdown] Skip: same deadline=${deadline}, round=${targetRound}`);
                return;
            }
            
            // ðŸ›¡ï¸ ÐÐµ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐµÑÐ»Ð¸ Ð°Ð²Ñ‚Ð¾Ñ…Ð¾Ð´ ÑƒÐ¶Ðµ ÑÐ´ÐµÐ»Ð°Ð½ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ñ€Ð°ÑƒÐ½Ð´Ð°
            if (autoMoveTriggeredForRound === targetRound) {
                console.log(`[startMoveCountdown] Skip: autoMove already triggered for round ${targetRound}`);
                return;
            }
            
            // ÐÐµ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐµÑÐ»Ð¸ Ð¸Ð³Ñ€Ð¾Ðº Ð²Ñ‹Ð±Ñ‹Ð»
            if (currentMatch && !currentMatch.aliveIds?.includes(userId)) return;
            
            // ðŸ›¡ï¸ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð’Ð¡Ð• pending Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ñ‹ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ Ð½Ð¾Ð²Ð¾Ð³Ð¾
            if (moveCountdownInterval) {
                clearInterval(moveCountdownInterval);
                moveCountdownInterval = null;
            }
            if (moveCountdownTimeout) {
                clearTimeout(moveCountdownTimeout);
                moveCountdownTimeout = null;
            }
            
            currentTimerRound = targetRound;
            currentTimerDeadline = deadline;
            console.log(`[startMoveCountdown] Starting timer for round ${targetRound}, deadline=${deadline}`);
            
            let remaining = seconds;
            let intervalId = null;
            
            const updateTimer = () => {
                const timerEl = document.getElementById('moveTimer');
                if (timerEl) {
                    timerEl.textContent = remaining + 's';
                    if (remaining <= 3) timerEl.style.color = '#ff4444';
                    else if (remaining <= 6) timerEl.style.color = '#ffaa00';
                    else timerEl.style.color = '#00ff88';
                }
                remaining--;
                if (remaining < 0) {
                    clearInterval(intervalId);
                    moveCountdownInterval = null;
                    const timerElFinal = document.getElementById('moveTimer');
                    if (timerElFinal) timerElFinal.textContent = 'â±ï¸';
                    
                    const isPlayerAlive = currentMatch?.aliveIds?.includes(userId);
                    // ðŸ›¡ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð°Ð²Ñ‚Ð¾Ñ…Ð¾Ð´ ÐµÑ‰Ñ‘ Ð½Ðµ Ð´ÐµÐ»Ð°Ð»Ð¸ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ñ€Ð°ÑƒÐ½Ð´Ð°
                    if (isPlayerAlive && currentMatch && !currentMatch.moves?.[userId] && autoMoveTriggeredForRound !== currentTimerRound) {
                        autoMoveTriggeredForRound = currentTimerRound;  // ðŸ›¡ï¸ Ð¡Ñ‚Ð°Ð²Ð¸Ð¼ Ñ„Ð»Ð°Ð³ Ð”Ðž Ð²Ñ‹Ð·Ð¾Ð²Ð°
                        const moves = ['ROCK', 'PAPER', 'SCISSORS'];
                        const randomMove = moves[Math.floor(Math.random() * moves.length)];
                        log('â±ï¸ Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹ÑˆÐ»Ð¾! ÐÐ²Ñ‚Ð¾-Ñ…Ð¾Ð´: ' + randomMove);
                        makeMove(randomMove);
                    }
                }
            };
            
            // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ñ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ°Ð¼Ð¸ ÐµÑÐ»Ð¸ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½
            let retryCount = 0;
            const maxRetries = 10;
            
            const tryStartTimer = () => {
                let timerEl = document.getElementById('moveTimer');
                
                // ðŸ›¡ï¸ Ð•ÑÐ»Ð¸ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð° Ð½ÐµÑ‚, ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ ÐµÐ³Ð¾ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸ Ð² game-status
                if (!timerEl) {
                    const gameStatus = document.querySelector('.game-status');
                    if (gameStatus && !document.getElementById('moveTimer')) {
                        timerEl = document.createElement('div');
                        timerEl.id = 'moveTimer';
                        timerEl.className = 'move-timer';
                        timerEl.style.cssText = 'font-size: 2em; font-weight: bold; margin: 10px 0; color: #00ff88;';
                        // Ð’ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾ÑÐ»Ðµ status-text
                        const statusText = gameStatus.querySelector('.status-text');
                        if (statusText && statusText.nextSibling) {
                            gameStatus.insertBefore(timerEl, statusText.nextSibling);
                        } else if (gameStatus.firstChild) {
                            gameStatus.insertBefore(timerEl, gameStatus.firstChild.nextSibling);
                        } else {
                            gameStatus.appendChild(timerEl);
                        }
                        console.log('[startMoveCountdown] Created moveTimer dynamically');
                    }
                }
                
                if (!timerEl && retryCount < maxRetries) {
                    retryCount++;
                    moveCountdownTimeout = setTimeout(tryStartTimer, 100);
                    return;
                }
                
                // Ð­Ð»ÐµÐ¼ÐµÐ½Ñ‚ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð»Ð¸ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð»Ð¸ÑÑŒ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸
                updateTimer();
                intervalId = setInterval(updateTimer, 1000);
                moveCountdownInterval = intervalId;
                moveCountdownTimeout = null;
            };
            
            // ÐÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ñ‡Ñ‚Ð¾Ð±Ñ‹ DOM ÑƒÑÐ¿ÐµÐ» Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒÑÑ
            moveCountdownTimeout = setTimeout(tryStartTimer, 50);  // ðŸ›¡ï¸ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ID
        }

        function stopMoveCountdown() {
            if (moveCountdownInterval) {
                clearInterval(moveCountdownInterval);
                moveCountdownInterval = null;
            }
            if (moveCountdownTimeout) {
                clearTimeout(moveCountdownTimeout);  // ðŸ›¡ï¸ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ pending timeout
                moveCountdownTimeout = null;
            }
            currentTimerRound = null;
            currentTimerDeadline = null;
            // ðŸ›¡ï¸ ÐÐ• ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ autoMoveTriggeredForRound Ð·Ð´ÐµÑÑŒ - ÑÑ‚Ð¾ Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ Ñ€Ð°ÑƒÐ½Ð´Ð°
        }
        
        // ðŸ›¡ï¸ Ð¡Ð±Ñ€Ð¾Ñ Ñ„Ð»Ð°Ð³Ð° Ð°Ð²Ñ‚Ð¾Ñ…Ð¾Ð´Ð° Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¼Ð°Ñ‚Ñ‡Ð°
        function resetAutoMoveFlag() {
            autoMoveTriggeredForRound = null;
        }

        // Render Functions
        function showWaiting(text, withCountdown = false, seconds = 0) {
            let countdownHtml = '';
            if (withCountdown && seconds > 0) {
                countdownHtml = `<div id="countdownTimer" style="font-size: 1.5em; margin-top: 10px; color: #ffd700;"></div>`;
                startCountdown(seconds);
            }
            
            document.getElementById('gameContent').innerHTML = `
                <div class="waiting">
                    <div>${text}</div>
                    ${countdownHtml}
                </div>
            `;
        }

        function renderMatch(m) {
            const isPlayerAlive = m.aliveIds.includes(userId);
            const isFinished = m.status === 'FINISHED';
            const isPlayerWinner = m.winnerId === userId;
            
            console.log('Render match:', { round: m.round, isPlayerAlive, isFinished, userId, aliveIds: m.aliveIds });

            // Play sounds based on outcome
            if (isFinished) {
                if (isPlayerWinner) sounds.win();
                else if (m.playerIds.includes(userId)) sounds.lose();
            }

            let statusText = isFinished 
                ? (isPlayerWinner ? t('victory') : t('defeat')) 
                : (isPlayerAlive ? t('yourTurn') : t('waitingTurn'));

            let html = `
                <div class="game-status">
                    <div class="status-text">${statusText}</div>
                    ${!isFinished && isPlayerAlive ? `
                    <div class="move-timer" id="moveTimer" style="font-size: 2em; font-weight: bold; margin: 10px 0; color: #00ff88;">â±ï¸</div>
                    ` : ''}
                    <div class="match-info">
                        <div class="info-item">
                            <div class="info-label">${t('round')}</div>
                            <div class="info-value">${m.round}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">${t('pot')}</div>
                            <div class="info-value">${m.potVp} VP</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">${t('stake')}</div>
                            <div class="info-value">${m.stakeVp} VP</div>
                        </div>
                        ${isFinished ? `
                        <div class="info-item">
                            <div class="info-label">${t('payout')}</div>
                            <div class="info-value">${m.payoutVp} VP</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Players Grid
            html += `<div class="players-grid">`;
            m.playerIds.forEach(pid => {
                const isBot = pid.startsWith('BOT');
                const isAlive = m.aliveIds.includes(pid);
                const isEliminated = m.eliminatedIds.includes(pid);
                const isWinner = m.winnerId === pid;
                const isMe = pid === userId;
                
                let moveEmoji = 'â“';
                if (m.lastRound && m.lastRound.moves[pid]) {
                    moveEmoji = getMoveEmoji(m.lastRound.moves[pid]);
                }

                let statusText = isWinner ? t('winner') : isEliminated ? t('eliminated') : isAlive ? t('inGame') : '';
                let botDisplayName = isBot ? (m.botNames?.[pid] || pid) : pid;
                // ðŸ‘¤ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ displayName Ð¸Ð· playerNames (ÐºÐ»Ð¸ÐµÐ½Ñ‚) Ð¸Ð»Ð¸ m.playerNames (ÑÐµÑ€Ð²ÐµÑ€)
                let playerDisplayName = !isBot ? (playerNames[pid] || m.playerNames?.[pid] || pid.slice(0,8)) : botDisplayName;
                let nameText = isMe ? 'ðŸ‘¤ ' + (t('you') || 'You') : isBot ? 'ðŸ¤– ' + botDisplayName : 'ðŸ‘¤ ' + playerDisplayName;

                html += `
                    <div class="player-card ${isWinner ? 'winner' : isEliminated ? 'eliminated' : isAlive ? 'active' : ''}">
                        <div class="player-name">${nameText}</div>
                        <div class="player-move">${moveEmoji}</div>
                        <div class="player-status">${statusText}</div>
                    </div>
                `;
            });
            html += `</div>`;

            // Last Round Info
            if (m.lastRound) {
                const outcomeText = m.lastRound.outcome === 'TIE' ? t('tie') : t('elimination');
                html += `
                    <div class="round-info">
                        <div class="round-title">${t('round')} ${m.lastRound.roundNo}: ${outcomeText}</div>
                        ${m.lastRound.winningMove ? `<div>${t('wonWith')}: ${getMoveEmoji(m.lastRound.winningMove)} ${m.lastRound.winningMove}</div>` : ''}
                    </div>
                `;
            }

            // Move Buttons (only if alive and not finished)
            console.log('Move buttons check:', { isPlayerAlive, isFinished, shouldShow: isPlayerAlive && !isFinished });
            if (isPlayerAlive && !isFinished) {
                html += `
                    <div class="moves-container">
                        <button class="move-btn" data-move="ROCK" onclick="makeMove('ROCK')">
                            <div class="move-emoji">âœŠ</div>
                            <div class="move-text">${t('rock')}</div>
                        </button>
                        <button class="move-btn" data-move="PAPER" onclick="makeMove('PAPER')">
                            <div class="move-emoji">âœ‹</div>
                            <div class="move-text">${t('paper')}</div>
                        </button>
                        <button class="move-btn" data-move="SCISSORS" onclick="makeMove('SCISSORS')">
                            <div class="move-emoji">âœŒï¸</div>
                            <div class="move-text">${t('scissors')}</div>
                        </button>
                    </div>
                `;
            } else {
                console.log('Move buttons NOT shown - player not alive or game finished');
            }

            // Play Again Button
            if (isFinished) {
                html += `
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-success" onclick="resetAndPlayAgain()">${t('playAgain')}</button>
                    </div>
                `;
                // Add system message to game chat
                const resultMsg = isPlayerWinner ? 'Congratulations! You won!' : 'Game over. Better luck next time!';
                
                // ðŸŽ‰ Confetti and Toast on win!
                if (isPlayerWinner) {
                    startConfetti();
                    showToast('success', t('victory') || 'ÐŸÐ¾Ð±ÐµÐ´Ð°!', t('youWon') || 'Ð’Ñ‹ Ð¿Ð¾Ð±ÐµÐ´Ð¸Ð»Ð¸! +180 VP');
                } else {
                    showToast('info', t('gameOver') || 'Ð˜Ð³Ñ€Ð° Ð¾ÐºÐ¾Ð½Ñ‡ÐµÐ½Ð°', t('betterLuck') || 'Ð’ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ñ€Ð°Ð· Ð¿Ð¾Ð²ÐµÐ·ÐµÑ‚!');
                }
                
                if (m.matchId) {
                    addChatMessage('system', 'System', resultMsg, 'game', m.matchId);
                }
                
                // Update balance after match
                setTimeout(doCheckBalance, 500);
                
                // Clear current match state
                localStorage.setItem('uiState', 'game');
                currentMatch = null;
            }

            document.getElementById('gameContent').innerHTML = html;
        }

        function getMoveEmoji(move) {
            const emojis = { ROCK: 'âœŠ', PAPER: 'âœ‹', SCISSORS: 'âœŒï¸' };
            return emojis[move] || 'â“';
        }

        // Profile Functions
        let currentProfile = {
            displayName: '',
            email: '',
            gender: '',
            avatarUrl: '',
            isGuest: true
        };

        // ðŸ›¡ï¸ Admin emails - Add your email here to see Admin button
        const ADMIN_EMAILS = [
            'mellowin1987@gmail.com',
            'osanamyan@ukr.net'
        ];

        // Check if user is admin
        function checkAdminAccess(userEmail) {
            const adminItem = document.getElementById('adminMenuItem');
            if (adminItem && userEmail && ADMIN_EMAILS.includes(userEmail.toLowerCase())) {
                adminItem.style.display = 'flex';
            }
        }
        let selectedAvatarId = '';

        function goToProfileScreen() {
            console.log('[goToProfileScreen] START');
            localStorage.setItem('uiState', 'profile');
            console.log('[goToProfileScreen] uiState set to: profile');
            setButtons({ 
                showAuth: false, 
                showUser: true, 
                showConnect: true, 
                connect: true, 
                quickplay: false, 
                balance: false, 
                logs: false 
            });
            updateUserInfoAfterLogin();
            console.log('[goToProfileScreen] DONE');
        }

        function goToGameScreen() {
            // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð³Ñ€Ð¾Ð²Ð¾Ð¹ ÑÐºÑ€Ð°Ð½
            localStorage.setItem('uiState', 'game');
            setButtons({ 
                showAuth: false, 
                showUser: false, 
                showConnect: false, 
                connect: false, 
                quickplay: true, 
                balance: true, 
                logs: true 
            });
        }

        async function checkActiveMatchOrQueue() {
            console.log('[checkActiveMatchOrQueue] START, token:', token ? 'yes' : 'no');
            if (!token) {
                console.log('[checkActiveMatchOrQueue] No token, returning');
                return;
            }
            
            try {
                console.log('[checkActiveMatchOrQueue] Fetching /matchmaking/active...');
                const response = await fetch('/matchmaking/active', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[checkActiveMatchOrQueue] Response:', data);
                    
                    if (data.inQueue) {
                        console.log('[checkActiveMatchOrQueue] User is in queue:');
                        console.log(`  - playersFound: ${data.playersFound}/${data.totalNeeded}`);
                        console.log(`  - secondsLeft from server: ${data.secondsLeft}`);
                        console.log(`  - queueTime from server: ${data.queueTime}`);
                        
                        // Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾Ð¸ÑÐºÐ°
                        localStorage.setItem('uiState', 'searching');
                        isProcessing.quickplay = true;
                        // ðŸ›¡ï¸ Ð‘Ð›ÐžÐšÐ˜Ð Ð£Ð•Ðœ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¸Ð³Ñ€Ñ‹ Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¿Ð¾Ð¸ÑÐºÐ°
                        setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                        
                        // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°
                        const remainingSeconds = data.secondsLeft || 20;
                        const playersFound = data.playersFound || 1;
                        const totalNeeded = data.totalNeeded || 2;
                        
                        // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐºÑ€Ð°Ð½ Ð¿Ð¾Ð¸ÑÐºÐ° Ñ Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð¾Ð¼
                        showWaiting(`Ð˜Ñ‰ÐµÐ¼ ÑÐ¾Ð¿ÐµÑ€Ð½Ð¸ÐºÐ¾Ð² (${playersFound}/${totalNeeded})...`, true, remainingSeconds);
                        log(`ðŸ”„ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¿Ð¾Ð¸ÑÐº: ${playersFound}/${totalNeeded}, Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ ${remainingSeconds}Ñ`);
                    } else if (data.activeMatch) {
                        // Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¸Ð³Ñ€Ñ‹
                        localStorage.setItem('uiState', 'in-match');
                        currentMatch = data.activeMatch;
                        matchId = data.activeMatch.matchId;
                        activeMatches.add(matchId);
                        // ðŸ›¡ï¸ Ð‘Ð›ÐžÐšÐ˜Ð Ð£Ð•Ðœ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¸Ð³Ñ€Ñ‹ Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð¼Ð°Ñ‚Ñ‡Ð°
                        setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                        renderMatch(data.activeMatch);
                        log('ðŸ”„ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¼Ð°Ñ‚Ñ‡');
                        
                        // ðŸ”„ ÐŸÐµÑ€ÐµÐ¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ WebSocket Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ Ð¼Ð°Ñ‚Ñ‡Ð°
                        if (socket && matchId) {
                            socket.emit('match:join', { matchId });
                            console.log('[F5 Restore] Rejoined match room:', matchId);
                        }
                    } else {
                        // ÐÐ¸ Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸, Ð½Ð¸ Ð² Ð¼Ð°Ñ‚Ñ‡Ðµ â€” ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
                        console.log('[checkActiveMatchOrQueue] User not active, resetting UI state');
                        localStorage.setItem('uiState', 'game');
                        isProcessing.quickplay = false;
                        activeMatches.clear();
                        setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                        updateWaitingText(); // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Guest Login"
                    }
                }
            } catch (e) {
                console.log('checkActiveMatchOrQueue error:', e);
            }
        }

        function showProfileModal() {
            document.getElementById('profileModal').classList.add('show');
            initAvatars();
            loadProfile();
        }

        function initAvatars() {
            const maleGrid = document.getElementById('maleAvatars');
            const femaleGrid = document.getElementById('femaleAvatars');
            
            if (maleGrid && maleGrid.children.length === 0) {
                for (let i = 1; i <= 5; i++) {
                    const div = document.createElement('div');
                    div.className = 'avatar-item';
                    div.onclick = function() { selectAvatar('male' + i, this); };
                    div.innerHTML = '<img src="' + API_URL + '/avatars/male' + i + '.svg" alt="male' + i + '">';
                    maleGrid.appendChild(div);
                }
            }
            
            if (femaleGrid && femaleGrid.children.length === 0) {
                for (let i = 1; i <= 5; i++) {
                    const div = document.createElement('div');
                    div.className = 'avatar-item';
                    div.onclick = function() { selectAvatar('female' + i, this); };
                    div.innerHTML = '<img src="' + API_URL + '/avatars/female' + i + '.svg" alt="female' + i + '">';
                    femaleGrid.appendChild(div);
                }
            }
        }

        function hideProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }

        async function loadProfile() {
            if (!token) return;
            
            // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ displayName Ð´Ð»Ñ Ð³Ð¾ÑÑ‚ÐµÐ¹ (F5 recovery)
            const savedDisplayName = localStorage.getItem('displayName') || currentProfile.displayName;
            
            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': token }
                });
                const data = await res.json();
                
                // Ð”Ð»Ñ Ð³Ð¾ÑÑ‚ÐµÐ¹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ð¹ displayName, ÐµÑÐ»Ð¸ ÑÐµÑ€Ð²ÐµÑ€ Ð²ÐµÑ€Ð½ÑƒÐ» Ð¿ÑƒÑÑ‚Ð¾Ð¹
                const isGuestUser = data.isGuest || localStorage.getItem('isGuest') === 'true';
                const displayName = isGuestUser && savedDisplayName 
                    ? savedDisplayName 
                    : (data.displayName || data.username || '');
                
                currentProfile = {
                    displayName: displayName,
                    email: data.email || '',
                    gender: data.gender || '',
                    avatarUrl: data.avatarUrl || '',
                    isGuest: data.isGuest
                };
                
                // Check admin access
                checkAdminAccess(data.email);
                
                // Ð”Ð»Ñ Ð³Ð¾ÑÑ‚ÐµÐ¹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ displayName Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð² localStorage
                if (isGuestUser && savedDisplayName) {
                    localStorage.setItem('displayName', displayName);
                }
                
                // Fill form
                document.getElementById('profileDisplayName').value = currentProfile.displayName;
                document.getElementById('profileGender').value = currentProfile.gender;
                
                // Filter avatars by gender if set
                filterAvatarsByGender(currentProfile.gender);
                
                // Show avatar
                const avatarImg = document.getElementById('profileCurrentAvatar');
                if (currentProfile.avatarUrl) {
                    avatarImg.src = currentProfile.avatarUrl;
                    avatarImg.style.display = 'block';
                } else {
                    // Default avatar based on gender
                    const defaultAvatar = currentProfile.gender === 'female' ? `${API_URL}/avatars/female1.svg` : `${API_URL}/avatars/male1.svg`;
                    avatarImg.src = defaultAvatar;
                    avatarImg.style.display = 'block';
                }
                
                // Show/hide link email section
                const linkSection = document.getElementById('linkEmailSection');
                if (currentProfile.isGuest) {
                    linkSection.style.display = 'block';
                } else {
                    linkSection.style.display = 'none';
                }
                
            } catch (e) {
                console.error('Failed to load profile:', e);
            }
        }

        function switchAvatarTab(tab, clickedTab) {
            // Update tab buttons
            document.querySelectorAll('.avatar-tab').forEach(t => t.classList.remove('active'));
            clickedTab.classList.add('active');
            
            // Show/hide grids
            document.getElementById('maleAvatars').classList.add('hidden');
            document.getElementById('femaleAvatars').classList.add('hidden');
            document.getElementById('customAvatar').classList.add('hidden');
            
            document.getElementById(tab + 'Avatars')?.classList.remove('hidden');
            if (tab === 'custom') {
                document.getElementById('customAvatar').classList.remove('hidden');
            }
        }

        function selectAvatar(avatarId, clickedElement) {
            selectedAvatarId = avatarId;
            
            // Update UI
            document.querySelectorAll('.avatar-item').forEach(item => item.classList.remove('selected'));
            if (clickedElement) clickedElement.classList.add('selected');
            
            // Preview
            document.getElementById('profileCurrentAvatar').src = API_URL + '/avatars/' + avatarId + '.svg';
            
            // Auto-set gender based on avatar selection (always update)
            const newGender = avatarId.startsWith('male') ? 'male' : 'female';
            document.getElementById('profileGender').value = newGender;
        }

        function filterAvatarsByGender(gender) {
            // If gender is set, show only corresponding avatars
            if (gender === 'male') {
                document.getElementById('maleAvatars').classList.remove('hidden');
                document.getElementById('femaleAvatars').classList.add('hidden');
                // Update tabs
                document.querySelectorAll('.avatar-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.avatar-tab:nth-child(1)')?.classList.add('active');
            } else if (gender === 'female') {
                document.getElementById('maleAvatars').classList.add('hidden');
                document.getElementById('femaleAvatars').classList.remove('hidden');
                // Update tabs
                document.querySelectorAll('.avatar-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.avatar-tab:nth-child(2)')?.classList.add('active');
            }
            // If no gender, show both (default behavior)
        }

        // Listen for gender change
        document.addEventListener('DOMContentLoaded', function() {
            const genderSelect = document.getElementById('profileGender');
            if (genderSelect) {
                genderSelect.addEventListener('change', function() {
                    filterAvatarsByGender(this.value);
                });
            }
        });

        async function saveProfile() {
            const displayName = document.getElementById('profileDisplayName').value.trim();
            const gender = document.getElementById('profileGender').value;
            
            let avatarUrl = currentProfile.avatarUrl || null;
            // If selected a preset avatar (not custom upload)
            if (selectedAvatarId && selectedAvatarId !== 'custom') {
                avatarUrl = `${API_URL}/avatars/${selectedAvatarId}.svg`;
            }
            // Convert empty string to null for server
            if (avatarUrl === '') avatarUrl = null;
            
            try {
                const res = await fetch(`${API_URL}/auth/profile`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ displayName, gender, avatarUrl })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    log('âœ… ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½');
                    
                    // Update local profile
                    currentProfile.displayName = displayName;
                    currentProfile.gender = gender;
                    currentProfile.avatarUrl = avatarUrl;
                    // email Ð½Ðµ Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ
                    // Save displayName to localStorage for F5 recovery
                    localStorage.setItem('displayName', displayName);
                    
                    // Update UI
                    updateUserInfoAfterProfileUpdate();
                    hideProfileModal();
                } else {
                    const err = await res.json();
                    log('âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: ' + (err.message || 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ'));
                }
            } catch (e) {
                log('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ‚Ð¸');
            }
        }

        async function linkEmail() {
            const email = document.getElementById('linkEmail').value.trim();
            const password = document.getElementById('linkPassword').value;
            
            if (!email || !password || password.length < 6) {
                log('âŒ Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ email Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ (Ð¼Ð¸Ð½. 6 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²)');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/auth/link-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    log('âœ… ' + data.message);
                    hideProfileModal();
                } else {
                    log('âŒ ' + (data.message || 'ÐžÑˆÐ¸Ð±ÐºÐ°'));
                }
            } catch (e) {
                log('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ‚Ð¸');
            }
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Resize and compress image before storing
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize to max 200x200 for small avatar
                    const maxSize = 200;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compress to JPEG with 60% quality
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    
                    const profileImg = document.getElementById('profileCurrentAvatar');
                    profileImg.src = compressedDataUrl;
                    profileImg.style.display = 'block';
                    currentProfile.avatarUrl = compressedDataUrl;
                    selectedAvatarId = 'custom';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updateUserInfo() {
            // Update mini avatar in header
            const miniAvatar = document.getElementById('userAvatar');
            if (miniAvatar && currentProfile.avatarUrl) {
                miniAvatar.src = currentProfile.avatarUrl;
                miniAvatar.style.display = 'inline-block';
            }
        }

        function updateUserInfoAfterLogin() {
            // Show user info section
            const userInfo = document.getElementById('userInfo');
            if (userInfo) userInfo.style.display = 'flex';
            
            // Update email display
            const emailDisplay = document.getElementById('userEmail');
            if (emailDisplay) {
                emailDisplay.textContent = currentProfile.displayName || userId.slice(0, 8);
            }
            
            // Update avatar
            updateUserInfo();
        }

        function updateUserInfoAfterProfileUpdate() {
            // Update display name
            const emailDisplay = document.getElementById('userEmail');
            if (emailDisplay && currentProfile.displayName) {
                emailDisplay.textContent = currentProfile.displayName;
            }
            
            // Update mini avatar in header
            const miniAvatar = document.getElementById('userAvatar');
            if (miniAvatar && currentProfile.avatarUrl) {
                miniAvatar.src = currentProfile.avatarUrl;
                miniAvatar.style.display = 'inline-block';
            }
            
            // Re-render chat to show new avatar
            renderChatMessages();
        }

        // ðŸ‘¤ ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¸Ð³Ñ€Ð¾ÐºÐ°
        async function showPublicProfile(targetUserId, displayName) {
            sounds.click();
            
            // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¼Ð¾Ð´Ð°Ð»ÐºÑƒ Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¾Ð¹
            const modal = document.getElementById('statsModal');
            const body = document.getElementById('statsModalBody');
            modal.classList.add('show');
            body.innerHTML = `<div style="text-align:center;padding:20px;">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ ${displayName}...</div>`;
            
            try {
                // Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ
                const r = await fetch(`${API_URL}/auth/public-profile/${targetUserId}`, {
                    headers: token ? { "Authorization": "Bearer " + token } : {}
                });
                
                if (!r.ok) {
                    body.innerHTML = `<div style="text-align:center;padding:20px;color:#ff6b6b;">âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ</div>`;
                    return;
                }
                
                const data = await r.json();
                
                body.innerHTML = `
                    <div style="text-align:center;padding:20px;">
                        <div style="font-size:3em;margin-bottom:10px;">${data.avatarUrl ? `<img src="${data.avatarUrl}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">` : 'ðŸ‘¤'}</div>
                        <div style="font-size:1.5em;font-weight:bold;color:#ffd700;margin-bottom:5px;">${data.displayName || 'Ð˜Ð³Ñ€Ð¾Ðº'}</div>
                        <div style="color:#aaa;margin-bottom:20px;">ID: ${data.id?.slice(0,8)}...</div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:20px;">
                            <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;">
                                <div style="font-size:1.8em;font-weight:bold;color:#00ff88;">${data.stats?.totalMatches || 0}</div>
                                <div style="font-size:0.9em;color:#aaa;">Ð’ÑÐµÐ³Ð¾ Ð¸Ð³Ñ€</div>
                            </div>
                            <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;">
                                <div style="font-size:1.8em;font-weight:bold;color:#ffd700;">${data.stats?.wins || 0}</div>
                                <div style="font-size:0.9em;color:#aaa;">ÐŸÐ¾Ð±ÐµÐ´</div>
                            </div>
                        </div>
                        
                        <div style="margin-top:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:10px;">
                            <div style="color:#aaa;margin-bottom:10px;">Ð’Ð¸Ð½Ñ€ÐµÐ¹Ñ‚</div>
                            <div style="font-size:1.5em;font-weight:bold;color:${(data.stats?.winRate || 0) > 50 ? '#00ff88' : '#ff6b6b'};">${data.stats?.winRate || 0}%</div>
                        </div>
                    </div>
                `;
            } catch (e) {
                body.innerHTML = `<div style="text-align:center;padding:20px;color:#ff6b6b;">âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: ${e.message}</div>`;
            }
        }

        // Stats Modal Functions
        async function showStatsModal() {
            sounds.click();
            if (!token) {
                log('âŒ Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ');
                return;
            }
            document.getElementById('statsModal').classList.add('show');
            const body = document.getElementById('statsModalBody');
            body.innerHTML = '<div style="text-align:center;padding:20px;">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...</div>';
            try {
                const r = await fetch(`${API_URL}/auth/stats`, { headers: { "Authorization": "Bearer " + token } });
                const s = await r.json();
                const winColor = s.winRate >= 50 ? '#4ade80' : (s.winRate >= 30 ? '#ffd700' : '#f87171');
                body.innerHTML = `
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;">
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:2em;font-weight:bold;color:#ffd700;margin-bottom:5px;">${s.totalMatches}</div>
                            <div style="font-size:0.9em;opacity:0.8;">Ð’ÑÐµÐ³Ð¾ Ð¼Ð°Ñ‚Ñ‡ÐµÐ¹</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:2em;font-weight:bold;color:${winColor};margin-bottom:5px;">${s.winRate}%</div>
                            <div style="font-size:0.9em;opacity:0.8;">Ð’Ð¸Ð½Ñ€ÐµÐ¹Ñ‚</div>
                            <div style="width:100%;height:10px;background:rgba(255,255,255,0.1);border-radius:5px;overflow:hidden;margin-top:8px;">
                                <div style="height:100%;background:linear-gradient(90deg,#4ade80,#ffd700);width:${s.winRate}%"></div>
                            </div>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:2em;font-weight:bold;color:#4ade80;margin-bottom:5px;">${s.wins}</div>
                            <div style="font-size:0.9em;opacity:0.8;">ÐŸÐ¾Ð±ÐµÐ´</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:2em;font-weight:bold;color:#f87171;margin-bottom:5px;">${s.losses}</div>
                            <div style="font-size:0.9em;opacity:0.8;">ÐŸÐ¾Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹</div>
                        </div>
                    </div>
                    <div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.2);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>ðŸ”¥ Ð¡ÐµÑ€Ð¸Ñ:</span><strong>${s.winStreak} (Ð¼Ð°ÐºÑ: ${s.maxWinStreak})</strong></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>ðŸ’° Ð’Ñ‹Ð¸Ð³Ñ€Ð°Ð½Ð¾:</span><strong style="color:#4ade80">${s.totalWonVp.toLocaleString()} VP</strong></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>ðŸ’¸ ÐŸÑ€Ð¾Ð¸Ð³Ñ€Ð°Ð½Ð¾:</span><strong style="color:#f87171">${s.totalLostVp.toLocaleString()} VP</strong></div>
                        <div style="display:flex;justify-content:space-between;"><span>ðŸŽ¯ ÐœÐ°ÐºÑ. Ð²Ñ‹Ð¸Ð³Ñ€Ñ‹Ñˆ:</span><strong style="color:#ffd700">${s.biggestWinVp.toLocaleString()} VP</strong></div>
                    </div>`;
            } catch (e) {
                body.innerHTML = '<div style="color:#f87171;text-align:center;">âŒ ÐžÑˆÐ¸Ð±ÐºÐ°</div>';
            }
        }
        
        function hideStatsModal() {
            document.getElementById('statsModal').classList.remove('show');
        }

        // Leaderboard
        let currentLeaderboardCategory = 'wins';
        let currentLeaderboardOffset = 0;
        const LEADERBOARD_LIMIT = 10;

        async function showLeaderboard() {
            sounds.click();
            if (!token) {
                log('âŒ Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ');
                return;
            }
            document.getElementById('leaderboardModal').classList.add('show');
            await loadLeaderboard();
            await loadMyLeaderboardPosition();
        }

        function hideLeaderboardModal() {
            document.getElementById('leaderboardModal').classList.remove('show');
        }

        async function switchLeaderboardCategory(category) {
            sounds.click();
            currentLeaderboardCategory = category;
            currentLeaderboardOffset = 0;
            
            // Update tab buttons
            document.querySelectorAll('#leaderboardTabs .stats-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`lb-tab-${category}`).classList.add('active');
            
            await loadLeaderboard();
            await loadMyLeaderboardPosition();
        }

        async function loadLeaderboard() {
            const body = document.getElementById('leaderboardBody');
            body.innerHTML = '<div class="leaderboard-loading">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‚Ð¾Ð¿Ð°...</div>';
            document.getElementById('leaderboardPagination').style.display = 'none';
            
            try {
                const res = await fetch(`${API_URL}/leaderboard?category=${currentLeaderboardCategory}&limit=${LEADERBOARD_LIMIT}&offset=${currentLeaderboardOffset}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) throw new Error('Failed to load');
                
                const data = await res.json();
                renderLeaderboard(data.entries, data.total);
            } catch (e) {
                body.innerHTML = '<div class="leaderboard-empty">âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ‚Ð¾Ð¿Ð°</div>';
            }
        }

        function renderLeaderboard(entries, total) {
            const body = document.getElementById('leaderboardBody');
            
            if (!entries || entries.length === 0) {
                body.innerHTML = '<div class="leaderboard-empty">ðŸ“œ ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…</div>';
                return;
            }
            
            const categoryLabels = {
                wins: 'ÐŸÐ¾Ð±ÐµÐ´',
                winRate: 'Ð’Ð¸Ð½Ñ€ÐµÐ¹Ñ‚',
                profit: 'VP Ð²Ñ‹Ð¸Ð³Ñ€Ð°Ð½Ð¾',
                streak: 'Ð¡Ñ‚Ñ€Ð¸Ðº',
                biggestWin: 'ÐœÐ°ÐºÑ. ÑÑ‚Ñ€Ð¸Ðº'
            };
            
            let html = '<table class="leaderboard-table"><thead><tr>';
            html += '<th>#</th>';
            html += '<th>Ð˜Ð³Ñ€Ð¾Ðº</th>';
            html += `<th>${categoryLabels[currentLeaderboardCategory]}</th>`;
            html += '<th>Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°</th>';
            html += '</tr></thead><tbody>';
            
            entries.forEach(entry => {
                const rankClass = entry.rank <= 3 ? `top-${entry.rank}` : '';
                const avatar = entry.avatarUrl ? 
                    `<img src="${entry.avatarUrl}" style="width:32px;height:32px;border-radius:50%;">` : 
                    'ðŸ‘¤';
                
                let valueDisplay = entry.value;
                if (currentLeaderboardCategory === 'winRate') {
                    valueDisplay = entry.value + '%';
                } else if (currentLeaderboardCategory === 'profit') {
                    valueDisplay = entry.value.toLocaleString() + ' VP';
                }
                
                html += `<tr${entry.userId === currentUserId ? ' class="leaderboard-my-position"' : ''}>`;
                html += `<td class="leaderboard-rank ${rankClass}">${entry.rank}</td>`;
                html += `<td><div class="leaderboard-player"><div class="leaderboard-avatar">${avatar}</div><span>${escapeHtml(entry.displayName)}</span></div></td>`;
                html += `<td class="leaderboard-value">${valueDisplay}</td>`;
                html += `<td class="leaderboard-stats">${entry.stats.wins}âœ¦/${entry.stats.losses}âœ–<br>${entry.stats.totalMatches} Ð¼Ð°Ñ‚Ñ‡ÐµÐ¹</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            body.innerHTML = html;
            
            // Update pagination
            const totalPages = Math.ceil(total / LEADERBOARD_LIMIT);
            const currentPage = Math.floor(currentLeaderboardOffset / LEADERBOARD_LIMIT) + 1;
            document.getElementById('leaderboardPage').textContent = `${currentPage} / ${totalPages}`;
            document.getElementById('leaderboardPagination').style.display = totalPages > 1 ? 'flex' : 'none';
        }

        async function loadMyLeaderboardPosition() {
            try {
                const res = await fetch(`${API_URL}/leaderboard/me?category=${currentLeaderboardCategory}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) return;
                
                const data = await res.json();
                if (data && data.rank) {
                    // Add my position at the bottom if not in current view
                    const existingRow = document.querySelector('.leaderboard-my-position');
                    if (!existingRow) {
                        const tbody = document.querySelector('.leaderboard-table tbody');
                        if (tbody) {
                            const categoryLabels = {
                                wins: 'ÐŸÐ¾Ð±ÐµÐ´',
                                winRate: 'Ð’Ð¸Ð½Ñ€ÐµÐ¹Ñ‚',
                                profit: 'VP Ð²Ñ‹Ð¸Ð³Ñ€Ð°Ð½Ð¾',
                                streak: 'Ð¡Ñ‚Ñ€Ð¸Ðº',
                                biggestWin: 'ÐœÐ°ÐºÑ. ÑÑ‚Ñ€Ð¸Ðº'
                            };
                            
                            let valueDisplay = data.value;
                            if (currentLeaderboardCategory === 'winRate') {
                                valueDisplay = data.value + '%';
                            } else if (currentLeaderboardCategory === 'profit') {
                                valueDisplay = data.value.toLocaleString() + ' VP';
                            }
                            
                            const avatar = data.avatarUrl ? 
                                `<img src="${data.avatarUrl}" style="width:32px;height:32px;border-radius:50%;">` : 
                                'ðŸ‘¤';
                            
                            const html = `<tr class="leaderboard-my-position">
                                <td class="leaderboard-rank">${data.rank}</td>
                                <td><div class="leaderboard-player"><div class="leaderboard-avatar">${avatar}</div><span>${escapeHtml(data.displayName)} (Ð²Ñ‹)</span></div></td>
                                <td class="leaderboard-value">${valueDisplay}</td>
                                <td class="leaderboard-stats">${data.stats.wins}âœ¦/${data.stats.losses}âœ–<br>${data.stats.totalMatches} Ð¼Ð°Ñ‚Ñ‡ÐµÐ¹</td>
                            </tr>`;
                            tbody.insertAdjacentHTML('beforeend', html);
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to load my position:', e);
            }
        }

        function loadLeaderboardPrev() {
            if (currentLeaderboardOffset >= LEADERBOARD_LIMIT) {
                currentLeaderboardOffset -= LEADERBOARD_LIMIT;
                loadLeaderboard();
            }
        }

        function loadLeaderboardNext() {
            currentLeaderboardOffset += LEADERBOARD_LIMIT;
            loadLeaderboard();
        }

        // Unified Stats Modal with Tabs
        let currentStatsTab = 'overview';

        async function showStatsModal() {
            sounds.click();
            if (!token) {
                log('âŒ Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ');
                return;
            }
            document.getElementById('statsModal').classList.add('show');
            // Load default tab
            await loadStatsTab('overview');
        }

        async function switchStatsTab(tabName) {
            sounds.click();
            currentStatsTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.stats-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Load tab content
            await loadStatsTab(tabName);
        }

        async function loadStatsTab(tabName) {
            const body = document.getElementById('statsModalBody');
            body.innerHTML = '<div style="text-align:center;padding:20px;">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...</div>';
            
            try {
                switch(tabName) {
                    case 'overview':
                        await loadOverviewTab(body);
                        break;
                    case 'matches':
                        await loadMatchesTab(body);
                        break;
                    case 'finance':
                        await loadFinanceTab(body);
                        break;
                }
            } catch (e) {
                body.innerHTML = '<div style="color:#f87171;text-align:center;">âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸</div>';
            }
        }

        async function loadOverviewTab(body) {
            const r = await fetch(`${API_URL}/auth/stats`, { headers: { "Authorization": "Bearer " + token } });
            const s = await r.json();
            const winColor = s.winRate >= 50 ? '#4ade80' : (s.winRate >= 30 ? '#ffd700' : '#f87171');
            
            // Calculate angles for pie chart
            const total = s.wins + s.losses;
            const winAngle = total > 0 ? (s.wins / total) * 360 : 0;
            
            body.innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;">
                    <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                        <div style="font-size:2em;font-weight:bold;color:#ffd700;margin-bottom:5px;">${s.totalMatches}</div>
                        <div style="font-size:0.9em;opacity:0.8;">Ð’ÑÐµÐ³Ð¾ Ð¼Ð°Ñ‚Ñ‡ÐµÐ¹</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                        <div style="font-size:2em;font-weight:bold;color:${winColor};margin-bottom:5px;">${s.winRate}%</div>
                        <div style="font-size:0.9em;opacity:0.8;">Ð’Ð¸Ð½Ñ€ÐµÐ¹Ñ‚</div>
                        <div style="width:100%;height:10px;background:rgba(255,255,255,0.1);border-radius:5px;overflow:hidden;margin-top:8px;">
                            <div style="height:100%;background:linear-gradient(90deg,#4ade80,#ffd700);width:${s.winRate}%"></div>
                        </div>
                    </div>
                    <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                        <div style="font-size:2em;font-weight:bold;color:#4ade80;margin-bottom:5px;">${s.wins}</div>
                        <div style="font-size:0.9em;opacity:0.8;">ÐŸÐ¾Ð±ÐµÐ´</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                        <div style="font-size:2em;font-weight:bold;color:#f87171;margin-bottom:5px;">${s.losses}</div>
                        <div style="font-size:0.9em;opacity:0.8;">ÐŸÐ¾Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹</div>
                    </div>
                </div>
                
                <!-- Pie Chart -->
                ${total > 0 ? `
                <div style="text-align:center;margin:20px 0;">
                    <div style="font-size:0.9em;opacity:0.8;margin-bottom:10px;">ÐŸÐ¾Ð±ÐµÐ´Ñ‹ / ÐŸÐ¾Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ</div>
                    <div style="width:150px;height:150px;margin:0 auto;border-radius:50%;background:conic-gradient(#4ade80 0deg ${winAngle}deg, #f87171 ${winAngle}deg 360deg);position:relative;">
                        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card-bg);width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8em;">
                            ${s.wins}:${s.losses}
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.2);">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>ðŸ”¥ Ð¡ÐµÑ€Ð¸Ñ:</span><strong>${s.winStreak} (Ð¼Ð°ÐºÑ: ${s.maxWinStreak})</strong></div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>ðŸ’° Ð’Ñ‹Ð¸Ð³Ñ€Ð°Ð½Ð¾:</span><strong style="color:#4ade80">${s.totalWonVp.toLocaleString()} VP</strong></div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>ðŸ’¸ ÐŸÑ€Ð¾Ð¸Ð³Ñ€Ð°Ð½Ð¾:</span><strong style="color:#f87171">${s.totalLostVp.toLocaleString()} VP</strong></div>
                    <div style="display:flex;justify-content:space-between;"><span>ðŸŽ¯ ÐœÐ°ÐºÑ. Ð²Ñ‹Ð¸Ð³Ñ€Ñ‹Ñˆ:</span><strong style="color:#ffd700">${s.biggestWinVp.toLocaleString()} VP</strong></div>
                </div>`;
        }

        async function loadMatchesTab(body) {
            const r = await fetch(`${API_URL}/matchmaking/history`, { headers: { "Authorization": "Bearer " + token } });
            const data = await r.json();
            
            if (data.error) {
                body.innerHTML = `<div style="text-align:center;padding:20px;color:#f87171;">ÐžÑˆÐ¸Ð±ÐºÐ°: ${data.error}</div>`;
                return;
            }
            
            if (!data.matches || data.matches.length === 0) {
                body.innerHTML = '<div style="text-align:center;padding:40px;opacity:0.7;">ðŸŽ® Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¼Ð°Ñ‚Ñ‡ÐµÐ¹ Ð¿ÑƒÑÑ‚Ð°</div>';
                return;
            }
            
            let html = '<div style="max-height:400px;overflow-y:auto;">';
            data.matches.forEach(m => {
                const isWin = m.winnerId === userId;
                const profit = isWin ? (m.payout - m.stake) : -m.stake;
                const date = new Date(m.finishedAt).toLocaleString();
                const profitColor = profit > 0 ? '#4ade80' : (profit < 0 ? '#f87171' : '#aaa');
                const profitSign = profit > 0 ? '+' : '';
                
                html += `
                    <div style="background:rgba(255,255,255,0.05);padding:12px;margin-bottom:8px;border-radius:8px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                            <strong>${isWin ? 'ðŸ† ÐŸÐ¾Ð±ÐµÐ´Ð°' : 'ðŸ’€ ÐŸÐ¾Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ'}</strong>
                            <span style="color:${profitColor};font-weight:bold;">${profitSign}${profit} VP</span>
                        </div>
                        <div style="font-size:0.85em;opacity:0.7;">Ð¡Ñ‚Ð°Ð²ÐºÐ°: ${m.stake} VP | Ð’Ñ‹Ð¿Ð»Ð°Ñ‚Ð°: ${m.payout} VP</div>
                        <div style="font-size:0.8em;opacity:0.5;margin-top:3px;">${date}</div>
                    </div>`;
            });
            html += '</div>';
            body.innerHTML = html;
        }

        async function loadFinanceTab(body) {
            // Load both reconcile and audit data
            const [reconcileRes, auditRes] = await Promise.all([
                fetch(`${API_URL}/wallet/reconcile`, { headers: { "Authorization": "Bearer " + token } }),
                fetch(`${API_URL}/auth/audit`, { headers: { "Authorization": "Bearer " + token } })
            ]);
            
            const d = await reconcileRes.json();
            const auditData = await auditRes.json();
            
            const statusColor = d.isBalanced ? '#4ade80' : '#f87171';
            const statusIcon = d.isBalanced ? 'âœ…' : 'âš ï¸';
            
            let html = `
                <!-- Reconcile Section -->
                <div style="text-align:center;margin-bottom:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:12px;">
                    <div style="font-size:2.5em;margin-bottom:10px;">${statusIcon}</div>
                    <div style="font-size:1.1em;font-weight:bold;color:${statusColor};">
                        ${d.isBalanced ? 'Ð‘Ð°Ð»Ð°Ð½Ñ Ð² Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ' : 'ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¾ Ñ€Ð°ÑÑ…Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ!'}
                    </div>
                    ${!d.isBalanced ? `<div style="color:#f87171;margin-top:5px;">Ð Ð°Ð·Ð½Ð¸Ñ†Ð°: ${d.discrepancy} VP</div>` : ''}
                </div>
                
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;">
                    <div style="background:rgba(255,255,255,0.1);padding:12px;border-radius:10px;text-align:center;">
                        <div style="font-size:1.5em;font-weight:bold;color:#4ade80;">${d.actualBalance.toLocaleString()}</div>
                        <div style="font-size:0.8em;opacity:0.7;">Ð¤Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.1);padding:12px;border-radius:10px;text-align:center;">
                        <div style="font-size:1.5em;font-weight:bold;color:#ffd700;">${d.expectedBalance.toLocaleString()}</div>
                        <div style="font-size:0.8em;opacity:0.7;">ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹</div>
                    </div>
                </div>
                
                <div style="margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1);">
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.9em;"><span>ðŸ’° Ð’Ñ‹Ð¸Ð³Ñ€Ð°Ð½Ð¾:</span><strong style="color:#4ade80">${d.stats.totalWon.toLocaleString()} VP</strong></div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.9em;"><span>ðŸ’¸ ÐŸÑ€Ð¾Ð¸Ð³Ñ€Ð°Ð½Ð¾:</span><strong style="color:#f87171">${d.stats.totalLost.toLocaleString()} VP</strong></div>
                    <div style="display:flex;justify-content:space-between;font-size:0.9em;"><span>ðŸ“Š Ð§Ð¸ÑÑ‚Ð°Ñ Ð¿Ñ€Ð¸Ð±Ñ‹Ð»ÑŒ:</span><strong style="color:${d.stats.netProfit >= 0 ? '#4ade80' : '#f87171'}">${d.stats.netProfit >= 0 ? '+' : ''}${d.stats.netProfit.toLocaleString()} VP</strong></div>
                </div>
                
                <!-- Recent Audit Logs -->
                <div style="font-size:0.9em;font-weight:bold;margin-bottom:10px;">ðŸ“œ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¸:</div>
            `;
            
            if (auditData.logs && auditData.logs.length > 0) {
                html += '<div style="max-height:200px;overflow-y:auto;">';
                auditData.logs.slice(0, 10).forEach(log => {
                    const date = new Date(log.createdAt).toLocaleString();
                    html += `
                        <div style="background:rgba(255,255,255,0.03);padding:8px;margin-bottom:5px;border-radius:6px;font-size:0.85em;">
                            <div style="display:flex;justify-content:space-between;">
                                <strong style="color:#ffd700;">${log.eventType}</strong>
                                <span style="opacity:0.5;font-size:0.75em;">${date}</span>
                            </div>
                        </div>`;
                });
                html += '</div>';
            } else {
                html += '<div style="text-align:center;padding:10px;opacity:0.5;font-size:0.9em;">ÐÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹</div>';
            }
            
            body.innerHTML = html;
        }

        // Legacy function redirects
        async function showAuditModal() { await showStatsModal(); await switchStatsTab('finance'); }
        function hideAuditModal() { hideStatsModal(); }
        async function showReconcileModal() { await showStatsModal(); await switchStatsTab('finance'); }
        function hideReconcileModal() { hideStatsModal(); }
        
        function hidePublicProfileModal() {
            document.getElementById('publicProfileModal').classList.remove('show');
        }

        // ðŸ› ï¸ Admin Panel Functions
        let adminCurrentPage = 1;
        
        async function showAdminPanel() {
            sounds.click();
            if (!token) {
                log('âŒ Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ');
                return;
            }
            
            document.getElementById('adminModal').classList.add('show');
            document.getElementById('adminBalanceSection').style.display = 'none';
            await loadAdminUsers();
        }
        
        function hideAdminPanel() {
            const modal = document.getElementById('adminModal');
            if (modal) modal.classList.remove('show');
            const balanceSection = document.getElementById('adminBalanceSection');
            if (balanceSection) balanceSection.style.display = 'none';
        }
        
        async function loadAdminUsers(page = 1) {
            adminCurrentPage = page;
            const search = document.getElementById('adminSearchInput').value;
            
            try {
                const response = await fetch(`${API_URL}/admin/users?page=${page}&limit=20${search ? '&search=' + encodeURIComponent(search) : ''}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error('Access denied or error');
                }
                
                const data = await response.json();
                renderAdminUsers(data.users, data.total);
            } catch (e) {
                console.error('loadAdminUsers error:', e);
                document.getElementById('adminUsersList').innerHTML = 
                    `<div style="text-align: center; padding: 20px; color: #ff6b6b;">âŒ ${e.message}</div>`;
            }
        }
        
        function renderAdminUsers(users, total) {
            const container = document.getElementById('adminUsersList');
            
            if (users.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px;">ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾</div>';
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <th style="padding: 10px; text-align: left;">ID</th>
                            <th style="padding: 10px; text-align: left;">Email/Ð˜Ð¼Ñ</th>
                            <th style="padding: 10px; text-align: right;">Ð‘Ð°Ð»Ð°Ð½Ñ</th>
                            <th style="padding: 10px; text-align: center;">Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            users.forEach(user => {
                const displayName = user.displayName || user.email || `Guest ${user.id.slice(0,8)}`;
                html += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 10px; font-family: monospace; font-size: 0.85em;">${user.id.slice(0,8)}...</td>
                        <td style="padding: 10px;">
                            ${user.isGuest ? 'ðŸ‘¤ ' : ''}${displayName}
                        </td>
                        <td style="padding: 10px; text-align: right;">
                            ${user.balanceWp.toLocaleString()} VP
                            ${user.frozenWp > 0 ? `<small style="color: #ffd700;">(${user.frozenWp} Ð·Ð°Ð¼Ð¾Ñ€Ð¾Ð¶ÐµÐ½Ð¾)</small>` : ''}
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            <button onclick="selectUserForBalance('${user.id}', '${displayName}', ${user.balanceWp})" 
                                    class="btn btn-primary" style="padding: 5px 10px; font-size: 0.85em;">
                                ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            // Pagination
            if (total > 20) {
                const totalPages = Math.ceil(total / 20);
                html += '<div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">';
                if (adminCurrentPage > 1) {
                    html += `<button onclick="loadAdminUsers(${adminCurrentPage - 1})" class="btn btn-secondary">â† ÐÐ°Ð·Ð°Ð´</button>`;
                }
                html += `<span style="padding: 8px;">Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° ${adminCurrentPage} Ð¸Ð· ${totalPages}</span>`;
                if (adminCurrentPage < totalPages) {
                    html += `<button onclick="loadAdminUsers(${adminCurrentPage + 1})" class="btn btn-secondary">Ð’Ð¿ÐµÑ€ÐµÐ´ â†’</button>`;
                }
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function searchAdminUsers() {
            loadAdminUsers(1);
        }
        
        function selectUserForBalance(userId, displayName, balance) {
            document.getElementById('adminSelectedUserId').value = userId;
            document.getElementById('adminSelectedUserName').textContent = displayName;
            document.getElementById('adminSelectedUserBalance').textContent = balance.toLocaleString();
            document.getElementById('adminBalanceAmount').value = '';
            document.getElementById('adminBalanceReason').value = '';
            document.getElementById('adminBalanceSection').style.display = 'block';
        }
        
        async function updateUserBalance() {
            const userId = document.getElementById('adminSelectedUserId').value;
            const amount = parseInt(document.getElementById('adminBalanceAmount').value);
            const reason = document.getElementById('adminBalanceReason').value;
            
            if (!userId || isNaN(amount)) {
                showToast('error', 'Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ');
                return;
            }
            
            if (!reason) {
                showToast('error', 'Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñƒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/admin/users/balance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ userId, amount, reason })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast('success', `âœ… Ð‘Ð°Ð»Ð°Ð½Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½: ${result.oldBalance} â†’ ${result.newBalance}`);
                    document.getElementById('adminBalanceSection').style.display = 'none';
                    loadAdminUsers(adminCurrentPage); // Refresh list
                } else {
                    showToast('error', result.message || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð±Ð°Ð»Ð°Ð½ÑÐ°');
                }
            } catch (e) {
                console.error('updateUserBalance error:', e);
                showToast('error', 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ‚Ð¸');
            }
        }
    </script>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="loginTitle">ðŸ”‘ Ð’Ñ…Ð¾Ð´</h3>
                <button class="modal-close" onclick="hideLoginModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="loginEmailLabel">Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" onkeydown="handleEnter(event, 'login')">
                </div>
                <div class="form-group">
                    <label id="loginPasswordLabel">ÐŸÐ°Ñ€Ð¾Ð»ÑŒ</label>
                    <div class="password-field">
                        <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="handleEnter(event, 'login')">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)">ðŸ‘ï¸</button>
                    </div>
                </div>
                <button class="btn btn-success btn-full" id="loginSubmitBtn" onclick="doLogin()">Ð’Ð¾Ð¹Ñ‚Ð¸</button>
                <div class="form-links">
                    <a href="#" id="forgotPasswordLink" onclick="showForgotModal(); hideLoginModal(); return false;">Ð—Ð°Ð±Ñ‹Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ?</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal-overlay" id="registerModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ðŸ“ Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ</h3>
                <button class="modal-close" onclick="hideRegisterModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com" onkeydown="handleEnter(event, 'register')">
                </div>
                <div class="form-group">
                    <label>Ð˜Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ</label>
                    <input type="text" id="registerUsername" placeholder="Username">
                </div>
                <div class="form-group">
                    <label id="linkPasswordLabel">ÐŸÐ°Ñ€Ð¾Ð»ÑŒ (Ð¼Ð¸Ð½. 6 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²)</label>
                    <div class="password-field">
                        <input type="password" id="registerPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="handleEnter(event, 'register')">
                        <button type="button" class="password-toggle" onclick="togglePassword('registerPassword', this)">ðŸ‘ï¸</button>
                    </div>
                </div>
                <button class="btn btn-success btn-full" onclick="doRegister()">Ð—Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒÑÑ</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="profileModalTitle">ðŸ‘¤ ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ</h3>
                <button class="modal-close" onclick="hideProfileModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="profile-section">
                    <div class="avatar-preview-large" id="profileAvatarPreview">
                        <img id="profileCurrentAvatar" src="" alt="avatar">
                    </div>
                    <div class="profile-info">
                        <div class="form-group">
                            <label id="profileDisplayNameLabel">ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÐ¼Ð¾Ðµ Ð¸Ð¼Ñ</label>
                            <input type="text" id="profileDisplayName" placeholder="Ð’Ð°ÑˆÐµ Ð¸Ð¼Ñ" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label id="profileGenderLabel">ÐŸÐ¾Ð»</label>
                            <select id="profileGender">
                                <option value="" id="genderNotSpecified">ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½</option>
                                <option value="male" id="genderMale">ÐœÑƒÐ¶ÑÐºÐ¾Ð¹</option>
                                <option value="female" id="genderFemale">Ð–ÐµÐ½ÑÐºÐ¸Ð¹</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="avatar-section" id="avatarSection">
                    <label id="profileAvatarLabel">Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð°Ð²Ð°Ñ‚Ð°Ñ€ÐºÑƒ</label>
                    <div class="avatar-tabs">
                        <button class="avatar-tab active" id="avatarTabMale" onclick="switchAvatarTab('male', this)">ÐœÑƒÐ¶ÑÐºÐ¸Ðµ</button>
                        <button class="avatar-tab" id="avatarTabFemale" onclick="switchAvatarTab('female', this)">Ð–ÐµÐ½ÑÐºÐ¸Ðµ</button>
                        <button class="avatar-tab" id="avatarTabCustom" onclick="switchAvatarTab('custom', this)">Ð¡Ð²Ð¾Ñ</button>
                    </div>
                    <div class="avatar-grid" id="maleAvatars"></div>
                    <div class="avatar-grid hidden" id="femaleAvatars"></div>
                    <div class="avatar-grid hidden" id="customAvatar">
                        <div class="upload-area" onclick="document.getElementById('avatarUpload').click()">
                            <span>ðŸ“· ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð¾Ñ‚Ð¾</span>
                            <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                        </div>
                    </div>
                </div>
                
                <div class="profile-actions">
                    <button class="btn btn-success btn-full" id="profileSaveBtn" onclick="saveProfile()">ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ</button>
                </div>
                
                <div class="profile-link-email" id="linkEmailSection" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <p id="profileGuestText">Ð’Ñ‹ Ð²Ð¾ÑˆÐ»Ð¸ ÐºÐ°Ðº Ð³Ð¾ÑÑ‚ÑŒ. ÐŸÑ€Ð¸Ð²ÑÐ¶Ð¸Ñ‚Ðµ email Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ°:</p>
                    <div class="form-group">
                        <input type="email" id="linkEmail" placeholder="your@email.com" onkeydown="handleEnter(event, 'linkEmail')">
                    </div>
                    <div class="form-group">
                        <div class="password-field">
                            <input type="password" id="linkPassword" placeholder="ÐŸÐ°Ñ€Ð¾Ð»ÑŒ (Ð¼Ð¸Ð½. 6 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²)" onkeydown="handleEnter(event, 'linkEmail')">
                            <button type="button" class="password-toggle" onclick="togglePassword('linkPassword', this)">ðŸ‘ï¸</button>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-full" id="linkEmailBtn" onclick="linkEmail()">ðŸ”— ÐŸÑ€Ð¸Ð²ÑÐ·Ð°Ñ‚ÑŒ email</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal-overlay" id="forgotModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ðŸ” Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ñ</h3>
                <button class="modal-close" onclick="hideForgotModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p class="form-info">Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ email Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑÑ‹Ð»ÐºÐ¸ Ð½Ð° ÑÐ±Ñ€Ð¾Ñ Ð¿Ð°Ñ€Ð¾Ð»Ñ</p>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="forgotEmail" placeholder="your@email.com">
                </div>
                <button class="btn btn-success btn-full" onclick="doForgotPassword()">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div class="modal-overlay" id="leaderboardModal" onclick="closeModal(event)">
        <div class="modal modal-large" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ðŸ† Ð¢Ð¾Ð¿ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²</h3>
                <button class="modal-close" onclick="hideLeaderboardModal()">Ã—</button>
            </div>
            <!-- Category Tabs -->
            <div class="stats-tabs" id="leaderboardTabs">
                <button class="stats-tab active" onclick="switchLeaderboardCategory('wins')" id="lb-tab-wins">ðŸ† ÐŸÐ¾Ð±ÐµÐ´Ñ‹</button>
                <button class="stats-tab" onclick="switchLeaderboardCategory('winRate')" id="lb-tab-winRate">ðŸ“ˆ Ð’Ð¸Ð½Ñ€ÐµÐ¹Ñ‚</button>
                <button class="stats-tab" onclick="switchLeaderboardCategory('profit')" id="lb-tab-profit">ðŸ’° ÐŸÑ€Ð¾Ñ„Ð¸Ñ‚</button>
                <button class="stats-tab" onclick="switchLeaderboardCategory('streak')" id="lb-tab-streak">ðŸ”¥ Ð¡Ñ‚Ñ€Ð¸Ðº</button>
                <button class="stats-tab" onclick="switchLeaderboardCategory('biggestWin')" id="lb-tab-biggestWin">â­ Ð ÐµÐºÐ¾Ñ€Ð´</button>
            </div>
            <div class="modal-body" id="leaderboardBody">
                <div class="leaderboard-loading">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...</div>
            </div>
            <!-- Pagination -->
            <div class="leaderboard-pagination" id="leaderboardPagination" style="display: none;">
                <button class="btn btn-secondary" onclick="loadLeaderboardPrev()">â† ÐÐ°Ð·Ð°Ð´</button>
                <span id="leaderboardPage">1</span>
                <button class="btn btn-secondary" onclick="loadLeaderboardNext()">Ð’Ð¿ÐµÑ€Ñ‘Ð´ â†’</button>
            </div>
        </div>
    </div>

    <!-- Unified Stats Modal with Tabs -->
    <div class="modal-overlay" id="statsModal" onclick="closeModal(event)">
        <div class="modal modal-large" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°</h3>
                <button class="modal-close" onclick="hideStatsModal()">Ã—</button>
            </div>
            <!-- Tabs -->
            <div class="stats-tabs">
                <button class="stats-tab active" onclick="switchStatsTab('overview')" id="tab-overview">ðŸ“ˆ ÐžÐ±Ð·Ð¾Ñ€</button>
                <button class="stats-tab" onclick="switchStatsTab('matches')" id="tab-matches">ðŸŽ® ÐœÐ°Ñ‚Ñ‡Ð¸</button>
                <button class="stats-tab" onclick="switchStatsTab('finance')" id="tab-finance">ðŸ’° Ð¤Ð¸Ð½Ð°Ð½ÑÑ‹</button>
            </div>
            <div class="modal-body" id="statsModalBody">
                <!-- Content loaded dynamically -->
                <div class="stats-loading">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...</div>
            </div>
        </div>
    </div>

    <!-- Public Profile Modal (for viewing other players) -->
    <div class="modal-overlay" id="publicProfileModal" onclick="closeModal(event)">
        <div class="modal modal-small" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ðŸ‘¤ ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¸Ð³Ñ€Ð¾ÐºÐ°</h3>
                <button class="modal-close" onclick="hidePublicProfileModal()">Ã—</button>
            </div>
            <div class="modal-body" id="publicProfileBody">
                <div class="public-profile">
                    <div class="profile-avatar-large" id="publicProfileAvatar"></div>
                    <h3 id="publicProfileName"></h3>
                    <div class="public-stats" id="publicProfileStats"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Admin Panel Modal -->
    <div class="modal-overlay" id="adminModal" onclick="hideAdminPanel()">
        <div class="modal modal-large" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>âš™ï¸ ÐÐ´Ð¼Ð¸Ð½ ÐŸÐ°Ð½ÐµÐ»ÑŒ</h3>
                <button class="modal-close" onclick="hideAdminPanel()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- User Search -->
                <div style="margin-bottom: 20px;">
                    <input type="text" id="adminSearchInput" placeholder="ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ email Ð¸Ð»Ð¸ Ð¸Ð¼ÐµÐ½Ð¸..." 
                           style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: inherit;">
                    <button onclick="searchAdminUsers()" class="btn btn-primary" style="margin-top: 10px;">ðŸ” ÐŸÐ¾Ð¸ÑÐº</button>
                </div>
                
                <!-- Users List -->
                <div id="adminUsersList" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; padding: 20px; color: #888;">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...</div>
                </div>
                
                <!-- Balance Update Section -->
                <div id="adminBalanceSection" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); display: none;">
                    <h4 style="margin-bottom: 15px;">ðŸ’° Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð±Ð°Ð»Ð°Ð½Ñ</h4>
                    <input type="hidden" id="adminSelectedUserId">
                    <div style="display: grid; gap: 10px;">
                        <div>
                            <label>ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ:</label>
                            <span id="adminSelectedUserName" style="font-weight: bold;"></span>
                        </div>
                        <div>
                            <label>Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð±Ð°Ð»Ð°Ð½Ñ:</label>
                            <span id="adminSelectedUserBalance"></span> VP
                        </div>
                        <div>
                            <label>Ð¡ÑƒÐ¼Ð¼Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ:</label>
                            <input type="number" id="adminBalanceAmount" placeholder="+100 Ð¸Ð»Ð¸ -50" 
                                   style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: inherit;">
                            <small style="color: #888;">ÐŸÐ¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ = Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ, Ð¾Ñ‚Ñ€Ð¸Ñ†Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ = ÑÐ½ÑÑ‚ÑŒ</small>
                        </div>
                        <div>
                            <label>ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°:</label>
                            <input type="text" id="adminBalanceReason" placeholder="Ð‘Ð¾Ð½ÑƒÑ Ð·Ð° Ñ‚ÑƒÑ€Ð½Ð¸Ñ€ / Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸" 
                                   style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: inherit;">
                        </div>
                        <button onclick="updateUserBalance()" class="btn btn-success" style="margin-top: 10px;">ðŸ’¾ ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confetti Canvas -->
    <canvas id="confettiCanvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;"></canvas>
    
    <!-- Toast Container -->
    <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none;"></div>
</body>
</html>