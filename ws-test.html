<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WagerPlay - Rock Paper Scissors</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23667eea'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3E%F0%9F%8E%AE%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            text-align: center;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        /* Balance Card */
        .balance-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .balance-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .balance-frozen {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Control Buttons */
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(17,153,142,0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(17,153,142,0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Game Area */
        .game-area {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            min-height: 300px;
        }

        .game-status {
            text-align: center;
            margin-bottom: 30px;
        }

        .status-text {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .match-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        /* Move Buttons */
        .moves-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .move-btn {
            width: 120px;
            height: 140px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 2px solid transparent;
        }

        .move-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.05);
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .move-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .move-btn.selected {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
            box-shadow: 0 0 30px rgba(255,215,0,0.5);
        }

        .move-emoji {
            font-size: 3em;
        }

        .move-text {
            font-size: 1.1em;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Players Grid */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .player-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .player-card.active {
            border-color: #38ef7d;
            background: rgba(56,239,125,0.1);
        }

        .player-card.eliminated {
            opacity: 0.4;
            border-color: #ff4757;
        }

        .player-card.winner {
            border-color: #ffd700;
            background: rgba(255,215,0,0.2);
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }

        .player-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .player-move {
            font-size: 2em;
            margin: 10px 0;
        }

        .player-status {
            font-size: 0.8em;
            opacity: 0.8;
        }

        /* Round Info */
        .round-info {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .round-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #ffd700;
        }

        /* Log */
        .log-container {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            opacity: 0.5;
            margin-right: 10px;
        }

        /* Waiting Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .waiting {
            animation: pulse 1.5s infinite;
            text-align: center;
            font-size: 1.2em;
            padding: 40px;
        }

        .hidden {
            display: none !important;
        }

        /* Sound toggle */
        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sound-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* Language Selector */
        .lang-selector {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .lang-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .lang-btn.active {
            border-color: #ffd700;
            background: rgba(255,215,0,0.3);
        }

        /* Player Selector */
        .player-selector {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .selector-label {
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .selector-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .selector-btn {
            padding: 10px 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .selector-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
        }

        .selector-btn.active {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
            color: #ffd700;
        }

        /* Dropdown Play Button */
        .dropdown-play {
            position: relative;
            display: flex;
            align-items: center;
        }

        .btn-play-main {
            border-radius: 12px 0 0 12px;
            padding-right: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-play-arrow {
            border-radius: 0 12px 12px 0;
            padding: 12px 15px;
            margin-left: 2px;
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }

        .btn-play-arrow:hover {
            transform: translateY(-2px);
        }

        .btn-play-arrow.active {
            background: rgba(255,215,0,0.5);
        }

        .player-count-badge {
            background: rgba(255,215,0,0.8);
            color: #1e3c72;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: bold;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            background: rgba(30, 60, 114, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            overflow: hidden;
            z-index: 100;
            min-width: 150px;
        }

        .dropdown-menu.show {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .dropdown-item.selected {
            background: rgba(255,215,0,0.3);
        }

        .dropdown-players {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .dropdown-item.selected .dropdown-players {
            background: #ffd700;
            color: #1e3c72;
        }

        .dropdown-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Chat */
        .chat-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
            overflow: hidden;
            display: none;
        }

        .chat-container.active {
            display: block;
        }

        .chat-header {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .chat-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            max-width: 300px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }

        .chat-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .chat-tabs::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }

        .chat-tab {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-tab.active {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
            color: #ffd700;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .chat-message.system {
            background: rgba(255,215,0,0.2);
            text-align: center;
            font-style: italic;
        }

        .chat-author {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 3px;
        }

        .chat-time {
            font-size: 0.75em;
            opacity: 0.6;
            margin-left: 10px;
        }

        .chat-input-area {
            display: flex;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            outline: none;
        }

        .chat-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .chat-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-send:hover {
            transform: scale(1.1);
        }

        .chat-closed {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
            font-style: italic;
        }

        /* Auth Buttons */
        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.1);
            padding: 8px 20px;
            border-radius: 25px;
        }

        .user-email {
            font-weight: 600;
            color: #ffd700;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1em;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .form-group input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .btn-full {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
        }

        .form-links {
            text-align: center;
            margin-top: 20px;
        }

        .form-links a {
            color: #ffd700;
            text-decoration: none;
            font-size: 0.9em;
        }

        .form-links a:hover {
            text-decoration: underline;
        }

        .form-info {
            text-align: center;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        /* Profile Modal Styles */
        .profile-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .avatar-preview-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid #667eea;
            flex-shrink: 0;
        }

        .avatar-preview-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
        }

        .profile-info select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            color: white;
            font-size: 1em;
        }

        .profile-info select option {
            background: #2a5298;
            color: white;
        }

        .avatar-section {
            margin-bottom: 20px;
        }

        .avatar-section > label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .avatar-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .avatar-tab {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .avatar-tab.active {
            background: #667eea;
        }

        .avatar-tab:hover {
            background: rgba(255,255,255,0.2);
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .avatar-item {
            aspect-ratio: 1;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .avatar-item:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .avatar-item.selected {
            border-color: #00d9ff;
            box-shadow: 0 0 10px rgba(0,217,255,0.5);
        }

        .avatar-item img {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }

        .upload-area {
            grid-column: 1 / -1;
            height: 100px;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102,126,234,0.1);
        }

        .user-avatar-mini {
            transition: transform 0.3s;
        }

        .user-avatar-mini:hover {
            transform: scale(1.1);
        }

        .profile-link-email p {
            margin-bottom: 10px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <button class="sound-toggle" onclick="toggleSound()" title="–í–∫–ª/–≤—ã–∫–ª –∑–≤—É–∫">üîä</button>

    <div class="container">
        <!-- Language Selector -->
        <div class="lang-selector">
            <button class="lang-btn" onclick="setLang('ru')" id="lang-ru">üá∑üá∫</button>
            <button class="lang-btn" onclick="setLang('en')" id="lang-en">üá¨üáß</button>
            <button class="lang-btn" onclick="setLang('cn')" id="lang-cn">üá®üá≥</button>
        </div>

        <h1>üéÆ WagerPlay</h1>
        <p class="subtitle">Rock Paper Scissors - –ò–≥—Ä–∞–π –∏ –≤—ã–∏–≥—Ä—ã–≤–∞–π!</p>

        <!-- Balance -->
        <div class="balance-card">
            <div class="balance-label">üí∞ –í–ê–® –ë–ê–õ–ê–ù–°</div>
            <div class="balance-amount" id="balanceDisplay">0 VP</div>
            <div class="balance-frozen" id="frozenDisplay"></div>
        </div>

        <!-- Controls -->
        <div class="controls" id="authControls">
            <!-- Not logged in -->
            <div class="auth-buttons" id="authButtons">
                <button class="btn btn-success" onclick="showLoginModal()">üîë –í–æ–π—Ç–∏</button>
                <button class="btn btn-primary" onclick="showRegisterModal()">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                <button class="btn btn-secondary" onclick="doGuest()">üë§ Guest</button>
            </div>
            
            <!-- Logged in -->
            <div class="user-info hidden" id="userInfo">
                <span class="user-email" id="userEmail"></span>
                <img id="userAvatar" class="user-avatar-mini" src="" alt="avatar" onclick="showProfileModal()" style="cursor: pointer; width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; display: none;">
                <button class="btn btn-secondary" onclick="showProfileModal()">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
                <button class="btn btn-secondary" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
            
            <button class="btn btn-primary" id="btnConnect" onclick="doConnect()" disabled>üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            
            <!-- Dropdown Play Button -->
            <div class="dropdown-play" id="dropdownPlay">
                <button class="btn btn-primary btn-play-main" id="btnQuickplay" onclick="doQuickplay()" disabled>
                    üéÆ <span id="playBtnText">–ò–≥—Ä–∞—Ç—å 2 | 100 VP</span> <span class="player-count-badge" id="playerBadge">2</span>
                </button>
                <button class="btn btn-primary btn-play-arrow" id="btnPlayArrow" onclick="togglePlayerDropdown()" disabled>
                    ‚ñ≤
                </button>
                <div class="dropdown-menu" id="playerDropdown">
                    <div class="dropdown-item" onclick="selectPlayersDropdown(2)">
                        <span class="dropdown-players">2</span>
                        <span class="dropdown-label">–∏–≥—Ä–æ–∫–∞</span>
                    </div>
                    <div class="dropdown-item" onclick="selectPlayersDropdown(3)">
                        <span class="dropdown-players">3</span>
                        <span class="dropdown-label">–∏–≥—Ä–æ–∫–∞</span>
                    </div>
                    <div class="dropdown-item" onclick="selectPlayersDropdown(4)">
                        <span class="dropdown-players">4</span>
                        <span class="dropdown-label">–∏–≥—Ä–æ–∫–∞</span>
                    </div>
                    <div class="dropdown-item" onclick="selectPlayersDropdown(5)">
                        <span class="dropdown-players">5</span>
                        <span class="dropdown-label">–∏–≥—Ä–æ–∫–æ–≤</span>
                    </div>
                </div>
            </div>
            
            <!-- Stake Selection Dropdown -->
            <div class="dropdown-play" id="dropdownStake" style="margin-left: 8px;">
                <button class="btn btn-primary btn-play-main" id="btnStake" onclick="toggleStakeDropdown()" disabled>
                    üí∞ <span id="stakeBtnText">100</span> VP
                </button>
                <button class="btn btn-primary btn-play-arrow" id="btnStakeArrow" onclick="toggleStakeDropdown()" disabled>
                    ‚ñ≤
                </button>
                <div class="dropdown-menu" id="stakeDropdown">
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(100)">
                        <span class="dropdown-players">100</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(200)">
                        <span class="dropdown-players">200</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(500)">
                        <span class="dropdown-players">500</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(1000)">
                        <span class="dropdown-players">1K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(2500)">
                        <span class="dropdown-players">2.5K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(5000)">
                        <span class="dropdown-players">5K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(10000)">
                        <span class="dropdown-players">10K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" id="btnBalance" onclick="doCheckBalance()" disabled>üí≥ –ë–∞–ª–∞–Ω—Å</button>
            <button class="btn btn-primary" id="btnStats" onclick="doShowStats()" disabled>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class="btn btn-primary" id="btnLogs" onclick="showLogsInChat()" disabled>üìã –õ–æ–≥–∏</button>
        </div>

        <!-- Game Area -->
        <div class="game-area">
            <div id="gameContent">
                <div class="waiting" id="waitingText">Press "Guest Login" to start</div>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <span>üí¨ –ß–ê–¢</span>
                <div class="chat-tabs" id="chatTabsContainer">
                    <button class="chat-tab active" onclick="switchChatTab('global')" id="tab-global">–û–±—â–∏–π</button>
                    <!-- Game tabs will be added here dynamically -->
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleChatKeypress(event)">
                <button class="chat-send" onclick="sendChatMessage()">‚û§</button>
            </div>
        </div>

        <!-- Log -->
        <div class="log-container" id="log">
            <div class="log-entry"><span class="log-time">[System]</span> –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ WagerPlay!</div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // API Config
        const API_URL = ''; // –ü—É—Å—Ç–æ –¥–ª—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ localhost –∏ ngrok)
        
        // Game State
        let token = "";
        let userId = "";
        let matchId = "";
        let socket = null;
        let soundEnabled = true;
        let currentMatch = null;
        let countdownInterval = null;
        let isProcessing = {
            guest: false,
            connect: false,
            quickplay: false,
            move: false
        };
        let currentLang = 'ru';

        // Translations
        const i18n = {
            ru: {
                title: 'WagerPlay - Rock Paper Scissors',
                subtitle: '–ò–≥—Ä–∞–π –∏ –≤—ã–∏–≥—Ä—ã–≤–∞–π!',
                balance: '–í–ê–® –ë–ê–õ–ê–ù–°',
                frozen: '–ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ',
                guest: 'üë§ Guest Login',
                connect: 'üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è',
                quickplay: 'üéÆ –ò–≥—Ä–∞—Ç—å 4/100',
                balanceBtn: 'üí≥ –ë–∞–ª–∞–Ω—Å',
            statsBtn: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                waitingGuest: '–ù–∞–∂–º–∏—Ç–µ "Guest Login" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å',
                waitingQueue: '–í –æ—á–µ—Ä–µ–¥–∏...',
                searching: '–ò—â–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤...',
                yourTurn: 'üéÆ –í–ê–® –•–û–î!',
                waitingTurn: '‚è≥ –û–ñ–ò–î–ê–ù–ò–ï',
                victory: 'üèÜ –ü–û–ë–ï–î–ê!',
                defeat: 'üíÄ –ü–û–†–ê–ñ–ï–ù–ò–ï',
                round: '–†–∞—É–Ω–¥',
                pot: '–ë–∞–Ω–∫',
                stake: '–°—Ç–∞–≤–∫–∞',
                payout: '–í—ã–ø–ª–∞—Ç–∞',
                winner: '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å',
                eliminated: '–í—ã–±—ã–ª',
                inGame: '–í –∏–≥—Ä–µ',
                rock: '–ö–∞–º–µ–Ω—å',
                paper: '–ë—É–º–∞–≥–∞',
                scissors: '–ù–æ–∂–Ω–∏—Ü—ã',
                playAgain: 'üîÑ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞',
                tie: 'ü§ù –ù–∏—á—å—è',
                elimination: '‚öîÔ∏è –í—ã–±—ã–≤–∞–Ω–∏–µ',
                wonWith: '–ü–æ–±–µ–¥–∏–ª',
                chat: 'üí¨ –ß–ê–¢',
                global: '–û–±—â–∏–π',
                game: '–ò–≥—Ä–∞',
                chatPlaceholder: '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...',
                players2: '2 –∏–≥—Ä–æ–∫–∞',
                players3: '3 –∏–≥—Ä–æ–∫–∞',
                players4: '4 –∏–≥—Ä–æ–∫–∞',
                selectPlayers: '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:',
                you: '–í—ã',
                alreadyInQueue: '–í—ã —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏!',
                chatWillClose: '–ß–∞—Ç –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã',
                gameStarted: '–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –£–¥–∞—á–∏!',
                login: '–í–æ–π—Ç–∏',
                register: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                logout: '–í—ã–π—Ç–∏',
                guest: 'Guest'
            },
            en: {
                title: 'WagerPlay - Rock Paper Scissors',
                subtitle: 'Play and Win!',
                balance: 'YOUR BALANCE',
                frozen: 'Frozen',
                guest: 'üë§ Guest Login',
                connect: 'üîó Connect',
                quickplay: 'üéÆ Quickplay 4/100',
                balanceBtn: 'üí≥ Balance',
                waitingGuest: 'Press "Guest Login" to start',
                waitingQueue: 'In queue...',
                searching: 'Searching for players...',
                yourTurn: 'üéÆ YOUR TURN!',
                waitingTurn: '‚è≥ WAITING',
                victory: 'üèÜ VICTORY!',
                defeat: 'üíÄ DEFEAT',
                round: 'Round',
                pot: 'Pot',
                stake: 'Stake',
                payout: 'Payout',
                winner: 'Winner',
                eliminated: 'Eliminated',
                inGame: 'In game',
                rock: 'Rock',
                paper: 'Paper',
                scissors: 'Scissors',
                playAgain: 'üîÑ Play Again',
                tie: 'ü§ù Tie',
                elimination: '‚öîÔ∏è Elimination',
                wonWith: 'Won with',
                chat: 'üí¨ CHAT',
                global: 'Global',
                game: 'Game',
                chatPlaceholder: 'Type message...',
                players2: '2 Players',
                players3: '3 Players',
                players4: '4 Players',
                selectPlayers: 'Select mode:',
                you: 'You',
                alreadyInQueue: 'Already in queue!',
                chatWillClose: 'Chat will close in 2 minutes',
                gameStarted: 'Game started! Good luck!',
                login: 'Login',
                register: 'Register',
                logout: 'Logout',
                guest: 'Guest'
            },
            cn: {
                title: 'WagerPlay - Áü≥Â§¥Ââ™ÂàÄÂ∏É',
                subtitle: 'Áé©Ê∏∏ÊàèÔºåËµ¢Â§ßÂ•ñÔºÅ',
                balance: 'ÊÇ®ÁöÑ‰ΩôÈ¢ù',
                frozen: 'ÂÜªÁªì',
                guest: 'üë§ Ê∏∏ÂÆ¢ÁôªÂΩï',
                connect: 'üîó ËøûÊé•',
                quickplay: 'üéÆ Âø´ÈÄüÊ∏∏Êàè 4/100',
                balanceBtn: 'üí≥ ‰ΩôÈ¢ù',
                waitingGuest: 'ÁÇπÂáª"Ê∏∏ÂÆ¢ÁôªÂΩï"ÂºÄÂßã',
                waitingQueue: 'ÊéíÈòü‰∏≠...',
                searching: 'ÂØªÊâæÁé©ÂÆ∂...',
                yourTurn: 'üéÆ ËΩÆÂà∞ÊÇ®ÔºÅ',
                waitingTurn: '‚è≥ Á≠âÂæÖ‰∏≠',
                victory: 'üèÜ ËÉúÂà©ÔºÅ',
                defeat: 'üíÄ Â§±Ë¥•',
                round: 'ÂõûÂêà',
                pot: 'Â•ñÊ±†',
                stake: 'ËµåÊ≥®',
                payout: 'Â•ñÈáë',
                winner: 'Ëµ¢ÂÆ∂',
                eliminated: 'Â∑≤Ê∑òÊ±∞',
                inGame: 'Ê∏∏Êàè‰∏≠',
                rock: 'Áü≥Â§¥',
                paper: 'Â∏É',
                scissors: 'Ââ™ÂàÄ',
                playAgain: 'üîÑ ÂÜçÁé©‰∏ÄÊ¨°',
                tie: 'ü§ù Âπ≥Â±Ä',
                elimination: '‚öîÔ∏è Ê∑òÊ±∞',
                wonWith: 'Ëé∑ËÉú',
                chat: 'üí¨ ËÅäÂ§©',
                global: 'ÂÖ®Â±Ä',
                game: 'Ê∏∏Êàè',
                chatPlaceholder: 'ËæìÂÖ•Ê∂àÊÅØ...',
                players2: '2‰∫∫',
                players3: '3‰∫∫',
                players4: '4‰∫∫',
                selectPlayers: 'ÈÄâÊã©Ê®°ÂºèÔºö',
                you: 'ÊÇ®',
                alreadyInQueue: 'Â∑≤ÁªèÂú®ÈòüÂàó‰∏≠ÔºÅ',
                chatWillClose: 'ËÅäÂ§©Â∞ÜÂú®2ÂàÜÈíüÂêéÂÖ≥Èó≠',
                gameStarted: 'Ê∏∏ÊàèÂºÄÂßãÔºÅÁ•ù‰Ω†Â•ΩËøêÔºÅ',
                login: 'ÁôªÂΩï',
                register: 'Ê≥®ÂÜå',
                logout: 'ÈÄÄÂá∫',
                guest: 'Ê∏∏ÂÆ¢'
            }
        };

        function t(key) {
            return i18n[currentLang][key] || key;
        }

        function setLang(lang) {
            currentLang = lang;
            const btnGuest = document.getElementById('btnGuest');
            const btnConnect = document.getElementById('btnConnect');
            const playBtnText = document.getElementById('playBtnText');
            const btnBalance = document.getElementById('btnBalance');
            const subtitle = document.querySelector('.subtitle');
            const balanceLabel = document.querySelector('.balance-label');
            
            if (btnGuest) btnGuest.textContent = t('guest');
            if (btnConnect) btnConnect.textContent = t('connect');
            if (playBtnText) playBtnText.textContent = t('quickplay');
            if (btnBalance) btnBalance.textContent = t('balanceBtn');
            const btnStats = document.getElementById('btnStats');
            if (btnStats) btnStats.textContent = t('statsBtn');
            if (subtitle) subtitle.textContent = t('subtitle');
            if (balanceLabel) balanceLabel.textContent = 'üí∞ ' + t('balance');
            
            // Update language buttons
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            const langBtn = document.getElementById(`lang-${lang}`);
            if (langBtn) langBtn.classList.add('active');
            
            // Refresh match display if exists
            if (currentMatch) renderMatch(currentMatch);
        }

        // Player Selection
        let selectedPlayers = 2;
        let selectedStake = 100; // –î–µ—Ñ–æ–ª—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞
        let currentChatTab = 'global';
        let currentGameChatId = null; // ID —Ç–µ–∫—É—â–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ –∏–≥—Ä—ã
        let gameChatTimeouts = {}; // –¢–∞–π–º–µ—Ä—ã –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –∏–≥—Ä—ã { matchId: timeout }

        function selectPlayers(count) {
            if (isProcessing.quickplay) {
                sounds.error();
                return;
            }
            selectedPlayers = count;
            // Update badge on main button
            document.getElementById('playerBadge').textContent = count;
            // Update dropdown selection
            updateDropdownSelection(count);
            sounds.click();
            log(`${t('selectPlayers')} ${count}`);
        }

        function togglePlayerDropdown() {
            const dropdown = document.getElementById('playerDropdown');
            const arrow = document.getElementById('btnPlayArrow');
            dropdown.classList.toggle('show');
            arrow.classList.toggle('active');
            // Close stake dropdown if open
            document.getElementById('stakeDropdown').classList.remove('show');
            document.getElementById('btnStakeArrow').classList.remove('active');
            sounds.click();
        }
        
        function toggleStakeDropdown() {
            const dropdown = document.getElementById('stakeDropdown');
            const arrow = document.getElementById('btnStakeArrow');
            dropdown.classList.toggle('show');
            arrow.classList.toggle('active');
            // Close player dropdown if open
            document.getElementById('playerDropdown').classList.remove('show');
            document.getElementById('btnPlayArrow').classList.remove('active');
            sounds.click();
        }
        
        function selectStakeDropdown(stake) {
            selectedStake = stake;
            const stakeText = stake >= 1000 ? (stake/1000) + 'K' : stake;
            document.getElementById('stakeBtnText').textContent = stakeText;
            
            // Update selection visual
            document.querySelectorAll('.stake-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Close dropdown
            document.getElementById('stakeDropdown').classList.remove('show');
            document.getElementById('btnStakeArrow').classList.remove('active');
            
            sounds.click();
            log(`üí∞ –°—Ç–∞–≤–∫–∞: ${stake} VP`);
        }

        function selectPlayersDropdown(count) {
            selectedPlayers = count;
            document.getElementById('playerBadge').textContent = count;
            updateDropdownSelection(count);
            
            // Update button text with selected player count and stake
            const btnText = document.getElementById('playBtnText');
            const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
            if (btnText) {
                btnText.textContent = `–ò–≥—Ä–∞—Ç—å ${count} | ${stakeText} VP`;
            }
            
            // Close dropdown
            document.getElementById('playerDropdown').classList.remove('show');
            document.getElementById('btnPlayArrow').classList.remove('active');
            
            sounds.click();
            log(`${t('selectPlayers')} ${count}`);
        }

        function updateDropdownSelection(count) {
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('selected');
            });
            // Select the item (based on index 0=2, 1=3, 2=4, 3=5)
            const items = document.querySelectorAll('.dropdown-item');
            if (items[count - 2]) {
                items[count - 2].classList.add('selected');
            }
        }

        // Chat Functions - Each game has its own chat
        function switchChatTab(tab, gameId = null) {
            currentChatTab = tab;
            if (gameId) currentGameChatId = gameId;
            
            // Update UI tabs - remove active from all
            document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
            
            // Activate correct tab
            if (tab === 'global') {
                document.getElementById('tab-global').classList.add('active');
            } else if (tab === 'game' && currentGameChatId) {
                const tabId = `tab-game-${currentGameChatId}`;
                const gameTab = document.getElementById(tabId);
                if (gameTab) gameTab.classList.add('active');
            }
            
            // Update chat title
            const chatTitle = document.querySelector('.chat-header span');
            if (tab === 'global') {
                chatTitle.textContent = 'üí¨ ' + t('chat') + ' - ' + t('global');
            } else if (tab === 'game' && currentGameChatId) {
                const shortId = currentGameChatId.slice(0, 8);
                chatTitle.textContent = `üí¨ Game #${shortId}`;
            }
            
            renderChatMessages();
            sounds.click();
        }

        function showChat() {
            const chat = document.getElementById('chatContainer');
            chat.classList.add('active');
            chat.style.display = 'block';
        }

        function hideChat() {
            const chat = document.getElementById('chatContainer');
            chat.classList.remove('active');
            chat.style.display = 'none';
        }

        function createGameChat(gameMatchId) {
            console.log('Creating game chat for:', gameMatchId);
            if (!window.chatHistory) window.chatHistory = { global: [], games: {} };
            if (!window.chatHistory.games) window.chatHistory.games = {};
            if (!window.chatHistory.games[gameMatchId]) {
                window.chatHistory.games[gameMatchId] = [];
            }
            currentGameChatId = gameMatchId;
            
            // Create new tab for this game
            const tabsContainer = document.getElementById('chatTabsContainer');
            const tabId = `tab-game-${gameMatchId}`;
            
            // Check if tab already exists
            if (!document.getElementById(tabId)) {
                const newTab = document.createElement('button');
                newTab.className = 'chat-tab';
                newTab.id = tabId;
                newTab.textContent = '#' + gameMatchId.slice(0, 6);
                newTab.onclick = () => switchChatTab('game', gameMatchId);
                tabsContainer.appendChild(newTab);
            }
            
            // Add system message
            addChatMessage('system', 'System', `${t('gameStarted')} #${gameMatchId.slice(0, 8)}`, 'game', gameMatchId);
            
            // Switch to this game chat
            switchChatTab('game', gameMatchId);
            
            console.log('Game chat created. Current games:', Object.keys(window.chatHistory.games));
        }

        function closeGameChat(gameMatchId) {
            if (!gameMatchId) gameMatchId = currentGameChatId;
            if (!gameMatchId) return;
            
            // Mark chat as closed
            if (window.chatHistory.games && window.chatHistory.games[gameMatchId]) {
                window.chatHistory.games[gameMatchId].push({
                    type: 'system',
                    author: 'System',
                    text: t('chatClosed'),
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    closed: true
                });
            }
            
            // Find the specific tab for this game and add lock
            const tabId = `tab-game-${gameMatchId}`;
            const gameTab = document.getElementById(tabId);
            if (gameTab) {
                gameTab.textContent = '#' + gameMatchId.slice(0, 6) + ' üîí';
                gameTab.style.opacity = '0.5';
            }
            
            // If this is current game, refresh messages
            if (currentGameChatId === gameMatchId) {
                renderChatMessages();
            }
            
            // Schedule tab removal after 2 minutes (total 4 minutes from game end)
            setTimeout(() => {
                const tabToRemove = document.getElementById(tabId);
                if (tabToRemove) {
                    tabToRemove.remove();
                    // Clean up history
                    if (window.chatHistory.games[gameMatchId]) {
                        delete window.chatHistory.games[gameMatchId];
                    }
                }
            }, 120000); // Remove tab after additional 2 minutes
        }

        function handleChatKeypress(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            const author = currentProfile.displayName || (userId ? userId.slice(0,8) : 'Guest');

            if (currentChatTab === 'global') {
                if (socket) socket.emit('chat:global', { text });
                // –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–∏—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—É–±—Ä–∞–ª–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)
            } else if (currentChatTab === 'game' && currentGameChatId) {
                if (socket) socket.emit('chat:game', { matchId: currentGameChatId, text });
                // –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–∏—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—É–±—Ä–∞–ª–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)
            }

            input.value = '';
            sounds.click();
        }

        function addChatMessage(type, author, text, tab, gameId = null) {
            if (!window.chatHistory) window.chatHistory = { global: [] };
            if (!window.chatHistory.games) window.chatHistory.games = {};
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const message = { type, author, text, time };
            
            if (tab === 'global') {
                window.chatHistory.global.push(message);
            } else if (tab === 'game' && gameId) {
                if (!window.chatHistory.games[gameId]) window.chatHistory.games[gameId] = [];
                window.chatHistory.games[gameId].push(message);
            }
            
            if (currentChatTab === tab && (tab === 'global' || currentGameChatId === gameId)) {
                renderChatMessages();
            }
        }

        function renderChatMessages() {
            const messagesEl = document.getElementById('chatMessages');
            if (!messagesEl) return;
            messagesEl.innerHTML = '';
            
            let history = [];
            if (currentChatTab === 'global') {
                history = window.chatHistory?.global || [];
            } else if (currentChatTab === 'game' && currentGameChatId) {
                history = window.chatHistory?.games?.[currentGameChatId] || [];
            }
            
            if (history.length === 0) {
                messagesEl.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 20px;">No messages yet</div>';
            }
            
            history.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.className = `chat-message ${msg.type}`;
                if (msg.type === 'system') {
                    messageEl.textContent = msg.text;
                } else {
                    // Determine avatar and display name
                    let avatarSrc = `${API_URL}/avatars/male1.svg`; // default
                    let displayAuthor = msg.author;
                    
                    // If message is from current user, show their display name and avatar
                    if (msg.author === userId.slice(0,8) || msg.author === currentProfile.displayName) {
                        displayAuthor = currentProfile.displayName || msg.author;
                        if (currentProfile.avatarUrl) {
                            avatarSrc = currentProfile.avatarUrl;
                        }
                    }
                    
                    messageEl.innerHTML = `
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <img src="${avatarSrc}" style="width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0;">
                            <div style="flex: 1;">
                                <div class="chat-author">${displayAuthor} <span class="chat-time">${msg.time}</span></div>
                                <div>${escapeHtml(msg.text)}</div>
                            </div>
                        </div>
                    `;
                }
                messagesEl.appendChild(messageEl);
            });
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal functions
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('show');
            sounds.click();
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('show');
            sounds.click();
        }

        function hideRegisterModal() {
            document.getElementById('registerModal').classList.remove('show');
        }

        function showForgotModal() {
            document.getElementById('forgotModal').classList.add('show');
            sounds.click();
        }

        function hideForgotModal() {
            document.getElementById('forgotModal').classList.remove('show');
        }

        function closeModal(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.classList.remove('show');
            }
        }

        // Auth API functions
        async function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }

            try {
                const r = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await r.json();

                if (r.ok) {
                    token = data.token;
                    userId = data.userId;
                    currentProfile = {
                        displayName: data.displayName || data.username || email,
                        gender: data.gender || '',
                        avatarUrl: data.avatarUrl || '',
                        isGuest: false
                    };
                    updateBalanceDisplay(data.balanceWp);
                    hideLoginModal();
                    showUserInfo(data.email || data.username);
                    log(`‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω: ${data.email || data.username}`);
                    setButtons({ guest: false, connect: true, quickplay: false, balance: true, logs: false });
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Å –∞–≤–∞—Ç–∞—Ä–∫–æ–π
                    await loadProfile();
                    updateUserInfoAfterLogin();
                } else {
                    // –ï—Å–ª–∏ email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ
                    if (data.message && data.message.includes('Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω')) {
                        if (confirm(data.message + '\n\n–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ?')) {
                            await resendVerification(email);
                        }
                    } else {
                        alert(data.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                    }
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
            }
        }

        // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        async function resendVerification(email) {
            try {
                const r = await fetch(`${API_URL}/auth/resend-verification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await r.json();
                alert(data.message || '–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message);
            }
        }

        async function doRegister() {
            const email = document.getElementById('registerEmail').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!email || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }
            if (password.length < 6) {
                alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            try {
                const r = await fetch('/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, username })
                });
                const data = await r.json();

                if (r.ok) {
                    hideRegisterModal();
                    alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
                    log('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ' + data.message);
                } else {
                    alert(data.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
            }
        }

        async function doForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();

            if (!email) {
                alert('–í–≤–µ–¥–∏—Ç–µ email');
                return;
            }

            try {
                const r = await fetch('/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await r.json();

                hideForgotModal();
                alert(data.message);
                log('üìß ' + data.message);
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
            }
        }

        function showUserInfo(email) {
            document.getElementById('authButtons').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userEmail').textContent = email;
        }

        function logout() {
            token = '';
            userId = '';
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            document.getElementById('authButtons').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            setButtons({ guest: true, connect: false, quickplay: false, balance: false, logs: false });
            log('üëã –í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
            sounds.click();
        }

        // Initialize on load
        window.onload = function() {
            setLang('ru');
            // Initialize chat history structure
            window.chatHistory = { global: [], games: {} };
            gameChatTimeouts = {};
            // Add welcome message
            addChatMessage('system', 'System', 'Welcome to WagerPlay! Select language above.', 'global');
            // Initialize button text with default player count
            const btnText = document.getElementById('playBtnText');
            if (btnText) {
                btnText.textContent = `–ò–≥—Ä–∞—Ç—å 2/100`;
            }
            // Initialize player badge
            const playerBadge = document.getElementById('playerBadge');
            if (playerBadge) {
                playerBadge.textContent = '2';
            }
            // Initialize dropdown selection
            updateDropdownSelection(2);
        };

        // Audio Context for sounds
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        // Sound effects
        const sounds = {
            click: () => playTone(800, 0.1, 'square'),
            error: () => playMelody([200, 150], 0.1),
            matchFound: () => {
                // üéÆ –ú–ê–¢–ß –ù–ê–ô–î–ï–ù! - —Ä–∞–¥–æ—Å—Ç–Ω—ã–π –∑–≤—É–∫
                const now = audioCtx.currentTime;
                const notes = [
                    { f: 440, d: 0.1, t: 0 },
                    { f: 554, d: 0.1, t: 0.1 },
                    { f: 659, d: 0.3, t: 0.2 },
                ];
                notes.forEach(n => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = n.f;
                    osc.type = 'triangle';
                    gain.gain.setValueAtTime(0.0, now + n.t);
                    gain.gain.linearRampToValueAtTime(0.4, now + n.t + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + n.t + n.d);
                    osc.start(now + n.t);
                    osc.stop(now + n.t + n.d);
                });
            },
            countdown: (num) => {
                // ‚è±Ô∏è –ó–≤—É–∫ –æ—Ç—Å—á—ë—Ç–∞ (–±–∏–ø –¥–ª—è –∫–∞–∂–¥–æ–π —Ü–∏—Ñ—Ä—ã)
                const freq = num <= 3 ? 880 : 660; // –í—ã—à–µ –∑–≤—É–∫ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 —Å–µ–∫
                playTone(freq, 0.15, 'square');
            },
            matchStart: () => playMelody([440, 554, 659, 880], 0.1),
            win: () => {
                // üèÜ –ü–æ–±–µ–¥–Ω–∞—è –º–µ–ª–æ–¥–∏—è (—Ñ–∞–Ω—Ñ–∞—Ä—ã) ~2.5 —Å–µ–∫
                const now = audioCtx.currentTime;
                const notes = [
                    { f: 523, d: 0.15, t: 0 },      // C5
                    { f: 659, d: 0.15, t: 0.15 },   // E5
                    { f: 784, d: 0.15, t: 0.30 },   // G5
                    { f: 1047, d: 0.50, t: 0.45 },  // C6 (—É–¥–ª–∏–Ω—ë–Ω–Ω–∞—è)
                    { f: 523, d: 0.10, t: 1.0 },    // C5 (—ç—Ö–æ)
                    { f: 659, d: 0.10, t: 1.15 },   // E5
                    { f: 784, d: 0.10, t: 1.30 },   // G5
                    { f: 1047, d: 0.80, t: 1.45 }   // C6 (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–Ω–∞—è)
                ];
                notes.forEach(n => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = n.f;
                    osc.type = 'triangle';
                    gain.gain.setValueAtTime(0.0, now + n.t);
                    gain.gain.linearRampToValueAtTime(0.4, now + n.t + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + n.t + n.d);
                    osc.start(now + n.t);
                    osc.stop(now + n.t + n.d);
                });
            },
            lose: () => playMelody([400, 350, 300], 0.15),
            tie: () => playTone(440, 0.2, 'sine'),
            move: () => playTone(600, 0.05, 'square'),
            matchStart: () => playMelody([440, 554, 659, 880], 0.1)
        };

        function playTone(freq, duration, type = 'sine') {
            if (!soundEnabled) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            osc.type = type;
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + duration);
        }

        function playMelody(frequencies, duration) {
            if (!soundEnabled) return;
            frequencies.forEach((freq, i) => {
                setTimeout(() => playTone(freq, duration), i * duration * 1000);
            });
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.querySelector('.sound-toggle').textContent = soundEnabled ? 'üîä' : 'üîá';
        }

        // Logging
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logEl.insertBefore(entry, logEl.firstChild);
        }

        // Get server logs from backend
        async function getServerLogs() {
            if (!matchId) {
                log('‚ùå No active match');
                return;
            }
            try {
                const r = await fetch(`/matchmaking/match/${matchId}/audit`);
                const logs = await r.json();
                console.log('=== SERVER LOGS ===', logs);
                console.log('Full logs:', JSON.stringify(logs, null, 2));
                log(`üìã Server logs: ${logs.length} entries (see Console)`);
                return logs;
            } catch (e) {
                log(`‚ùå Error getting logs: ${e.message}`);
            }
        }

        // View server logs in VS Code Terminal:
        // 1. Open VS Code
        // 2. Look at bottom panel (Terminal tab)
        // 3. All errors and logs are shown there
        // Or press Ctrl+` (backtick) to open terminal

        // Show server logs in chat
        function showLogsInChat() {
            getServerLogs().then(logs => {
                if (logs && logs.length > 0) {
                    addChatMessage('system', 'System', `üìã Match logs: ${logs.length} events`, 'game', matchId);
                    logs.slice(-5).forEach(l => {
                        const msg = `[${l.eventType}] ${l.actorId?.slice(0,8) || 'System'}`;
                        addChatMessage('system', 'Log', msg, 'game', matchId);
                    });
                }
            });
        }

        // Update UI
        function updateBalanceDisplay(balance, frozen = 0) {
            document.getElementById('balanceDisplay').textContent = `${balance} VP`;
            document.getElementById('frozenDisplay').textContent = frozen > 0 ? `–ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ: ${frozen} VP` : '';
        }

        function setButtons(state) {
            const btnGuest = document.getElementById('btnGuest');
            const btnConnect = document.getElementById('btnConnect');
            const btnQuickplay = document.getElementById('btnQuickplay');
            const btnPlayArrow = document.getElementById('btnPlayArrow');
            const btnBalance = document.getElementById('btnBalance');
            const btnLogs = document.getElementById('btnLogs');
            
            if (btnGuest) btnGuest.disabled = !state.guest;
            if (btnConnect) btnConnect.disabled = !state.connect;
            if (btnQuickplay) btnQuickplay.disabled = !state.quickplay;
            if (btnPlayArrow) btnPlayArrow.disabled = !state.quickplay;
            const btnStake = document.getElementById('btnStake');
            const btnStakeArrow = document.getElementById('btnStakeArrow');
            if (btnStake) btnStake.disabled = !state.quickplay;
            if (btnStakeArrow) btnStakeArrow.disabled = !state.quickplay;
            const btnStats = document.getElementById('btnStats');
            if (btnBalance) btnBalance.disabled = !state.balance;
            if (btnStats) btnStats.disabled = !state.balance;
            if (btnLogs) btnLogs.disabled = !state.logs;
        }

        // Guest Login
        async function doGuest() {
            if (isProcessing.guest) {
                sounds.error();
                return;
            }
            isProcessing.guest = true;
            sounds.click();
            
            try {
                const r = await fetch(`${API_URL}/auth/guest`, { method: "POST" });
                const j = await r.json();
                token = j.token;
                userId = j.userId;
                currentProfile = {
                    displayName: j.displayName || `Guest${userId.slice(0,6)}`,
                    gender: '',
                    avatarUrl: '',
                    isGuest: true
                };
                updateBalanceDisplay(j.balanceWp);
                log(`‚úÖ Guest login: ${userId.slice(0,8)}...`);
                setButtons({ guest: false, connect: true, quickplay: false, balance: true, logs: false });
                updateUserInfoAfterLogin();
                doCheckBalance();
            } catch (e) {
                log(`‚ùå Guest error: ${e.message}`);
            } finally {
                isProcessing.guest = false;
            }
        }

        // Check Balance
        async function doCheckBalance() {
            sounds.click();
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ Guest');
                return;
            }
            try {
                const r = await fetch("/wallet", {
                    headers: { "Authorization": "Bearer " + token }
                });
                const j = await r.json();
                if (j.balanceWp !== undefined) {
                    updateBalanceDisplay(j.balanceWp, j.frozenWp);
                    log(`üí∞ –ë–∞–ª–∞–Ω—Å: ${j.balanceWp} VP`);
                }
            } catch (e) {
                log(`‚ùå Balance error: ${e.message}`);
            }
        }

        // üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        async function doShowStats() {
            sounds.click();
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ Guest');
                return;
            }
            try {
                console.log('[doShowStats] Fetching stats...');
                const r = await fetch("/auth/stats", {
                    headers: { "Authorization": "Bearer " + token }
                });
                console.log('[doShowStats] Response status:', r.status);
                const s = await r.json();
                console.log('[doShowStats] Stats data:', s);
                
                log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                log('‚ïë       üìä –í–ê–®–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê       ‚ïë');
                log('‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£');
                log(`‚ïë üéÆ –ú–∞—Ç—á–µ–π: ${s.totalMatches.toString().padStart(3)}              ‚ïë`);
                log(`‚ïë ‚úÖ –ü–æ–±–µ–¥: ${s.wins.toString().padStart(3)}  ‚ùå –ü–æ—Ä–∞–∂–µ–Ω–∏–π: ${s.losses.toString().padStart(3)}  ‚ïë`);
                log(`‚ïë üìà –í–∏–Ω—Ä–µ–π—Ç: ${s.winRate.toString().padStart(3)}%              ‚ïë`);
                log(`‚ïë üî• –°–µ—Ä–∏—è: ${s.winStreak} (–ú–∞–∫—Å: ${s.maxWinStreak})         ‚ïë`);
                log('‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£');
                log(`‚ïë üí∞ –í—Å–µ–≥–æ –≤—ã–∏–≥—Ä–∞–Ω–æ: ${s.totalWonVp.toString().padStart(6)} VP   ‚ïë`);
                log(`‚ïë üí∏ –í—Å–µ–≥–æ –ø—Ä–æ–∏–≥—Ä–∞–Ω–æ: ${s.totalLostVp.toString().padStart(5)} VP   ‚ïë`);
                log(`‚ïë üéØ –ú–∞–∫—Å. –≤—ã–∏–≥—Ä—ã—à: ${s.biggestWinVp.toString().padStart(6)} VP   ‚ïë`);
                log(`‚ïë üé≤ –ú–∞–∫—Å. —Å—Ç–∞–≤–∫–∞: ${s.biggestStakeVp.toString().padStart(6)} VP   ‚ïë`);
                log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            } catch (e) {
                console.error('[doShowStats] Error:', e);
                log(`‚ùå Stats error: ${e.message}`);
            }
        }

        // Connect WebSocket
        function doConnect() {
            if (isProcessing.connect) {
                sounds.error();
                return;
            }
            isProcessing.connect = true;
            sounds.click();
            
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ Guest token');
                isProcessing.connect = false;
                return;
            }

            socket = io(window.location.origin, { auth: { token } });

            socket.on("connected", (m) => {
                isProcessing.connect = false;
                log(`üîó WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω: ${m.userId.slice(0,8)}...`);
                setButtons({ guest: false, connect: false, quickplay: true, balance: true, logs: true });
                sounds.matchStart();
            });

            socket.on("quickplay:result", (m) => {
                log(`üéÆ Quickplay: ${m.status}`);
                if (m.status === 'ALREADY_IN_QUEUE') {
                    log('‚ö†Ô∏è Already in queue!');
                    isProcessing.quickplay = false;
                    const qpBtn1 = document.getElementById('btnQuickplay');
                    if (qpBtn1) qpBtn1.disabled = false;
                    showWaiting(t('waitingQueue'), true, 5);
                    return;
                }
                if (m.ticketId) {
                    showWaiting(t('waitingQueue'), true, 20);  // 20 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø–æ–∏—Å–∫
                    // Keep button disabled while in queue
                    const qpBtn2 = document.getElementById('btnQuickplay');
                    const pbt2 = document.getElementById('playBtnText');
                    if (qpBtn2) qpBtn2.disabled = true;
                    if (pbt2) pbt2.textContent = '‚è≥ ' + (t('searching') || 'Searching...');
                }
                if (m.matchId) {
                    matchId = m.matchId;
                    isProcessing.quickplay = false;
                    // Reset button text
                    const pbt5 = document.getElementById('playBtnText');
                    const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
                    if (pbt5) pbt5.textContent = `–ò–≥—Ä–∞—Ç—å ${selectedPlayers} | ${stakeText} VP`;
                }
            });

            socket.on("queue:waiting", (m) => {
                log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ: ${m.seconds} —Å–µ–∫`);
                showWaiting(`–ò—â–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤ (${m.playersFound || 1}/${selectedPlayers})...`, true, m.seconds);
            });

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏ (–∫–æ–≥–¥–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è –Ω–æ–≤—ã–π –∏–≥—Ä–æ–∫)
            socket.on("queue:sync", (m) => {
                log(`üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ${m.playersFound}/${m.totalNeeded} –∏–≥—Ä–æ–∫–æ–≤, –æ—Å—Ç–∞–ª–æ—Å—å ${m.secondsLeft}—Å–µ–∫`);
                // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º
                showWaiting(`–ò—â–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤ (${m.playersFound}/${m.totalNeeded})...`, true, m.secondsLeft);
            });

            socket.on("fallback:result", (m) => {
                stopCountdown();
                log(`ü§ñ Fallback: ${m.status}`);
                isProcessing.quickplay = false;
                const pbt6 = document.getElementById('playBtnText');
                if (pbt6) pbt6.textContent = t('quickplay');
                if (m.matchId) {
                    matchId = m.matchId;
                    sounds.matchStart();
                }
            });

            socket.on("match:round", (data) => {
                // –ó–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞
                sounds.click();
                log(`üéÆ –†–∞—É–Ω–¥ ${data.round}, –æ—Å—Ç–∞–ª–æ—Å—å –∏–≥—Ä–æ–∫–æ–≤: ${data.aliveCount}`);
            });

            // ‚è±Ô∏è –¢–∞–π–º–µ—Ä —Ö–æ–¥–∞ (12 —Å–µ–∫—É–Ω–¥)
            socket.on("match:timer", (data) => {
                if (data.type === 'move') {
                    startMoveCountdown(data.secondsLeft || 12);
                }
            });

            // üéÆ –ú–ê–¢–ß –ì–û–¢–û–í! - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –º–∞—Ç—á —Å—Ä–∞–∑—É
            socket.on("match:ready", (data) => {
                log(`üéÆ Match ready: ${data.matchId.slice(0,8)}...`);
                currentMatchId = data.matchId;
                isProcessing.quickplay = false;
                stopCountdown();
                
                // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ –º–∞—Ç—á–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞—Ç–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                socket.emit("match:join", { matchId: data.matchId });
                
                // ‚ùå –ù–ï –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º match:get –∑–¥–µ—Å—å - –∂–¥—ë–º match:start –ø–æ—Å–ª–µ –æ—Ç—Å—á—ë—Ç–∞!
                // –ò–≥—Ä–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ match:start
            });

            // üéÆ –ú–ê–¢–ß –ù–ê–ô–î–ï–ù! - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Å –æ—Ç—Å—á—ë—Ç–æ–º
            let matchCountdownInterval = null;
            socket.on("match:found", (data) => {
                sounds.matchFound();
                log('üéÆ –ú–ê–¢–ß –ù–ê–ô–î–ï–ù!');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –æ–∂–∏–¥–∞–Ω–∏—è —Å –±–æ–ª—å—à–∏–º —Ç–∞–π–º–µ—Ä–æ–º
                document.getElementById('gameContent').innerHTML = `
                    <div class="waiting">
                        <div style="font-size: 2em; color: #ffd700; margin-bottom: 20px;">üéÆ –ú–ê–¢–ß –ù–ê–ô–î–ï–ù!</div>
                        <div style="font-size: 4em; font-weight: bold; color: #00ff88;" id="matchCountdown">5</div>
                        <div style="margin-top: 20px;">–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ –∏–≥—Ä–µ...</div>
                    </div>
                `;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å—á—ë—Ç
                let count = 5;
                matchCountdownInterval = setInterval(() => {
                    count--;
                    const el = document.getElementById('matchCountdown');
                    if (el) {
                        el.textContent = count;
                        sounds.countdown(count);
                    }
                    if (count <= 0) {
                        clearInterval(matchCountdownInterval);
                    }
                }, 1000);
            });

            // ‚è±Ô∏è –û—Ç—Å—á—ë—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—Ä–µ–∑–µ—Ä–≤)
            socket.on("match:countdown", (data) => {
                const el = document.getElementById('matchCountdown');
                if (el) {
                    el.textContent = data.seconds;
                }
                // üîä –ó–≤—É–∫ –æ—Ç—Å—á—ë—Ç–∞ (—á–µ–º –º–µ–Ω—å—à–µ —á–∏—Å–ª–æ, —Ç–µ–º –≤—ã—à–µ —á–∞—Å—Ç–æ—Ç–∞)
                if (sounds.countdown) {
                    sounds.countdown(data.seconds);
                }
            });

            // üöÄ –ú–∞—Ç—á –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è
            socket.on("match:start", (m) => {
                if (matchCountdownInterval) {
                    clearInterval(matchCountdownInterval);
                }
                sounds.matchStart();
                log('üöÄ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!');
                
                // –†–µ–Ω–¥–µ—Ä–∏–º –º–∞—Ç—á —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ç–∞–π–º–µ—Ä
                currentMatch = m;
                matchId = m.matchId;
                renderMatch(m);
                showChat();
                createGameChat(m.matchId);
                
                // ‚è±Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ —Ö–æ–¥–∞
                const isPlayerAlive = m.aliveIds?.includes(userId);
                const isFinished = m.status === 'FINISHED';
                if (isPlayerAlive && !isFinished) {
                    startMoveCountdown(12);
                }
            });

            socket.on("match:update", (m) => {
                stopCountdown();
                stopMoveCountdown();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ö–æ–¥–∞
                isProcessing.move = false;
                
                // If this is a new match (different from current game chat), create new chat
                if (m.matchId && m.matchId !== currentGameChatId) {
                    matchId = m.matchId;
                    showChat();
                    createGameChat(m.matchId);
                }
                
                currentMatch = m;
                renderMatch(m);
                
                // ‚è±Ô∏è –¢–∞–π–º–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ match:timer –∏–ª–∏ match:start
                // –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ match:update —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
                
                // üéÆ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ä–∞—É–Ω–¥–∞
                if (m.lastRound) {
                    const lr = m.lastRound;
                    const moveEmoji = { 'ROCK': '‚úä', 'PAPER': '‚úã', 'SCISSORS': '‚úåÔ∏è' };
                    
                    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞—É–Ω–¥–∞
                    log(`üì¢ –†–ê–£–ù–î ${lr.roundNo}`);
                    
                    // –•–æ–¥—ã –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
                    if (lr.moves) {
                        Object.entries(lr.moves).forEach(([pid, move]) => {
                            const isBot = pid.startsWith('BOT');
                            const botName = isBot ? (m.botNames?.[pid] || pid) : null;
                            const name = isBot ? botName : (pid === userId ? '–í—ã' : pid.slice(0, 8));
                            const emoji = moveEmoji[move] || move;
                            log(`  ${name}: ${emoji} ${move}`);
                        });
                    }
                    
                    // –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥–∞
                    if (lr.outcome === 'TIE') {
                        log(`ü§ù –ù–∏—á—å—è! (${lr.reason === 'ALL_SAME' ? '–≤—Å–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ' : '–≤—Å–µ —Ç—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞'})`);
                    } else if (lr.outcome === 'ELIMINATION') {
                        const losers = lr.losers || [];
                        const winningMove = lr.winningMove || '';
                        const winEmoji = moveEmoji[winningMove] || '';
                        log(`‚öîÔ∏è –ü–æ–±–µ–∂–¥–∞–µ—Ç: ${winEmoji} ${winningMove}`);
                        
                        losers.forEach(pid => {
                            const isBot = pid.startsWith('BOT');
                            const botName = isBot ? (m.botNames?.[pid] || pid) : null;
                            const name = isBot ? botName : (pid === userId ? '–í—ã' : pid.slice(0, 8));
                            const skull = isBot ? 'ü§ñ' : (pid === userId ? 'üíÄ' : 'üë§');
                            log(`  ${skull} ${name} –í–´–ë–´–í–ê–ï–¢!`);
                        });
                    }
                    
                    log(`üë• –û—Å—Ç–∞–ª–æ—Å—å –∏–≥—Ä–æ–∫–æ–≤: ${m.aliveIds?.length || 0}`);
                }
                
                // Reset move processing flag when match updates
                isProcessing.move = false;
                
                // Enable logs button when we have a match
                if (m.matchId) {
                    const logsBtn = document.getElementById('btnLogs');
                    if (logsBtn) logsBtn.disabled = false;
                }
                
                // If match is finished, schedule chat close and reset quickplay button
                if (m.status === 'FINISHED') {
                    isProcessing.quickplay = false;
                    const qpBtn3 = document.getElementById('btnQuickplay');
                    const pbt3 = document.getElementById('playBtnText');
                    if (qpBtn3) qpBtn3.disabled = false;
                    if (pbt3) pbt3.textContent = t('playAgain');
                    
                    // Schedule this specific game chat to close after 2 minutes
                    if (m.matchId && !gameChatTimeouts[m.matchId]) {
                        addChatMessage('system', 'System', t('chatWillClose'), 'game', m.matchId);
                        gameChatTimeouts[m.matchId] = setTimeout(() => {
                            closeGameChat(m.matchId);
                            delete gameChatTimeouts[m.matchId];
                        }, 120000); // 2 minutes
                    }
                }
            });

            socket.on("chat:message", (data) => {
                addChatMessage('user', data.author?.slice(0,8) || 'Unknown', data.text, data.channel || 'global');
            });

            socket.on("chat:global", (data) => {
                addChatMessage('user', data.author?.slice(0,8) || 'Unknown', data.text, 'global');
            });

            socket.on("chat:game", (data) => {
                // Add to specific game chat if matchId provided
                const targetGameId = data.matchId || currentGameChatId;
                if (targetGameId) {
                    addChatMessage('user', data.author?.slice(0,8) || 'Unknown', data.text, 'game', targetGameId);
                }
            });

            socket.on("error", (m) => {
                isProcessing.move = false;
                isProcessing.quickplay = false;
                const qpBtn4 = document.getElementById('btnQuickplay');
                const pbt4 = document.getElementById('playBtnText');
                if (qpBtn4) qpBtn4.disabled = false;
                const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
                if (pbt4) pbt4.textContent = `–ò–≥—Ä–∞—Ç—å ${selectedPlayers} | ${stakeText} VP`;
                log(`‚ùå Error: ${m.message}`);
            });
        }

        // Quickplay
        function resetAndPlayAgain() {
            // Clear match state
            currentMatch = null;
            matchId = null;
            currentGameChatId = null;
            stopMoveCountdown();
            stopCountdown();
            
            // Start new game
            doQuickplay();
        }

        function doQuickplay() {
            if (isProcessing.quickplay) {
                sounds.error();
                return;
            }
            isProcessing.quickplay = true;
            sounds.click();
            
            if (!socket) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å');
                isProcessing.quickplay = false;
                return;
            }
            socket.emit("quickplay", { playersCount: selectedPlayers, stakeVp: selectedStake });
            log(`üéÆ Quickplay: ${selectedPlayers} players, ${selectedStake} VP`);
            // Show game chat - will be initialized when match arrives
        }

        // Make Move
        function makeMove(move) {
            // ‚è±Ô∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä - —Ö–æ–¥ —Å–¥–µ–ª–∞–Ω
            stopMoveCountdown();
            
            // ‚ùå –ù–µ –¥–∞—ë–º –≤—ã–±–∏—Ç—ã–º –∏–≥—Ä–æ–∫–∞–º —Ö–æ–¥–∏—Ç—å
            if (currentMatch && !currentMatch.aliveIds?.includes(userId)) {
                log('‚ùå –í—ã –≤—ã–±—ã–ª–∏ –∏–∑ –º–∞—Ç—á–∞');
                return;
            }
            
            if (isProcessing.move) {
                sounds.error();
                return;
            }
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–¥–µ–ª–∞–ª–∏ –ª–∏ —É–∂–µ —Ö–æ–¥ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ
            if (currentMatch && currentMatch.moves && currentMatch.moves[userId]) {
                log('‚ö†Ô∏è –í—ã —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ —Ö–æ–¥ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ');
                return;
            }
            isProcessing.move = true;
            sounds.move();
            
            if (!socket || !matchId) {
                log('‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Ç—á–∞ (socket: ' + !!socket + ', matchId: ' + matchId + ')');
                isProcessing.move = false;
                return;
            }
            
            console.log('[makeMove] Sending move:', { matchId, move, userId });
            
            // Disable all move buttons
            document.querySelectorAll('.move-btn').forEach(btn => {
                if (btn) btn.disabled = true;
            });
            
            socket.emit("move", { matchId, move });
            log(`üëä –•–æ–¥: ${move}`);
            
            // Visual feedback
            document.querySelectorAll('.move-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.move === move) {
                    btn.classList.add('selected');
                }
            });
            
            // Auto-reset after 5 seconds if server doesn't respond
            setTimeout(() => {
                if (isProcessing.move) {
                    isProcessing.move = false;
                    log('‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    // Buttons will be re-enabled by renderMatch on next update
                }
            }, 5000);
        }

        // Countdown Timer
        function startCountdown(seconds) {
            if (countdownInterval) clearInterval(countdownInterval);
            let remaining = seconds;
            
            const updateTimer = () => {
                const timerEl = document.getElementById('countdownTimer');
                if (timerEl) {
                    timerEl.textContent = `${t('searching')} ${remaining}s`;
                }
                remaining--;
                if (remaining < 0) {
                    clearInterval(countdownInterval);
                }
            };
            
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }

        function stopCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        // ‚è±Ô∏è –¢–∞–π–º–µ—Ä –¥–ª—è —Ö–æ–¥–∞ (12 —Å–µ–∫—É–Ω–¥)
        let moveCountdownInterval = null;
        function startMoveCountdown(seconds) {
            // ‚ùå –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤—ã–±—ã–ª
            if (currentMatch && !currentMatch.aliveIds?.includes(userId)) {
                console.log('[startMoveCountdown] Skipped - player eliminated');
                return;
            }
            
            if (moveCountdownInterval) clearInterval(moveCountdownInterval);
            let remaining = seconds;
            
            const updateTimer = () => {
                const timerEl = document.getElementById('moveTimer');
                if (timerEl) {
                    timerEl.textContent = remaining + 's';
                    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∫–æ–≥–¥–∞ –º–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏
                    if (remaining <= 3) {
                        timerEl.style.color = '#ff4444';
                    } else if (remaining <= 6) {
                        timerEl.style.color = '#ffaa00';
                    } else {
                        timerEl.style.color = '#00ff88';
                    }
                }
                remaining--;
                if (remaining < 0) {
                    clearInterval(moveCountdownInterval);
                    if (timerEl) timerEl.textContent = '‚è±Ô∏è';
                    // ‚è±Ô∏è –ê–≤—Ç–æ-—Ö–æ–¥ –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –∂–∏–≤ –∏ —Ö–æ–¥ –Ω–µ —Å–¥–µ–ª–∞–Ω)
                    const isPlayerAlive = currentMatch?.aliveIds?.includes(userId);
                    if (isPlayerAlive && currentMatch && !currentMatch.moves?.[userId]) {
                        const moves = ['ROCK', 'PAPER', 'SCISSORS'];
                        const randomMove = moves[Math.floor(Math.random() * moves.length)];
                        log('‚è±Ô∏è –í—Ä–µ–º—è –≤—ã—à–ª–æ! –ê–≤—Ç–æ-—Ö–æ–¥: ' + randomMove);
                        makeMove(randomMove);
                    } else if (!isPlayerAlive) {
                        console.log('[AutoMove] Skipped - player eliminated');
                    } else {
                        console.log('[AutoMove] Skipped - move already made');
                    }
                }
            };
            
            updateTimer();
            moveCountdownInterval = setInterval(updateTimer, 1000);
        }

        function stopMoveCountdown() {
            if (moveCountdownInterval) {
                clearInterval(moveCountdownInterval);
                moveCountdownInterval = null;
            }
        }

        // Render Functions
        function showWaiting(text, withCountdown = false, seconds = 0) {
            let countdownHtml = '';
            if (withCountdown && seconds > 0) {
                countdownHtml = `<div id="countdownTimer" style="font-size: 1.5em; margin-top: 10px; color: #ffd700;"></div>`;
                startCountdown(seconds);
            }
            
            document.getElementById('gameContent').innerHTML = `
                <div class="waiting">
                    <div>${text}</div>
                    ${countdownHtml}
                </div>
            `;
        }

        function renderMatch(m) {
            const isPlayerAlive = m.aliveIds.includes(userId);
            const isFinished = m.status === 'FINISHED';
            const isPlayerWinner = m.winnerId === userId;
            
            console.log('Render match:', { round: m.round, isPlayerAlive, isFinished, userId, aliveIds: m.aliveIds });

            // Play sounds based on outcome
            if (isFinished) {
                if (isPlayerWinner) sounds.win();
                else if (m.playerIds.includes(userId)) sounds.lose();
            }

            let statusText = isFinished 
                ? (isPlayerWinner ? t('victory') : t('defeat')) 
                : (isPlayerAlive ? t('yourTurn') : t('waitingTurn'));

            let html = `
                <div class="game-status">
                    <div class="status-text">${statusText}</div>
                    ${!isFinished && isPlayerAlive ? `
                    <div class="move-timer" id="moveTimer" style="font-size: 2em; font-weight: bold; margin: 10px 0; color: #00ff88;">12s</div>
                    ` : ''}
                    <div class="match-info">
                        <div class="info-item">
                            <div class="info-label">${t('round')}</div>
                            <div class="info-value">${m.round}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">${t('pot')}</div>
                            <div class="info-value">${m.potVp} VP</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">${t('stake')}</div>
                            <div class="info-value">${m.stakeVp} VP</div>
                        </div>
                        ${isFinished ? `
                        <div class="info-item">
                            <div class="info-label">${t('payout')}</div>
                            <div class="info-value">${m.payoutVp} VP</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Players Grid
            html += `<div class="players-grid">`;
            m.playerIds.forEach(pid => {
                const isBot = pid.startsWith('BOT');
                const isAlive = m.aliveIds.includes(pid);
                const isEliminated = m.eliminatedIds.includes(pid);
                const isWinner = m.winnerId === pid;
                const isMe = pid === userId;
                
                let moveEmoji = '‚ùì';
                if (m.lastRound && m.lastRound.moves[pid]) {
                    moveEmoji = getMoveEmoji(m.lastRound.moves[pid]);
                }

                let statusText = isWinner ? t('winner') : isEliminated ? t('eliminated') : isAlive ? t('inGame') : '';
                let botDisplayName = isBot ? (m.botNames?.[pid] || pid) : pid;
                let nameText = isMe ? 'üë§ ' + (t('you') || 'You') : isBot ? 'ü§ñ ' + botDisplayName : 'üë§ ' + pid.slice(0,8);

                html += `
                    <div class="player-card ${isWinner ? 'winner' : isEliminated ? 'eliminated' : isAlive ? 'active' : ''}">
                        <div class="player-name">${nameText}</div>
                        <div class="player-move">${moveEmoji}</div>
                        <div class="player-status">${statusText}</div>
                    </div>
                `;
            });
            html += `</div>`;

            // Last Round Info
            if (m.lastRound) {
                const outcomeText = m.lastRound.outcome === 'TIE' ? t('tie') : t('elimination');
                html += `
                    <div class="round-info">
                        <div class="round-title">${t('round')} ${m.lastRound.roundNo}: ${outcomeText}</div>
                        ${m.lastRound.winningMove ? `<div>${t('wonWith')}: ${getMoveEmoji(m.lastRound.winningMove)} ${m.lastRound.winningMove}</div>` : ''}
                    </div>
                `;
            }

            // Move Buttons (only if alive and not finished)
            console.log('Move buttons check:', { isPlayerAlive, isFinished, shouldShow: isPlayerAlive && !isFinished });
            if (isPlayerAlive && !isFinished) {
                html += `
                    <div class="moves-container">
                        <button class="move-btn" data-move="ROCK" onclick="makeMove('ROCK')">
                            <div class="move-emoji">‚úä</div>
                            <div class="move-text">${t('rock')}</div>
                        </button>
                        <button class="move-btn" data-move="PAPER" onclick="makeMove('PAPER')">
                            <div class="move-emoji">‚úã</div>
                            <div class="move-text">${t('paper')}</div>
                        </button>
                        <button class="move-btn" data-move="SCISSORS" onclick="makeMove('SCISSORS')">
                            <div class="move-emoji">‚úåÔ∏è</div>
                            <div class="move-text">${t('scissors')}</div>
                        </button>
                    </div>
                `;
            } else {
                console.log('Move buttons NOT shown - player not alive or game finished');
            }

            // Play Again Button
            if (isFinished) {
                html += `
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-success" onclick="resetAndPlayAgain()">${t('playAgain')}</button>
                    </div>
                `;
                // Add system message to game chat
                const resultMsg = isPlayerWinner ? 'Congratulations! You won!' : 'Game over. Better luck next time!';
                if (m.matchId) {
                    addChatMessage('system', 'System', resultMsg, 'game', m.matchId);
                }
                
                // Update balance after match
                setTimeout(doCheckBalance, 500);
                
                // Clear current match state
                currentMatch = null;
            }

            document.getElementById('gameContent').innerHTML = html;
        }

        function getMoveEmoji(move) {
            const emojis = { ROCK: '‚úä', PAPER: '‚úã', SCISSORS: '‚úåÔ∏è' };
            return emojis[move] || '‚ùì';
        }

        // Profile Functions
        let currentProfile = {
            displayName: '',
            gender: '',
            avatarUrl: '',
            isGuest: true
        };
        let selectedAvatarId = '';

        function showProfileModal() {
            document.getElementById('profileModal').classList.add('show');
            initAvatars();
            loadProfile();
        }

        function initAvatars() {
            const maleGrid = document.getElementById('maleAvatars');
            const femaleGrid = document.getElementById('femaleAvatars');
            
            if (maleGrid && maleGrid.children.length === 0) {
                for (let i = 1; i <= 5; i++) {
                    const div = document.createElement('div');
                    div.className = 'avatar-item';
                    div.onclick = function() { selectAvatar('male' + i, this); };
                    div.innerHTML = '<img src="' + API_URL + '/avatars/male' + i + '.svg" alt="male' + i + '">';
                    maleGrid.appendChild(div);
                }
            }
            
            if (femaleGrid && femaleGrid.children.length === 0) {
                for (let i = 1; i <= 5; i++) {
                    const div = document.createElement('div');
                    div.className = 'avatar-item';
                    div.onclick = function() { selectAvatar('female' + i, this); };
                    div.innerHTML = '<img src="' + API_URL + '/avatars/female' + i + '.svg" alt="female' + i + '">';
                    femaleGrid.appendChild(div);
                }
            }
        }

        function hideProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }

        async function loadProfile() {
            if (!token) return;
            
            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': token }
                });
                const data = await res.json();
                
                currentProfile = {
                    displayName: data.displayName || data.username || '',
                    gender: data.gender || '',
                    avatarUrl: data.avatarUrl || '',
                    isGuest: data.isGuest
                };
                
                // Fill form
                document.getElementById('profileDisplayName').value = currentProfile.displayName;
                document.getElementById('profileGender').value = currentProfile.gender;
                
                // Filter avatars by gender if set
                filterAvatarsByGender(currentProfile.gender);
                
                // Show avatar
                const avatarImg = document.getElementById('profileCurrentAvatar');
                if (currentProfile.avatarUrl) {
                    avatarImg.src = currentProfile.avatarUrl;
                    avatarImg.style.display = 'block';
                } else {
                    // Default avatar based on gender
                    const defaultAvatar = currentProfile.gender === 'female' ? `${API_URL}/avatars/female1.svg` : `${API_URL}/avatars/male1.svg`;
                    avatarImg.src = defaultAvatar;
                    avatarImg.style.display = 'block';
                }
                
                // Show/hide link email section
                const linkSection = document.getElementById('linkEmailSection');
                if (currentProfile.isGuest) {
                    linkSection.style.display = 'block';
                } else {
                    linkSection.style.display = 'none';
                }
                
            } catch (e) {
                console.error('Failed to load profile:', e);
            }
        }

        function switchAvatarTab(tab, clickedTab) {
            // Update tab buttons
            document.querySelectorAll('.avatar-tab').forEach(t => t.classList.remove('active'));
            clickedTab.classList.add('active');
            
            // Show/hide grids
            document.getElementById('maleAvatars').classList.add('hidden');
            document.getElementById('femaleAvatars').classList.add('hidden');
            document.getElementById('customAvatar').classList.add('hidden');
            
            document.getElementById(tab + 'Avatars')?.classList.remove('hidden');
            if (tab === 'custom') {
                document.getElementById('customAvatar').classList.remove('hidden');
            }
        }

        function selectAvatar(avatarId, clickedElement) {
            selectedAvatarId = avatarId;
            
            // Update UI
            document.querySelectorAll('.avatar-item').forEach(item => item.classList.remove('selected'));
            if (clickedElement) clickedElement.classList.add('selected');
            
            // Preview
            document.getElementById('profileCurrentAvatar').src = API_URL + '/avatars/' + avatarId + '.svg';
            
            // Auto-set gender based on avatar selection (always update)
            const newGender = avatarId.startsWith('male') ? 'male' : 'female';
            document.getElementById('profileGender').value = newGender;
        }

        function filterAvatarsByGender(gender) {
            // If gender is set, show only corresponding avatars
            if (gender === 'male') {
                document.getElementById('maleAvatars').classList.remove('hidden');
                document.getElementById('femaleAvatars').classList.add('hidden');
                // Update tabs
                document.querySelectorAll('.avatar-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.avatar-tab:nth-child(1)')?.classList.add('active');
            } else if (gender === 'female') {
                document.getElementById('maleAvatars').classList.add('hidden');
                document.getElementById('femaleAvatars').classList.remove('hidden');
                // Update tabs
                document.querySelectorAll('.avatar-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.avatar-tab:nth-child(2)')?.classList.add('active');
            }
            // If no gender, show both (default behavior)
        }

        // Listen for gender change
        document.addEventListener('DOMContentLoaded', function() {
            const genderSelect = document.getElementById('profileGender');
            if (genderSelect) {
                genderSelect.addEventListener('change', function() {
                    filterAvatarsByGender(this.value);
                });
            }
        });

        async function saveProfile() {
            const displayName = document.getElementById('profileDisplayName').value.trim();
            const gender = document.getElementById('profileGender').value;
            
            let avatarUrl = currentProfile.avatarUrl;
            // If selected a preset avatar (not custom upload)
            if (selectedAvatarId && selectedAvatarId !== 'custom') {
                avatarUrl = `${API_URL}/avatars/${selectedAvatarId}.svg`;
            }
            
            try {
                const res = await fetch(`${API_URL}/auth/profile`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ displayName, gender, avatarUrl })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
                    
                    // Update local profile
                    currentProfile.displayName = displayName;
                    currentProfile.gender = gender;
                    currentProfile.avatarUrl = avatarUrl;
                    
                    // Update UI
                    updateUserInfoAfterProfileUpdate();
                    hideProfileModal();
                } else {
                    const err = await res.json();
                    log('‚ùå –û—à–∏–±–∫–∞: ' + (err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'));
                }
            } catch (e) {
                log('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        async function linkEmail() {
            const email = document.getElementById('linkEmail').value.trim();
            const password = document.getElementById('linkPassword').value;
            
            if (!email || !password || password.length < 6) {
                log('‚ùå –í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/auth/link-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    log('‚úÖ ' + data.message);
                    hideProfileModal();
                } else {
                    log('‚ùå ' + (data.message || '–û—à–∏–±–∫–∞'));
                }
            } catch (e) {
                log('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Resize and compress image before storing
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize to max 200x200 for small avatar
                    const maxSize = 200;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compress to JPEG with 60% quality
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    
                    const profileImg = document.getElementById('profileCurrentAvatar');
                    profileImg.src = compressedDataUrl;
                    profileImg.style.display = 'block';
                    currentProfile.avatarUrl = compressedDataUrl;
                    selectedAvatarId = 'custom';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updateUserInfo() {
            // Update mini avatar in header
            const miniAvatar = document.getElementById('userAvatar');
            if (miniAvatar && currentProfile.avatarUrl) {
                miniAvatar.src = currentProfile.avatarUrl;
                miniAvatar.style.display = 'inline-block';
            }
        }

        function updateUserInfoAfterLogin() {
            // Show user info section
            document.getElementById('userInfo')?.classList.remove('hidden');
            
            // Update email display
            const emailDisplay = document.getElementById('userEmail');
            if (emailDisplay) {
                emailDisplay.textContent = currentProfile.displayName || userId.slice(0, 8);
            }
            
            // Update avatar
            updateUserInfo();
        }

        function updateUserInfoAfterProfileUpdate() {
            // Update display name
            const emailDisplay = document.getElementById('userEmail');
            if (emailDisplay && currentProfile.displayName) {
                emailDisplay.textContent = currentProfile.displayName;
            }
            
            // Update mini avatar in header
            const miniAvatar = document.getElementById('userAvatar');
            if (miniAvatar && currentProfile.avatarUrl) {
                miniAvatar.src = currentProfile.avatarUrl;
                miniAvatar.style.display = 'inline-block';
            }
            
            // Re-render chat to show new avatar
            renderChatMessages();
        }
    </script>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üîë –í—Ö–æ–¥</h3>
                <button class="modal-close" onclick="hideLoginModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn btn-success btn-full" onclick="doLogin()">–í–æ–π—Ç–∏</button>
                <div class="form-links">
                    <a href="#" onclick="showForgotModal(); hideLoginModal(); return false;">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal-overlay" id="registerModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                <button class="modal-close" onclick="hideRegisterModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="registerUsername" placeholder="Username">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)</label>
                    <input type="password" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn btn-success btn-full" onclick="doRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
                <button class="modal-close" onclick="hideProfileModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="profile-section">
                    <div class="avatar-preview-large" id="profileAvatarPreview">
                        <img id="profileCurrentAvatar" src="" alt="avatar">
                    </div>
                    <div class="profile-info">
                        <div class="form-group">
                            <label>–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                            <input type="text" id="profileDisplayName" placeholder="–í–∞—à–µ –∏–º—è" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>–ü–æ–ª</label>
                            <select id="profileGender">
                                <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                                <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                                <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="avatar-section" id="avatarSection">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä–∫—É</label>
                    <div class="avatar-tabs">
                        <button class="avatar-tab active" onclick="switchAvatarTab('male', this)">–ú—É–∂—Å–∫–∏–µ</button>
                        <button class="avatar-tab" onclick="switchAvatarTab('female', this)">–ñ–µ–Ω—Å–∫–∏–µ</button>
                        <button class="avatar-tab" onclick="switchAvatarTab('custom', this)">–°–≤–æ—è</button>
                    </div>
                    <div class="avatar-grid" id="maleAvatars"></div>
                    <div class="avatar-grid hidden" id="femaleAvatars"></div>
                    <div class="avatar-grid hidden" id="customAvatar">
                        <div class="upload-area" onclick="document.getElementById('avatarUpload').click()">
                            <span>üì∑ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</span>
                            <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                        </div>
                    </div>
                </div>
                
                <div class="profile-actions">
                    <button class="btn btn-success btn-full" onclick="saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                
                <div class="profile-link-email" id="linkEmailSection" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <p>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å. –ü—Ä–∏–≤—è–∂–∏—Ç–µ email –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:</p>
                    <div class="form-group">
                        <input type="email" id="linkEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <input type="password" id="linkPassword" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                    </div>
                    <button class="btn btn-primary btn-full" onclick="linkEmail()">üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å email</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal-overlay" id="forgotModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üîê –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h3>
                <button class="modal-close" onclick="hideForgotModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p class="form-info">–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</p>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="forgotEmail" placeholder="your@email.com">
                </div>
                <button class="btn btn-success btn-full" onclick="doForgotPassword()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</body>
</html>