<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WagerPlay - Rock Paper Scissors</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23667eea'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3E%F0%9F%8E%AE%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            text-align: center;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        /* Balance Card */
        .balance-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .balance-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .balance-frozen {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Control Buttons */
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(17,153,142,0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(17,153,142,0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Game Area */
        .game-area {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            min-height: 300px;
        }

        .game-status {
            text-align: center;
            margin-bottom: 30px;
        }

        .status-text {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .match-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        /* Move Buttons */
        .moves-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .move-btn {
            width: 120px;
            height: 140px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 2px solid transparent;
        }

        .move-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.05);
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .move-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .move-btn.selected {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
            box-shadow: 0 0 30px rgba(255,215,0,0.5);
        }

        .move-emoji {
            font-size: 3em;
        }

        .move-text {
            font-size: 1.1em;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Players Grid */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .player-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .player-card.active {
            border-color: #38ef7d;
            background: rgba(56,239,125,0.1);
        }

        .player-card.eliminated {
            opacity: 0.4;
            border-color: #ff4757;
        }

        .player-card.winner {
            border-color: #ffd700;
            background: rgba(255,215,0,0.2);
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }

        .player-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .player-move {
            font-size: 2em;
            margin: 10px 0;
        }

        .player-status {
            font-size: 0.8em;
            opacity: 0.8;
        }

        /* Round Info */
        .round-info {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .round-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #ffd700;
        }

        /* Log */
        .log-container {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            opacity: 0.5;
            margin-right: 10px;
        }

        /* Waiting Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .waiting {
            animation: pulse 1.5s infinite;
            text-align: center;
            font-size: 1.2em;
            padding: 40px;
        }

        .hidden {
            display: none !important;
        }

        /* Sound toggle */
        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sound-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* Language Selector */
        .lang-selector {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .lang-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .lang-btn.active {
            border-color: #ffd700;
            background: rgba(255,215,0,0.3);
        }

        /* Player Selector */
        .player-selector {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .selector-label {
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .selector-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .selector-btn {
            padding: 10px 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .selector-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
        }

        .selector-btn.active {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
            color: #ffd700;
        }

        /* Game Controls Row */
        .game-controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }

        /* Dropdown Play Button */
        .dropdown-play {
            position: relative;
            display: flex;
            align-items: center;
        }

        .btn-play-main, .btn-stake-main {
            border-radius: 12px 0 0 12px;
            padding-right: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-play-arrow, .btn-stake-arrow {
            border-radius: 0 12px 12px 0;
            padding: 12px 10px;
            margin-left: 2px;
            font-size: 0.7em;
            min-width: 32px;
            transition: transform 0.3s ease;
        }

        .btn-play-arrow:hover, .btn-stake-arrow:hover {
            transform: translateY(-2px);
        }

        .btn-play-arrow.active, .btn-stake-arrow.active {
            background: rgba(255,215,0,0.5);
        }

        .player-count-badge {
            background: rgba(255,215,0,0.8);
            color: #1e3c72;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.85em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Stats Modal */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .winrate-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .winrate-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #ffd700);
            transition: width 0.5s ease;
        }

        .public-profile {
            text-align: center;
            padding: 20px;
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
        }

        .public-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .public-stat {
            text-align: center;
        }

        .public-stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        .public-stat-label {
            font-size: 0.75em;
            opacity: 0.7;
            margin-top: 3px;
        }

        .chat-author-clickable {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .chat-author-clickable:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .player-count-badge {
            background: rgba(255,215,0,0.8);
            color: #1e3c72;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: bold;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            background: rgba(30, 60, 114, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            overflow: hidden;
            z-index: 100;
            min-width: 150px;
        }

        .dropdown-menu.show {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .dropdown-item.selected {
            background: rgba(255,215,0,0.3);
        }

        .dropdown-players {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .dropdown-item.selected .dropdown-players {
            background: #ffd700;
            color: #1e3c72;
        }

        .dropdown-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Chat */
        .chat-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
            overflow: hidden;
            display: none;
        }

        .chat-container.active {
            display: block;
        }

        .chat-header {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .chat-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            max-width: 300px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }

        .chat-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .chat-tabs::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }

        .chat-tab {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-tab.active {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
            color: #ffd700;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .chat-message.system {
            background: rgba(255,215,0,0.2);
            text-align: center;
            font-style: italic;
        }

        .chat-author {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 3px;
        }

        .chat-time {
            font-size: 0.75em;
            opacity: 0.6;
            margin-left: 10px;
        }

        .chat-input-area {
            display: flex;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            outline: none;
        }

        .chat-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .chat-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-send:hover {
            transform: scale(1.1);
        }

        .chat-closed {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
            font-style: italic;
        }

        /* Auth Buttons */
        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.1);
            padding: 8px 20px;
            border-radius: 25px;
        }

        .user-email {
            font-weight: 600;
            color: #ffd700;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1em;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .form-group input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        /* Password field with toggle */
        .password-field {
            position: relative;
        }
        
        .password-field input {
            width: 100%;
            padding-right: 40px;
        }
        
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 5px;
        }
        
        .password-toggle:hover {
            opacity: 1;
        }

        .btn-full {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
        }

        .form-links {
            text-align: center;
            margin-top: 20px;
        }

        .form-links a {
            color: #ffd700;
            text-decoration: none;
            font-size: 0.9em;
        }

        .form-links a:hover {
            text-decoration: underline;
        }

        .form-info {
            text-align: center;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        /* Profile Modal Styles */
        .profile-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .avatar-preview-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid #667eea;
            flex-shrink: 0;
        }

        .avatar-preview-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
        }

        .profile-info select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            color: white;
            font-size: 1em;
        }

        .profile-info select option {
            background: #2a5298;
            color: white;
        }

        .avatar-section {
            margin-bottom: 20px;
        }

        .avatar-section > label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .avatar-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .avatar-tab {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .avatar-tab.active {
            background: #667eea;
        }

        .avatar-tab:hover {
            background: rgba(255,255,255,0.2);
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .avatar-item {
            aspect-ratio: 1;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .avatar-item:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .avatar-item.selected {
            border-color: #00d9ff;
            box-shadow: 0 0 10px rgba(0,217,255,0.5);
        }

        .avatar-item img {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }

        .upload-area {
            grid-column: 1 / -1;
            height: 100px;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102,126,234,0.1);
        }

        .user-avatar-mini {
            transition: transform 0.3s;
        }

        .user-avatar-mini:hover {
            transform: scale(1.1);
        }

        .profile-link-email p {
            margin-bottom: 10px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <button class="sound-toggle" onclick="toggleSound()" title="–í–∫–ª/–≤—ã–∫–ª –∑–≤—É–∫">üîä</button>

    <div class="container">
        <!-- Language Selector -->
        <div class="lang-selector">
            <button class="lang-btn" onclick="setLang('ru')" id="lang-ru">üá∑üá∫</button>
            <button class="lang-btn" onclick="setLang('en')" id="lang-en">üá¨üáß</button>
            <button class="lang-btn" onclick="setLang('cn')" id="lang-cn">üá®üá≥</button>
        </div>

        <h1>üéÆ WagerPlay</h1>
        <p class="subtitle">Rock Paper Scissors - –ò–≥—Ä–∞–π –∏ –≤—ã–∏–≥—Ä—ã–≤–∞–π!</p>

        <!-- Balance -->
        <div class="balance-card">
            <div class="balance-label">üí∞ –í–ê–® –ë–ê–õ–ê–ù–°</div>
            <div class="balance-amount" id="balanceDisplay">0 VP</div>
            <div class="balance-frozen" id="frozenDisplay"></div>
        </div>

        <!-- Controls -->
        <div class="controls" id="authControls">
            <!-- Not logged in -->
            <div class="auth-buttons" id="authButtons">
                <button class="btn btn-success" onclick="showLoginModal()">üîë <span id="btnLoginText">–í–æ–π—Ç–∏</span></button>
                <button class="btn btn-primary" onclick="showRegisterModal()">üìù <span id="btnRegisterText">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></button>
                <button class="btn btn-secondary" id="btnGuest" onclick="doGuest()">üë§ <span id="btnGuestText">–ì–æ—Å—Ç—å</span></button>
            </div>
            
            <!-- Logged in -->
            <div class="user-info hidden" id="userInfo">
                <span class="user-email" id="userEmail"></span>
                <img id="userAvatar" class="user-avatar-mini" src="" alt="avatar" onclick="showProfileModal()" style="cursor: pointer; width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; display: none;">
                <button class="btn btn-secondary" onclick="showProfileModal()">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
                <button class="btn btn-secondary" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
            
            <button class="btn btn-primary" id="btnConnect" onclick="doConnect()" disabled>üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            
            <!-- Game Controls Row -->
            <div class="game-controls-row" id="gameControlsRow">
                <!-- Play Button with Player Count -->
            <div class="dropdown-play" id="dropdownPlay">
                <button class="btn btn-primary btn-play-main" id="btnQuickplay" onclick="doQuickplay()" disabled>
                    üéÆ <span id="playBtnText">–ò–≥—Ä–∞—Ç—å 2 | 100 VP</span> <span class="player-count-badge" id="playerBadge">2</span>
                </button>
                <button class="btn btn-primary btn-play-arrow" id="btnPlayArrow" onclick="togglePlayerDropdown()" disabled>
                    ‚ñº
                </button>
                <div class="dropdown-menu" id="playerDropdown">
                    <div class="dropdown-item" onclick="selectPlayersDropdown(2)">
                        <span class="dropdown-players">2</span>
                        <span class="dropdown-label">–∏–≥—Ä–æ–∫–∞</span>
                    </div>
                    <div class="dropdown-item" onclick="selectPlayersDropdown(3)">
                        <span class="dropdown-players">3</span>
                        <span class="dropdown-label">–∏–≥—Ä–æ–∫–∞</span>
                    </div>
                    <div class="dropdown-item" onclick="selectPlayersDropdown(4)">
                        <span class="dropdown-players">4</span>
                        <span class="dropdown-label">–∏–≥—Ä–æ–∫–∞</span>
                    </div>
                    <div class="dropdown-item" onclick="selectPlayersDropdown(5)">
                        <span class="dropdown-players">5</span>
                        <span class="dropdown-label">–∏–≥—Ä–æ–∫–æ–≤</span>
                    </div>
                </div>
            </div>
            
            <!-- Stake Selection Dropdown -->
            <div class="dropdown-play" id="dropdownStake" style="margin-left: 8px;">
                <button class="btn btn-primary btn-stake-main" id="btnStake" onclick="toggleStakeDropdown()" disabled>
                    üí∞ <span id="stakeBtnText">100</span> VP
                </button>
                <button class="btn btn-primary btn-stake-arrow" id="btnStakeArrow" onclick="toggleStakeDropdown()" disabled>
                    ‚ñº
                </button>
                <div class="dropdown-menu" id="stakeDropdown">
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(100)">
                        <span class="dropdown-players">100</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(200)">
                        <span class="dropdown-players">200</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(500)">
                        <span class="dropdown-players">500</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(1000)">
                        <span class="dropdown-players">1K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(2500)">
                        <span class="dropdown-players">2.5K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(5000)">
                        <span class="dropdown-players">5K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(10000)">
                        <span class="dropdown-players">10K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" id="btnBalance" onclick="doCheckBalance()" disabled>üí≥ –ë–∞–ª–∞–Ω—Å</button>
            <button class="btn btn-primary" id="btnStats" onclick="showStatsModal()" disabled>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                <button class="btn btn-primary" id="btnLogs" onclick="showLogsInChat()" disabled>üìã –õ–æ–≥–∏</button>
                <button class="btn btn-secondary" id="btnAudit" onclick="showAuditModal()" disabled>üìú Audit</button>
                <button class="btn btn-secondary" id="btnReconcile" onclick="showReconcileModal()" disabled>‚öñÔ∏è –°–≤–µ—Ä–∫–∞</button>
            </div>
        </div>

        <!-- Game Area -->
        <div class="game-area">
            <div id="gameContent">
                <div class="waiting" id="waitingText">Press "Guest Login" to start</div>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <span>üí¨ –ß–ê–¢</span>
                <div class="chat-tabs" id="chatTabsContainer">
                    <button class="chat-tab active" onclick="switchChatTab('global')" id="tab-global">–û–±—â–∏–π</button>
                    <!-- Game tabs will be added here dynamically -->
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleChatKeypress(event)">
                <button class="chat-send" onclick="sendChatMessage()">‚û§</button>
            </div>
        </div>

        <!-- Log -->
        <div class="log-container" id="log">
            <div class="log-entry"><span class="log-time">[System]</span> –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ WagerPlay!</div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // API Config
        const API_URL = window.location.origin; // –ü–æ–ª–Ω—ã–π URL –¥–ª—è ngrok –∏ localhost
        
        // Game State
        let token = "";
        let userId = "";
        let matchId = "";
        let socket = null;
        let soundEnabled = true;
        let currentMatch = null;
        const activeMatches = new Set();  // üõ°Ô∏è –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –í–°–ï –∞–∫—Ç–∏–≤–Ω—ã–µ –º–∞—Ç—á–∏
        let countdownInterval = null;
        let matchCountdownInterval = null;  // üéÆ –û—Ç—Å—á—ë—Ç –ø–µ—Ä–µ–¥ –º–∞—Ç—á–µ–º
        let playerNames = {};  // üë§ –•—Ä–∞–Ω–∏–ª–∏—â–µ ID -> displayName
        let shownRounds = new Set();  // üõ°Ô∏è –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ä–∞—É–Ω–¥–æ–≤ –≤ —á–∞—Ç–µ
        let shownMoveWarningForRound = null;  // üõ°Ô∏è Debounce –¥–ª—è "—É–∂–µ —Å–¥–µ–ª–∞–ª–∏ —Ö–æ–¥"
        let isProcessing = {
            guest: false,
            connect: false,
            quickplay: false,
            move: false
        };
        let currentLang = 'ru';

        // Translations
        const i18n = {
            ru: {
                title: 'WagerPlay - Rock Paper Scissors',
                subtitle: '–ò–≥—Ä–∞–π –∏ –≤—ã–∏–≥—Ä—ã–≤–∞–π!',
                balance: '–í–ê–® –ë–ê–õ–ê–ù–°',
                frozen: '–ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ',
                guest: 'üë§ Guest Login',
                connect: 'üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è',
                quickplay: 'üéÆ –ò–≥—Ä–∞—Ç—å 4/100',
                balanceBtn: 'üí≥ –ë–∞–ª–∞–Ω—Å',
            statsBtn: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                waitingGuest: '–ù–∞–∂–º–∏—Ç–µ "Guest Login" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å',
                waitingQueue: '–í –æ—á–µ—Ä–µ–¥–∏...',
                searching: '–ò—â–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤...',
                yourTurn: 'üéÆ –í–ê–® –•–û–î!',
                waitingTurn: '‚è≥ –û–ñ–ò–î–ê–ù–ò–ï',
                victory: 'üèÜ –ü–û–ë–ï–î–ê!',
                defeat: 'üíÄ –ü–û–†–ê–ñ–ï–ù–ò–ï',
                round: '–†–∞—É–Ω–¥',
                pot: '–ë–∞–Ω–∫',
                stake: '–°—Ç–∞–≤–∫–∞',
                payout: '–í—ã–ø–ª–∞—Ç–∞',
                winner: '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å',
                eliminated: '–í—ã–±—ã–ª',
                inGame: '–í –∏–≥—Ä–µ',
                rock: '–ö–∞–º–µ–Ω—å',
                paper: '–ë—É–º–∞–≥–∞',
                scissors: '–ù–æ–∂–Ω–∏—Ü—ã',
                playAgain: 'üîÑ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞',
                tie: 'ü§ù –ù–∏—á—å—è',
                elimination: '‚öîÔ∏è –í—ã–±—ã–≤–∞–Ω–∏–µ',
                wonWith: '–ü–æ–±–µ–¥–∏–ª',
                chat: 'üí¨ –ß–ê–¢',
                global: '–û–±—â–∏–π',
                game: '–ò–≥—Ä–∞',
                chatPlaceholder: '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...',
                players2: '2 –∏–≥—Ä–æ–∫–∞',
                players3: '3 –∏–≥—Ä–æ–∫–∞',
                players4: '4 –∏–≥—Ä–æ–∫–∞',
                selectPlayers: '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:',
                you: '–í—ã',
                alreadyInQueue: '–í—ã —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏!',
                chatWillClose: '–ß–∞—Ç –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã',
                gameStarted: '–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –£–¥–∞—á–∏!',
                login: '–í–æ–π—Ç–∏',
                register: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                logout: '–í—ã–π—Ç–∏',
                guest: '–ì–æ—Å—Ç—å',
                statsBtn: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'
            },
            en: {
                title: 'WagerPlay - Rock Paper Scissors',
                subtitle: 'Play and Win!',
                balance: 'YOUR BALANCE',
                frozen: 'Frozen',
                guest: 'üë§ Guest Login',
                connect: 'üîó Connect',
                quickplay: 'üéÆ Quickplay 4/100',
                balanceBtn: 'üí≥ Balance',
                waitingGuest: 'Press "Guest Login" to start',
                waitingQueue: 'In queue...',
                searching: 'Searching for players...',
                yourTurn: 'üéÆ YOUR TURN!',
                waitingTurn: '‚è≥ WAITING',
                victory: 'üèÜ VICTORY!',
                defeat: 'üíÄ DEFEAT',
                round: 'Round',
                pot: 'Pot',
                stake: 'Stake',
                payout: 'Payout',
                winner: 'Winner',
                eliminated: 'Eliminated',
                inGame: 'In game',
                rock: 'Rock',
                paper: 'Paper',
                scissors: 'Scissors',
                playAgain: 'üîÑ Play Again',
                tie: 'ü§ù Tie',
                elimination: '‚öîÔ∏è Elimination',
                wonWith: 'Won with',
                chat: 'üí¨ CHAT',
                global: 'Global',
                game: 'Game',
                chatPlaceholder: 'Type message...',
                players2: '2 Players',
                players3: '3 Players',
                players4: '4 Players',
                selectPlayers: 'Select mode:',
                you: 'You',
                alreadyInQueue: 'Already in queue!',
                chatWillClose: 'Chat will close in 2 minutes',
                gameStarted: 'Game started! Good luck!',
                login: 'Login',
                register: 'Register',
                logout: 'Logout',
                guest: 'Guest',
                statsBtn: 'üìä Stats'
            },
            cn: {
                title: 'WagerPlay - Áü≥Â§¥Ââ™ÂàÄÂ∏É',
                subtitle: 'Áé©Ê∏∏ÊàèÔºåËµ¢Â§ßÂ•ñÔºÅ',
                balance: 'ÊÇ®ÁöÑ‰ΩôÈ¢ù',
                frozen: 'ÂÜªÁªì',
                guest: 'üë§ Ê∏∏ÂÆ¢ÁôªÂΩï',
                connect: 'üîó ËøûÊé•',
                quickplay: 'üéÆ Âø´ÈÄüÊ∏∏Êàè 4/100',
                balanceBtn: 'üí≥ ‰ΩôÈ¢ù',
                waitingGuest: 'ÁÇπÂáª"Ê∏∏ÂÆ¢ÁôªÂΩï"ÂºÄÂßã',
                waitingQueue: 'ÊéíÈòü‰∏≠...',
                searching: 'ÂØªÊâæÁé©ÂÆ∂...',
                yourTurn: 'üéÆ ËΩÆÂà∞ÊÇ®ÔºÅ',
                waitingTurn: '‚è≥ Á≠âÂæÖ‰∏≠',
                victory: 'üèÜ ËÉúÂà©ÔºÅ',
                defeat: 'üíÄ Â§±Ë¥•',
                round: 'ÂõûÂêà',
                pot: 'Â•ñÊ±†',
                stake: 'ËµåÊ≥®',
                payout: 'Â•ñÈáë',
                winner: 'Ëµ¢ÂÆ∂',
                eliminated: 'Â∑≤Ê∑òÊ±∞',
                inGame: 'Ê∏∏Êàè‰∏≠',
                rock: 'Áü≥Â§¥',
                paper: 'Â∏É',
                scissors: 'Ââ™ÂàÄ',
                playAgain: 'üîÑ ÂÜçÁé©‰∏ÄÊ¨°',
                tie: 'ü§ù Âπ≥Â±Ä',
                elimination: '‚öîÔ∏è Ê∑òÊ±∞',
                wonWith: 'Ëé∑ËÉú',
                chat: 'üí¨ ËÅäÂ§©',
                global: 'ÂÖ®Â±Ä',
                game: 'Ê∏∏Êàè',
                chatPlaceholder: 'ËæìÂÖ•Ê∂àÊÅØ...',
                players2: '2‰∫∫',
                players3: '3‰∫∫',
                players4: '4‰∫∫',
                selectPlayers: 'ÈÄâÊã©Ê®°ÂºèÔºö',
                you: 'ÊÇ®',
                alreadyInQueue: 'Â∑≤ÁªèÂú®ÈòüÂàó‰∏≠ÔºÅ',
                chatWillClose: 'ËÅäÂ§©Â∞ÜÂú®2ÂàÜÈíüÂêéÂÖ≥Èó≠',
                gameStarted: 'Ê∏∏ÊàèÂºÄÂßãÔºÅÁ•ù‰Ω†Â•ΩËøêÔºÅ',
                login: 'ÁôªÂΩï',
                register: 'Ê≥®ÂÜå',
                logout: 'ÈÄÄÂá∫',
                guest: 'Ê∏∏ÂÆ¢',
                statsBtn: 'üìä ÁªüËÆ°'
            }
        };

        function t(key) {
            return i18n[currentLang][key] || key;
        }

        function setLang(lang) {
            currentLang = lang;
            const btnGuest = document.getElementById('btnGuest');
            const btnConnect = document.getElementById('btnConnect');
            const playBtnText = document.getElementById('playBtnText');
            const btnBalance = document.getElementById('btnBalance');
            const subtitle = document.querySelector('.subtitle');
            const balanceLabel = document.querySelector('.balance-label');
            
            const btnLoginText = document.getElementById('btnLoginText');
            const btnRegisterText = document.getElementById('btnRegisterText');
            const btnGuestText = document.getElementById('btnGuestText');
            
            if (btnLoginText) btnLoginText.textContent = t('login');
            if (btnRegisterText) btnRegisterText.textContent = t('register');
            if (btnGuestText) btnGuestText.textContent = t('guest');
            if (btnConnect) btnConnect.textContent = t('connect');
            if (playBtnText) playBtnText.textContent = t('quickplay');
            if (btnBalance) btnBalance.textContent = t('balanceBtn');
            const btnStats = document.getElementById('btnStats');
            if (btnStats) btnStats.textContent = t('statsBtn');
            if (subtitle) subtitle.textContent = t('subtitle');
            if (balanceLabel) balanceLabel.textContent = 'üí∞ ' + t('balance');
            
            // Update language buttons
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            const langBtn = document.getElementById(`lang-${lang}`);
            if (langBtn) langBtn.classList.add('active');
            
            // Refresh match display if exists
            if (currentMatch) renderMatch(currentMatch);
        }

        // Player Selection
        let selectedPlayers = 2;
        let selectedStake = 100; // –î–µ—Ñ–æ–ª—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞
        let currentChatTab = 'global';
        let currentGameChatId = null; // ID —Ç–µ–∫—É—â–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ –∏–≥—Ä—ã
        let gameChatTimeouts = {}; // –¢–∞–π–º–µ—Ä—ã –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –∏–≥—Ä—ã { matchId: timeout }

        function selectPlayers(count) {
            if (isProcessing.quickplay) {
                sounds.error();
                return;
            }
            selectedPlayers = count;
            // Update badge on main button
            document.getElementById('playerBadge').textContent = count;
            // Update dropdown selection
            updateDropdownSelection(count);
            sounds.click();
            log(`${t('selectPlayers')} ${count}`);
        }

        function togglePlayerDropdown() {
            const dropdown = document.getElementById('playerDropdown');
            const arrow = document.getElementById('btnPlayArrow');
            dropdown.classList.toggle('show');
            arrow.classList.toggle('active');
            // Close stake dropdown if open
            document.getElementById('stakeDropdown').classList.remove('show');
            document.getElementById('btnStakeArrow').classList.remove('active');
            sounds.click();
        }
        
        function toggleStakeDropdown() {
            const dropdown = document.getElementById('stakeDropdown');
            const arrow = document.getElementById('btnStakeArrow');
            dropdown.classList.toggle('show');
            arrow.classList.toggle('active');
            // Close player dropdown if open
            document.getElementById('playerDropdown').classList.remove('show');
            document.getElementById('btnPlayArrow').classList.remove('active');
            sounds.click();
        }
        
        function selectStakeDropdown(stake) {
            selectedStake = stake;
            const stakeText = stake >= 1000 ? (stake/1000) + 'K' : stake;
            document.getElementById('stakeBtnText').textContent = stakeText;
            
            // Update selection visual
            document.querySelectorAll('.stake-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Close dropdown
            document.getElementById('stakeDropdown').classList.remove('show');
            document.getElementById('btnStakeArrow').classList.remove('active');
            
            sounds.click();
            log(`üí∞ –°—Ç–∞–≤–∫–∞: ${stake} VP`);
        }

        function selectPlayersDropdown(count) {
            selectedPlayers = count;
            document.getElementById('playerBadge').textContent = count;
            updateDropdownSelection(count);
            
            // Update button text with selected player count and stake
            const btnText = document.getElementById('playBtnText');
            const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
            if (btnText) {
                btnText.textContent = `–ò–≥—Ä–∞—Ç—å ${count} | ${stakeText} VP`;
            }
            
            // Close dropdown
            document.getElementById('playerDropdown').classList.remove('show');
            document.getElementById('btnPlayArrow').classList.remove('active');
            
            sounds.click();
            log(`${t('selectPlayers')} ${count}`);
        }

        function updateDropdownSelection(count) {
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('selected');
            });
            // Select the item (based on index 0=2, 1=3, 2=4, 3=5)
            const items = document.querySelectorAll('.dropdown-item');
            if (items[count - 2]) {
                items[count - 2].classList.add('selected');
            }
        }

        // Chat Functions - Each game has its own chat
        function switchChatTab(tab, gameId = null) {
            currentChatTab = tab;
            if (gameId) currentGameChatId = gameId;
            
            // Update UI tabs - remove active from all
            document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
            
            // Activate correct tab
            if (tab === 'global') {
                document.getElementById('tab-global').classList.add('active');
            } else if (tab === 'game' && currentGameChatId) {
                const tabId = `tab-game-${currentGameChatId}`;
                const gameTab = document.getElementById(tabId);
                if (gameTab) gameTab.classList.add('active');
            }
            
            // Update chat title
            const chatTitle = document.querySelector('.chat-header span');
            if (tab === 'global') {
                chatTitle.textContent = 'üí¨ ' + t('chat') + ' - ' + t('global');
            } else if (tab === 'game' && currentGameChatId) {
                const shortId = currentGameChatId.slice(0, 8);
                chatTitle.textContent = `üí¨ Game #${shortId}`;
            }
            
            renderChatMessages();
            sounds.click();
        }

        function showChat() {
            const chat = document.getElementById('chatContainer');
            chat.classList.add('active');
            chat.style.display = 'block';
        }

        function hideChat() {
            const chat = document.getElementById('chatContainer');
            chat.classList.remove('active');
            chat.style.display = 'none';
        }

        function createGameChat(gameMatchId) {
            console.log('Creating game chat for:', gameMatchId);
            if (!window.chatHistory) window.chatHistory = { global: [], games: {} };
            if (!window.chatHistory.games) window.chatHistory.games = {};
            if (!window.chatHistory.games[gameMatchId]) {
                window.chatHistory.games[gameMatchId] = [];
            }
            currentGameChatId = gameMatchId;
            
            // Create new tab for this game
            const tabsContainer = document.getElementById('chatTabsContainer');
            const tabId = `tab-game-${gameMatchId}`;
            
            // Check if tab already exists
            if (!document.getElementById(tabId)) {
                const newTab = document.createElement('button');
                newTab.className = 'chat-tab';
                newTab.id = tabId;
                newTab.textContent = '#' + gameMatchId.slice(0, 6);
                newTab.onclick = () => switchChatTab('game', gameMatchId);
                tabsContainer.appendChild(newTab);
            }
            
            // Add system message
            addChatMessage('system', 'System', `${t('gameStarted')} #${gameMatchId.slice(0, 8)}`, 'game', gameMatchId);
            
            // Switch to this game chat
            switchChatTab('game', gameMatchId);
            
            console.log('Game chat created. Current games:', Object.keys(window.chatHistory.games));
        }

        function closeGameChat(gameMatchId) {
            if (!gameMatchId) gameMatchId = currentGameChatId;
            if (!gameMatchId) return;
            
            // Mark chat as closed
            if (window.chatHistory.games && window.chatHistory.games[gameMatchId]) {
                window.chatHistory.games[gameMatchId].push({
                    type: 'system',
                    author: 'System',
                    text: t('chatClosed'),
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    closed: true
                });
            }
            
            // Find the specific tab for this game and add lock
            const tabId = `tab-game-${gameMatchId}`;
            const gameTab = document.getElementById(tabId);
            if (gameTab) {
                gameTab.textContent = '#' + gameMatchId.slice(0, 6) + ' üîí';
                gameTab.style.opacity = '0.5';
            }
            
            // If this is current game, refresh messages
            if (currentGameChatId === gameMatchId) {
                renderChatMessages();
            }
            
            // Schedule tab removal after 2 minutes (total 4 minutes from game end)
            setTimeout(() => {
                const tabToRemove = document.getElementById(tabId);
                if (tabToRemove) {
                    tabToRemove.remove();
                    // Clean up history
                    if (window.chatHistory.games[gameMatchId]) {
                        delete window.chatHistory.games[gameMatchId];
                    }
                }
            }, 120000); // Remove tab after additional 2 minutes
        }

        function handleChatKeypress(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            const author = currentProfile.displayName || (userId ? userId.slice(0,8) : 'Guest');

            if (currentChatTab === 'global') {
                if (socket) socket.emit('chat:global', { text });
                // –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–∏—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—É–±—Ä–∞–ª–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)
            } else if (currentChatTab === 'game' && currentGameChatId) {
                if (socket) socket.emit('chat:game', { matchId: currentGameChatId, text });
                // –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–∏—Ç—Å—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—É–±—Ä–∞–ª–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)
            }

            input.value = '';
            sounds.click();
        }

        function addChatMessage(type, author, text, tab, gameId = null, avatarUrl = null) {
            if (!window.chatHistory) window.chatHistory = { global: [] };
            if (!window.chatHistory.games) window.chatHistory.games = {};
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const message = { type, author, text, time, avatarUrl };
            
            if (tab === 'global') {
                window.chatHistory.global.push(message);
            } else if (tab === 'game' && gameId) {
                if (!window.chatHistory.games[gameId]) window.chatHistory.games[gameId] = [];
                window.chatHistory.games[gameId].push(message);
            }
            
            if (currentChatTab === tab && (tab === 'global' || currentGameChatId === gameId)) {
                renderChatMessages();
            }
        }

        function renderChatMessages() {
            const messagesEl = document.getElementById('chatMessages');
            if (!messagesEl) return;
            messagesEl.innerHTML = '';
            
            let history = [];
            if (currentChatTab === 'global') {
                history = window.chatHistory?.global || [];
            } else if (currentChatTab === 'game' && currentGameChatId) {
                history = window.chatHistory?.games?.[currentGameChatId] || [];
            }
            
            if (history.length === 0) {
                messagesEl.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 20px;">No messages yet</div>';
            }
            
            history.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.className = `chat-message ${msg.type}`;
                if (msg.type === 'system') {
                    messageEl.textContent = msg.text;
                } else {
                    // Determine avatar and display name
                    let avatarSrc = msg.avatarUrl || `${API_URL}/avatars/male1.svg`; // default or from message
                    let displayAuthor = msg.author;
                    
                    // If message is from current user, show their display name and avatar
                    const isCurrentUser = msg.author === userId.slice(0,8) || msg.author === currentProfile.displayName;
                    if (isCurrentUser) {
                        displayAuthor = currentProfile.displayName || msg.author;
                        if (currentProfile.avatarUrl) {
                            avatarSrc = currentProfile.avatarUrl;
                        }
                    }
                    
                    // Make author name clickable if not current user
                    const authorClass = isCurrentUser ? 'chat-author' : 'chat-author chat-author-clickable';
                    const authorClick = isCurrentUser ? '' : `onclick="showPublicProfile('${msg.author}', '${displayAuthor}')"`;
                    
                    messageEl.innerHTML = `
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <img src="${avatarSrc}" style="width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0; cursor: ${isCurrentUser ? 'default' : 'pointer'};" ${authorClick}>
                            <div style="flex: 1;">
                                <div class="${authorClass}" ${authorClick}>${displayAuthor} <span class="chat-time">${msg.time}</span></div>
                                <div>${escapeHtml(msg.text)}</div>
                            </div>
                        </div>
                    `;
                }
                messagesEl.appendChild(messageEl);
            });
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal functions
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('show');
            sounds.click();
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('show');
            sounds.click();
        }

        function hideRegisterModal() {
            document.getElementById('registerModal').classList.remove('show');
        }

        function showForgotModal() {
            document.getElementById('forgotModal').classList.add('show');
            sounds.click();
        }

        function hideForgotModal() {
            document.getElementById('forgotModal').classList.remove('show');
        }

        function closeModal(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.classList.remove('show');
            }
        }

        // Global Enter handler for modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                // Check which modal is open
                const loginModal = document.getElementById('loginModal');
                const registerModal = document.getElementById('registerModal');
                const forgotModal = document.getElementById('forgotModal');
                
                if (loginModal && loginModal.classList.contains('show')) {
                    event.preventDefault();
                    doLogin();
                } else if (registerModal && registerModal.classList.contains('show')) {
                    event.preventDefault();
                    doRegister();
                } else if (forgotModal && forgotModal.classList.contains('show')) {
                    event.preventDefault();
                    doForgotPassword();
                }
            }
        });

        // Password toggle function
        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }

        // Enter key handler
        function handleEnter(event, action) {
            if (event.key === 'Enter') {
                event.preventDefault();
                switch(action) {
                    case 'login':
                        doLogin();
                        break;
                    case 'register':
                        doRegister();
                        break;
                    case 'linkEmail':
                        linkEmail();
                        break;
                }
            }
        }

        // Auth API functions
        async function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }

            try {
                const r = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await r.json();

                if (r.ok) {
                    token = data.token;
                    userId = data.userId;
                    currentProfile = {
                        displayName: data.displayName || data.username || email,
                        gender: data.gender || '',
                        avatarUrl: data.avatarUrl || '',
                        isGuest: false
                    };
                    updateBalanceDisplay(data.balanceWp);
                    hideLoginModal();
                    showUserInfo(data.email || data.username);
                    log(`‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω: ${data.email || data.username}`);
                    setButtons({ showAuth: false, showUser: true, showConnect: true, connect: true, quickplay: false, balance: true, logs: false });
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Å –∞–≤–∞—Ç–∞—Ä–∫–æ–π
                    await loadProfile();
                    updateUserInfoAfterLogin();
                } else {
                    // –ï—Å–ª–∏ email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ
                    if (data.message && data.message.includes('Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω')) {
                        if (confirm(data.message + '\n\n–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ?')) {
                            await resendVerification(email);
                        }
                    } else {
                        alert(data.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                    }
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
            }
        }

        // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        async function resendVerification(email) {
            try {
                const r = await fetch(`${API_URL}/auth/resend-verification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await r.json();
                alert(data.message || '–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message);
            }
        }

        async function doRegister() {
            const email = document.getElementById('registerEmail').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!email || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }
            if (password.length < 6) {
                alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            try {
                const r = await fetch('/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, username })
                });
                const data = await r.json();

                if (r.ok) {
                    hideRegisterModal();
                    alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
                    log('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ' + data.message);
                } else {
                    alert(data.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
            }
        }

        async function doForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();

            if (!email) {
                alert('–í–≤–µ–¥–∏—Ç–µ email');
                return;
            }

            try {
                const r = await fetch('/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await r.json();

                hideForgotModal();
                alert(data.message);
                log('üìß ' + data.message);
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
            }
        }

        function showUserInfo(email) {
            document.getElementById('authButtons').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userEmail').textContent = email;
        }

        function logout() {
            token = '';
            userId = '';
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            document.getElementById('authButtons').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            setButtons({ showAuth: true, showUser: false, showConnect: false, connect: false, quickplay: false, balance: false, logs: false });
            log('üëã –í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
            sounds.click();
        }

        // Initialize on load
        window.onload = function() {
            // Initialize button states - show auth buttons, hide others
            setButtons({ showAuth: true, showUser: false, showConnect: false, connect: false, quickplay: false, balance: false, logs: false });
            setLang('ru');
            // Initialize chat history structure
            window.chatHistory = { global: [], games: {} };
            gameChatTimeouts = {};
            // Add welcome message
            addChatMessage('system', 'System', 'Welcome to WagerPlay! Select language above.', 'global');
            // Initialize button text with default player count
            const btnText = document.getElementById('playBtnText');
            if (btnText) {
                btnText.textContent = `–ò–≥—Ä–∞—Ç—å 2/100`;
            }
            // Initialize player badge
            const playerBadge = document.getElementById('playerBadge');
            if (playerBadge) {
                playerBadge.textContent = '2';
            }
            // Initialize dropdown selection
            updateDropdownSelection(2);
            // Close all dropdowns
            document.getElementById('playerDropdown').classList.remove('show');
            document.getElementById('stakeDropdown').classList.remove('show');
            document.getElementById('btnPlayArrow').classList.remove('active');
            document.getElementById('btnStakeArrow').classList.remove('active');
        };

        // Audio Context for sounds
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        // Sound effects
        const sounds = {
            click: () => playTone(800, 0.1, 'square'),
            error: () => playMelody([200, 150], 0.1),
            matchFound: () => {
                // üéÆ –ú–ê–¢–ß –ù–ê–ô–î–ï–ù! - —Ä–∞–¥–æ—Å—Ç–Ω—ã–π –∑–≤—É–∫
                const now = audioCtx.currentTime;
                const notes = [
                    { f: 440, d: 0.1, t: 0 },
                    { f: 554, d: 0.1, t: 0.1 },
                    { f: 659, d: 0.3, t: 0.2 },
                ];
                notes.forEach(n => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = n.f;
                    osc.type = 'triangle';
                    gain.gain.setValueAtTime(0.0, now + n.t);
                    gain.gain.linearRampToValueAtTime(0.4, now + n.t + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + n.t + n.d);
                    osc.start(now + n.t);
                    osc.stop(now + n.t + n.d);
                });
            },
            countdown: (num) => {
                // ‚è±Ô∏è –ó–≤—É–∫ –æ—Ç—Å—á—ë—Ç–∞ (–±–∏–ø –¥–ª—è –∫–∞–∂–¥–æ–π —Ü–∏—Ñ—Ä—ã)
                const freq = num <= 3 ? 880 : 660; // –í—ã—à–µ –∑–≤—É–∫ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 —Å–µ–∫
                playTone(freq, 0.15, 'square');
            },
            matchStart: () => playMelody([440, 554, 659, 880], 0.1),
            win: () => {
                // üèÜ –ü–æ–±–µ–¥–Ω–∞—è –º–µ–ª–æ–¥–∏—è (—Ñ–∞–Ω—Ñ–∞—Ä—ã) ~2.5 —Å–µ–∫
                const now = audioCtx.currentTime;
                const notes = [
                    { f: 523, d: 0.15, t: 0 },      // C5
                    { f: 659, d: 0.15, t: 0.15 },   // E5
                    { f: 784, d: 0.15, t: 0.30 },   // G5
                    { f: 1047, d: 0.50, t: 0.45 },  // C6 (—É–¥–ª–∏–Ω—ë–Ω–Ω–∞—è)
                    { f: 523, d: 0.10, t: 1.0 },    // C5 (—ç—Ö–æ)
                    { f: 659, d: 0.10, t: 1.15 },   // E5
                    { f: 784, d: 0.10, t: 1.30 },   // G5
                    { f: 1047, d: 0.80, t: 1.45 }   // C6 (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–Ω–∞—è)
                ];
                notes.forEach(n => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = n.f;
                    osc.type = 'triangle';
                    gain.gain.setValueAtTime(0.0, now + n.t);
                    gain.gain.linearRampToValueAtTime(0.4, now + n.t + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + n.t + n.d);
                    osc.start(now + n.t);
                    osc.stop(now + n.t + n.d);
                });
            },
            lose: () => playMelody([400, 350, 300], 0.15),
            tie: () => playTone(440, 0.2, 'sine'),
            move: () => playTone(600, 0.05, 'square'),
            matchStart: () => playMelody([440, 554, 659, 880], 0.1)
        };

        function playTone(freq, duration, type = 'sine') {
            if (!soundEnabled) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            osc.type = type;
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + duration);
        }

        function playMelody(frequencies, duration) {
            if (!soundEnabled) return;
            frequencies.forEach((freq, i) => {
                setTimeout(() => playTone(freq, duration), i * duration * 1000);
            });
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.querySelector('.sound-toggle').textContent = soundEnabled ? 'üîä' : 'üîá';
        }

        // Logging
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logEl.insertBefore(entry, logEl.firstChild);
        }

        // Get server logs from backend
        async function getServerLogs() {
            if (!matchId) {
                log('‚ùå No active match');
                return;
            }
            try {
                const r = await fetch(`/matchmaking/match/${matchId}/audit`);
                const logs = await r.json();
                console.log('=== SERVER LOGS ===', logs);
                console.log('Full logs:', JSON.stringify(logs, null, 2));
                log(`üìã Server logs: ${logs.length} entries (see Console)`);
                return logs;
            } catch (e) {
                log(`‚ùå Error getting logs: ${e.message}`);
            }
        }

        // View server logs in VS Code Terminal:
        // 1. Open VS Code
        // 2. Look at bottom panel (Terminal tab)
        // 3. All errors and logs are shown there
        // Or press Ctrl+` (backtick) to open terminal

        // Show server logs in chat
        function showLogsInChat() {
            getServerLogs().then(logs => {
                if (logs && logs.length > 0) {
                    addChatMessage('system', 'System', `üìã Match logs: ${logs.length} events`, 'game', matchId);
                    logs.slice(-5).forEach(l => {
                        const msg = `[${l.eventType}] ${l.actorId?.slice(0,8) || 'System'}`;
                        addChatMessage('system', 'Log', msg, 'game', matchId);
                    });
                }
            });
        }

        // Update UI
        function updateBalanceDisplay(balance, frozen = 0) {
            document.getElementById('balanceDisplay').textContent = `${balance} VP`;
            document.getElementById('frozenDisplay').textContent = frozen > 0 ? `–ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ: ${frozen} VP` : '';
        }

        function setButtons(state) {
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            const btnConnect = document.getElementById('btnConnect');
            const dropdownPlay = document.getElementById('dropdownPlay');
            const dropdownStake = document.getElementById('dropdownStake');
            const btnQuickplay = document.getElementById('btnQuickplay');
            const btnPlayArrow = document.getElementById('btnPlayArrow');
            const btnStake = document.getElementById('btnStake');
            const btnStakeArrow = document.getElementById('btnStakeArrow');
            const btnBalance = document.getElementById('btnBalance');
            const btnStats = document.getElementById('btnStats');
            const btnLogs = document.getElementById('btnLogs');
            const btnAudit = document.getElementById('btnAudit');
            const btnReconcile = document.getElementById('btnReconcile');
            const balanceCard = document.querySelector('.balance-card');
            
            // Phase 1: Auth (Login/Register/Guest visible)
            if (authButtons) authButtons.style.display = state.showAuth ? 'flex' : 'none';
            if (userInfo) userInfo.style.display = state.showUser ? 'flex' : 'none';
            
            // Phase 2: Connect (after login) - show Connect button, hide game buttons
            if (btnConnect) {
                btnConnect.style.display = state.showConnect ? 'inline-block' : 'none';
                btnConnect.disabled = !state.connect;
            }
            
            // Game controls row - show only after connect
            const gameControlsRow = document.getElementById('gameControlsRow');
            if (gameControlsRow) {
                gameControlsRow.style.display = state.quickplay ? 'flex' : 'none';
                gameControlsRow.style.flexWrap = 'wrap';
            }
            
            // Enable/disable game buttons
            // üõ°Ô∏è –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞–≤–∫–∏ –∏ –∏–≥—Ä—ã –µ—Å–ª–∏ –∏–¥–µ—Ç –ø–æ–∏—Å–∫ (isProcessing.quickplay) –ò–õ–ò —É–∂–µ –≤ –º–∞—Ç—á–µ (activeMatches)
            const isInMatch = activeMatches.size > 0;
            const isSearching = isProcessing.quickplay || isInMatch;
            console.log('[setButtons] isProcessing.quickplay:', isProcessing.quickplay, 'activeMatches:', Array.from(activeMatches), 'isInMatch:', isInMatch, 'isSearching:', isSearching);
            if (btnQuickplay) btnQuickplay.disabled = !state.quickplay || isSearching;
            if (btnPlayArrow) btnPlayArrow.disabled = !state.quickplay || isSearching;
            if (btnStake) btnStake.disabled = !state.quickplay || isSearching;
            if (btnStakeArrow) btnStakeArrow.disabled = !state.quickplay || isSearching;
            // üõ°Ô∏è –í–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
            if (btnQuickplay) btnQuickplay.style.opacity = isSearching ? '0.5' : '1';
            if (btnStake) btnStake.style.opacity = isSearching ? '0.5' : '1';
            if (btnBalance) {
                btnBalance.style.display = state.quickplay ? 'inline-block' : 'none';
                btnBalance.disabled = !state.balance;
            }
            if (btnStats) {
                btnStats.style.display = state.quickplay ? 'inline-block' : 'none';
                btnStats.disabled = !state.balance;
            }
            if (btnLogs) {
                btnLogs.style.display = state.quickplay ? 'inline-block' : 'none';
                btnLogs.disabled = !state.logs;
            }
            if (btnAudit) {
                btnAudit.style.display = state.quickplay ? 'inline-block' : 'none';
                btnAudit.disabled = !state.balance;
            }
            if (btnReconcile) {
                btnReconcile.style.display = state.quickplay ? 'inline-block' : 'none';
                btnReconcile.disabled = !state.balance;
            }
            
            // Show balance card only after login
            if (balanceCard) balanceCard.style.display = (state.showUser || state.showConnect || state.quickplay) ? 'block' : 'none';
        }
        
        function updateWaitingText() {
            const waitingText = document.getElementById('waitingText');
            if (!waitingText) return;
            
            if (!token) {
                waitingText.textContent = t('waitingGuest');
            } else if (!socket) {
                waitingText.textContent = t('connect') + ' ‚Üí';
            } else {
                waitingText.textContent = t('waitingQueue');
            }
        }

        // Guest Login
        async function doGuest() {
            if (isProcessing.guest) {
                sounds.error();
                return;
            }
            isProcessing.guest = true;
            sounds.click();
            
            try {
                const r = await fetch(`${API_URL}/auth/guest`, { method: "POST" });
                const j = await r.json();
                token = j.token;
                userId = j.userId;
                currentProfile = {
                    displayName: j.displayName || `Guest${userId.slice(0,6)}`,
                    gender: '',
                    avatarUrl: '',
                    isGuest: true
                };
                updateBalanceDisplay(j.balanceWp);
                log(`‚úÖ Guest login: ${userId.slice(0,8)}...`);
                setButtons({ showAuth: false, showUser: true, showConnect: true, connect: true, quickplay: false, balance: true, logs: false });
                updateUserInfoAfterLogin();
                updateWaitingText();
                doCheckBalance();
            } catch (e) {
                log(`‚ùå Guest error: ${e.message}`);
            } finally {
                isProcessing.guest = false;
            }
        }

        // Check Balance
        async function doCheckBalance() {
            sounds.click();
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ Guest');
                return;
            }
            try {
                const r = await fetch("/wallet", {
                    headers: { "Authorization": "Bearer " + token }
                });
                const j = await r.json();
                if (j.balanceWp !== undefined) {
                    updateBalanceDisplay(j.balanceWp, j.frozenWp);
                    log(`üí∞ –ë–∞–ª–∞–Ω—Å: ${j.balanceWp} VP`);
                }
            } catch (e) {
                log(`‚ùå Balance error: ${e.message}`);
            }
        }

        // üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        async function doShowStats() {
            sounds.click();
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ Guest');
                return;
            }
            try {
                console.log('[doShowStats] Fetching stats...');
                const r = await fetch("/auth/stats", {
                    headers: { "Authorization": "Bearer " + token }
                });
                console.log('[doShowStats] Response status:', r.status);
                const s = await r.json();
                console.log('[doShowStats] Stats data:', s);
                
                log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                log('‚ïë       üìä –í–ê–®–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê       ‚ïë');
                log('‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£');
                log(`‚ïë üéÆ –ú–∞—Ç—á–µ–π: ${s.totalMatches.toString().padStart(3)}              ‚ïë`);
                log(`‚ïë ‚úÖ –ü–æ–±–µ–¥: ${s.wins.toString().padStart(3)}  ‚ùå –ü–æ—Ä–∞–∂–µ–Ω–∏–π: ${s.losses.toString().padStart(3)}  ‚ïë`);
                log(`‚ïë üìà –í–∏–Ω—Ä–µ–π—Ç: ${s.winRate.toString().padStart(3)}%              ‚ïë`);
                log(`‚ïë üî• –°–µ—Ä–∏—è: ${s.winStreak} (–ú–∞–∫—Å: ${s.maxWinStreak})         ‚ïë`);
                log('‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£');
                log(`‚ïë üí∞ –í—Å–µ–≥–æ –≤—ã–∏–≥—Ä–∞–Ω–æ: ${s.totalWonVp.toString().padStart(6)} VP   ‚ïë`);
                log(`‚ïë üí∏ –í—Å–µ–≥–æ –ø—Ä–æ–∏–≥—Ä–∞–Ω–æ: ${s.totalLostVp.toString().padStart(5)} VP   ‚ïë`);
                log(`‚ïë üéØ –ú–∞–∫—Å. –≤—ã–∏–≥—Ä—ã—à: ${s.biggestWinVp.toString().padStart(6)} VP   ‚ïë`);
                log(`‚ïë üé≤ –ú–∞–∫—Å. —Å—Ç–∞–≤–∫–∞: ${s.biggestStakeVp.toString().padStart(6)} VP   ‚ïë`);
                log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
            } catch (e) {
                console.error('[doShowStats] Error:', e);
                log(`‚ùå Stats error: ${e.message}`);
            }
        }

        // Connect WebSocket
        function doConnect() {
            if (isProcessing.connect) {
                sounds.error();
                return;
            }
            isProcessing.connect = true;
            sounds.click();
            
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ Guest token');
                isProcessing.connect = false;
                return;
            }

            socket = io(window.location.origin, { 
                auth: { 
                    token,
                    displayName: currentProfile.displayName || ''
                } 
            });

            socket.on("connected", (m) => {
                isProcessing.connect = false;
                log(`üîó WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω: ${m.userId.slice(0,8)}...`);
                // üõ°Ô∏è –ù–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ —É–∂–µ –≤ –º–∞—Ç—á–µ
                if (activeMatches.size === 0) {
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                }
                sounds.matchStart();
            });

            socket.on("matches:cleanup", (data) => {
                log(`üí∞ –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ ${data.returnedVp} VP –∏–∑ –∑–∞–≤–∏—Å—à–∏—Ö –º–∞—Ç—á–µ–π`);
                if (data.returnedVp > 0) {
                    alert(`‚úÖ –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ ${data.returnedVp} VP –∏–∑ –∑–∞–≤–∏—Å—à–∏—Ö –º–∞—Ç—á–µ–π`);
                    loadBalance(); // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                }
            });

            socket.on("quickplay:result", (m) => {
                log(`üéÆ Quickplay: ${m.status}`);
                if (m.status === 'ALREADY_IN_QUEUE') {
                    log('‚ö†Ô∏è Already in queue!');
                    isProcessing.quickplay = false;
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    showWaiting(t('waitingQueue'), true, 5);
                    return;
                }
                if (m.ticketId) {
                    showWaiting(t('waitingQueue'), true, 20);  // 20 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø–æ–∏—Å–∫
                    // Keep button disabled while in queue
                    const qpBtn2 = document.getElementById('btnQuickplay');
                    const pbt2 = document.getElementById('playBtnText');
                    if (qpBtn2) qpBtn2.disabled = true;
                    if (pbt2) pbt2.textContent = '‚è≥ ' + (t('searching') || 'Searching...');
                }
                if (m.matchId) {
                    matchId = m.matchId;
                    isProcessing.quickplay = false;
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    // Reset button text
                    const pbt5 = document.getElementById('playBtnText');
                    const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
                    if (pbt5) pbt5.textContent = `–ò–≥—Ä–∞—Ç—å ${selectedPlayers} | ${stakeText} VP`;
                }
            });

            socket.on("queue:waiting", (m) => {
                log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ: ${m.seconds} —Å–µ–∫`);
                showWaiting(`–ò—â–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤ (${m.playersFound || 1}/${selectedPlayers})...`, true, m.seconds);
            });

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏ (–∫–æ–≥–¥–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è –Ω–æ–≤—ã–π –∏–≥—Ä–æ–∫)
            socket.on("queue:sync", (m) => {
                log(`üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ${m.playersFound}/${m.totalNeeded} –∏–≥—Ä–æ–∫–æ–≤, –æ—Å—Ç–∞–ª–æ—Å—å ${m.secondsLeft}—Å–µ–∫`);
                // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º
                showWaiting(`–ò—â–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤ (${m.playersFound}/${m.totalNeeded})...`, true, m.secondsLeft);
            });

            socket.on("fallback:result", (m) => {
                stopCountdown();
                log(`ü§ñ Fallback: ${m.status}`);
                isProcessing.quickplay = false;
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                const pbt6 = document.getElementById('playBtnText');
                if (pbt6) pbt6.textContent = t('quickplay');
                if (m.matchId) {
                    matchId = m.matchId;
                    sounds.matchStart();
                }
            });

            socket.on("match:round", (data) => {
                // –ó–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞
                sounds.click();
                log(`üéÆ –†–∞—É–Ω–¥ ${data.round}, –æ—Å—Ç–∞–ª–æ—Å—å –∏–≥—Ä–æ–∫–æ–≤: ${data.aliveCount}`);
            });

            // ‚è±Ô∏è –¢–∞–π–º–µ—Ä —Ö–æ–¥–∞ (12 —Å–µ–∫—É–Ω–¥)
            socket.on("match:timer", (data) => {
                console.log('[CLIENT match:timer]', data);
                if (data.type === 'move' && data.deadline) {
                    // üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–æ–±—ã—Ç–∏–π: –µ—Å–ª–∏ —Ä–∞—É–Ω–¥ –≤ —Å–æ–±—ã—Ç–∏–∏ –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                    if (data.round && currentMatch && data.round < currentMatch.round) {
                        console.log('[CLIENT match:timer] Skipping old timer for round', data.round, '(current:', currentMatch.round, ')');
                        return;
                    }
                    
                    // üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è: –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ –∂–µ —Ä–∞—É–Ω–¥–∞
                    if (data.round && currentTimerRound === data.round && moveCountdownInterval) {
                        console.log('[CLIENT match:timer] Timer already running for round', data.round);
                        return;
                    }
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º secondsLeft –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø–æ deadline (–±–æ–ª–µ–µ —Ç–æ—á–Ω–æ)
                    const now = Date.now();
                    const secondsLeft = Math.max(0, Math.ceil((data.deadline - now) / 1000));
                    console.log('[CLIENT match:timer] Calculated secondsLeft:', secondsLeft, 'round from server:', data.round);
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—É–Ω–¥ –∏–∑ —Å–æ–±—ã—Ç–∏—è (—Ç–µ–ø–µ—Ä—å —Å–µ—Ä–≤–µ—Ä –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç round)
                    const targetRound = data.round || currentMatch?.round;
                    
                    startMoveCountdown(secondsLeft, targetRound, data.deadline);
                }
            });

            // üéÆ –ú–ê–¢–ß –ì–û–¢–û–í! - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –º–∞—Ç—á —Å—Ä–∞–∑—É
            socket.on("match:ready", (data) => {
                log(`üéÆ Match ready: ${data.matchId.slice(0,8)}...`);
                activeMatches.add(data.matchId);  // üõ°Ô∏è –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ç—á –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ
                console.log('[match:ready] Added to activeMatches:', data.matchId, 'Size:', activeMatches.size);
                isProcessing.quickplay = false;
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                stopCountdown();
                
                // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ –º–∞—Ç—á–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞—Ç–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                socket.emit("match:join", { matchId: data.matchId });
                
                // ‚ùå –ù–ï –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º match:get –∑–¥–µ—Å—å - –∂–¥—ë–º match:start –ø–æ—Å–ª–µ –æ—Ç—Å—á—ë—Ç–∞!
                // –ò–≥—Ä–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ match:start
            });

            // üéÆ –ú–ê–¢–ß –ù–ê–ô–î–ï–ù! - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —Å –æ—Ç—Å—á—ë—Ç–æ–º
            socket.on("match:found", (data) => {
                // üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –æ—Ç—Å—á—ë—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
                if (matchCountdownInterval) {
                    clearInterval(matchCountdownInterval);
                    matchCountdownInterval = null;
                }
                
                sounds.matchFound();
                log('üéÆ –ú–ê–¢–ß –ù–ê–ô–î–ï–ù!');
                
                // üõ°Ô∏è –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–º –º–∞—Ç—á–µ (–¥–æ match:start)
                activeMatches.add(data.matchId);
                console.log('[match:found] Added to activeMatches:', data.matchId, 'Size:', activeMatches.size);
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –æ–∂–∏–¥–∞–Ω–∏—è —Å –±–æ–ª—å—à–∏–º —Ç–∞–π–º–µ—Ä–æ–º
                document.getElementById('gameContent').innerHTML = `
                    <div class="waiting">
                        <div style="font-size: 2em; color: #ffd700; margin-bottom: 20px;">üéÆ –ú–ê–¢–ß –ù–ê–ô–î–ï–ù!</div>
                        <div style="font-size: 4em; font-weight: bold; color: #00ff88;" id="matchCountdown">5</div>
                        <div style="margin-top: 20px;">–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ –∏–≥—Ä–µ...</div>
                    </div>
                `;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å—á—ë—Ç
                let count = 5;
                matchCountdownInterval = setInterval(() => {
                    count--;
                    const el = document.getElementById('matchCountdown');
                    if (el) {
                        el.textContent = count;
                        sounds.countdown(count);
                    }
                    if (count <= 0) {
                        clearInterval(matchCountdownInterval);
                        matchCountdownInterval = null;
                    }
                }, 1000);
            });

            // ‚è±Ô∏è –û—Ç—Å—á—ë—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—Ä–µ–∑–µ—Ä–≤)
            socket.on("match:countdown", (data) => {
                const el = document.getElementById('matchCountdown');
                if (el) {
                    el.textContent = data.seconds;
                }
                // üîä –ó–≤—É–∫ –æ—Ç—Å—á—ë—Ç–∞ (—á–µ–º –º–µ–Ω—å—à–µ —á–∏—Å–ª–æ, —Ç–µ–º –≤—ã—à–µ —á–∞—Å—Ç–æ—Ç–∞)
                if (sounds.countdown) {
                    sounds.countdown(data.seconds);
                }
            });

            // üöÄ –ú–∞—Ç—á –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è
            socket.on("match:start", (m) => {
                console.log('[CLIENT match:start]', {matchId: m.matchId, round: m.round, deadline: m.moveDeadline});
                if (matchCountdownInterval) {
                    clearInterval(matchCountdownInterval);
                }
                sounds.matchStart();
                log('üöÄ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! (match:start)');
                
                // üõ°Ô∏è –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ç—á –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ match:ready)
                activeMatches.add(m.matchId);
                console.log('[match:start] Added to activeMatches:', m.matchId, 'Size:', activeMatches.size);
                
                // üõ°Ô∏è –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –º–∞—Ç—á–∞
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                
                // üßπ –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é —Ä–∞—É–Ω–¥–æ–≤ –∏ —Ç–∞–π–º–µ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ –º–∞—Ç—á–∞
                shownRounds.clear();
                shownMoveWarningForRound = null;  // üõ°Ô∏è –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥Ë≠¶Âëä
                currentTimerRound = null;
                currentTimerDeadline = null;
                resetAutoMoveFlag();  // üõ°Ô∏è –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∞–≤—Ç–æ—Ö–æ–¥–∞
                console.log('[match:start] Cleared shownRounds, timers, and autoMove flag');
                
                // –†–µ–Ω–¥–µ—Ä–∏–º –º–∞—Ç—á —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ç–∞–π–º–µ—Ä
                currentMatch = m;
                matchId = m.matchId;
                // üë§ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º–µ–Ω–∞ –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –º–∞—Ç—á–∞
                if (m.playerNames) {
                    Object.assign(playerNames, m.playerNames);
                }
                renderMatch(m);
                showChat();
                createGameChat(m.matchId);
                
                // ‚è±Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å deadline
                if (m.moveDeadline) {
                    const now = Date.now();
                    const deadline = m.moveDeadline;
                    const secondsLeft = Math.max(0, Math.ceil((deadline - now) / 1000));
                    console.log('[match:start] Starting timer with secondsLeft:', secondsLeft, 'for round', m.round);
                    if (secondsLeft > 0) {
                        startMoveCountdown(secondsLeft, m.round, deadline);
                    }
                }
            });

            socket.on("match:update", (m) => {
                console.log('[CLIENT match:update]', {matchId: m.matchId, round: m.round, status: m.status, deadline: m.moveDeadline});
                stopCountdown();
                // üõ°Ô∏è –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º moveCountdown –∑–¥–µ—Å—å - –ø—É—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–∫–∞ –Ω–µ –ø—Ä–∏–¥–µ—Ç match:timer —Å –Ω–æ–≤—ã–º —Ä–∞—É–Ω–¥–æ–º
                // stopMoveCountdown();  // <-- –£–ë–†–ê–ù–û
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ö–æ–¥–∞
                isProcessing.move = false;
                
                // ‚è±Ô∏è –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –∑–¥–µ—Å—å - —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ match:start –∏–ª–∏ match:timer
                
                // If this is a new match (different from current game chat), create new chat
                if (m.matchId && m.matchId !== currentGameChatId) {
                    matchId = m.matchId;
                    showChat();
                    createGameChat(m.matchId);
                }
                
                currentMatch = m;
                // üë§ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º–µ–Ω–∞ –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –º–∞—Ç—á–∞
                if (m.playerNames) {
                    Object.assign(playerNames, m.playerNames);
                }
                renderMatch(m);
                
                // ‚è±Ô∏è –¢–∞–π–º–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ match:timer –∏–ª–∏ match:start
                // –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ match:update —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
                
                // üéÆ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ä–∞—É–Ω–¥–∞
                if (m.lastRound) {
                    const lr = m.lastRound;
                    const roundKey = `${m.matchId}:${lr.roundNo}`;
                    
                    // üõ°Ô∏è –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —É–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ —ç—Ç–æ—Ç —Ä–∞—É–Ω–¥
                    if (shownRounds.has(roundKey)) {
                        console.log(`[match:update] Skipping duplicate round ${lr.roundNo}`);
                    } else {
                        shownRounds.add(roundKey);
                        console.log(`[match:update] Showing round ${lr.roundNo} for first time`);
                        
                        const moveEmoji = { 'ROCK': '‚úä', 'PAPER': '‚úã', 'SCISSORS': '‚úåÔ∏è' };
                        
                        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞—É–Ω–¥–∞
                        log(`üì¢ –†–ê–£–ù–î ${lr.roundNo}`);
                    
                    // –•–æ–¥—ã –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
                    if (lr.moves) {
                        Object.entries(lr.moves).forEach(([pid, move]) => {
                            const isBot = pid.startsWith('BOT');
                            const botName = isBot ? (m.botNames?.[pid] || pid) : null;
                            const name = isBot ? botName : (pid === userId ? '–í—ã' : pid.slice(0, 8));
                            const emoji = moveEmoji[move] || move;
                            log(`  ${name}: ${emoji} ${move}`);
                        });
                    }
                    
                    // –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥–∞
                    if (lr.outcome === 'TIE') {
                        log(`ü§ù –ù–∏—á—å—è! (${lr.reason === 'ALL_SAME' ? '–≤—Å–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ' : '–≤—Å–µ —Ç—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞'})`);
                    } else if (lr.outcome === 'ELIMINATION') {
                        const losers = lr.losers || [];
                        const winningMove = lr.winningMove || '';
                        const winEmoji = moveEmoji[winningMove] || '';
                        log(`‚öîÔ∏è –ü–æ–±–µ–∂–¥–∞–µ—Ç: ${winEmoji} ${winningMove}`);
                        
                        losers.forEach(pid => {
                            const isBot = pid.startsWith('BOT');
                            const botName = isBot ? (m.botNames?.[pid] || pid) : null;
                            const name = isBot ? botName : (pid === userId ? '–í—ã' : pid.slice(0, 8));
                            const skull = isBot ? 'ü§ñ' : (pid === userId ? 'üíÄ' : 'üë§');
                            log(`  ${skull} ${name} –í–´–ë–´–í–ê–ï–¢!`);
                        });
                    }
                    
                        log(`üë• –û—Å—Ç–∞–ª–æ—Å—å –∏–≥—Ä–æ–∫–æ–≤: ${m.aliveIds?.length || 0}`);
                    } // end of else (new round)
                } // end of if (m.lastRound)
                
                // Reset move processing flag when match updates
                isProcessing.move = false;
                
                // Enable logs button when we have a match
                if (m.matchId) {
                    const logsBtn = document.getElementById('btnLogs');
                    if (logsBtn) logsBtn.disabled = false;
                }
                
                // If match is finished, schedule chat close and reset quickplay button
                if (m.status === 'FINISHED') {
                    isProcessing.quickplay = false;
                    activeMatches.delete(m.matchId);  // üõ°Ô∏è –£–¥–∞–ª—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π –º–∞—Ç—á –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö
                    console.log('[match:update FINISHED] Removed from activeMatches:', m.matchId, 'Size:', activeMatches.size);
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    const qpBtn3 = document.getElementById('btnQuickplay');
                    const pbt3 = document.getElementById('playBtnText');
                    if (pbt3) pbt3.textContent = t('playAgain');
                    
                    // Schedule this specific game chat to close after 2 minutes
                    if (m.matchId && !gameChatTimeouts[m.matchId]) {
                        addChatMessage('system', 'System', t('chatWillClose'), 'game', m.matchId);
                        gameChatTimeouts[m.matchId] = setTimeout(() => {
                            closeGameChat(m.matchId);
                            delete gameChatTimeouts[m.matchId];
                        }, 120000); // 2 minutes
                    }
                }
            });

            socket.on("chat:message", (data) => {
                addChatMessage('user', data.author?.slice(0,8) || 'Unknown', data.text, data.channel || 'global');
            });

            socket.on("chat:global", (data) => {
                const displayName = data.displayName || data.author?.slice(0,8) || 'Unknown';
                // üë§ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –∏–≥—Ä–æ–∫–∞
                if (data.author && data.displayName) {
                    playerNames[data.author] = data.displayName;
                }
                addChatMessage('user', displayName, data.text, 'global', null, data.avatarUrl);
            });

            socket.on("chat:game", (data) => {
                // Add to specific game chat if matchId provided
                const targetGameId = data.matchId || currentGameChatId;
                if (targetGameId) {
                    const displayName = data.displayName || data.author?.slice(0,8) || 'Unknown';
                    // üë§ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –∏–≥—Ä–æ–∫–∞
                    if (data.author && data.displayName) {
                        playerNames[data.author] = data.displayName;
                    }
                    addChatMessage('user', displayName, data.text, 'game', targetGameId, data.avatarUrl);
                }
            });

            socket.on("error", (m) => {
                isProcessing.move = false;
                isProcessing.quickplay = false;
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                const qpBtn4 = document.getElementById('btnQuickplay');
                const pbt4 = document.getElementById('playBtnText');
                const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
                if (pbt4) pbt4.textContent = `–ò–≥—Ä–∞—Ç—å ${selectedPlayers} | ${stakeText} VP`;
                log(`‚ùå Error: ${m.message}`);
            });
        }

        // Quickplay
        function resetAndPlayAgain() {
            // Clear match state
            currentMatch = null;
            matchId = null;
            currentGameChatId = null;
            stopMoveCountdown();
            stopCountdown();
            
            // Start new game
            doQuickplay();
        }

        function doQuickplay() {
            if (isProcessing.quickplay) {
                sounds.error();
                return;
            }
            isProcessing.quickplay = true;
            sounds.click();
            
            // üõ°Ô∏è –û–±–Ω–æ–≤–ª—è–µ–º UI —á—Ç–æ–±—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏
            setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
            
            if (!socket) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å');
                isProcessing.quickplay = false;
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                return;
            }
            socket.emit("quickplay", { playersCount: selectedPlayers, stakeVp: selectedStake });
            log(`üéÆ Quickplay: ${selectedPlayers} players, ${selectedStake} VP`);
            // Show game chat - will be initialized when match arrives
        }

        // Make Move
        function makeMove(move) {
            // ‚ùå –ù–µ –¥–∞—ë–º –≤—ã–±–∏—Ç—ã–º –∏–≥—Ä–æ–∫–∞–º —Ö–æ–¥–∏—Ç—å
            if (currentMatch && !currentMatch.aliveIds?.includes(userId)) {
                log('‚ùå –í—ã –≤—ã–±—ã–ª–∏ –∏–∑ –º–∞—Ç—á–∞');
                return;
            }
            
            if (isProcessing.move) {
                sounds.error();
                return;
            }
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–¥–µ–ª–∞–ª–∏ –ª–∏ —É–∂–µ —Ö–æ–¥ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ (üõ°Ô∏è debounce - –ø–æ–∫–∞–∑—ã–≤–∞–µ–ºË≠¶Âëä —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –∑–∞ —Ä–∞—É–Ω–¥)
            if (currentMatch && currentMatch.moves && currentMatch.moves[userId]) {
                const roundKey = `${currentMatch.matchId}:${currentMatch.round}`;
                if (!shownMoveWarningForRound || shownMoveWarningForRound !== roundKey) {
                    shownMoveWarningForRound = roundKey;
                    log('‚ö†Ô∏è –í—ã —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ —Ö–æ–¥ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ');
                }
                return;
            }
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥Ë≠¶Âëä –ø—Ä–∏ –Ω–æ–≤–æ–º —Ä–∞—É–Ω–¥–µ
            if (currentMatch) {
                const roundKey = `${currentMatch.matchId}:${currentMatch.round}`;
                if (shownMoveWarningForRound && shownMoveWarningForRound !== roundKey) {
                    shownMoveWarningForRound = null;
                }
            }
            
            // üõ°Ô∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
            stopMoveCountdown();
            
            isProcessing.move = true;
            sounds.move();
            
            if (!socket || !matchId) {
                log('‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Ç—á–∞ (socket: ' + !!socket + ', matchId: ' + matchId + ')');
                isProcessing.move = false;
                return;
            }
            
            console.log('[makeMove] Sending move:', { matchId, move, userId });
            
            // Disable all move buttons
            document.querySelectorAll('.move-btn').forEach(btn => {
                if (btn) btn.disabled = true;
            });
            
            socket.emit("move", { matchId, move });
            log(`üëä –•–æ–¥: ${move}`);
            
            // Visual feedback
            document.querySelectorAll('.move-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.move === move) {
                    btn.classList.add('selected');
                }
            });
            
            // Auto-reset after 5 seconds if server doesn't respond
            setTimeout(() => {
                if (isProcessing.move) {
                    isProcessing.move = false;
                    log('‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    // Buttons will be re-enabled by renderMatch on next update
                }
            }, 5000);
        }

        // Countdown Timer
        function startCountdown(seconds) {
            if (countdownInterval) clearInterval(countdownInterval);
            let remaining = seconds;
            
            const updateTimer = () => {
                const timerEl = document.getElementById('countdownTimer');
                if (timerEl) {
                    timerEl.textContent = `${t('searching')} ${remaining}s`;
                }
                remaining--;
                if (remaining < 0) {
                    clearInterval(countdownInterval);
                }
            };
            
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }

        function stopCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        // ‚è±Ô∏è –¢–∞–π–º–µ—Ä –¥–ª—è —Ö–æ–¥–∞ (12 —Å–µ–∫—É–Ω–¥)
        let moveCountdownInterval = null;
        let moveCountdownTimeout = null;  // üõ°Ô∏è –î–ª—è –æ—Ç–º–µ–Ω—ã pending setTimeout
        let currentTimerRound = null;
        let currentTimerDeadline = null;
        let autoMoveTriggeredForRound = null;  // üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ—Ö–æ–¥–∞
        
        function startMoveCountdown(seconds, round = null, deadline = null) {
            if (seconds <= 0) return;
            
            const targetRound = round || currentMatch?.round;
            
            // üõ°Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —Ç–æ—Ç –∂–µ deadline —Å —Å–≤–µ–∂–∏–º —Ç–∞–π–º–µ—Ä–æ–º
            if (deadline && deadline === currentTimerDeadline && currentTimerRound === targetRound && moveCountdownInterval && seconds >= 10) {
                console.log(`[startMoveCountdown] Skip: same deadline=${deadline}, round=${targetRound}`);
                return;
            }
            
            // üõ°Ô∏è –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –∞–≤—Ç–æ—Ö–æ–¥ —É–∂–µ —Å–¥–µ–ª–∞–Ω –¥–ª—è —ç—Ç–æ–≥–æ —Ä–∞—É–Ω–¥–∞
            if (autoMoveTriggeredForRound === targetRound) {
                console.log(`[startMoveCountdown] Skip: autoMove already triggered for round ${targetRound}`);
                return;
            }
            
            // –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤—ã–±—ã–ª
            if (currentMatch && !currentMatch.aliveIds?.includes(userId)) return;
            
            // üõ°Ô∏è –û—á–∏—â–∞–µ–º –í–°–ï pending —Ç–∞–π–º–µ—Ä—ã –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –Ω–æ–≤–æ–≥–æ
            if (moveCountdownInterval) {
                clearInterval(moveCountdownInterval);
                moveCountdownInterval = null;
            }
            if (moveCountdownTimeout) {
                clearTimeout(moveCountdownTimeout);
                moveCountdownTimeout = null;
            }
            
            currentTimerRound = targetRound;
            currentTimerDeadline = deadline;
            console.log(`[startMoveCountdown] Starting timer for round ${targetRound}, deadline=${deadline}`);
            
            let remaining = seconds;
            let intervalId = null;
            
            const updateTimer = () => {
                const timerEl = document.getElementById('moveTimer');
                if (timerEl) {
                    timerEl.textContent = remaining + 's';
                    if (remaining <= 3) timerEl.style.color = '#ff4444';
                    else if (remaining <= 6) timerEl.style.color = '#ffaa00';
                    else timerEl.style.color = '#00ff88';
                }
                remaining--;
                if (remaining < 0) {
                    clearInterval(intervalId);
                    moveCountdownInterval = null;
                    const timerElFinal = document.getElementById('moveTimer');
                    if (timerElFinal) timerElFinal.textContent = '‚è±Ô∏è';
                    
                    const isPlayerAlive = currentMatch?.aliveIds?.includes(userId);
                    // üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∞–≤—Ç–æ—Ö–æ–¥ –µ—â—ë –Ω–µ –¥–µ–ª–∞–ª–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ä–∞—É–Ω–¥–∞
                    if (isPlayerAlive && currentMatch && !currentMatch.moves?.[userId] && autoMoveTriggeredForRound !== currentTimerRound) {
                        autoMoveTriggeredForRound = currentTimerRound;  // üõ°Ô∏è –°—Ç–∞–≤–∏–º —Ñ–ª–∞–≥ –î–û –≤—ã–∑–æ–≤–∞
                        const moves = ['ROCK', 'PAPER', 'SCISSORS'];
                        const randomMove = moves[Math.floor(Math.random() * moves.length)];
                        log('‚è±Ô∏è –í—Ä–µ–º—è –≤—ã—à–ª–æ! –ê–≤—Ç–æ-—Ö–æ–¥: ' + randomMove);
                        makeMove(randomMove);
                    }
                }
            };
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
            let retryCount = 0;
            const maxRetries = 10;
            
            const tryStartTimer = () => {
                let timerEl = document.getElementById('moveTimer');
                
                // üõ°Ô∏è –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞—ë–º –µ–≥–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ game-status
                if (!timerEl) {
                    const gameStatus = document.querySelector('.game-status');
                    if (gameStatus && !document.getElementById('moveTimer')) {
                        timerEl = document.createElement('div');
                        timerEl.id = 'moveTimer';
                        timerEl.className = 'move-timer';
                        timerEl.style.cssText = 'font-size: 2em; font-weight: bold; margin: 10px 0; color: #00ff88;';
                        // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ status-text
                        const statusText = gameStatus.querySelector('.status-text');
                        if (statusText && statusText.nextSibling) {
                            gameStatus.insertBefore(timerEl, statusText.nextSibling);
                        } else if (gameStatus.firstChild) {
                            gameStatus.insertBefore(timerEl, gameStatus.firstChild.nextSibling);
                        } else {
                            gameStatus.appendChild(timerEl);
                        }
                        console.log('[startMoveCountdown] Created moveTimer dynamically');
                    }
                }
                
                if (!timerEl && retryCount < maxRetries) {
                    retryCount++;
                    moveCountdownTimeout = setTimeout(tryStartTimer, 100);
                    return;
                }
                
                // –≠–ª–µ–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –ø–æ–ø—ã—Ç–∫–∏
                updateTimer();
                intervalId = setInterval(updateTimer, 1000);
                moveCountdownInterval = intervalId;
                moveCountdownTimeout = null;
            };
            
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã DOM —É—Å–ø–µ–ª –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
            moveCountdownTimeout = setTimeout(tryStartTimer, 50);  // üõ°Ô∏è –°–æ—Ö—Ä–∞–Ω—è–µ–º ID
        }

        function stopMoveCountdown() {
            if (moveCountdownInterval) {
                clearInterval(moveCountdownInterval);
                moveCountdownInterval = null;
            }
            if (moveCountdownTimeout) {
                clearTimeout(moveCountdownTimeout);  // üõ°Ô∏è –û—á–∏—â–∞–µ–º pending timeout
                moveCountdownTimeout = null;
            }
            currentTimerRound = null;
            currentTimerDeadline = null;
            // üõ°Ô∏è –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º autoMoveTriggeredForRound –∑–¥–µ—Å—å - —ç—Ç–æ –∑–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–∞—É–Ω–¥–∞
        }
        
        // üõ°Ô∏è –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –∞–≤—Ç–æ—Ö–æ–¥–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –Ω–æ–≤–æ–≥–æ –º–∞—Ç—á–∞
        function resetAutoMoveFlag() {
            autoMoveTriggeredForRound = null;
        }

        // Render Functions
        function showWaiting(text, withCountdown = false, seconds = 0) {
            let countdownHtml = '';
            if (withCountdown && seconds > 0) {
                countdownHtml = `<div id="countdownTimer" style="font-size: 1.5em; margin-top: 10px; color: #ffd700;"></div>`;
                startCountdown(seconds);
            }
            
            document.getElementById('gameContent').innerHTML = `
                <div class="waiting">
                    <div>${text}</div>
                    ${countdownHtml}
                </div>
            `;
        }

        function renderMatch(m) {
            const isPlayerAlive = m.aliveIds.includes(userId);
            const isFinished = m.status === 'FINISHED';
            const isPlayerWinner = m.winnerId === userId;
            
            console.log('Render match:', { round: m.round, isPlayerAlive, isFinished, userId, aliveIds: m.aliveIds });

            // Play sounds based on outcome
            if (isFinished) {
                if (isPlayerWinner) sounds.win();
                else if (m.playerIds.includes(userId)) sounds.lose();
            }

            let statusText = isFinished 
                ? (isPlayerWinner ? t('victory') : t('defeat')) 
                : (isPlayerAlive ? t('yourTurn') : t('waitingTurn'));

            let html = `
                <div class="game-status">
                    <div class="status-text">${statusText}</div>
                    ${!isFinished && isPlayerAlive ? `
                    <div class="move-timer" id="moveTimer" style="font-size: 2em; font-weight: bold; margin: 10px 0; color: #00ff88;">‚è±Ô∏è</div>
                    ` : ''}
                    <div class="match-info">
                        <div class="info-item">
                            <div class="info-label">${t('round')}</div>
                            <div class="info-value">${m.round}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">${t('pot')}</div>
                            <div class="info-value">${m.potVp} VP</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">${t('stake')}</div>
                            <div class="info-value">${m.stakeVp} VP</div>
                        </div>
                        ${isFinished ? `
                        <div class="info-item">
                            <div class="info-label">${t('payout')}</div>
                            <div class="info-value">${m.payoutVp} VP</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Players Grid
            html += `<div class="players-grid">`;
            m.playerIds.forEach(pid => {
                const isBot = pid.startsWith('BOT');
                const isAlive = m.aliveIds.includes(pid);
                const isEliminated = m.eliminatedIds.includes(pid);
                const isWinner = m.winnerId === pid;
                const isMe = pid === userId;
                
                let moveEmoji = '‚ùì';
                if (m.lastRound && m.lastRound.moves[pid]) {
                    moveEmoji = getMoveEmoji(m.lastRound.moves[pid]);
                }

                let statusText = isWinner ? t('winner') : isEliminated ? t('eliminated') : isAlive ? t('inGame') : '';
                let botDisplayName = isBot ? (m.botNames?.[pid] || pid) : pid;
                // üë§ –ò—Å–ø–æ–ª—å–∑—É–µ–º displayName –∏–∑ playerNames (–∫–ª–∏–µ–Ω—Ç) –∏–ª–∏ m.playerNames (—Å–µ—Ä–≤–µ—Ä)
                let playerDisplayName = !isBot ? (playerNames[pid] || m.playerNames?.[pid] || pid.slice(0,8)) : botDisplayName;
                let nameText = isMe ? 'üë§ ' + (t('you') || 'You') : isBot ? 'ü§ñ ' + botDisplayName : 'üë§ ' + playerDisplayName;

                html += `
                    <div class="player-card ${isWinner ? 'winner' : isEliminated ? 'eliminated' : isAlive ? 'active' : ''}">
                        <div class="player-name">${nameText}</div>
                        <div class="player-move">${moveEmoji}</div>
                        <div class="player-status">${statusText}</div>
                    </div>
                `;
            });
            html += `</div>`;

            // Last Round Info
            if (m.lastRound) {
                const outcomeText = m.lastRound.outcome === 'TIE' ? t('tie') : t('elimination');
                html += `
                    <div class="round-info">
                        <div class="round-title">${t('round')} ${m.lastRound.roundNo}: ${outcomeText}</div>
                        ${m.lastRound.winningMove ? `<div>${t('wonWith')}: ${getMoveEmoji(m.lastRound.winningMove)} ${m.lastRound.winningMove}</div>` : ''}
                    </div>
                `;
            }

            // Move Buttons (only if alive and not finished)
            console.log('Move buttons check:', { isPlayerAlive, isFinished, shouldShow: isPlayerAlive && !isFinished });
            if (isPlayerAlive && !isFinished) {
                html += `
                    <div class="moves-container">
                        <button class="move-btn" data-move="ROCK" onclick="makeMove('ROCK')">
                            <div class="move-emoji">‚úä</div>
                            <div class="move-text">${t('rock')}</div>
                        </button>
                        <button class="move-btn" data-move="PAPER" onclick="makeMove('PAPER')">
                            <div class="move-emoji">‚úã</div>
                            <div class="move-text">${t('paper')}</div>
                        </button>
                        <button class="move-btn" data-move="SCISSORS" onclick="makeMove('SCISSORS')">
                            <div class="move-emoji">‚úåÔ∏è</div>
                            <div class="move-text">${t('scissors')}</div>
                        </button>
                    </div>
                `;
            } else {
                console.log('Move buttons NOT shown - player not alive or game finished');
            }

            // Play Again Button
            if (isFinished) {
                html += `
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-success" onclick="resetAndPlayAgain()">${t('playAgain')}</button>
                    </div>
                `;
                // Add system message to game chat
                const resultMsg = isPlayerWinner ? 'Congratulations! You won!' : 'Game over. Better luck next time!';
                if (m.matchId) {
                    addChatMessage('system', 'System', resultMsg, 'game', m.matchId);
                }
                
                // Update balance after match
                setTimeout(doCheckBalance, 500);
                
                // Clear current match state
                currentMatch = null;
            }

            document.getElementById('gameContent').innerHTML = html;
        }

        function getMoveEmoji(move) {
            const emojis = { ROCK: '‚úä', PAPER: '‚úã', SCISSORS: '‚úåÔ∏è' };
            return emojis[move] || '‚ùì';
        }

        // Profile Functions
        let currentProfile = {
            displayName: '',
            gender: '',
            avatarUrl: '',
            isGuest: true
        };
        let selectedAvatarId = '';

        function showProfileModal() {
            document.getElementById('profileModal').classList.add('show');
            initAvatars();
            loadProfile();
        }

        function initAvatars() {
            const maleGrid = document.getElementById('maleAvatars');
            const femaleGrid = document.getElementById('femaleAvatars');
            
            if (maleGrid && maleGrid.children.length === 0) {
                for (let i = 1; i <= 5; i++) {
                    const div = document.createElement('div');
                    div.className = 'avatar-item';
                    div.onclick = function() { selectAvatar('male' + i, this); };
                    div.innerHTML = '<img src="' + API_URL + '/avatars/male' + i + '.svg" alt="male' + i + '">';
                    maleGrid.appendChild(div);
                }
            }
            
            if (femaleGrid && femaleGrid.children.length === 0) {
                for (let i = 1; i <= 5; i++) {
                    const div = document.createElement('div');
                    div.className = 'avatar-item';
                    div.onclick = function() { selectAvatar('female' + i, this); };
                    div.innerHTML = '<img src="' + API_URL + '/avatars/female' + i + '.svg" alt="female' + i + '">';
                    femaleGrid.appendChild(div);
                }
            }
        }

        function hideProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }

        async function loadProfile() {
            if (!token) return;
            
            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': token }
                });
                const data = await res.json();
                
                currentProfile = {
                    displayName: data.displayName || data.username || '',
                    gender: data.gender || '',
                    avatarUrl: data.avatarUrl || '',
                    isGuest: data.isGuest
                };
                
                // Fill form
                document.getElementById('profileDisplayName').value = currentProfile.displayName;
                document.getElementById('profileGender').value = currentProfile.gender;
                
                // Filter avatars by gender if set
                filterAvatarsByGender(currentProfile.gender);
                
                // Show avatar
                const avatarImg = document.getElementById('profileCurrentAvatar');
                if (currentProfile.avatarUrl) {
                    avatarImg.src = currentProfile.avatarUrl;
                    avatarImg.style.display = 'block';
                } else {
                    // Default avatar based on gender
                    const defaultAvatar = currentProfile.gender === 'female' ? `${API_URL}/avatars/female1.svg` : `${API_URL}/avatars/male1.svg`;
                    avatarImg.src = defaultAvatar;
                    avatarImg.style.display = 'block';
                }
                
                // Show/hide link email section
                const linkSection = document.getElementById('linkEmailSection');
                if (currentProfile.isGuest) {
                    linkSection.style.display = 'block';
                } else {
                    linkSection.style.display = 'none';
                }
                
            } catch (e) {
                console.error('Failed to load profile:', e);
            }
        }

        function switchAvatarTab(tab, clickedTab) {
            // Update tab buttons
            document.querySelectorAll('.avatar-tab').forEach(t => t.classList.remove('active'));
            clickedTab.classList.add('active');
            
            // Show/hide grids
            document.getElementById('maleAvatars').classList.add('hidden');
            document.getElementById('femaleAvatars').classList.add('hidden');
            document.getElementById('customAvatar').classList.add('hidden');
            
            document.getElementById(tab + 'Avatars')?.classList.remove('hidden');
            if (tab === 'custom') {
                document.getElementById('customAvatar').classList.remove('hidden');
            }
        }

        function selectAvatar(avatarId, clickedElement) {
            selectedAvatarId = avatarId;
            
            // Update UI
            document.querySelectorAll('.avatar-item').forEach(item => item.classList.remove('selected'));
            if (clickedElement) clickedElement.classList.add('selected');
            
            // Preview
            document.getElementById('profileCurrentAvatar').src = API_URL + '/avatars/' + avatarId + '.svg';
            
            // Auto-set gender based on avatar selection (always update)
            const newGender = avatarId.startsWith('male') ? 'male' : 'female';
            document.getElementById('profileGender').value = newGender;
        }

        function filterAvatarsByGender(gender) {
            // If gender is set, show only corresponding avatars
            if (gender === 'male') {
                document.getElementById('maleAvatars').classList.remove('hidden');
                document.getElementById('femaleAvatars').classList.add('hidden');
                // Update tabs
                document.querySelectorAll('.avatar-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.avatar-tab:nth-child(1)')?.classList.add('active');
            } else if (gender === 'female') {
                document.getElementById('maleAvatars').classList.add('hidden');
                document.getElementById('femaleAvatars').classList.remove('hidden');
                // Update tabs
                document.querySelectorAll('.avatar-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.avatar-tab:nth-child(2)')?.classList.add('active');
            }
            // If no gender, show both (default behavior)
        }

        // Listen for gender change
        document.addEventListener('DOMContentLoaded', function() {
            const genderSelect = document.getElementById('profileGender');
            if (genderSelect) {
                genderSelect.addEventListener('change', function() {
                    filterAvatarsByGender(this.value);
                });
            }
        });

        async function saveProfile() {
            const displayName = document.getElementById('profileDisplayName').value.trim();
            const gender = document.getElementById('profileGender').value;
            
            let avatarUrl = currentProfile.avatarUrl || null;
            // If selected a preset avatar (not custom upload)
            if (selectedAvatarId && selectedAvatarId !== 'custom') {
                avatarUrl = `${API_URL}/avatars/${selectedAvatarId}.svg`;
            }
            // Convert empty string to null for server
            if (avatarUrl === '') avatarUrl = null;
            
            try {
                const res = await fetch(`${API_URL}/auth/profile`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ displayName, gender, avatarUrl })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
                    
                    // Update local profile
                    currentProfile.displayName = displayName;
                    currentProfile.gender = gender;
                    currentProfile.avatarUrl = avatarUrl;
                    
                    // Update UI
                    updateUserInfoAfterProfileUpdate();
                    hideProfileModal();
                } else {
                    const err = await res.json();
                    log('‚ùå –û—à–∏–±–∫–∞: ' + (err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'));
                }
            } catch (e) {
                log('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        async function linkEmail() {
            const email = document.getElementById('linkEmail').value.trim();
            const password = document.getElementById('linkPassword').value;
            
            if (!email || !password || password.length < 6) {
                log('‚ùå –í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/auth/link-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    log('‚úÖ ' + data.message);
                    hideProfileModal();
                } else {
                    log('‚ùå ' + (data.message || '–û—à–∏–±–∫–∞'));
                }
            } catch (e) {
                log('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Resize and compress image before storing
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize to max 200x200 for small avatar
                    const maxSize = 200;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compress to JPEG with 60% quality
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    
                    const profileImg = document.getElementById('profileCurrentAvatar');
                    profileImg.src = compressedDataUrl;
                    profileImg.style.display = 'block';
                    currentProfile.avatarUrl = compressedDataUrl;
                    selectedAvatarId = 'custom';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updateUserInfo() {
            // Update mini avatar in header
            const miniAvatar = document.getElementById('userAvatar');
            if (miniAvatar && currentProfile.avatarUrl) {
                miniAvatar.src = currentProfile.avatarUrl;
                miniAvatar.style.display = 'inline-block';
            }
        }

        function updateUserInfoAfterLogin() {
            // Show user info section
            document.getElementById('userInfo')?.classList.remove('hidden');
            
            // Update email display
            const emailDisplay = document.getElementById('userEmail');
            if (emailDisplay) {
                emailDisplay.textContent = currentProfile.displayName || userId.slice(0, 8);
            }
            
            // Update avatar
            updateUserInfo();
        }

        function updateUserInfoAfterProfileUpdate() {
            // Update display name
            const emailDisplay = document.getElementById('userEmail');
            if (emailDisplay && currentProfile.displayName) {
                emailDisplay.textContent = currentProfile.displayName;
            }
            
            // Update mini avatar in header
            const miniAvatar = document.getElementById('userAvatar');
            if (miniAvatar && currentProfile.avatarUrl) {
                miniAvatar.src = currentProfile.avatarUrl;
                miniAvatar.style.display = 'inline-block';
            }
            
            // Re-render chat to show new avatar
            renderChatMessages();
        }

        // üë§ –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—É–±–ª–∏—á–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –∏–≥—Ä–æ–∫–∞
        async function showPublicProfile(targetUserId, displayName) {
            sounds.click();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å –∑–∞–≥—Ä—É–∑–∫–æ–π
            const modal = document.getElementById('statsModal');
            const body = document.getElementById('statsModalBody');
            modal.classList.add('show');
            body.innerHTML = `<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è ${displayName}...</div>`;
            
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
                const r = await fetch(`${API_URL}/auth/public-profile/${targetUserId}`, {
                    headers: token ? { "Authorization": "Bearer " + token } : {}
                });
                
                if (!r.ok) {
                    body.innerHTML = `<div style="text-align:center;padding:20px;color:#ff6b6b;">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>`;
                    return;
                }
                
                const data = await r.json();
                
                body.innerHTML = `
                    <div style="text-align:center;padding:20px;">
                        <div style="font-size:3em;margin-bottom:10px;">${data.avatarUrl ? `<img src="${data.avatarUrl}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">` : 'üë§'}</div>
                        <div style="font-size:1.5em;font-weight:bold;color:#ffd700;margin-bottom:5px;">${data.displayName || '–ò–≥—Ä–æ–∫'}</div>
                        <div style="color:#aaa;margin-bottom:20px;">ID: ${data.id?.slice(0,8)}...</div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:20px;">
                            <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;">
                                <div style="font-size:1.8em;font-weight:bold;color:#00ff88;">${data.stats?.totalMatches || 0}</div>
                                <div style="font-size:0.9em;color:#aaa;">–í—Å–µ–≥–æ –∏–≥—Ä</div>
                            </div>
                            <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;">
                                <div style="font-size:1.8em;font-weight:bold;color:#ffd700;">${data.stats?.wins || 0}</div>
                                <div style="font-size:0.9em;color:#aaa;">–ü–æ–±–µ–¥</div>
                            </div>
                        </div>
                        
                        <div style="margin-top:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:10px;">
                            <div style="color:#aaa;margin-bottom:10px;">–í–∏–Ω—Ä–µ–π—Ç</div>
                            <div style="font-size:1.5em;font-weight:bold;color:${(data.stats?.winRate || 0) > 50 ? '#00ff88' : '#ff6b6b'};">${data.stats?.winRate || 0}%</div>
                        </div>
                    </div>
                `;
            } catch (e) {
                body.innerHTML = `<div style="text-align:center;padding:20px;color:#ff6b6b;">‚ùå –û—à–∏–±–∫–∞: ${e.message}</div>`;
            }
        }

        // Stats Modal Functions
        async function showStatsModal() {
            sounds.click();
            if (!token) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ');
                return;
            }
            document.getElementById('statsModal').classList.add('show');
            const body = document.getElementById('statsModalBody');
            body.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const r = await fetch(`${API_URL}/auth/stats`, { headers: { "Authorization": "Bearer " + token } });
                const s = await r.json();
                const winColor = s.winRate >= 50 ? '#4ade80' : (s.winRate >= 30 ? '#ffd700' : '#f87171');
                body.innerHTML = `
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;">
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:2em;font-weight:bold;color:#ffd700;margin-bottom:5px;">${s.totalMatches}</div>
                            <div style="font-size:0.9em;opacity:0.8;">–í—Å–µ–≥–æ –º–∞—Ç—á–µ–π</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:2em;font-weight:bold;color:${winColor};margin-bottom:5px;">${s.winRate}%</div>
                            <div style="font-size:0.9em;opacity:0.8;">–í–∏–Ω—Ä–µ–π—Ç</div>
                            <div style="width:100%;height:10px;background:rgba(255,255,255,0.1);border-radius:5px;overflow:hidden;margin-top:8px;">
                                <div style="height:100%;background:linear-gradient(90deg,#4ade80,#ffd700);width:${s.winRate}%"></div>
                            </div>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:2em;font-weight:bold;color:#4ade80;margin-bottom:5px;">${s.wins}</div>
                            <div style="font-size:0.9em;opacity:0.8;">–ü–æ–±–µ–¥</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:2em;font-weight:bold;color:#f87171;margin-bottom:5px;">${s.losses}</div>
                            <div style="font-size:0.9em;opacity:0.8;">–ü–æ—Ä–∞–∂–µ–Ω–∏–π</div>
                        </div>
                    </div>
                    <div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.2);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>üî• –°–µ—Ä–∏—è:</span><strong>${s.winStreak} (–º–∞–∫—Å: ${s.maxWinStreak})</strong></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>üí∞ –í—ã–∏–≥—Ä–∞–Ω–æ:</span><strong style="color:#4ade80">${s.totalWonVp.toLocaleString()} VP</strong></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>üí∏ –ü—Ä–æ–∏–≥—Ä–∞–Ω–æ:</span><strong style="color:#f87171">${s.totalLostVp.toLocaleString()} VP</strong></div>
                        <div style="display:flex;justify-content:space-between;"><span>üéØ –ú–∞–∫—Å. –≤—ã–∏–≥—Ä—ã—à:</span><strong style="color:#ffd700">${s.biggestWinVp.toLocaleString()} VP</strong></div>
                    </div>`;
            } catch (e) {
                body.innerHTML = '<div style="color:#f87171;text-align:center;">‚ùå –û—à–∏–±–∫–∞</div>';
            }
        }
        
        function hideStatsModal() {
            document.getElementById('statsModal').classList.remove('show');
        }

        async function showAuditModal() {
            sounds.click();
            if (!token) { log('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
            document.getElementById('auditModal').classList.add('show');
            const body = document.getElementById('auditModalBody');
            body.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const r = await fetch(`${API_URL}/auth/audit`, { headers: { "Authorization": "Bearer " + token } });
                const data = await r.json();
                if (data.count === 0) {
                    body.innerHTML = '<div style="text-align:center;padding:20px;opacity:0.7;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏</div>';
                    return;
                }
                let html = `<div style="max-height:400px;overflow-y:auto;">`;
                data.logs.forEach(log => {
                    const date = new Date(log.createdAt).toLocaleString();
                    const payload = JSON.stringify(log.payload || {});
                    html += `
                        <div style="background:rgba(255,255,255,0.05);padding:12px;margin-bottom:8px;border-radius:8px;font-size:0.9em;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                                <strong style="color:#ffd700;">${log.eventType}</strong>
                                <span style="opacity:0.6;font-size:0.8em;">${date}</span>
                            </div>
                            ${log.matchId ? `<div style="opacity:0.7;font-size:0.85em;">Match: ${log.matchId}</div>` : ''}
                            <div style="opacity:0.7;font-size:0.85em;word-break:break-all;">${payload}</div>
                        </div>`;
                });
                html += '</div>';
                body.innerHTML = html;
            } catch (e) {
                body.innerHTML = '<div style="color:#f87171;text-align:center;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        function hideAuditModal() {
            document.getElementById('auditModal').classList.remove('show');
        }

        async function showReconcileModal() {
            sounds.click();
            if (!token) { log('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
            document.getElementById('reconcileModal').classList.add('show');
            const body = document.getElementById('reconcileModalBody');
            body.innerHTML = '<div style="text-align:center;padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const r = await fetch(`${API_URL}/wallet/reconcile`, { headers: { "Authorization": "Bearer " + token } });
                const d = await r.json();
                const statusColor = d.isBalanced ? '#4ade80' : '#f87171';
                const statusIcon = d.isBalanced ? '‚úÖ' : '‚ö†Ô∏è';
                body.innerHTML = `
                    <div style="text-align:center;margin-bottom:20px;">
                        <div style="font-size:3em;margin-bottom:10px;">${statusIcon}</div>
                        <div style="font-size:1.2em;font-weight:bold;color:${statusColor};">
                            ${d.isBalanced ? '–ë–∞–ª–∞–Ω—Å –≤ –ø–æ—Ä—è–¥–∫–µ' : '–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ!'}
                        </div>
                        ${!d.isBalanced ? `<div style="color:#f87171;margin-top:10px;">–†–∞–∑–Ω–∏—Ü–∞: ${d.discrepancy} VP</div>` : ''}
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;">
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:1.8em;font-weight:bold;color:#4ade80;">${d.actualBalance.toLocaleString()}</div>
                            <div style="font-size:0.85em;opacity:0.8;">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:1.8em;font-weight:bold;color:#ffd700;">${d.expectedBalance.toLocaleString()}</div>
                            <div style="font-size:0.85em;opacity:0.8;">–û–∂–∏–¥–∞–µ–º—ã–π –±–∞–ª–∞–Ω—Å</div>
                        </div>
                    </div>
                    <div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.2);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>üí∞ –í—Å–µ–≥–æ –≤—ã–∏–≥—Ä–∞–Ω–æ:</span><strong style="color:#4ade80">${d.stats.totalWon.toLocaleString()} VP</strong></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>üí∏ –í—Å–µ–≥–æ –ø—Ä–æ–∏–≥—Ä–∞–Ω–æ:</span><strong style="color:#f87171">${d.stats.totalLost.toLocaleString()} VP</strong></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>üìä –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å:</span><strong style="color:${d.stats.netProfit >= 0 ? '#4ade80' : '#f87171'}">${d.stats.netProfit >= 0 ? '+' : ''}${d.stats.netProfit.toLocaleString()} VP</strong></div>
                        <div style="display:flex;justify-content:space-between;"><span>‚ùÑÔ∏è –ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ:</span><strong>${d.frozenBalance.toLocaleString()} VP</strong></div>
                    </div>`;
            } catch (e) {
                body.innerHTML = '<div style="color:#f87171;text-align:center;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        function hideReconcileModal() {
            document.getElementById('reconcileModal').classList.remove('show');
        }
        
        function hidePublicProfileModal() {
            document.getElementById('publicProfileModal').classList.remove('show');
        }
    </script>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üîë –í—Ö–æ–¥</h3>
                <button class="modal-close" onclick="hideLoginModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" onkeydown="handleEnter(event, 'login')">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <div class="password-field">
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="handleEnter(event, 'login')">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)">üëÅÔ∏è</button>
                    </div>
                </div>
                <button class="btn btn-success btn-full" onclick="doLogin()">–í–æ–π—Ç–∏</button>
                <div class="form-links">
                    <a href="#" onclick="showForgotModal(); hideLoginModal(); return false;">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal-overlay" id="registerModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                <button class="modal-close" onclick="hideRegisterModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com" onkeydown="handleEnter(event, 'register')">
                </div>
                <div class="form-group">
                    <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="registerUsername" placeholder="Username">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)</label>
                    <div class="password-field">
                        <input type="password" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="handleEnter(event, 'register')">
                        <button type="button" class="password-toggle" onclick="togglePassword('registerPassword', this)">üëÅÔ∏è</button>
                    </div>
                </div>
                <button class="btn btn-success btn-full" onclick="doRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
                <button class="modal-close" onclick="hideProfileModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="profile-section">
                    <div class="avatar-preview-large" id="profileAvatarPreview">
                        <img id="profileCurrentAvatar" src="" alt="avatar">
                    </div>
                    <div class="profile-info">
                        <div class="form-group">
                            <label>–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                            <input type="text" id="profileDisplayName" placeholder="–í–∞—à–µ –∏–º—è" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label>–ü–æ–ª</label>
                            <select id="profileGender">
                                <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                                <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                                <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="avatar-section" id="avatarSection">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä–∫—É</label>
                    <div class="avatar-tabs">
                        <button class="avatar-tab active" onclick="switchAvatarTab('male', this)">–ú—É–∂—Å–∫–∏–µ</button>
                        <button class="avatar-tab" onclick="switchAvatarTab('female', this)">–ñ–µ–Ω—Å–∫–∏–µ</button>
                        <button class="avatar-tab" onclick="switchAvatarTab('custom', this)">–°–≤–æ—è</button>
                    </div>
                    <div class="avatar-grid" id="maleAvatars"></div>
                    <div class="avatar-grid hidden" id="femaleAvatars"></div>
                    <div class="avatar-grid hidden" id="customAvatar">
                        <div class="upload-area" onclick="document.getElementById('avatarUpload').click()">
                            <span>üì∑ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</span>
                            <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                        </div>
                    </div>
                </div>
                
                <div class="profile-actions">
                    <button class="btn btn-success btn-full" onclick="saveProfile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                
                <div class="profile-link-email" id="linkEmailSection" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <p>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å. –ü—Ä–∏–≤—è–∂–∏—Ç–µ email –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:</p>
                    <div class="form-group">
                        <input type="email" id="linkEmail" placeholder="your@email.com" onkeydown="handleEnter(event, 'linkEmail')">
                    </div>
                    <div class="form-group">
                        <div class="password-field">
                            <input type="password" id="linkPassword" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" onkeydown="handleEnter(event, 'linkEmail')">
                            <button type="button" class="password-toggle" onclick="togglePassword('linkPassword', this)">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-full" onclick="linkEmail()">üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å email</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal-overlay" id="forgotModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üîê –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h3>
                <button class="modal-close" onclick="hideForgotModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p class="form-info">–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</p>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="forgotEmail" placeholder="your@email.com">
                </div>
                <button class="btn btn-success btn-full" onclick="doForgotPassword()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <!-- Stats Modal -->
    <div class="modal-overlay" id="statsModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <button class="modal-close" onclick="hideStatsModal()">√ó</button>
            </div>
            <div class="modal-body" id="statsModalBody">
                <div class="stats-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <!-- Audit Modal -->
    <div class="modal-overlay" id="auditModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üìú –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h3>
                <button class="modal-close" onclick="hideAuditModal()">√ó</button>
            </div>
            <div class="modal-body" id="auditModalBody">
                <div class="stats-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <!-- Reconcile Modal -->
    <div class="modal-overlay" id="reconcileModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>‚öñÔ∏è –°–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞</h3>
                <button class="modal-close" onclick="hideReconcileModal()">√ó</button>
            </div>
            <div class="modal-body" id="reconcileModalBody">
                <div class="stats-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <!-- Public Profile Modal (for viewing other players) -->
    <div class="modal-overlay" id="publicProfileModal" onclick="closeModal(event)">
        <div class="modal modal-small" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å –∏–≥—Ä–æ–∫–∞</h3>
                <button class="modal-close" onclick="hidePublicProfileModal()">√ó</button>
            </div>
            <div class="modal-body" id="publicProfileBody">
                <div class="public-profile">
                    <div class="profile-avatar-large" id="publicProfileAvatar"></div>
                    <h3 id="publicProfileName"></h3>
                    <div class="public-stats" id="publicProfileStats"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>