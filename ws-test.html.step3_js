<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WagerPlay - Rock Paper Scissors</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23667eea'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3E%F0%9F%8E%AE%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            text-align: center;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        /* Balance Card */
        .balance-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .balance-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .balance-frozen {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Control Buttons */
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(17,153,142,0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(17,153,142,0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Game Area */
        .game-area {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            min-height: 300px;
        }

        .game-status {
            text-align: center;
            margin-bottom: 30px;
        }

        .status-text {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .match-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        /* Move Buttons */
        .moves-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .move-btn {
            width: 120px;
            height: 140px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 2px solid transparent;
        }

        .move-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.05);
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .move-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .move-btn.selected {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
            box-shadow: 0 0 30px rgba(255,215,0,0.5);
        }

        .move-emoji {
            font-size: 3em;
        }

        .move-text {
            font-size: 1.1em;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Players Grid */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .player-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .player-card.active {
            border-color: #38ef7d;
            background: rgba(56,239,125,0.1);
        }

        .player-card.eliminated {
            opacity: 0.4;
            border-color: #ff4757;
        }

        .player-card.winner {
            border-color: #ffd700;
            background: rgba(255,215,0,0.2);
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }

        .player-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .player-move {
            font-size: 2em;
            margin: 10px 0;
        }

        .player-status {
            font-size: 0.8em;
            opacity: 0.8;
        }

        /* Round Info */
        .round-info {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .round-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #ffd700;
        }

        /* Log */
        .log-container {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            opacity: 0.5;
            margin-right: 10px;
        }

        /* Waiting Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .waiting {
            animation: pulse 1.5s infinite;
            text-align: center;
            font-size: 1.2em;
            padding: 40px;
        }

        .hidden {
            display: none !important;
        }

        /* Sound toggle */
        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sound-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* Burger Menu */
        .burger-menu-container {
            position: fixed;
            top: 20px;
            right: 80px;
            z-index: 1000;
        }

        .burger-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            padding: 10px 15px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .burger-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .burger-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(30, 60, 114, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            overflow: hidden;
            min-width: 200px;
        }

        .burger-menu.show {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        /* Language Dropdown Styles */
        .lang-dropdown-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .lang-dropdown-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .lang-dropdown-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .lang-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: rgba(30, 60, 114, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            overflow: hidden;
            min-width: 150px;
        }

        .lang-dropdown-menu.show {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        .lang-dropdown-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
        }

        .lang-dropdown-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .lang-dropdown-item.selected {
            background: rgba(255,215,0,0.3);
        }

        /* Player Selector */
        .player-selector {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .selector-label {
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .selector-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .selector-btn {
            padding: 10px 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .selector-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
        }

        .selector-btn.active {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
            color: #ffd700;
        }

        /* Game Controls Row */
        .game-controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }

        /* Dropdown Play Button */
        .dropdown-play {
            position: relative;
            display: flex;
            align-items: center;
        }

        .btn-play-main, .btn-stake-main {
            border-radius: 12px 0 0 12px;
            padding-right: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-play-arrow, .btn-stake-arrow {
            border-radius: 0 12px 12px 0;
            padding: 12px 10px;
            margin-left: 2px;
            font-size: 0.7em;
            min-width: 32px;
            transition: transform 0.3s ease;
        }

        .btn-play-arrow:hover, .btn-stake-arrow:hover {
            transform: translateY(-2px);
        }

        .btn-play-arrow.active, .btn-stake-arrow.active {
            background: rgba(255,215,0,0.5);
        }

        .player-count-badge {
            background: rgba(255,215,0,0.8);
            color: #1e3c72;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.85em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Stats Modal */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .winrate-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .winrate-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #ffd700);
            transition: width 0.5s ease;
        }

        .public-profile {
            text-align: center;
            padding: 20px;
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
        }

        .public-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .public-stat {
            text-align: center;
        }

        .public-stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        .public-stat-label {
            font-size: 0.75em;
            opacity: 0.7;
            margin-top: 3px;
        }

        .chat-author-clickable {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .chat-author-clickable:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .player-count-badge {
            background: rgba(255,215,0,0.8);
            color: #1e3c72;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: bold;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            background: rgba(30, 60, 114, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            overflow: hidden;
            z-index: 100;
            min-width: 150px;
        }

        .dropdown-menu.show {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .dropdown-item.selected {
            background: rgba(255,215,0,0.3);
        }

        .dropdown-players {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .dropdown-item.selected .dropdown-players {
            background: #ffd700;
            color: #1e3c72;
        }

        .dropdown-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Chat */
        .chat-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
            overflow: hidden;
            display: none;
        }

        .chat-container.active {
            display: block;
        }

        .chat-header {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .chat-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            max-width: 300px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }

        .chat-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .chat-tabs::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }

        .chat-tab {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-tab.active {
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
            color: #ffd700;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .chat-message.system {
            background: rgba(255,215,0,0.2);
            text-align: center;
            font-style: italic;
        }

        .chat-author {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 3px;
        }

        .chat-time {
            font-size: 0.75em;
            opacity: 0.6;
            margin-left: 10px;
        }

        .chat-input-area {
            display: flex;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            outline: none;
        }

        .chat-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .chat-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-send:hover {
            transform: scale(1.1);
        }

        .chat-closed {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
            font-style: italic;
        }

        /* Auth Buttons */
        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.1);
            padding: 8px 20px;
            border-radius: 25px;
        }

        .user-email {
            font-weight: 600;
            color: #ffd700;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1em;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .form-group input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        /* Password field with toggle */
        .password-field {
            position: relative;
        }
        
        .password-field input {
            width: 100%;
            padding-right: 40px;
        }
        
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 5px;
        }
        
        .password-toggle:hover {
            opacity: 1;
        }

        .btn-full {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
        }

        .form-links {
            text-align: center;
            margin-top: 20px;
        }

        .form-links a {
            color: #ffd700;
            text-decoration: none;
            font-size: 0.9em;
        }

        .form-links a:hover {
            text-decoration: underline;
        }

        .form-info {
            text-align: center;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        /* Profile Modal Styles */
        .profile-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .avatar-preview-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid #667eea;
            flex-shrink: 0;
        }

        .avatar-preview-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
        }

        .profile-info select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            color: white;
            font-size: 1em;
        }

        .profile-info select option {
            background: #2a5298;
            color: white;
        }

        .avatar-section {
            margin-bottom: 20px;
        }

        .avatar-section > label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .avatar-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .avatar-tab {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .avatar-tab.active {
            background: #667eea;
        }

        .avatar-tab:hover {
            background: rgba(255,255,255,0.2);
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .avatar-item {
            aspect-ratio: 1;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .avatar-item:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .avatar-item.selected {
            border-color: #00d9ff;
            box-shadow: 0 0 10px rgba(0,217,255,0.5);
        }

        .avatar-item img {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }

        .upload-area {
            grid-column: 1 / -1;
            height: 100px;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102,126,234,0.1);
        }

        .user-avatar-mini {
            transition: transform 0.3s;
        }

        .user-avatar-mini:hover {
            transform: scale(1.1);
        }

        .profile-link-email p {
            margin-bottom: 10px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <button class="sound-toggle" onclick="toggleSound()" title="Ğ’ĞºĞ»/Ğ²Ñ‹ĞºĞ» Ğ·Ğ²ÑƒĞº">ğŸ”Š</button>

    <!-- Burger Menu -->
    <div class="burger-menu-container">
        <button class="burger-btn" onclick="toggleMenu()" title="ĞœĞµĞ½Ñ">â˜°</button>
        <div class="burger-menu" id="burgerMenu">
            <div class="dropdown-item" onclick="doCheckBalance(); closeMenu();">
                <span>ğŸ’³</span>
                <span id="burgerBalanceText">Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ</span>
            </div>
            <div class="dropdown-item" onclick="showStatsModal(); closeMenu();">
                <span>ğŸ“Š</span>
                <span id="burgerStatsText">Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</span>
            </div>
            <div class="dropdown-item" onclick="showLogsInChat(); closeMenu();">
                <span>ğŸ“‹</span>
                <span id="burgerLogsText">Ğ›Ğ¾Ğ³Ğ¸</span>
            </div>
            <div class="dropdown-item" onclick="showAuditModal(); closeMenu();">
                <span>ğŸ“œ</span>
                <span id="burgerAuditText">ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°</span>
            </div>
            <div class="dropdown-item" onclick="showReconcileModal(); closeMenu();">
                <span>âš–ï¸</span>
                <span id="burgerReconcileText">Ğ¡Ğ²ĞµÑ€ĞºĞ°</span>
            </div>
        </div>
    </div>

    <!-- Language Dropdown -->
    <div class="lang-dropdown-container">
        <button class="lang-dropdown-btn" onclick="toggleLanguageDropdown()" id="langDropdownBtn">RU â–¼</button>
        <div class="lang-dropdown-menu" id="langDropdownMenu">
            <div class="lang-dropdown-item" onclick="setLang('ru')" data-lang="ru">
                <span>ğŸ‡·ğŸ‡º</span>
                <span>Ğ ÑƒÑÑĞºĞ¸Ğ¹</span>
            </div>
            <div class="lang-dropdown-item" onclick="setLang('en')" data-lang="en">
                <span>ğŸ‡ºğŸ‡¸</span>
                <span>English</span>
            </div>
            <div class="lang-dropdown-item" onclick="setLang('cn')" data-lang="cn">
                <span>ğŸ‡¨ğŸ‡³</span>
                <span>ä¸­æ–‡</span>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>ğŸ® WagerPlay</h1>
        <p class="subtitle">Rock Paper Scissors - Ğ˜Ğ³Ñ€Ğ°Ğ¹ Ğ¸ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ñ‹Ğ²Ğ°Ğ¹!</p>

        <!-- Balance -->
        <div class="balance-card">
            <div class="balance-label">ğŸ’° Ğ’ĞĞ¨ Ğ‘ĞĞ›ĞĞĞ¡</div>
            <div class="balance-amount" id="balanceDisplay">0 VP</div>
            <div class="balance-frozen" id="frozenDisplay"></div>
        </div>

        <!-- Controls -->
        <div class="controls" id="authControls">
            <!-- Not logged in -->
            <div class="auth-buttons" id="authButtons">
                <button class="btn btn-success" onclick="showLoginModal()">ğŸ”‘ <span id="btnLoginText">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</span></button>
                <button class="btn btn-primary" onclick="showRegisterModal()">ğŸ“ <span id="btnRegisterText">Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</span></button>
                <button class="btn btn-secondary" id="btnGuest" onclick="doGuest()">ğŸ‘¤ <span id="btnGuestText">Ğ“Ğ¾ÑÑ‚ÑŒ</span></button>
            </div>
            
            <!-- Logged in -->
            <div class="user-info" id="userInfo" style="display: none;">
                <span class="user-email" id="userEmail"></span>
                <img id="userAvatar" class="user-avatar-mini" src="" alt="avatar" onclick="showProfileModal()" style="cursor: pointer; width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; display: none;">
                <button class="btn btn-secondary" id="btnProfile" onclick="showProfileModal()">ğŸ‘¤ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</button>
                <button class="btn btn-secondary" id="btnLogout" onclick="logout()">ğŸšª Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
            </div>
            
            <button class="btn btn-primary" id="btnConnect" onclick="doConnect()" disabled>ğŸ”— ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ</button>
            
            <!-- Game Controls Row -->
            <div class="game-controls-row" id="gameControlsRow">
                <!-- Play Button with Player Count -->
            <div class="dropdown-play" id="dropdownPlay">
                <button class="btn btn-primary btn-play-main" id="btnQuickplay" onclick="doQuickplay()" disabled>
                    ğŸ® <span id="playBtnText">Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ 2 | 100 VP</span> <span class="player-count-badge" id="playerBadge">2</span>
                </button>
                <button class="btn btn-primary btn-play-arrow" id="btnPlayArrow" onclick="togglePlayerDropdown()" disabled>
                    â–¼
                </button>
                <div class="dropdown-menu" id="playerDropdown">
                    <div class="dropdown-item" onclick="selectPlayersDropdown(2)">
                        <span class="dropdown-players">2</span>
                        <span class="dropdown-label">Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°</span>
                    </div>
                    <div class="dropdown-item" onclick="selectPlayersDropdown(3)">
                        <span class="dropdown-players">3</span>
                        <span class="dropdown-label">Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°</span>
                    </div>
                    <div class="dropdown-item" onclick="selectPlayersDropdown(4)">
                        <span class="dropdown-players">4</span>
                        <span class="dropdown-label">Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°</span>
                    </div>
                    <div class="dropdown-item" onclick="selectPlayersDropdown(5)">
                        <span class="dropdown-players">5</span>
                        <span class="dropdown-label">Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²</span>
                    </div>
                </div>
            </div>
            
            <!-- Stake Selection Dropdown -->
            <div class="dropdown-play" id="dropdownStake" style="margin-left: 8px;">
                <button class="btn btn-primary btn-stake-main" id="btnStake" onclick="toggleStakeDropdown()" disabled>
                    ğŸ’° <span id="stakeBtnText">100</span> VP
                </button>
                <button class="btn btn-primary btn-stake-arrow" id="btnStakeArrow" onclick="toggleStakeDropdown()" disabled>
                    â–¼
                </button>
                <div class="dropdown-menu" id="stakeDropdown">
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(100)">
                        <span class="dropdown-players">100</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(200)">
                        <span class="dropdown-players">200</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(500)">
                        <span class="dropdown-players">500</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(1000)">
                        <span class="dropdown-players">1K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(2500)">
                        <span class="dropdown-players">2.5K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(5000)">
                        <span class="dropdown-players">5K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                    <div class="dropdown-item stake-item" onclick="selectStakeDropdown(10000)">
                        <span class="dropdown-players">10K</span>
                        <span class="dropdown-label">VP</span>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" id="btnGoToProfile" onclick="goToProfileScreen()" disabled>ğŸ‘¤ Ğ’ ĞŸĞ ĞĞ¤Ğ˜Ğ›Ğ¬</button>
            </div>
        </div>

        <!-- Game Area -->
        <div class="game-area">
            <div id="gameContent">
                <div class="waiting" id="waitingText">Press "Guest Login" to start</div>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <span>ğŸ’¬ Ğ§ĞĞ¢</span>
                <div class="chat-tabs" id="chatTabsContainer">
                    <button class="chat-tab active" onclick="switchChatTab('global')" id="tab-global">ĞĞ±Ñ‰Ğ¸Ğ¹</button>
                    <!-- Game tabs will be added here dynamically -->
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..." onkeypress="handleChatKeypress(event)">
                <button class="chat-send" onclick="sendChatMessage()">â¤</button>
            </div>
        </div>

        <!-- Log -->
        <div class="log-container" id="log">
            <div class="log-entry"><span class="log-time">[System]</span> Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² WagerPlay!</div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // API Config
        const API_URL = window.location.origin; // ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ URL Ğ´Ğ»Ñ ngrok Ğ¸ localhost
        
        // Game State
        let token = "";
        let userId = "";
        let matchId = "";
        let socket = null;
        let soundEnabled = true;
        let hasUserInteracted = false;  // ğŸµ Ğ”Ğ»Ñ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸ AudioContext Ğ´Ğ¾ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ¸ĞºĞ°
        let currentMatch = null;
        const activeMatches = new Set();  // ğŸ›¡ï¸ ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ’Ğ¡Ğ• Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¼Ğ°Ñ‚Ñ‡Ğ¸
        let countdownInterval = null;
        let matchCountdownInterval = null;  // ğŸ® ĞÑ‚ÑÑ‡Ñ‘Ñ‚ Ğ¿ĞµÑ€ĞµĞ´ Ğ¼Ğ°Ñ‚Ñ‡ĞµĞ¼
        let playerNames = {};  // ğŸ‘¤ Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ ID -> displayName
        let shownRounds = new Set();  // ğŸ›¡ï¸ Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ñ€Ğ°ÑƒĞ½Ğ´Ğ¾Ğ² Ğ² Ñ‡Ğ°Ñ‚Ğµ
        let shownMoveWarningForRound = null;  // ğŸ›¡ï¸ Debounce Ğ´Ğ»Ñ "ÑƒĞ¶Ğµ ÑĞ´ĞµĞ»Ğ°Ğ»Ğ¸ Ñ…Ğ¾Ğ´"
        let isProcessing = {
            guest: false,
            connect: false,
            quickplay: false,
            move: false
        };
        let currentLang = 'ru';

        // Translations
        const i18n = {
            ru: {
                title: 'WagerPlay - Rock Paper Scissors',
                subtitle: 'Ğ˜Ğ³Ñ€Ğ°Ğ¹ Ğ¸ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ñ‹Ğ²Ğ°Ğ¹!',
                balance: 'Ğ’ĞĞ¨ Ğ‘ĞĞ›ĞĞĞ¡',
                frozen: 'Ğ—Ğ°Ğ¼Ğ¾Ñ€Ğ¾Ğ¶ĞµĞ½Ğ¾',
                guest: 'ğŸ‘¤ Guest Login',
                connect: 'ğŸ”— ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ',
                quickplay: 'ğŸ® Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ 4/100',
                balanceBtn: 'ğŸ’³ Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ',
            statsBtn: 'ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°',
                goToProfileBtn: 'ğŸ‘¤ Ğ’ ĞŸĞ ĞĞ¤Ğ˜Ğ›Ğ¬',
                waitingGuest: 'ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "Guest Login" Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ',
                waitingQueue: 'Ğ’ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸...',
                searching: 'Ğ˜Ñ‰ĞµĞ¼ ÑĞ¾Ğ¿ĞµÑ€Ğ½Ğ¸ĞºĞ¾Ğ²...',
                yourTurn: 'ğŸ® Ğ’ĞĞ¨ Ğ¥ĞĞ”!',
                waitingTurn: 'â³ ĞĞ–Ğ˜Ğ”ĞĞĞ˜Ğ•',
                victory: 'ğŸ† ĞŸĞĞ‘Ğ•Ğ”Ğ!',
                defeat: 'ğŸ’€ ĞŸĞĞ ĞĞ–Ğ•ĞĞ˜Ğ•',
                round: 'Ğ Ğ°ÑƒĞ½Ğ´',
                pot: 'Ğ‘Ğ°Ğ½Ğº',
                stake: 'Ğ¡Ñ‚Ğ°Ğ²ĞºĞ°',
                payout: 'Ğ’Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğ°',
                winner: 'ĞŸĞ¾Ğ±ĞµĞ´Ğ¸Ñ‚ĞµĞ»ÑŒ',
                eliminated: 'Ğ’Ñ‹Ğ±Ñ‹Ğ»',
                inGame: 'Ğ’ Ğ¸Ğ³Ñ€Ğµ',
                rock: 'ĞšĞ°Ğ¼ĞµĞ½ÑŒ',
                paper: 'Ğ‘ÑƒĞ¼Ğ°Ğ³Ğ°',
                scissors: 'ĞĞ¾Ğ¶Ğ½Ğ¸Ñ†Ñ‹',
                playAgain: 'ğŸ”„ Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°',
                tie: 'ğŸ¤ ĞĞ¸Ñ‡ÑŒÑ',
                elimination: 'âš”ï¸ Ğ’Ñ‹Ğ±Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ',
                wonWith: 'ĞŸĞ¾Ğ±ĞµĞ´Ğ¸Ğ»',
                chat: 'ğŸ’¬ Ğ§ĞĞ¢',
                global: 'ĞĞ±Ñ‰Ğ¸Ğ¹',
                game: 'Ğ˜Ğ³Ñ€Ğ°',
                chatPlaceholder: 'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ...',
                players2: '2 Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°',
                players3: '3 Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°',
                players4: '4 Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°',
                selectPlayers: 'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€ĞµĞ¶Ğ¸Ğ¼:',
                you: 'Ğ’Ñ‹',
                alreadyInQueue: 'Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸!',
                chatWillClose: 'Ğ§Ğ°Ñ‚ Ğ·Ğ°ĞºÑ€Ğ¾ĞµÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· 2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹',
                gameStarted: 'Ğ˜Ğ³Ñ€Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°ÑÑŒ! Ğ£Ğ´Ğ°Ñ‡Ğ¸!',
                login: 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸',
                loginTitle: 'ğŸ”‘ Ğ’Ñ…Ğ¾Ğ´',
                register: 'Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ',
                logout: 'Ğ’Ñ‹Ğ¹Ñ‚Ğ¸',
                guest: 'Ğ“Ğ¾ÑÑ‚ÑŒ',
                statsBtn: 'ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°',
                goToProfileBtn: 'ğŸ‘¤ Ğ’ ĞŸĞ ĞĞ¤Ğ˜Ğ›Ğ¬',
                logsBtn: 'ğŸ“‹ Ğ›Ğ¾Ğ³Ğ¸',
                auditBtn: 'ğŸ“œ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°',
                reconcileBtn: 'âš–ï¸ Ğ¡Ğ²ĞµÑ€ĞºĞ°',
                profileBtn: 'ğŸ‘¤ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ',
                logoutBtn: 'ğŸšª Ğ’Ñ‹Ğ¹Ñ‚Ğ¸',
                // Login modal
                emailLabel: 'Email',
                passwordLabel: 'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ',
                forgotPassword: 'Ğ—Ğ°Ğ±Ñ‹Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ?',
                // Profile modal
                displayNameLabel: 'ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼Ğ¾Ğµ Ğ¸Ğ¼Ñ',
                genderLabel: 'ĞŸĞ¾Ğ»',
                genderNotSpecified: 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½',
                genderMale: 'ĞœÑƒĞ¶ÑĞºĞ¾Ğ¹',
                genderFemale: 'Ğ–ĞµĞ½ÑĞºĞ¸Ğ¹',
                selectAvatar: 'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€ĞºÑƒ',
                avatarMale: 'ĞœÑƒĞ¶ÑĞºĞ¸Ğµ',
                avatarFemale: 'Ğ–ĞµĞ½ÑĞºĞ¸Ğµ',
                avatarCustom: 'Ğ¡Ğ²Ğ¾Ñ',
                saveBtn: 'ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ',
                profileModalTitle: 'ğŸ‘¤ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ',
                profileGuestText: 'Ğ’Ñ‹ Ğ²Ğ¾ÑˆĞ»Ğ¸ ĞºĞ°Ğº Ğ³Ğ¾ÑÑ‚ÑŒ. ĞŸÑ€Ğ¸Ğ²ÑĞ¶Ğ¸Ñ‚Ğµ email Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°:',
                linkPasswordLabel: 'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ (Ğ¼Ğ¸Ğ½. 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)',
                linkEmailBtn: 'ğŸ”— ĞŸÑ€Ğ¸Ğ²ÑĞ·Ğ°Ñ‚ÑŒ email'
            },
            en: {
                title: 'WagerPlay - Rock Paper Scissors',
                subtitle: 'Play and Win!',
                balance: 'YOUR BALANCE',
                frozen: 'Frozen',
                guest: 'ğŸ‘¤ Guest Login',
                connect: 'ğŸ”— Connect',
                quickplay: 'ğŸ® Quickplay 4/100',
                balanceBtn: 'ğŸ’³ Balance',
                waitingGuest: 'Press "Guest Login" to start',
                waitingQueue: 'In queue...',
                searching: 'Searching for players...',
                yourTurn: 'ğŸ® YOUR TURN!',
                waitingTurn: 'â³ WAITING',
                victory: 'ğŸ† VICTORY!',
                defeat: 'ğŸ’€ DEFEAT',
                round: 'Round',
                pot: 'Pot',
                stake: 'Stake',
                payout: 'Payout',
                winner: 'Winner',
                eliminated: 'Eliminated',
                inGame: 'In game',
                rock: 'Rock',
                paper: 'Paper',
                scissors: 'Scissors',
                playAgain: 'ğŸ”„ Play Again',
                tie: 'ğŸ¤ Tie',
                elimination: 'âš”ï¸ Elimination',
                wonWith: 'Won with',
                chat: 'ğŸ’¬ CHAT',
                global: 'Global',
                game: 'Game',
                chatPlaceholder: 'Type message...',
                players2: '2 Players',
                players3: '3 Players',
                players4: '4 Players',
                selectPlayers: 'Select mode:',
                you: 'You',
                alreadyInQueue: 'Already in queue!',
                chatWillClose: 'Chat will close in 2 minutes',
                gameStarted: 'Game started! Good luck!',
                login: 'Login',
                loginTitle: 'ğŸ”‘ Login',
                register: 'Register',
                logout: 'Logout',
                guest: 'Guest',
                statsBtn: 'ğŸ“Š Stats',
                goToProfileBtn: 'ğŸ‘¤ TO PROFILE',
                logsBtn: 'ğŸ“‹ Logs',
                auditBtn: 'ğŸ“œ Audit',
                reconcileBtn: 'âš–ï¸ Reconcile',
                profileBtn: 'ğŸ‘¤ Profile',
                logoutBtn: 'ğŸšª Logout',
                // Login modal
                emailLabel: 'Email',
                passwordLabel: 'Password',
                forgotPassword: 'Forgot password?',
                // Profile modal
                displayNameLabel: 'Display Name',
                genderLabel: 'Gender',
                genderNotSpecified: 'Not specified',
                genderMale: 'Male',
                genderFemale: 'Female',
                selectAvatar: 'Select Avatar',
                avatarMale: 'Male',
                avatarFemale: 'Female',
                avatarCustom: 'Custom',
                saveBtn: 'ğŸ’¾ Save',
                profileModalTitle: 'ğŸ‘¤ Profile',
                profileGuestText: 'You are logged in as a guest. Link your email to save progress:',
                linkPasswordLabel: 'Password (min. 6 characters)',
                linkEmailBtn: 'ğŸ”— Link Email'
            },
            cn: {
                title: 'WagerPlay - çŸ³å¤´å‰ªåˆ€å¸ƒ',
                subtitle: 'ç©æ¸¸æˆï¼Œèµ¢å¤§å¥–ï¼',
                balance: 'æ‚¨çš„ä½™é¢',
                frozen: 'å†»ç»“',
                guest: 'ğŸ‘¤ æ¸¸å®¢ç™»å½•',
                connect: 'ğŸ”— è¿æ¥',
                quickplay: 'ğŸ® å¿«é€Ÿæ¸¸æˆ 4/100',
                balanceBtn: 'ğŸ’³ ä½™é¢',
                waitingGuest: 'ç‚¹å‡»"æ¸¸å®¢ç™»å½•"å¼€å§‹',
                waitingQueue: 'æ’é˜Ÿä¸­...',
                searching: 'å¯»æ‰¾ç©å®¶...',
                yourTurn: 'ğŸ® è½®åˆ°æ‚¨ï¼',
                waitingTurn: 'â³ ç­‰å¾…ä¸­',
                victory: 'ğŸ† èƒœåˆ©ï¼',
                defeat: 'ğŸ’€ å¤±è´¥',
                round: 'å›åˆ',
                pot: 'å¥–æ± ',
                stake: 'èµŒæ³¨',
                payout: 'å¥–é‡‘',
                winner: 'èµ¢å®¶',
                eliminated: 'å·²æ·˜æ±°',
                inGame: 'æ¸¸æˆä¸­',
                rock: 'çŸ³å¤´',
                paper: 'å¸ƒ',
                scissors: 'å‰ªåˆ€',
                playAgain: 'ğŸ”„ å†ç©ä¸€æ¬¡',
                tie: 'ğŸ¤ å¹³å±€',
                elimination: 'âš”ï¸ æ·˜æ±°',
                wonWith: 'è·èƒœ',
                chat: 'ğŸ’¬ èŠå¤©',
                global: 'å…¨å±€',
                game: 'æ¸¸æˆ',
                chatPlaceholder: 'è¾“å…¥æ¶ˆæ¯...',
                players2: '2äºº',
                players3: '3äºº',
                players4: '4äºº',
                selectPlayers: 'é€‰æ‹©æ¨¡å¼ï¼š',
                you: 'æ‚¨',
                alreadyInQueue: 'å·²ç»åœ¨é˜Ÿåˆ—ä¸­ï¼',
                chatWillClose: 'èŠå¤©å°†åœ¨2åˆ†é’Ÿåå…³é—­',
                gameStarted: 'æ¸¸æˆå¼€å§‹ï¼ç¥ä½ å¥½è¿ï¼',
                login: 'ç™»å½•',
                loginTitle: 'ğŸ”‘ ç™»å½•',
                register: 'æ³¨å†Œ',
                logout: 'é€€å‡º',
                guest: 'æ¸¸å®¢',
                statsBtn: 'ğŸ“Š ç»Ÿè®¡',
                goToProfileBtn: 'ğŸ‘¤ ä¸ªäººèµ„æ–™',
                logsBtn: 'ğŸ“‹ æ—¥å¿—',
                auditBtn: 'ğŸ“œ å®¡è®¡',
                reconcileBtn: 'âš–ï¸ å¯¹è´¦',
                profileBtn: 'ğŸ‘¤ èµ„æ–™',
                logoutBtn: 'ğŸšª é€€å‡º',
                // Login modal
                emailLabel: 'é‚®ç®±',
                passwordLabel: 'å¯†ç ',
                forgotPassword: 'å¿˜è®°å¯†ç ï¼Ÿ',
                // Profile modal
                displayNameLabel: 'æ˜¾ç¤ºåç§°',
                genderLabel: 'æ€§åˆ«',
                genderNotSpecified: 'æœªæŒ‡å®š',
                genderMale: 'ç”·',
                genderFemale: 'å¥³',
                selectAvatar: 'é€‰æ‹©å¤´åƒ',
                avatarMale: 'ç”·æ€§',
                avatarFemale: 'å¥³æ€§',
                avatarCustom: 'è‡ªå®šä¹‰',
                saveBtn: 'ğŸ’¾ ä¿å­˜',
                profileModalTitle: 'ğŸ‘¤ èµ„æ–™',
                profileGuestText: 'æ‚¨ä»¥è®¿å®¢èº«ä»½ç™»å½•ã€‚è¯·ç»‘å®šé‚®ç®±ä»¥ä¿å­˜è¿›åº¦ï¼š',
                linkPasswordLabel: 'å¯†ç ï¼ˆæœ€å°‘6ä¸ªå­—ç¬¦ï¼‰',
                linkEmailBtn: 'ğŸ”— ç»‘å®šé‚®ç®±'
            }
        };

        function t(key) {
            return i18n[currentLang][key] || key;
        }

        function setLang(lang) {
            currentLang = lang;
            const btnGuest = document.getElementById('btnGuest');
            const btnConnect = document.getElementById('btnConnect');
            const playBtnText = document.getElementById('playBtnText');
            const btnBalance = document.getElementById('btnBalance');
            const subtitle = document.querySelector('.subtitle');
            const balanceLabel = document.querySelector('.balance-label');
            
            const btnLoginText = document.getElementById('btnLoginText');
            const btnRegisterText = document.getElementById('btnRegisterText');
            const btnGuestText = document.getElementById('btnGuestText');
            
            // Auth buttons
            if (btnLoginText) btnLoginText.textContent = t('login');
            const loginTitle = document.getElementById('loginTitle');
            if (loginTitle) loginTitle.textContent = t('loginTitle');
            if (btnRegisterText) btnRegisterText.textContent = t('register');
            if (btnGuestText) btnGuestText.textContent = t('guest');
            if (btnConnect) btnConnect.textContent = t('connect');
            if (playBtnText) playBtnText.textContent = t('quickplay');
            if (btnBalance) btnBalance.textContent = t('balanceBtn');
            
            // Stats, Logs, Audit, Reconcile buttons
            const btnStats = document.getElementById('btnStats');
            if (btnStats) btnStats.textContent = t('statsBtn');
            const btnGoToProfile = document.getElementById('btnGoToProfile');
            if (btnGoToProfile) btnGoToProfile.textContent = t('goToProfileBtn');
            const btnLogs = document.getElementById('btnLogs');
            if (btnLogs) btnLogs.textContent = t('logsBtn');
            const btnAudit = document.getElementById('btnAudit');
            if (btnAudit) btnAudit.textContent = t('auditBtn');
            const btnReconcile = document.getElementById('btnReconcile');
            if (btnReconcile) btnReconcile.textContent = t('reconcileBtn');
            
            // Profile and Logout buttons
            const btnProfile = document.getElementById('btnProfile');
            if (btnProfile) btnProfile.textContent = t('profileBtn');
            const btnLogout = document.getElementById('btnLogout');
            if (btnLogout) btnLogout.textContent = t('logoutBtn');
            
            // Login modal labels
            const loginEmailLabel = document.getElementById('loginEmailLabel');
            if (loginEmailLabel) loginEmailLabel.textContent = t('emailLabel');
            const loginPasswordLabel = document.getElementById('loginPasswordLabel');
            if (loginPasswordLabel) loginPasswordLabel.textContent = t('passwordLabel');
            const loginSubmitBtn = document.getElementById('loginSubmitBtn');
            if (loginSubmitBtn) loginSubmitBtn.textContent = t('login');
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            if (forgotPasswordLink) forgotPasswordLink.textContent = t('forgotPassword');
            
            // Profile modal labels
            const profileDisplayNameLabel = document.getElementById('profileDisplayNameLabel');
            if (profileDisplayNameLabel) profileDisplayNameLabel.textContent = t('displayNameLabel');
            const profileGenderLabel = document.getElementById('profileGenderLabel');
            if (profileGenderLabel) profileGenderLabel.textContent = t('genderLabel');
            const profileAvatarLabel = document.getElementById('profileAvatarLabel');
            if (profileAvatarLabel) profileAvatarLabel.textContent = t('selectAvatar');
            const avatarTabMale = document.getElementById('avatarTabMale');
            if (avatarTabMale) avatarTabMale.textContent = t('avatarMale');
            const avatarTabFemale = document.getElementById('avatarTabFemale');
            if (avatarTabFemale) avatarTabFemale.textContent = t('avatarFemale');
            const avatarTabCustom = document.getElementById('avatarTabCustom');
            if (avatarTabCustom) avatarTabCustom.textContent = t('avatarCustom');
            const profileSaveBtn = document.getElementById('profileSaveBtn');
            if (profileSaveBtn) profileSaveBtn.textContent = t('saveBtn');
            
            // Gender options
            const genderNotSpecified = document.getElementById('genderNotSpecified');
            if (genderNotSpecified) genderNotSpecified.textContent = t('genderNotSpecified');
            const genderMale = document.getElementById('genderMale');
            if (genderMale) genderMale.textContent = t('genderMale');
            const genderFemale = document.getElementById('genderFemale');
            if (genderFemale) genderFemale.textContent = t('genderFemale');
            
            // Profile modal title and guest text
            const profileModalTitle = document.getElementById('profileModalTitle');
            if (profileModalTitle) profileModalTitle.textContent = t('profileModalTitle');
            const profileGuestText = document.getElementById('profileGuestText');
            if (profileGuestText) profileGuestText.textContent = t('profileGuestText');
            const linkPasswordLabel = document.getElementById('linkPasswordLabel');
            if (linkPasswordLabel) linkPasswordLabel.textContent = t('linkPasswordLabel');
            const linkPassword = document.getElementById('linkPassword');
            if (linkPassword) linkPassword.setAttribute('placeholder', t('linkPasswordLabel'));
            const linkEmailBtn = document.getElementById('linkEmailBtn');
            if (linkEmailBtn) linkEmailBtn.textContent = t('linkEmailBtn');
            
            if (subtitle) subtitle.textContent = t('subtitle');
            if (balanceLabel) balanceLabel.textContent = 'ğŸ’° ' + t('balance');
            
            // Update language dropdown
            const langDropdownBtn = document.getElementById('langDropdownBtn');
            if (langDropdownBtn) {
                const langNames = { ru: 'RU', en: 'EN', cn: 'CN' };
                langDropdownBtn.textContent = langNames[lang] + ' â–¼';
            }
            document.querySelectorAll('.lang-dropdown-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.lang === lang);
            });
            
            // Update burger menu texts
            const burgerBalanceText = document.getElementById('burgerBalanceText');
            const burgerStatsText = document.getElementById('burgerStatsText');
            const burgerLogsText = document.getElementById('burgerLogsText');
            const burgerAuditText = document.getElementById('burgerAuditText');
            const burgerReconcileText = document.getElementById('burgerReconcileText');
            if (burgerBalanceText) burgerBalanceText.textContent = t('balanceBtn').replace('ğŸ’³ ', '');
            if (burgerStatsText) burgerStatsText.textContent = t('statsBtn').replace('ğŸ“Š ', '');
            if (burgerLogsText) burgerLogsText.textContent = t('logsBtn').replace('ğŸ“‹ ', '');
            if (burgerAuditText) burgerAuditText.textContent = t('auditBtn').replace('ğŸ“œ ', '');
            if (burgerReconcileText) burgerReconcileText.textContent = t('reconcileBtn').replace('âš–ï¸ ', '');
            
            // Refresh match display if exists
            if (currentMatch) renderMatch(currentMatch);
            
            // Save preference
            localStorage.setItem('preferredLang', lang);
        }

        // Language Dropdown Functions
        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('langDropdownMenu');
            dropdown.classList.toggle('show');
        }

        function closeLanguageDropdown() {
            const dropdown = document.getElementById('langDropdownMenu');
            dropdown.classList.remove('show');
        }

        // Burger Menu Functions
        function toggleMenu() {
            const menu = document.getElementById('burgerMenu');
            menu.classList.toggle('show');
        }

        function closeMenu() {
            const menu = document.getElementById('burgerMenu');
            menu.classList.remove('show');
        }

        // Player Selection
        let selectedPlayers = 2;
        let selectedStake = 100; // Ğ”ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ğ°Ñ ÑÑ‚Ğ°Ğ²ĞºĞ°
        let currentChatTab = 'global';
        let currentGameChatId = null; // ID Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ° Ğ¸Ğ³Ñ€Ñ‹
        let gameChatTimeouts = {}; // Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€Ñ‹ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¸Ğ³Ñ€Ñ‹ { matchId: timeout }

        function selectPlayers(count) {
            if (isProcessing.quickplay) {
                sounds.error();
                return;
            }
            selectedPlayers = count;
            // Update badge on main button
            document.getElementById('playerBadge').textContent = count;
            // Update dropdown selection
            updateDropdownSelection(count);
            sounds.click();
            log(`${t('selectPlayers')} ${count}`);
        }

        function togglePlayerDropdown() {
            const dropdown = document.getElementById('playerDropdown');
            const arrow = document.getElementById('btnPlayArrow');
            dropdown.classList.toggle('show');
            arrow.classList.toggle('active');
            // Close stake dropdown if open
            document.getElementById('stakeDropdown').classList.remove('show');
            document.getElementById('btnStakeArrow').classList.remove('active');
            sounds.click();
        }
        
        function toggleStakeDropdown() {
            const dropdown = document.getElementById('stakeDropdown');
            const arrow = document.getElementById('btnStakeArrow');
            dropdown.classList.toggle('show');
            arrow.classList.toggle('active');
            // Close player dropdown if open
            document.getElementById('playerDropdown').classList.remove('show');
            document.getElementById('btnPlayArrow').classList.remove('active');
            sounds.click();
        }
        
        function selectStakeDropdown(stake) {
            selectedStake = stake;
            localStorage.setItem('selectedStake', stake); // ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸
            const stakeText = stake >= 1000 ? (stake/1000) + 'K' : stake;
            document.getElementById('stakeBtnText').textContent = stakeText;
            
            // Update selection visual
            document.querySelectorAll('.stake-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Close dropdown
            document.getElementById('stakeDropdown').classList.remove('show');
            document.getElementById('btnStakeArrow').classList.remove('active');
            
            sounds.click();
            log(`ğŸ’° Ğ¡Ñ‚Ğ°Ğ²ĞºĞ°: ${stake} VP`);
        }

        function selectPlayersDropdown(count) {
            selectedPlayers = count;
            localStorage.setItem('selectedPlayers', count); // ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸
            document.getElementById('playerBadge').textContent = count;
            updateDropdownSelection(count);
            
            // Update button text with selected player count and stake
            const btnText = document.getElementById('playBtnText');
            const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
            if (btnText) {
                btnText.textContent = `Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ ${count} | ${stakeText} VP`;
            }
            
            // Close dropdown
            document.getElementById('playerDropdown').classList.remove('show');
            document.getElementById('btnPlayArrow').classList.remove('active');
            
            sounds.click();
            log(`${t('selectPlayers')} ${count}`);
        }

        function updateDropdownSelection(count) {
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('selected');
            });
            // Select the item (based on index 0=2, 1=3, 2=4, 3=5)
            const items = document.querySelectorAll('.dropdown-item');
            if (items[count - 2]) {
                items[count - 2].classList.add('selected');
            }
        }

        // Chat Functions - Each game has its own chat
        function switchChatTab(tab, gameId = null) {
            currentChatTab = tab;
            if (gameId) currentGameChatId = gameId;
            
            // Update UI tabs - remove active from all
            document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
            
            // Activate correct tab
            if (tab === 'global') {
                document.getElementById('tab-global').classList.add('active');
            } else if (tab === 'game' && currentGameChatId) {
                const tabId = `tab-game-${currentGameChatId}`;
                const gameTab = document.getElementById(tabId);
                if (gameTab) gameTab.classList.add('active');
            }
            
            // Update chat title
            const chatTitle = document.querySelector('.chat-header span');
            if (tab === 'global') {
                chatTitle.textContent = 'ğŸ’¬ ' + t('chat') + ' - ' + t('global');
            } else if (tab === 'game' && currentGameChatId) {
                const shortId = currentGameChatId.slice(0, 8);
                chatTitle.textContent = `ğŸ’¬ Game #${shortId}`;
            }
            
            renderChatMessages();
            sounds.click();
        }

        function showChat() {
            const chat = document.getElementById('chatContainer');
            chat.classList.add('active');
            chat.style.display = 'block';
        }

        function hideChat() {
            const chat = document.getElementById('chatContainer');
            chat.classList.remove('active');
            chat.style.display = 'none';
        }

        function createGameChat(gameMatchId) {
            console.log('Creating game chat for:', gameMatchId);
            if (!window.chatHistory) window.chatHistory = { global: [], games: {} };
            if (!window.chatHistory.games) window.chatHistory.games = {};
            if (!window.chatHistory.games[gameMatchId]) {
                window.chatHistory.games[gameMatchId] = [];
            }
            currentGameChatId = gameMatchId;
            
            // Create new tab for this game
            const tabsContainer = document.getElementById('chatTabsContainer');
            const tabId = `tab-game-${gameMatchId}`;
            
            // Check if tab already exists
            if (!document.getElementById(tabId)) {
                const newTab = document.createElement('button');
                newTab.className = 'chat-tab';
                newTab.id = tabId;
                newTab.textContent = '#' + gameMatchId.slice(0, 6);
                newTab.onclick = () => switchChatTab('game', gameMatchId);
                tabsContainer.appendChild(newTab);
            }
            
            // Add system message
            addChatMessage('system', 'System', `${t('gameStarted')} #${gameMatchId.slice(0, 8)}`, 'game', gameMatchId);
            
            // Switch to this game chat
            switchChatTab('game', gameMatchId);
            
            console.log('Game chat created. Current games:', Object.keys(window.chatHistory.games));
        }

        function closeGameChat(gameMatchId) {
            if (!gameMatchId) gameMatchId = currentGameChatId;
            if (!gameMatchId) return;
            
            // Mark chat as closed
            if (window.chatHistory.games && window.chatHistory.games[gameMatchId]) {
                window.chatHistory.games[gameMatchId].push({
                    type: 'system',
                    author: 'System',
                    text: t('chatClosed'),
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    closed: true
                });
            }
            
            // Find the specific tab for this game and add lock
            const tabId = `tab-game-${gameMatchId}`;
            const gameTab = document.getElementById(tabId);
            if (gameTab) {
                gameTab.textContent = '#' + gameMatchId.slice(0, 6) + ' ğŸ”’';
                gameTab.style.opacity = '0.5';
            }
            
            // If this is current game, refresh messages
            if (currentGameChatId === gameMatchId) {
                renderChatMessages();
            }
            
            // Schedule tab removal after 2 minutes (total 4 minutes from game end)
            setTimeout(() => {
                const tabToRemove = document.getElementById(tabId);
                if (tabToRemove) {
                    tabToRemove.remove();
                    // Clean up history
                    if (window.chatHistory.games[gameMatchId]) {
                        delete window.chatHistory.games[gameMatchId];
                    }
                }
            }, 120000); // Remove tab after additional 2 minutes
        }

        function handleChatKeypress(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            const author = currentProfile.displayName || (userId ? userId.slice(0,8) : 'Guest');

            if (currentChatTab === 'global') {
                if (socket) socket.emit('chat:global', { text });
                // Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¾Ñ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ° (ÑƒĞ±Ñ€Ğ°Ğ»Ğ¸ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ)
            } else if (currentChatTab === 'game' && currentGameChatId) {
                if (socket) socket.emit('chat:game', { matchId: currentGameChatId, text });
                // Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¾Ñ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ° (ÑƒĞ±Ñ€Ğ°Ğ»Ğ¸ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ)
            }

            input.value = '';
            sounds.click();
        }

        function addChatMessage(type, author, text, tab, gameId = null, avatarUrl = null) {
            if (!window.chatHistory) window.chatHistory = { global: [] };
            if (!window.chatHistory.games) window.chatHistory.games = {};
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const message = { type, author, text, time, avatarUrl };
            
            if (tab === 'global') {
                window.chatHistory.global.push(message);
            } else if (tab === 'game' && gameId) {
                if (!window.chatHistory.games[gameId]) window.chatHistory.games[gameId] = [];
                window.chatHistory.games[gameId].push(message);
            }
            
            if (currentChatTab === tab && (tab === 'global' || currentGameChatId === gameId)) {
                renderChatMessages();
            }
        }

        function renderChatMessages() {
            const messagesEl = document.getElementById('chatMessages');
            if (!messagesEl) return;
            messagesEl.innerHTML = '';
            
            let history = [];
            if (currentChatTab === 'global') {
                history = window.chatHistory?.global || [];
            } else if (currentChatTab === 'game' && currentGameChatId) {
                history = window.chatHistory?.games?.[currentGameChatId] || [];
            }
            
            if (history.length === 0) {
                messagesEl.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 20px;">No messages yet</div>';
            }
            
            history.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.className = `chat-message ${msg.type}`;
                if (msg.type === 'system') {
                    messageEl.textContent = msg.text;
                } else {
                    // Determine avatar and display name
                    let avatarSrc = msg.avatarUrl || `${API_URL}/avatars/male1.svg`; // default or from message
                    let displayAuthor = msg.author;
                    
                    // If message is from current user, show their display name and avatar
                    const isCurrentUser = msg.author === userId.slice(0,8) || msg.author === currentProfile.displayName;
                    if (isCurrentUser) {
                        displayAuthor = currentProfile.displayName || msg.author;
                        if (currentProfile.avatarUrl) {
                            avatarSrc = currentProfile.avatarUrl;
                        }
                    }
                    
                    // Make author name clickable if not current user
                    const authorClass = isCurrentUser ? 'chat-author' : 'chat-author chat-author-clickable';
                    const authorClick = isCurrentUser ? '' : `onclick="showPublicProfile('${msg.author}', '${displayAuthor}')"`;
                    
                    messageEl.innerHTML = `
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <img src="${avatarSrc}" style="width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0; cursor: ${isCurrentUser ? 'default' : 'pointer'};" ${authorClick}>
                            <div style="flex: 1;">
                                <div class="${authorClass}" ${authorClick}>${displayAuthor} <span class="chat-time">${msg.time}</span></div>
                                <div>${escapeHtml(msg.text)}</div>
                            </div>
                        </div>
                    `;
                }
                messagesEl.appendChild(messageEl);
            });
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal functions
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('show');
            sounds.click();
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('show');
            sounds.click();
        }

        function hideRegisterModal() {
            document.getElementById('registerModal').classList.remove('show');
        }

        function showForgotModal() {
            document.getElementById('forgotModal').classList.add('show');
            sounds.click();
        }

        function hideForgotModal() {
            document.getElementById('forgotModal').classList.remove('show');
        }

        function closeModal(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.classList.remove('show');
            }
        }

        // Global Enter handler for modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                // Check which modal is open
                const loginModal = document.getElementById('loginModal');
                const registerModal = document.getElementById('registerModal');
                const forgotModal = document.getElementById('forgotModal');
                
                if (loginModal && loginModal.classList.contains('show')) {
                    event.preventDefault();
                    doLogin();
                } else if (registerModal && registerModal.classList.contains('show')) {
                    event.preventDefault();
                    doRegister();
                } else if (forgotModal && forgotModal.classList.contains('show')) {
                    event.preventDefault();
                    doForgotPassword();
                }
            }
        });

        // Password toggle function
        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                btn.textContent = 'ğŸ‘ï¸';
            }
        }

        // Enter key handler
        function handleEnter(event, action) {
            if (event.key === 'Enter') {
                event.preventDefault();
                switch(action) {
                    case 'login':
                        doLogin();
                        break;
                    case 'register':
                        doRegister();
                        break;
                    case 'linkEmail':
                        linkEmail();
                        break;
                }
            }
        }

        // Auth API functions
        async function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ email Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ');
                return;
            }

            try {
                const r = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await r.json();

                if (r.ok) {
                    token = data.token;
                    userId = data.userId;
                    // ğŸ›¡ï¸ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑĞµÑÑĞ¸Ñ Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ÑĞ»Ğµ F5
                    localStorage.setItem('token', token);
                    localStorage.setItem('userId', userId);
                    localStorage.setItem('isGuest', 'false');
                    currentProfile = {
                        displayName: data.displayName || data.username || email,
                        gender: data.gender || '',
                        avatarUrl: data.avatarUrl || '',
                        isGuest: false
                    };
                    updateBalanceDisplay(data.balanceWp);
                    hideLoginModal();
                    showUserInfo(data.email || data.username);
                    log(`âœ… Ğ’Ñ…Ğ¾Ğ´ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½: ${data.email || data.username}`);
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    
                    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ñ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€ĞºĞ¾Ğ¹
                    await loadProfile();
                    // updateUserInfoAfterLogin() - ĞĞ• Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼, Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ¿Ğ¾ĞºĞ°Ğ¶ĞµÑ‚ ĞŸĞ ĞĞ¤Ğ˜Ğ›Ğ¬/Ğ’Ğ«Ğ™Ğ¢Ğ˜
                } else {
                    // Ğ•ÑĞ»Ğ¸ email Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½ â€” Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾
                    if (data.message && data.message.includes('Email Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½')) {
                        if (confirm(data.message + '\n\nĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾?')) {
                            await resendVerification(email);
                        }
                    } else {
                        alert(data.message || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°');
                    }
                }
            } catch (e) {
                alert('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸: ' + e.message);
            }
        }

        // ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ
        async function resendVerification(email) {
            try {
                const r = await fetch(`${API_URL}/auth/resend-verification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await r.json();
                alert(data.message || 'ĞŸĞ¸ÑÑŒĞ¼Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾');
            } catch (e) {
                alert('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸: ' + e.message);
            }
        }

        async function doRegister() {
            const email = document.getElementById('registerEmail').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!email || !password) {
                alert('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ email Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ');
                return;
            }
            if (password.length < 6) {
                alert('ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²');
                return;
            }

            try {
                const r = await fetch('/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, username })
                });
                const data = await r.json();

                if (r.ok) {
                    hideRegisterModal();
                    alert('Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ°! ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ email Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ.');
                    log('âœ… Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ: ' + data.message);
                } else {
                    alert(data.message || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸');
                }
            } catch (e) {
                alert('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸: ' + e.message);
            }
        }

        async function doForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();

            if (!email) {
                alert('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ email');
                return;
            }

            try {
                const r = await fetch('/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await r.json();

                hideForgotModal();
                alert(data.message);
                log('ğŸ“§ ' + data.message);
            } catch (e) {
                alert('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸: ' + e.message);
            }
        }

        function showUserInfo(email) {
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            const userEmail = document.getElementById('userEmail');
            if (authButtons) authButtons.style.display = 'none';
            if (userInfo) userInfo.style.display = 'flex';
            if (userEmail) userEmail.textContent = email;
        }

        function logout() {
            token = '';
            userId = '';
            // ğŸ›¡ï¸ ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½ÑƒÑ ÑĞµÑÑĞ¸Ñ
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.removeItem('isGuest');
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            setButtons({ showAuth: true, showUser: false, showConnect: false, connect: false, quickplay: false, balance: false, logs: false });
            log('ğŸ‘‹ Ğ’Ñ‹Ñ…Ğ¾Ğ´ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½');
            sounds.click();
        }

        // Initialize on load
        window.onload = function() {
            // ğŸµ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ°ÑƒĞ´Ğ¸Ğ¾ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ ĞºĞ»Ğ¸ĞºĞµ (Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Chrome)
            const initAudioOnFirstClick = () => {
                hasUserInteracted = true;
                initAudio().then(() => {
                    console.log('[Audio] Initialized on first user interaction');
                });
            };
            document.addEventListener('click', initAudioOnFirstClick, { once: true });
            
            // Load saved language or default to Russian
            const savedLang = localStorage.getItem('preferredLang') || 'ru';
            setLang(savedLang);
            
            // ğŸ”„ Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ dropdown Ğ¿Ñ€Ğ¸ ĞºĞ»Ğ¸ĞºĞµ Ğ²Ğ½Ğµ
            document.addEventListener('click', function(e) {
                const langDropdown = document.querySelector('.lang-dropdown-container');
                const burgerMenu = document.querySelector('.burger-menu-container');
                if (langDropdown && !langDropdown.contains(e.target)) {
                    closeLanguageDropdown();
                }
                if (burgerMenu && !burgerMenu.contains(e.target)) {
                    closeMenu();
                }
            });
            
            // ğŸ›¡ï¸ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞµÑÑĞ¸Ñ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½
            const savedToken = localStorage.getItem('token');
            const savedUserId = localStorage.getItem('userId');
            // Restore displayName from localStorage for F5 recovery
            const savedDisplayName = localStorage.getItem('displayName');
            if (savedDisplayName) {
                currentProfile.displayName = savedDisplayName;
            }
            if (savedToken && savedUserId) {
                token = savedToken;
                userId = savedUserId;
                log(`ğŸ”„ Ğ¡ĞµÑÑĞ¸Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°: ${userId.slice(0,8)}...`);
                
                // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ UI
                const savedUiState = localStorage.getItem('uiState');
                console.log('[window.onload] savedUiState:', savedUiState);
                
                if (savedUiState === 'profile') {
                    console.log('[window.onload] Restoring PROFILE screen');
                    setButtons({ showAuth: false, showUser: true, showConnect: true, connect: true, quickplay: false, balance: false, logs: false });
                    updateUserInfoAfterLogin();
                    // Ğ’ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğµ ĞĞ• Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ WebSocket Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸
                } else {
                    console.log('[window.onload] Restoring GAME screen (default)');
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    checkActiveMatchOrQueue();
                    // ğŸ”„ ĞŸĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ WebSocket Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ¸Ğ³Ñ€Ğµ
                    console.log('[window.onload] Reconnecting WebSocket...');
                    setTimeout(() => doConnect(), 500);
                }
                doCheckBalance(false); // Ğ‘ĞµĞ· Ğ·Ğ²ÑƒĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ ÑĞµÑÑĞ¸Ğ¸
            } else {
                // Initialize button states - show auth buttons, hide others
                setButtons({ showAuth: true, showUser: false, showConnect: false, connect: false, quickplay: false, balance: false, logs: false });
            }
            // Initialize chat history structure
            window.chatHistory = { global: [], games: {} };
            gameChatTimeouts = {};
            // Add welcome message
            addChatMessage('system', 'System', 'Welcome to WagerPlay! Select language above.', 'global');
            // ğŸ”„ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸Ğ³Ñ€Ñ‹
            const savedPlayers = localStorage.getItem('selectedPlayers');
            const savedStake = localStorage.getItem('selectedStake');
            
            if (savedPlayers) {
                selectedPlayers = parseInt(savedPlayers);
                console.log('[window.onload] Restored selectedPlayers:', selectedPlayers);
            }
            if (savedStake) {
                selectedStake = parseInt(savedStake);
                console.log('[window.onload] Restored selectedStake:', selectedStake);
            }
            
            // Initialize button text with saved (or default) values
            const btnText = document.getElementById('playBtnText');
            const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
            if (btnText) {
                btnText.textContent = `Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ ${selectedPlayers} | ${stakeText} VP`;
            }
            // Initialize player badge
            const playerBadge = document.getElementById('playerBadge');
            if (playerBadge) {
                playerBadge.textContent = selectedPlayers;
            }
            // Initialize stake button text
            const stakeBtnText = document.getElementById('stakeBtnText');
            if (stakeBtnText) {
                stakeBtnText.textContent = stakeText;
            }
            // Initialize dropdown selection
            updateDropdownSelection(selectedPlayers);
            // Close all dropdowns
            document.getElementById('playerDropdown').classList.remove('show');
            document.getElementById('stakeDropdown').classList.remove('show');
            document.getElementById('btnPlayArrow').classList.remove('active');
            document.getElementById('btnStakeArrow').classList.remove('active');
        };

        // Audio Context for sounds (Ğ»ĞµĞ½Ğ¸Ğ²Ğ¾Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ)
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        let audioInitialized = false;

        // ğŸµ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ°ÑƒĞ´Ğ¸Ğ¾ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¸
        async function initAudio() {
            if (!hasUserInteracted) return false;  // ğŸµ Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ¾ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ»Ğ¸ĞºĞ°
            if (audioInitialized) return true;
            try {
                if (!audioCtx) {
                    audioCtx = new AudioContext();
                }
                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                }
                audioInitialized = true;
                return true;
            } catch (e) {
                // ĞĞµ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ - Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ·Ğ²ÑƒĞº
                return false;
            }
        }

        // Sound effects
        const sounds = {
            click: () => playTone(800, 0.1, 'square'),
            error: () => playMelody([200, 150], 0.1),
            matchFound: () => {
                // ğŸ® ĞœĞĞ¢Ğ§ ĞĞĞ™Ğ”Ğ•Ğ! - Ñ€Ğ°Ğ´Ğ¾ÑÑ‚Ğ½Ñ‹Ğ¹ Ğ·Ğ²ÑƒĞº
                if (!audioCtx) return;
                const now = audioCtx.currentTime;
                const notes = [
                    { f: 440, d: 0.1, t: 0 },
                    { f: 554, d: 0.1, t: 0.1 },
                    { f: 659, d: 0.3, t: 0.2 },
                ];
                notes.forEach(n => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = n.f;
                    osc.type = 'triangle';
                    gain.gain.setValueAtTime(0.0, now + n.t);
                    gain.gain.linearRampToValueAtTime(0.4, now + n.t + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + n.t + n.d);
                    osc.start(now + n.t);
                    osc.stop(now + n.t + n.d);
                });
            },
            countdown: (num) => {
                // â±ï¸ Ğ—Ğ²ÑƒĞº Ğ¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ğ° (Ğ±Ğ¸Ğ¿ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ñ†Ğ¸Ñ„Ñ€Ñ‹)
                const freq = num <= 3 ? 880 : 660;
                playTone(freq, 0.15, 'square');
            },
            matchStart: () => playMelody([440, 554, 659, 880], 0.1),
            win: () => {
                // ğŸ† ĞŸĞ¾Ğ±ĞµĞ´Ğ½Ğ°Ñ Ğ¼ĞµĞ»Ğ¾Ğ´Ğ¸Ñ (Ñ„Ğ°Ğ½Ñ„Ğ°Ñ€Ñ‹)
                if (!audioCtx) return;
                const now = audioCtx.currentTime;
                const notes = [
                    { f: 523, d: 0.15, t: 0 },
                    { f: 659, d: 0.15, t: 0.15 },
                    { f: 784, d: 0.15, t: 0.30 },
                    { f: 1047, d: 0.50, t: 0.45 },
                    { f: 523, d: 0.10, t: 1.0 },
                    { f: 659, d: 0.10, t: 1.15 },
                    { f: 784, d: 0.10, t: 1.30 },
                    { f: 1047, d: 0.80, t: 1.45 }
                ];
                notes.forEach(n => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = n.f;
                    osc.type = 'triangle';
                    gain.gain.setValueAtTime(0.0, now + n.t);
                    gain.gain.linearRampToValueAtTime(0.4, now + n.t + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + n.t + n.d);
                    osc.start(now + n.t);
                    osc.stop(now + n.t + n.d);
                });
            },
            lose: () => playMelody([400, 350, 300], 0.15),
            tie: () => playTone(440, 0.2, 'sine'),
            move: () => playTone(600, 0.05, 'square'),
            matchStart: () => playMelody([440, 554, 659, 880], 0.1)
        };

        async function playTone(freq, duration, type = 'sine') {
            if (!soundEnabled) return;
            // ğŸµ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ°ÑƒĞ´Ğ¸Ğ¾ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ·Ğ²ÑƒĞºĞµ (Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ»Ğ¸ĞºĞ°)
            const ready = await initAudio();
            if (!ready || !audioCtx) return;
            
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.value = freq;
                osc.type = type;
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + duration);
            } catch (e) {
                // ĞœĞ¾Ğ»Ñ‡Ğ° Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ°ÑƒĞ´Ğ¸Ğ¾
            }
        }

        async function playMelody(frequencies, duration) {
            if (!soundEnabled) return;
            // ğŸµ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ°ÑƒĞ´Ğ¸Ğ¾ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ·Ğ²ÑƒĞºĞµ
            const ready = await initAudio();
            if (!ready || !audioCtx) return;
            
            frequencies.forEach((freq, i) => {
                setTimeout(() => playTone(freq, duration), i * duration * 1000);
            });
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.querySelector('.sound-toggle').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
        }

        // Logging
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logEl.insertBefore(entry, logEl.firstChild);
        }

        // Get server logs from backend
        async function getServerLogs() {
            if (!matchId) {
                log('âŒ No active match');
                return;
            }
            try {
                const r = await fetch(`/matchmaking/match/${matchId}/audit`);
                const logs = await r.json();
                console.log('=== SERVER LOGS ===', logs);
                console.log('Full logs:', JSON.stringify(logs, null, 2));
                log(`ğŸ“‹ Server logs: ${logs.length} entries (see Console)`);
                return logs;
            } catch (e) {
                log(`âŒ Error getting logs: ${e.message}`);
            }
        }

        // View server logs in VS Code Terminal:
        // 1. Open VS Code
        // 2. Look at bottom panel (Terminal tab)
        // 3. All errors and logs are shown there
        // Or press Ctrl+` (backtick) to open terminal

        // Show server logs in chat
        function showLogsInChat() {
            getServerLogs().then(logs => {
                if (logs && logs.length > 0) {
                    addChatMessage('system', 'System', `ğŸ“‹ Match logs: ${logs.length} events`, 'game', matchId);
                    logs.slice(-5).forEach(l => {
                        const msg = `[${l.eventType}] ${l.actorId?.slice(0,8) || 'System'}`;
                        addChatMessage('system', 'Log', msg, 'game', matchId);
                    });
                }
            });
        }

        // Update UI
        function updateBalanceDisplay(balance, frozen = 0) {
            document.getElementById('balanceDisplay').textContent = `${balance} VP`;
            document.getElementById('frozenDisplay').textContent = frozen > 0 ? `Ğ—Ğ°Ğ¼Ğ¾Ñ€Ğ¾Ğ¶ĞµĞ½Ğ¾: ${frozen} VP` : '';
        }

        function setButtons(state) {
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            const btnConnect = document.getElementById('btnConnect');
            const dropdownPlay = document.getElementById('dropdownPlay');
            const dropdownStake = document.getElementById('dropdownStake');
            const btnQuickplay = document.getElementById('btnQuickplay');
            const btnPlayArrow = document.getElementById('btnPlayArrow');
            const btnStake = document.getElementById('btnStake');
            const btnStakeArrow = document.getElementById('btnStakeArrow');
            const btnBalance = document.getElementById('btnBalance');
            const btnStats = document.getElementById('btnStats');
            const btnLogs = document.getElementById('btnLogs');
            const btnAudit = document.getElementById('btnAudit');
            const btnReconcile = document.getElementById('btnReconcile');
            const balanceCard = document.querySelector('.balance-card');
            
            // Phase 1: Auth (Login/Register/Guest visible)
            if (authButtons) authButtons.style.display = state.showAuth ? 'flex' : 'none';
            if (userInfo) userInfo.style.display = state.showUser ? 'flex' : 'none';
            
            // ğŸ® ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğš Ğ˜Ğ“Ğ Ğ•" Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° ÑĞºÑ€Ğ°Ğ½Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
            const btnBackToGame = document.getElementById('btnBackToGame');
            if (btnBackToGame) {
                btnBackToGame.style.display = state.showUser ? 'inline-block' : 'none';
            }
            
            // Phase 2: Connect (after login) - show Connect button, hide game buttons
            if (btnConnect) {
                btnConnect.style.display = state.showConnect ? 'inline-block' : 'none';
                btnConnect.disabled = !state.connect;
            }
            
            // Game controls row - show only after connect
            const gameControlsRow = document.getElementById('gameControlsRow');
            if (gameControlsRow) {
                gameControlsRow.style.display = state.quickplay ? 'flex' : 'none';
                gameControlsRow.style.flexWrap = 'wrap';
            }
            
            // Enable/disable game buttons
            // ğŸ›¡ï¸ Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ÑÑ‚Ğ°Ğ²ĞºĞ¸ Ğ¸ Ğ¸Ğ³Ñ€Ñ‹ ĞµÑĞ»Ğ¸ Ğ¸Ğ´ĞµÑ‚ Ğ¿Ğ¾Ğ¸ÑĞº (isProcessing.quickplay) Ğ˜Ğ›Ğ˜ ÑƒĞ¶Ğµ Ğ² Ğ¼Ğ°Ñ‚Ñ‡Ğµ (activeMatches)
            // ğŸ›¡ï¸ ĞŸĞ ĞĞ’Ğ•Ğ Ğ¯Ğ•Ğœ Ñ‚Ğ°ĞºĞ¶Ğµ localStorage uiState Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ÑĞ»Ğµ F5
            const savedUiState = localStorage.getItem('uiState');
            const isInMatch = activeMatches.size > 0 || savedUiState === 'in-match';
            const isSearching = isProcessing.quickplay || isInMatch || savedUiState === 'searching';
            console.log('[setButtons] isProcessing.quickplay:', isProcessing.quickplay, 'activeMatches:', Array.from(activeMatches), 'isInMatch:', isInMatch, 'isSearching:', isSearching, 'uiState:', savedUiState);
            if (btnQuickplay) btnQuickplay.disabled = !state.quickplay || isSearching;
            if (btnPlayArrow) btnPlayArrow.disabled = !state.quickplay || isSearching;
            if (btnStake) btnStake.disabled = !state.quickplay || isSearching;
            if (btnStakeArrow) btnStakeArrow.disabled = !state.quickplay || isSearching;
            // ğŸ›¡ï¸ Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹
            if (btnQuickplay) btnQuickplay.style.opacity = isSearching ? '0.5' : '1';
            if (btnStake) btnStake.style.opacity = isSearching ? '0.5' : '1';
            if (btnBalance) {
                btnBalance.style.display = state.quickplay ? 'inline-block' : 'none';
                btnBalance.disabled = !state.balance;
            }
            if (btnStats) {
                btnStats.style.display = state.quickplay ? 'inline-block' : 'none';
                btnStats.disabled = !state.balance;
            }
            const btnGoToProfile = document.getElementById('btnGoToProfile');
            if (btnGoToProfile) {
                btnGoToProfile.style.display = state.quickplay ? 'inline-block' : 'none';
                // ğŸ›¡ï¸ Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "Ğ’ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ" ĞµÑĞ»Ğ¸ Ğ¸Ğ´Ñ‘Ñ‚ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¸Ğ»Ğ¸ Ğ¼Ğ°Ñ‚Ñ‡
                btnGoToProfile.disabled = !state.quickplay || isSearching || isInMatch;
                btnGoToProfile.style.opacity = (isSearching || isInMatch) ? '0.5' : '1';
            }
            if (btnLogs) {
                btnLogs.style.display = state.quickplay ? 'inline-block' : 'none';
                btnLogs.disabled = !state.logs;
            }
            if (btnAudit) {
                btnAudit.style.display = state.quickplay ? 'inline-block' : 'none';
                btnAudit.disabled = !state.balance;
            }
            if (btnReconcile) {
                btnReconcile.style.display = state.quickplay ? 'inline-block' : 'none';
                btnReconcile.disabled = !state.balance;
            }
            
            // Show balance card only after login
            if (balanceCard) balanceCard.style.display = (state.showUser || state.showConnect || state.quickplay) ? 'block' : 'none';
        }
        
        function updateWaitingText() {
            const waitingText = document.getElementById('waitingText');
            if (!waitingText) return;
            
            if (!token) {
                waitingText.textContent = t('waitingGuest');
            } else if (!socket) {
                waitingText.textContent = t('connect') + ' â†’';
            } else {
                waitingText.textContent = t('waitingQueue');
            }
        }

        // Guest Login
        async function doGuest() {
            if (isProcessing.guest) {
                sounds.error();
                return;
            }
            isProcessing.guest = true;
            sounds.click();
            
            try {
                const r = await fetch(`${API_URL}/auth/guest`, { method: "POST" });
                const j = await r.json();
                token = j.token;
                userId = j.userId;
                // ğŸ›¡ï¸ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑĞµÑÑĞ¸Ñ Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ÑĞ»Ğµ F5
                localStorage.setItem('token', token);
                localStorage.setItem('userId', userId);
                localStorage.setItem('isGuest', 'true');
                currentProfile = {
                    displayName: j.displayName || `Guest${userId.slice(0,6)}`,
                    gender: '',
                    avatarUrl: '',
                    isGuest: true
                };
                updateBalanceDisplay(j.balanceWp);
                log(`âœ… Guest login: ${userId.slice(0,8)}...`);
                setButtons({ showAuth: false, showUser: true, showConnect: true, connect: true, quickplay: false, balance: true, logs: false });
                updateUserInfoAfterLogin();
                updateWaitingText();
                doCheckBalance();
            } catch (e) {
                log(`âŒ Guest error: ${e.message}`);
            } finally {
                isProcessing.guest = false;
            }
        }

        // Check Balance
        async function doCheckBalance(playSound = true) {
            if (playSound) sounds.click();
            if (!token) {
                log('âŒ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Guest');
                return;
            }
            try {
                const r = await fetch("/wallet", {
                    headers: { "Authorization": "Bearer " + token }
                });
                const j = await r.json();
                if (j.balanceWp !== undefined) {
                    updateBalanceDisplay(j.balanceWp, j.frozenWp);
                    log(`ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: ${j.balanceWp} VP`);
                }
            } catch (e) {
                log(`âŒ Balance error: ${e.message}`);
            }
        }

        // ğŸ“Š ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
        async function doShowStats() {
            sounds.click();
            if (!token) {
                log('âŒ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Guest');
                return;
            }
            try {
                console.log('[doShowStats] Fetching stats...');
                const r = await fetch("/auth/stats", {
                    headers: { "Authorization": "Bearer " + token }
                });
                console.log('[doShowStats] Response status:', r.status);
                const s = await r.json();
                console.log('[doShowStats] Stats data:', s);
                
                log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
                log('â•‘       ğŸ“Š Ğ’ĞĞ¨Ğ Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ       â•‘');
                log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
                log(`â•‘ ğŸ® ĞœĞ°Ñ‚Ñ‡ĞµĞ¹: ${s.totalMatches.toString().padStart(3)}              â•‘`);
                log(`â•‘ âœ… ĞŸĞ¾Ğ±ĞµĞ´: ${s.wins.toString().padStart(3)}  âŒ ĞŸĞ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹: ${s.losses.toString().padStart(3)}  â•‘`);
                log(`â•‘ ğŸ“ˆ Ğ’Ğ¸Ğ½Ñ€ĞµĞ¹Ñ‚: ${s.winRate.toString().padStart(3)}%              â•‘`);
                log(`â•‘ ğŸ”¥ Ğ¡ĞµÑ€Ğ¸Ñ: ${s.winStreak} (ĞœĞ°ĞºÑ: ${s.maxWinStreak})         â•‘`);
                log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
                log(`â•‘ ğŸ’° Ğ’ÑĞµĞ³Ğ¾ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ğ°Ğ½Ğ¾: ${s.totalWonVp.toString().padStart(6)} VP   â•‘`);
                log(`â•‘ ğŸ’¸ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸Ğ³Ñ€Ğ°Ğ½Ğ¾: ${s.totalLostVp.toString().padStart(5)} VP   â•‘`);
                log(`â•‘ ğŸ¯ ĞœĞ°ĞºÑ. Ğ²Ñ‹Ğ¸Ğ³Ñ€Ñ‹Ñˆ: ${s.biggestWinVp.toString().padStart(6)} VP   â•‘`);
                log(`â•‘ ğŸ² ĞœĞ°ĞºÑ. ÑÑ‚Ğ°Ğ²ĞºĞ°: ${s.biggestStakeVp.toString().padStart(6)} VP   â•‘`);
                log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            } catch (e) {
                console.error('[doShowStats] Error:', e);
                log(`âŒ Stats error: ${e.message}`);
            }
        }

        // Connect WebSocket
        function doConnect() {
            if (isProcessing.connect) {
                sounds.error();
                return;
            }
            isProcessing.connect = true;
            // sounds.click() ÑƒĞ±Ñ€Ğ°Ğ½ - doConnect Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¸ F5
            
            if (!token) {
                log('âŒ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ Guest token');
                isProcessing.connect = false;
                return;
            }

            socket = io(window.location.origin, { 
                auth: { 
                    token,
                    displayName: currentProfile.displayName || ''
                } 
            });

            socket.on("connected", (m) => {
                isProcessing.connect = false;
                log(`ğŸ”— WebSocket Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½: ${m.userId.slice(0,8)}...`);
                
                // ğŸ”„ ĞŸĞ¾ÑĞ»Ğµ F5 Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¸Ğ³Ñ€Ñ‹/Ğ¿Ğ¾Ğ¸ÑĞºĞ° ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
                const savedUiState = localStorage.getItem('uiState');
                if (savedUiState === 'in-match' && matchId) {
                    // ĞŸĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ Ğº Ğ¼Ğ°Ñ‚Ñ‡Ñƒ
                    socket.emit('match:join', { matchId });
                    socket.emit('match:get', { matchId });
                    log('ğŸ”„ ĞŸĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ¼Ğ°Ñ‚Ñ‡Ñƒ Ğ¿Ğ¾ÑĞ»Ğµ F5');
                } else if (savedUiState === 'searching') {
                    // Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
                    log('ğŸ”„ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ¸ÑĞºĞ° ÑĞ¾Ğ¿ĞµÑ€Ğ½Ğ¸ĞºĞ¾Ğ²...');
                } else if (activeMatches.size === 0 && !isProcessing.quickplay) {
                    // âœ… Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ uiState Ğ² 'game' ĞºĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ğ»Ğ¸ÑÑŒ Ğ¸ Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¸Ğ³Ñ€Ñ‹
                    console.log('[socket.on connected] Setting uiState to game');
                    localStorage.setItem('uiState', 'game');
                }
                
                // ğŸ›¡ï¸ ĞĞµ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ĞµÑĞ»Ğ¸ Ğ¸Ğ³Ñ€Ğ¾Ğº ÑƒĞ¶Ğµ Ğ² Ğ¼Ğ°Ñ‚Ñ‡Ğµ
                if (activeMatches.size === 0 && savedUiState !== 'in-match' && savedUiState !== 'searching') {
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                }
                // sounds.matchStart() ÑƒĞ±Ñ€Ğ°Ğ½ - Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¸ F5
            });

            socket.on("matches:cleanup", (data) => {
                log(`ğŸ’° Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¾ ${data.returnedVp} VP Ğ¸Ğ· Ğ·Ğ°Ğ²Ğ¸ÑÑˆĞ¸Ñ… Ğ¼Ğ°Ñ‚Ñ‡ĞµĞ¹`);
                if (data.returnedVp > 0) {
                    alert(`âœ… Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¾ ${data.returnedVp} VP Ğ¸Ğ· Ğ·Ğ°Ğ²Ğ¸ÑÑˆĞ¸Ñ… Ğ¼Ğ°Ñ‚Ñ‡ĞµĞ¹`);
                    loadBalance(); // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
                }
            });

            socket.on("quickplay:result", (m) => {
                log(`ğŸ® Quickplay: ${m.status}`);
                if (m.status === 'ALREADY_IN_QUEUE') {
                    log('âš ï¸ Already in queue!');
                    isProcessing.quickplay = false;
                    localStorage.removeItem('searchStartTime');
                    localStorage.setItem('uiState', 'game');
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    showWaiting(t('waitingQueue'), true, 5);
                    return;
                }
                if (m.ticketId) {
                    showWaiting(t('waitingQueue'), true, 20);  // 20 ÑĞµĞºÑƒĞ½Ğ´ Ğ½Ğ° Ğ¿Ğ¾Ğ¸ÑĞº
                    // Keep button disabled while in queue
                    const qpBtn2 = document.getElementById('btnQuickplay');
                    const pbt2 = document.getElementById('playBtnText');
                    if (qpBtn2) qpBtn2.disabled = true;
                    if (pbt2) pbt2.textContent = 'â³ ' + (t('searching') || 'Searching...');
                }
                if (m.matchId) {
                    matchId = m.matchId;
                    isProcessing.quickplay = false;
                    // ĞœĞ°Ñ‚Ñ‡ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ - uiState ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑÑ Ğ² 'in-match' Ğ² match:start
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    // Reset button text
                    const pbt5 = document.getElementById('playBtnText');
                    const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
                    if (pbt5) pbt5.textContent = `Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ ${selectedPlayers} | ${stakeText} VP`;
                }
            });

            socket.on("queue:waiting", (m) => {
                log(`â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ: ${m.seconds} ÑĞµĞº`);
                showWaiting(`Ğ˜Ñ‰ĞµĞ¼ ÑĞ¾Ğ¿ĞµÑ€Ğ½Ğ¸ĞºĞ¾Ğ² (${m.playersFound || 1}/${selectedPlayers})...`, true, m.seconds);
            });

            // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ° Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ (ĞºĞ¾Ğ³Ğ´Ğ° Ğ¿Ñ€Ğ¸ÑĞ¾ĞµĞ´Ğ¸Ğ½ÑĞµÑ‚ÑÑ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ³Ñ€Ğ¾Ğº Ğ¸Ğ»Ğ¸ F5 Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ)
            socket.on("queue:sync", (m) => {
                console.log('[queue:sync]', m);
                
                // ğŸ”„ F5 Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ¸ÑĞºĞ°
                if (m.reconnected) {
                    console.log('[queue:sync] Reconnected while in queue, restoring state');
                    isProcessing.quickplay = true;
                    localStorage.setItem('uiState', 'searching');
                    setButtons({ showAuth: false, showUser: false, showConnect: false, quickplay: true, cancel: true });
                }
                
                log(`ğŸ”„ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: ${m.playersFound}/${m.totalNeeded} Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ², Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ ${m.secondsLeft}ÑĞµĞº`);
                // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ UI Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½ĞµĞ¼
                showWaiting(`Ğ˜Ñ‰ĞµĞ¼ ÑĞ¾Ğ¿ĞµÑ€Ğ½Ğ¸ĞºĞ¾Ğ² (${m.playersFound}/${m.totalNeeded})...`, true, m.secondsLeft);
            });

            socket.on("fallback:result", (m) => {
                stopCountdown();
                log(`ğŸ¤– Fallback: ${m.status}`);
                isProcessing.quickplay = false;
                localStorage.removeItem('searchStartTime');
                localStorage.setItem('uiState', 'game');
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                const pbt6 = document.getElementById('playBtnText');
                if (pbt6) pbt6.textContent = t('quickplay');
                if (m.matchId) {
                    matchId = m.matchId;
                    sounds.matchStart();
                }
            });

            socket.on("match:round", (data) => {
                // Ğ—Ğ²ÑƒĞºĞ¾Ğ²Ğ¾Ğ¹ ÑÑ„Ñ„ĞµĞºÑ‚ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ€Ğ°ÑƒĞ½Ğ´Ğ°
                sounds.click();
                log(`ğŸ® Ğ Ğ°ÑƒĞ½Ğ´ ${data.round}, Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²: ${data.aliveCount}`);
            });

            // â±ï¸ Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€ Ñ…Ğ¾Ğ´Ğ° (12 ÑĞµĞºÑƒĞ½Ğ´)
            socket.on("match:timer", (data) => {
                console.log('[CLIENT match:timer]', data);
                if (data.type === 'move' && data.deadline) {
                    // ğŸ›¡ï¸ Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ²ÑˆĞ¸Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹: ĞµÑĞ»Ğ¸ Ñ€Ğ°ÑƒĞ½Ğ´ Ğ² ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¸ Ğ¼ĞµĞ½ÑŒÑˆĞµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾, Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼
                    if (data.round && currentMatch && data.round < currentMatch.round) {
                        console.log('[CLIENT match:timer] Skipping old timer for round', data.round, '(current:', currentMatch.round, ')');
                        return;
                    }
                    
                    // ğŸ›¡ï¸ Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ: ĞµÑĞ»Ğ¸ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€ ÑƒĞ¶Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¶Ğµ Ñ€Ğ°ÑƒĞ½Ğ´Ğ°
                    if (data.round && currentTimerRound === data.round && moveCountdownInterval) {
                        console.log('[CLIENT match:timer] Timer already running for round', data.round);
                        return;
                    }
                    
                    // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ secondsLeft Ğ½Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğµ Ğ¿Ğ¾ deadline (Ğ±Ğ¾Ğ»ĞµĞµ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾)
                    const now = Date.now();
                    const secondsLeft = Math.max(0, Math.ceil((data.deadline - now) / 1000));
                    console.log('[CLIENT match:timer] Calculated secondsLeft:', secondsLeft, 'round from server:', data.round);
                    
                    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ€Ğ°ÑƒĞ½Ğ´ Ğ¸Ğ· ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ (Ñ‚ĞµĞ¿ĞµÑ€ÑŒ ÑĞµÑ€Ğ²ĞµÑ€ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ round)
                    const targetRound = data.round || currentMatch?.round;
                    
                    startMoveCountdown(secondsLeft, targetRound, data.deadline);
                }
            });

            // ğŸ® ĞœĞĞ¢Ğ§ Ğ“ĞĞ¢ĞĞ’! - Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ¼Ğ°Ñ‚Ñ‡ ÑÑ€Ğ°Ğ·Ñƒ
            socket.on("match:ready", (data) => {
                log(`ğŸ® Match ready: ${data.matchId.slice(0,8)}...`);
                activeMatches.add(data.matchId);  // ğŸ›¡ï¸ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¼Ğ°Ñ‚Ñ‡ Ğ² Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ
                console.log('[match:ready] Added to activeMatches:', data.matchId, 'Size:', activeMatches.size);
                isProcessing.quickplay = false;
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                stopCountdown();
                
                // ĞŸÑ€Ğ¸ÑĞ¾ĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ÑÑ Ğº ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ğµ Ğ¼Ğ°Ñ‚Ñ‡Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ° Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹
                socket.emit("match:join", { matchId: data.matchId });
                
                // âŒ ĞĞ• Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ match:get Ğ·Ğ´ĞµÑÑŒ - Ğ¶Ğ´Ñ‘Ğ¼ match:start Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ğ°!
                // Ğ˜Ğ³Ñ€Ğ° Ğ¾Ñ‚ĞºÑ€Ğ¾ĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»Ğµ match:start
            });

            // ğŸ® ĞœĞĞ¢Ğ§ ĞĞĞ™Ğ”Ğ•Ğ! - Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞºÑ€Ğ°Ğ½ Ñ Ğ¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ¼
            socket.on("match:found", (data) => {
                // ğŸ§¹ ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ¾Ñ‚ÑÑ‡Ñ‘Ñ‚ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
                if (matchCountdownInterval) {
                    clearInterval(matchCountdownInterval);
                    matchCountdownInterval = null;
                }
                
                sounds.matchFound();
                log('ğŸ® ĞœĞĞ¢Ğ§ ĞĞĞ™Ğ”Ğ•Ğ!');
                
                // ğŸ›¡ï¸ Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ½Ğ¾Ğ¼ Ğ¼Ğ°Ñ‚Ñ‡Ğµ (Ğ´Ğ¾ match:start)
                activeMatches.add(data.matchId);
                console.log('[match:found] Added to activeMatches:', data.matchId, 'Size:', activeMatches.size);
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                
                // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞºÑ€Ğ°Ğ½ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ Ñ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ¼ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ¾Ğ¼
                document.getElementById('gameContent').innerHTML = `
                    <div class="waiting">
                        <div style="font-size: 2em; color: #ffd700; margin-bottom: 20px;">ğŸ® ĞœĞĞ¢Ğ§ ĞĞĞ™Ğ”Ğ•Ğ!</div>
                        <div style="font-size: 4em; font-weight: bold; color: #00ff88;" id="matchCountdown">5</div>
                        <div style="margin-top: 20px;">ĞŸÑ€Ğ¸Ğ³Ğ¾Ñ‚Ğ¾Ğ²ÑŒÑ‚ĞµÑÑŒ Ğº Ğ¸Ğ³Ñ€Ğµ...</div>
                    </div>
                `;
                
                // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¾Ñ‚ÑÑ‡Ñ‘Ñ‚
                let count = 5;
                matchCountdownInterval = setInterval(() => {
                    count--;
                    const el = document.getElementById('matchCountdown');
                    if (el) {
                        el.textContent = count;
                        sounds.countdown(count);
                    }
                    if (count <= 0) {
                        clearInterval(matchCountdownInterval);
                        matchCountdownInterval = null;
                    }
                }, 1000);
            });

            // â±ï¸ ĞÑ‚ÑÑ‡Ñ‘Ñ‚ Ğ¾Ñ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ° (Ñ€ĞµĞ·ĞµÑ€Ğ²)
            socket.on("match:countdown", (data) => {
                const el = document.getElementById('matchCountdown');
                if (el) {
                    el.textContent = data.seconds;
                }
                // ğŸ”Š Ğ—Ğ²ÑƒĞº Ğ¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ğ° (Ñ‡ĞµĞ¼ Ğ¼ĞµĞ½ÑŒÑˆĞµ Ñ‡Ğ¸ÑĞ»Ğ¾, Ñ‚ĞµĞ¼ Ğ²Ñ‹ÑˆĞµ Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ğ°)
                if (sounds.countdown) {
                    sounds.countdown(data.seconds);
                }
            });

            // ğŸš€ ĞœĞ°Ñ‚Ñ‡ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ
            socket.on("match:start", (m) => {
                console.log('[CLIENT match:start]', {matchId: m.matchId, round: m.round, deadline: m.moveDeadline});
                if (matchCountdownInterval) {
                    clearInterval(matchCountdownInterval);
                }
                sounds.matchStart();
                log('ğŸš€ Ğ˜Ğ³Ñ€Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°ÑÑŒ! (match:start)');
                
                // ğŸ›¡ï¸ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¼Ğ°Ñ‚Ñ‡ Ğ² Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ (ĞµÑĞ»Ğ¸ ĞµÑ‰Ğµ Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² match:ready)
                activeMatches.add(m.matchId);
                console.log('[match:start] Added to activeMatches:', m.matchId, 'Size:', activeMatches.size);
                
                // ğŸ›¡ï¸ Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ Ğ¼Ğ°Ñ‚Ñ‡Ğ°
                localStorage.setItem('uiState', 'in-match');
                localStorage.removeItem('searchStartTime'); // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ°
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                
                // ğŸ§¹ Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ´ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ñ€Ğ°ÑƒĞ½Ğ´Ğ¾Ğ² Ğ¸ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¼Ğ°Ñ‚Ñ‡Ğ°
                shownRounds.clear();
                shownMoveWarningForRound = null;  // ğŸ›¡ï¸ Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³è­¦å‘Š
                currentTimerRound = null;
                currentTimerDeadline = null;
                resetAutoMoveFlag();  // ğŸ›¡ï¸ Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ°Ğ²Ñ‚Ğ¾Ñ…Ğ¾Ğ´Ğ°
                console.log('[match:start] Cleared shownRounds, timers, and autoMove flag');
                
                // Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼ Ğ¼Ğ°Ñ‚Ñ‡ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€
                currentMatch = m;
                matchId = m.matchId;
                // ğŸ‘¤ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ğ¼ĞµĞ½Ğ° Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ¸Ğ· Ğ¼Ğ°Ñ‚Ñ‡Ğ°
                if (m.playerNames) {
                    Object.assign(playerNames, m.playerNames);
                }
                renderMatch(m);
                showChat();
                createGameChat(m.matchId);
                
                // â±ï¸ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ deadline
                if (m.moveDeadline) {
                    const now = Date.now();
                    const deadline = m.moveDeadline;
                    const secondsLeft = Math.max(0, Math.ceil((deadline - now) / 1000));
                    console.log('[match:start] Starting timer with secondsLeft:', secondsLeft, 'for round', m.round);
                    if (secondsLeft > 0) {
                        startMoveCountdown(secondsLeft, m.round, deadline);
                    }
                }
            });

            // ğŸ”„ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ°Ñ‚Ñ‡Ğ° Ğ¿Ğ¾ÑĞ»Ğµ F5
            socket.on("match:get", (m) => {
                console.log('[CLIENT match:get]', {matchId: m.matchId, round: m.round, status: m.status});
                if (!m || m.status === 'FINISHED' || m.status === 'CANCELLED') {
                    log('âŒ ĞœĞ°Ñ‚Ñ‡ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½');
                    localStorage.setItem('uiState', 'game');
                    isProcessing.quickplay = false;
                    activeMatches.delete(m?.matchId);
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    return;
                }
                
                log('ğŸ”„ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¼Ğ°Ñ‚Ñ‡Ğ°');
                currentMatch = m;
                matchId = m.matchId;
                activeMatches.add(m.matchId);
                localStorage.setItem('uiState', 'in-match');
                
                // ğŸ›¡ï¸ Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                
                // Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼ Ğ¼Ğ°Ñ‚Ñ‡
                if (m.playerNames) {
                    Object.assign(playerNames, m.playerNames);
                }
                renderMatch(m);
                showChat();
                
                // â±ï¸ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ deadline
                if (m.moveDeadline) {
                    const now = Date.now();
                    const deadline = m.moveDeadline;
                    const secondsLeft = Math.max(0, Math.ceil((deadline - now) / 1000));
                    console.log('[match:get] Starting timer with secondsLeft:', secondsLeft, 'for round', m.round);
                    if (secondsLeft > 0) {
                        startMoveCountdown(secondsLeft, m.round, deadline);
                    }
                }
            });

            socket.on("match:update", (m) => {
                console.log('[CLIENT match:update]', {matchId: m.matchId, round: m.round, status: m.status, deadline: m.moveDeadline});
                stopCountdown();
                // ğŸ›¡ï¸ ĞĞ• Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ moveCountdown Ğ·Ğ´ĞµÑÑŒ - Ğ¿ÑƒÑÑ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ´ĞµÑ‚ match:timer Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼ Ñ€Ğ°ÑƒĞ½Ğ´Ğ¾Ğ¼
                // stopMoveCountdown();  // <-- Ğ£Ğ‘Ğ ĞĞĞ
                
                // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ñ…Ğ¾Ğ´Ğ°
                isProcessing.move = false;
                
                // â±ï¸ ĞĞ• Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€ Ğ·Ğ´ĞµÑÑŒ - Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡ĞµÑ€ĞµĞ· match:start Ğ¸Ğ»Ğ¸ match:timer
                
                // If this is a new match (different from current game chat), create new chat
                if (m.matchId && m.matchId !== currentGameChatId) {
                    matchId = m.matchId;
                    showChat();
                    createGameChat(m.matchId);
                }
                
                currentMatch = m;
                // ğŸ‘¤ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ğ¼ĞµĞ½Ğ° Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ¸Ğ· Ğ¼Ğ°Ñ‚Ñ‡Ğ°
                if (m.playerNames) {
                    Object.assign(playerNames, m.playerNames);
                }
                renderMatch(m);
                
                // â±ï¸ Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡ĞµÑ€ĞµĞ· match:timer Ğ¸Ğ»Ğ¸ match:start
                // ĞĞµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¸ match:update Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ²
                
                // ğŸ® Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹ Ñ€Ğ°ÑƒĞ½Ğ´Ğ°
                if (m.lastRound) {
                    const lr = m.lastRound;
                    const roundKey = `${m.matchId}:${lr.roundNo}`;
                    
                    // ğŸ›¡ï¸ Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ: Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞµÑĞ»Ğ¸ ÑƒĞ¶Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ»Ğ¸ ÑÑ‚Ğ¾Ñ‚ Ñ€Ğ°ÑƒĞ½Ğ´
                    if (shownRounds.has(roundKey)) {
                        console.log(`[match:update] Skipping duplicate round ${lr.roundNo}`);
                    } else {
                        shownRounds.add(roundKey);
                        console.log(`[match:update] Showing round ${lr.roundNo} for first time`);
                        
                        const moveEmoji = { 'ROCK': 'âœŠ', 'PAPER': 'âœ‹', 'SCISSORS': 'âœŒï¸' };
                        
                        // Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ñ€Ğ°ÑƒĞ½Ğ´Ğ°
                        log(`ğŸ“¢ Ğ ĞĞ£ĞĞ” ${lr.roundNo}`);
                    
                    // Ğ¥Ğ¾Ğ´Ñ‹ Ğ²ÑĞµÑ… Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²
                    if (lr.moves) {
                        Object.entries(lr.moves).forEach(([pid, move]) => {
                            const isBot = pid.startsWith('BOT');
                            const botName = isBot ? (m.botNames?.[pid] || pid) : null;
                            const name = isBot ? botName : (pid === userId ? 'Ğ’Ñ‹' : pid.slice(0, 8));
                            const emoji = moveEmoji[move] || move;
                            log(`  ${name}: ${emoji} ${move}`);
                        });
                    }
                    
                    // Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ñ€Ğ°ÑƒĞ½Ğ´Ğ°
                    if (lr.outcome === 'TIE') {
                        log(`ğŸ¤ ĞĞ¸Ñ‡ÑŒÑ! (${lr.reason === 'ALL_SAME' ? 'Ğ²ÑĞµ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ğ¾' : 'Ğ²ÑĞµ Ñ‚Ñ€Ğ¸ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ°'})`);
                    } else if (lr.outcome === 'ELIMINATION') {
                        const losers = lr.losers || [];
                        const winningMove = lr.winningMove || '';
                        const winEmoji = moveEmoji[winningMove] || '';
                        log(`âš”ï¸ ĞŸĞ¾Ğ±ĞµĞ¶Ğ´Ğ°ĞµÑ‚: ${winEmoji} ${winningMove}`);
                        
                        losers.forEach(pid => {
                            const isBot = pid.startsWith('BOT');
                            const botName = isBot ? (m.botNames?.[pid] || pid) : null;
                            const name = isBot ? botName : (pid === userId ? 'Ğ’Ñ‹' : pid.slice(0, 8));
                            const skull = isBot ? 'ğŸ¤–' : (pid === userId ? 'ğŸ’€' : 'ğŸ‘¤');
                            log(`  ${skull} ${name} Ğ’Ğ«Ğ‘Ğ«Ğ’ĞĞ•Ğ¢!`);
                        });
                    }
                    
                        log(`ğŸ‘¥ ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²: ${m.aliveIds?.length || 0}`);
                    } // end of else (new round)
                } // end of if (m.lastRound)
                
                // Reset move processing flag when match updates
                isProcessing.move = false;
                
                // Enable logs button when we have a match
                if (m.matchId) {
                    const logsBtn = document.getElementById('btnLogs');
                    if (logsBtn) logsBtn.disabled = false;
                }
                
                // If match is finished, schedule chat close and reset quickplay button
                if (m.status === 'FINISHED') {
                    isProcessing.quickplay = false;
                    activeMatches.delete(m.matchId);  // ğŸ›¡ï¸ Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¼Ğ°Ñ‚Ñ‡ Ğ¸Ğ· Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…
                    localStorage.setItem('uiState', 'game');  // ğŸ›¡ï¸ Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ UI
                    console.log('[match:update FINISHED] Removed from activeMatches:', m.matchId, 'Size:', activeMatches.size);
                    setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                    const qpBtn3 = document.getElementById('btnQuickplay');
                    const pbt3 = document.getElementById('playBtnText');
                    if (pbt3) pbt3.textContent = t('playAgain');
                    
                    // Schedule this specific game chat to close after 2 minutes
                    if (m.matchId && !gameChatTimeouts[m.matchId]) {
                        addChatMessage('system', 'System', t('chatWillClose'), 'game', m.matchId);
                        gameChatTimeouts[m.matchId] = setTimeout(() => {
                            closeGameChat(m.matchId);
                            delete gameChatTimeouts[m.matchId];
                        }, 120000); // 2 minutes
                    }
                }
            });

            socket.on("chat:message", (data) => {
                addChatMessage('user', data.author?.slice(0,8) || 'Unknown', data.text, data.channel || 'global');
            });

            socket.on("chat:global", (data) => {
                const displayName = data.displayName || data.author?.slice(0,8) || 'Unknown';
                // ğŸ‘¤ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°
                if (data.author && data.displayName) {
                    playerNames[data.author] = data.displayName;
                }
                addChatMessage('user', displayName, data.text, 'global', null, data.avatarUrl);
            });

            socket.on("chat:game", (data) => {
                // Add to specific game chat if matchId provided
                const targetGameId = data.matchId || currentGameChatId;
                if (targetGameId) {
                    const displayName = data.displayName || data.author?.slice(0,8) || 'Unknown';
                    // ğŸ‘¤ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°
                    if (data.author && data.displayName) {
                        playerNames[data.author] = data.displayName;
                    }
                    addChatMessage('user', displayName, data.text, 'game', targetGameId, data.avatarUrl);
                }
            });

            socket.on("error", (m) => {
                isProcessing.move = false;
                isProcessing.quickplay = false;
                localStorage.setItem('uiState', 'game');
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                const qpBtn4 = document.getElementById('btnQuickplay');
                const pbt4 = document.getElementById('playBtnText');
                const stakeText = selectedStake >= 1000 ? (selectedStake/1000) + 'K' : selectedStake;
                if (pbt4) pbt4.textContent = `Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ ${selectedPlayers} | ${stakeText} VP`;
                log(`âŒ Error: ${m.message}`);
            });
        }

        // Quickplay
        function resetAndPlayAgain() {
            // Clear match state
            currentMatch = null;
            matchId = null;
            currentGameChatId = null;
            stopMoveCountdown();
            stopCountdown();
            
            // Start new game
            doQuickplay();
        }

        function doQuickplay() {
            if (isProcessing.quickplay) {
                sounds.error();
                return;
            }
            isProcessing.quickplay = true;
            localStorage.setItem('uiState', 'searching');
            localStorage.setItem('searchStartTime', Date.now().toString());
            sounds.click();
            
            // ğŸ›¡ï¸ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ UI Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
            setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
            
            if (!socket) {
                log('âŒ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ĞµÑÑŒ');
                isProcessing.quickplay = false;
                localStorage.setItem('uiState', 'game');
                setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                return;
            }
            socket.emit("quickplay", { playersCount: selectedPlayers, stakeVp: selectedStake });
            log(`ğŸ® Quickplay: ${selectedPlayers} players, ${selectedStake} VP`);
            // Show game chat - will be initialized when match arrives
        }

        // Make Move
        function makeMove(move) {
            // âŒ ĞĞµ Ğ´Ğ°Ñ‘Ğ¼ Ğ²Ñ‹Ğ±Ğ¸Ñ‚Ñ‹Ğ¼ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°Ğ¼ Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ
            if (currentMatch && !currentMatch.aliveIds?.includes(userId)) {
                log('âŒ Ğ’Ñ‹ Ğ²Ñ‹Ğ±Ñ‹Ğ»Ğ¸ Ğ¸Ğ· Ğ¼Ğ°Ñ‚Ñ‡Ğ°');
                return;
            }
            
            if (isProcessing.move) {
                sounds.error();
                return;
            }
            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ ÑĞ´ĞµĞ»Ğ°Ğ»Ğ¸ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ñ…Ğ¾Ğ´ Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ€Ğ°ÑƒĞ½Ğ´Ğµ (ğŸ›¡ï¸ debounce - Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼è­¦å‘Š Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· Ğ·Ğ° Ñ€Ğ°ÑƒĞ½Ğ´)
            if (currentMatch && currentMatch.moves && currentMatch.moves[userId]) {
                const roundKey = `${currentMatch.matchId}:${currentMatch.round}`;
                if (!shownMoveWarningForRound || shownMoveWarningForRound !== roundKey) {
                    shownMoveWarningForRound = roundKey;
                    log('âš ï¸ Ğ’Ñ‹ ÑƒĞ¶Ğµ ÑĞ´ĞµĞ»Ğ°Ğ»Ğ¸ Ñ…Ğ¾Ğ´ Ğ² ÑÑ‚Ğ¾Ğ¼ Ñ€Ğ°ÑƒĞ½Ğ´Ğµ');
                }
                return;
            }
            // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³è­¦å‘Š Ğ¿Ñ€Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ñ€Ğ°ÑƒĞ½Ğ´Ğµ
            if (currentMatch) {
                const roundKey = `${currentMatch.matchId}:${currentMatch.round}`;
                if (shownMoveWarningForRound && shownMoveWarningForRound !== roundKey) {
                    shownMoveWarningForRound = null;
                }
            }
            
            // ğŸ›¡ï¸ ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€ Ğ¢ĞĞ›Ğ¬ĞšĞ ĞµÑĞ»Ğ¸ Ñ…Ğ¾Ğ´ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½
            stopMoveCountdown();
            
            isProcessing.move = true;
            sounds.move();
            
            if (!socket || !matchId) {
                log('âŒ ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¼Ğ°Ñ‚Ñ‡Ğ° (socket: ' + !!socket + ', matchId: ' + matchId + ')');
                isProcessing.move = false;
                return;
            }
            
            console.log('[makeMove] Sending move:', { matchId, move, userId });
            
            // Disable all move buttons
            document.querySelectorAll('.move-btn').forEach(btn => {
                if (btn) btn.disabled = true;
            });
            
            socket.emit("move", { matchId, move });
            log(`ğŸ‘Š Ğ¥Ğ¾Ğ´: ${move}`);
            
            // Visual feedback
            document.querySelectorAll('.move-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.move === move) {
                    btn.classList.add('selected');
                }
            });
            
            // Auto-reset after 5 seconds if server doesn't respond
            setTimeout(() => {
                if (isProcessing.move) {
                    isProcessing.move = false;
                    log('âš ï¸ Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°');
                    // Buttons will be re-enabled by renderMatch on next update
                }
            }, 5000);
        }

        // Countdown Timer
        function startCountdown(seconds) {
            if (countdownInterval) clearInterval(countdownInterval);
            let remaining = seconds;
            
            const updateTimer = () => {
                const timerEl = document.getElementById('countdownTimer');
                if (timerEl) {
                    timerEl.textContent = `${t('searching')} ${remaining}s`;
                }
                remaining--;
                if (remaining < 0) {
                    clearInterval(countdownInterval);
                }
            };
            
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }

        function stopCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        // â±ï¸ Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€ Ğ´Ğ»Ñ Ñ…Ğ¾Ğ´Ğ° (12 ÑĞµĞºÑƒĞ½Ğ´)
        let moveCountdownInterval = null;
        let moveCountdownTimeout = null;  // ğŸ›¡ï¸ Ğ”Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹ pending setTimeout
        let currentTimerRound = null;
        let currentTimerDeadline = null;
        let autoMoveTriggeredForRound = null;  // ğŸ›¡ï¸ Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ…Ğ¾Ğ´Ğ°
        
        function startMoveCountdown(seconds, round = null, deadline = null) {
            if (seconds <= 0) return;
            
            const targetRound = round || currentMatch?.round;
            
            // ğŸ›¡ï¸ ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞµÑĞ»Ğ¸ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ deadline Ñ ÑĞ²ĞµĞ¶Ğ¸Ğ¼ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ¾Ğ¼
            if (deadline && deadline === currentTimerDeadline && currentTimerRound === targetRound && moveCountdownInterval && seconds >= 10) {
                console.log(`[startMoveCountdown] Skip: same deadline=${deadline}, round=${targetRound}`);
                return;
            }
            
            // ğŸ›¡ï¸ ĞĞµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞµÑĞ»Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ…Ğ¾Ğ´ ÑƒĞ¶Ğµ ÑĞ´ĞµĞ»Ğ°Ğ½ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ€Ğ°ÑƒĞ½Ğ´Ğ°
            if (autoMoveTriggeredForRound === targetRound) {
                console.log(`[startMoveCountdown] Skip: autoMove already triggered for round ${targetRound}`);
                return;
            }
            
            // ĞĞµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞµÑĞ»Ğ¸ Ğ¸Ğ³Ñ€Ğ¾Ğº Ğ²Ñ‹Ğ±Ñ‹Ğ»
            if (currentMatch && !currentMatch.aliveIds?.includes(userId)) return;
            
            // ğŸ›¡ï¸ ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ’Ğ¡Ğ• pending Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ñ‹ Ğ¿ĞµÑ€ĞµĞ´ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ¼ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾
            if (moveCountdownInterval) {
                clearInterval(moveCountdownInterval);
                moveCountdownInterval = null;
            }
            if (moveCountdownTimeout) {
                clearTimeout(moveCountdownTimeout);
                moveCountdownTimeout = null;
            }
            
            currentTimerRound = targetRound;
            currentTimerDeadline = deadline;
            console.log(`[startMoveCountdown] Starting timer for round ${targetRound}, deadline=${deadline}`);
            
            let remaining = seconds;
            let intervalId = null;
            
            const updateTimer = () => {
                const timerEl = document.getElementById('moveTimer');
                if (timerEl) {
                    timerEl.textContent = remaining + 's';
                    if (remaining <= 3) timerEl.style.color = '#ff4444';
                    else if (remaining <= 6) timerEl.style.color = '#ffaa00';
                    else timerEl.style.color = '#00ff88';
                }
                remaining--;
                if (remaining < 0) {
                    clearInterval(intervalId);
                    moveCountdownInterval = null;
                    const timerElFinal = document.getElementById('moveTimer');
                    if (timerElFinal) timerElFinal.textContent = 'â±ï¸';
                    
                    const isPlayerAlive = currentMatch?.aliveIds?.includes(userId);
                    // ğŸ›¡ï¸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ñ…Ğ¾Ğ´ ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ´ĞµĞ»Ğ°Ğ»Ğ¸ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ€Ğ°ÑƒĞ½Ğ´Ğ°
                    if (isPlayerAlive && currentMatch && !currentMatch.moves?.[userId] && autoMoveTriggeredForRound !== currentTimerRound) {
                        autoMoveTriggeredForRound = currentTimerRound;  // ğŸ›¡ï¸ Ğ¡Ñ‚Ğ°Ğ²Ğ¸Ğ¼ Ñ„Ğ»Ğ°Ğ³ Ğ”Ğ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°
                        const moves = ['ROCK', 'PAPER', 'SCISSORS'];
                        const randomMove = moves[Math.floor(Math.random() * moves.length)];
                        log('â±ï¸ Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹ÑˆĞ»Ğ¾! ĞĞ²Ñ‚Ğ¾-Ñ…Ğ¾Ğ´: ' + randomMove);
                        makeMove(randomMove);
                    }
                }
            };
            
            // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€ Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ°Ğ¼Ğ¸ ĞµÑĞ»Ğ¸ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½
            let retryCount = 0;
            const maxRetries = 10;
            
            const tryStartTimer = () => {
                let timerEl = document.getElementById('moveTimer');
                
                // ğŸ›¡ï¸ Ğ•ÑĞ»Ğ¸ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ° Ğ½ĞµÑ‚, ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ĞµĞ³Ğ¾ Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ² game-status
                if (!timerEl) {
                    const gameStatus = document.querySelector('.game-status');
                    if (gameStatus && !document.getElementById('moveTimer')) {
                        timerEl = document.createElement('div');
                        timerEl.id = 'moveTimer';
                        timerEl.className = 'move-timer';
                        timerEl.style.cssText = 'font-size: 2em; font-weight: bold; margin: 10px 0; color: #00ff88;';
                        // Ğ’ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾ÑĞ»Ğµ status-text
                        const statusText = gameStatus.querySelector('.status-text');
                        if (statusText && statusText.nextSibling) {
                            gameStatus.insertBefore(timerEl, statusText.nextSibling);
                        } else if (gameStatus.firstChild) {
                            gameStatus.insertBefore(timerEl, gameStatus.firstChild.nextSibling);
                        } else {
                            gameStatus.appendChild(timerEl);
                        }
                        console.log('[startMoveCountdown] Created moveTimer dynamically');
                    }
                }
                
                if (!timerEl && retryCount < maxRetries) {
                    retryCount++;
                    moveCountdownTimeout = setTimeout(tryStartTimer, 100);
                    return;
                }
                
                // Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ¸ÑÑŒ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸
                updateTimer();
                intervalId = setInterval(updateTimer, 1000);
                moveCountdownInterval = intervalId;
                moveCountdownTimeout = null;
            };
            
            // ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ° Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ DOM ÑƒÑĞ¿ĞµĞ» Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒÑÑ
            moveCountdownTimeout = setTimeout(tryStartTimer, 50);  // ğŸ›¡ï¸ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ID
        }

        function stopMoveCountdown() {
            if (moveCountdownInterval) {
                clearInterval(moveCountdownInterval);
                moveCountdownInterval = null;
            }
            if (moveCountdownTimeout) {
                clearTimeout(moveCountdownTimeout);  // ğŸ›¡ï¸ ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ pending timeout
                moveCountdownTimeout = null;
            }
            currentTimerRound = null;
            currentTimerDeadline = null;
            // ğŸ›¡ï¸ ĞĞ• ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ autoMoveTriggeredForRound Ğ·Ğ´ĞµÑÑŒ - ÑÑ‚Ğ¾ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Ñ€Ğ°ÑƒĞ½Ğ´Ğ°
        }
        
        // ğŸ›¡ï¸ Ğ¡Ğ±Ñ€Ğ¾Ñ Ñ„Ğ»Ğ°Ğ³Ğ° Ğ°Ğ²Ñ‚Ğ¾Ñ…Ğ¾Ğ´Ğ° Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¼Ğ°Ñ‚Ñ‡Ğ°
        function resetAutoMoveFlag() {
            autoMoveTriggeredForRound = null;
        }

        // Render Functions
        function showWaiting(text, withCountdown = false, seconds = 0) {
            let countdownHtml = '';
            if (withCountdown && seconds > 0) {
                countdownHtml = `<div id="countdownTimer" style="font-size: 1.5em; margin-top: 10px; color: #ffd700;"></div>`;
                startCountdown(seconds);
            }
            
            document.getElementById('gameContent').innerHTML = `
                <div class="waiting">
                    <div>${text}</div>
                    ${countdownHtml}
                </div>
            `;
        }

        function renderMatch(m) {
            const isPlayerAlive = m.aliveIds.includes(userId);
            const isFinished = m.status === 'FINISHED';
            const isPlayerWinner = m.winnerId === userId;
            
            console.log('Render match:', { round: m.round, isPlayerAlive, isFinished, userId, aliveIds: m.aliveIds });

            // Play sounds based on outcome
            if (isFinished) {
                if (isPlayerWinner) sounds.win();
                else if (m.playerIds.includes(userId)) sounds.lose();
            }

            let statusText = isFinished 
                ? (isPlayerWinner ? t('victory') : t('defeat')) 
                : (isPlayerAlive ? t('yourTurn') : t('waitingTurn'));

            let html = `
                <div class="game-status">
                    <div class="status-text">${statusText}</div>
                    ${!isFinished && isPlayerAlive ? `
                    <div class="move-timer" id="moveTimer" style="font-size: 2em; font-weight: bold; margin: 10px 0; color: #00ff88;">â±ï¸</div>
                    ` : ''}
                    <div class="match-info">
                        <div class="info-item">
                            <div class="info-label">${t('round')}</div>
                            <div class="info-value">${m.round}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">${t('pot')}</div>
                            <div class="info-value">${m.potVp} VP</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">${t('stake')}</div>
                            <div class="info-value">${m.stakeVp} VP</div>
                        </div>
                        ${isFinished ? `
                        <div class="info-item">
                            <div class="info-label">${t('payout')}</div>
                            <div class="info-value">${m.payoutVp} VP</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Players Grid
            html += `<div class="players-grid">`;
            m.playerIds.forEach(pid => {
                const isBot = pid.startsWith('BOT');
                const isAlive = m.aliveIds.includes(pid);
                const isEliminated = m.eliminatedIds.includes(pid);
                const isWinner = m.winnerId === pid;
                const isMe = pid === userId;
                
                let moveEmoji = 'â“';
                if (m.lastRound && m.lastRound.moves[pid]) {
                    moveEmoji = getMoveEmoji(m.lastRound.moves[pid]);
                }

                let statusText = isWinner ? t('winner') : isEliminated ? t('eliminated') : isAlive ? t('inGame') : '';
                let botDisplayName = isBot ? (m.botNames?.[pid] || pid) : pid;
                // ğŸ‘¤ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ displayName Ğ¸Ğ· playerNames (ĞºĞ»Ğ¸ĞµĞ½Ñ‚) Ğ¸Ğ»Ğ¸ m.playerNames (ÑĞµÑ€Ğ²ĞµÑ€)
                let playerDisplayName = !isBot ? (playerNames[pid] || m.playerNames?.[pid] || pid.slice(0,8)) : botDisplayName;
                let nameText = isMe ? 'ğŸ‘¤ ' + (t('you') || 'You') : isBot ? 'ğŸ¤– ' + botDisplayName : 'ğŸ‘¤ ' + playerDisplayName;

                html += `
                    <div class="player-card ${isWinner ? 'winner' : isEliminated ? 'eliminated' : isAlive ? 'active' : ''}">
                        <div class="player-name">${nameText}</div>
                        <div class="player-move">${moveEmoji}</div>
                        <div class="player-status">${statusText}</div>
                    </div>
                `;
            });
            html += `</div>`;

            // Last Round Info
            if (m.lastRound) {
                const outcomeText = m.lastRound.outcome === 'TIE' ? t('tie') : t('elimination');
                html += `
                    <div class="round-info">
                        <div class="round-title">${t('round')} ${m.lastRound.roundNo}: ${outcomeText}</div>
                        ${m.lastRound.winningMove ? `<div>${t('wonWith')}: ${getMoveEmoji(m.lastRound.winningMove)} ${m.lastRound.winningMove}</div>` : ''}
                    </div>
                `;
            }

            // Move Buttons (only if alive and not finished)
            console.log('Move buttons check:', { isPlayerAlive, isFinished, shouldShow: isPlayerAlive && !isFinished });
            if (isPlayerAlive && !isFinished) {
                html += `
                    <div class="moves-container">
                        <button class="move-btn" data-move="ROCK" onclick="makeMove('ROCK')">
                            <div class="move-emoji">âœŠ</div>
                            <div class="move-text">${t('rock')}</div>
                        </button>
                        <button class="move-btn" data-move="PAPER" onclick="makeMove('PAPER')">
                            <div class="move-emoji">âœ‹</div>
                            <div class="move-text">${t('paper')}</div>
                        </button>
                        <button class="move-btn" data-move="SCISSORS" onclick="makeMove('SCISSORS')">
                            <div class="move-emoji">âœŒï¸</div>
                            <div class="move-text">${t('scissors')}</div>
                        </button>
                    </div>
                `;
            } else {
                console.log('Move buttons NOT shown - player not alive or game finished');
            }

            // Play Again Button
            if (isFinished) {
                html += `
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-success" onclick="resetAndPlayAgain()">${t('playAgain')}</button>
                    </div>
                `;
                // Add system message to game chat
                const resultMsg = isPlayerWinner ? 'Congratulations! You won!' : 'Game over. Better luck next time!';
                if (m.matchId) {
                    addChatMessage('system', 'System', resultMsg, 'game', m.matchId);
                }
                
                // Update balance after match
                setTimeout(doCheckBalance, 500);
                
                // Clear current match state
                localStorage.setItem('uiState', 'game');
                currentMatch = null;
            }

            document.getElementById('gameContent').innerHTML = html;
        }

        function getMoveEmoji(move) {
            const emojis = { ROCK: 'âœŠ', PAPER: 'âœ‹', SCISSORS: 'âœŒï¸' };
            return emojis[move] || 'â“';
        }

        // Profile Functions
        let currentProfile = {
            displayName: '',
            gender: '',
            avatarUrl: '',
            isGuest: true
        };
        let selectedAvatarId = '';

        function goToProfileScreen() {
            console.log('[goToProfileScreen] START');
            localStorage.setItem('uiState', 'profile');
            console.log('[goToProfileScreen] uiState set to: profile');
            setButtons({ 
                showAuth: false, 
                showUser: true, 
                showConnect: true, 
                connect: true, 
                quickplay: false, 
                balance: false, 
                logs: false 
            });
            updateUserInfoAfterLogin();
            console.log('[goToProfileScreen] DONE');
        }

        function goToGameScreen() {
            // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ³Ñ€Ğ¾Ğ²Ğ¾Ğ¹ ÑĞºÑ€Ğ°Ğ½
            localStorage.setItem('uiState', 'game');
            setButtons({ 
                showAuth: false, 
                showUser: false, 
                showConnect: false, 
                connect: false, 
                quickplay: true, 
                balance: true, 
                logs: true 
            });
        }

        async function checkActiveMatchOrQueue() {
            console.log('[checkActiveMatchOrQueue] START, token:', token ? 'yes' : 'no');
            if (!token) {
                console.log('[checkActiveMatchOrQueue] No token, returning');
                return;
            }
            
            try {
                console.log('[checkActiveMatchOrQueue] Fetching /matchmaking/active...');
                const response = await fetch('/matchmaking/active', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[checkActiveMatchOrQueue] Response:', data);
                    
                    if (data.inQueue) {
                        console.log('[checkActiveMatchOrQueue] User is in queue:');
                        console.log(`  - playersFound: ${data.playersFound}/${data.totalNeeded}`);
                        console.log(`  - secondsLeft from server: ${data.secondsLeft}`);
                        console.log(`  - queueTime from server: ${data.queueTime}`);
                        
                        // Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ¸ÑĞºĞ°
                        localStorage.setItem('uiState', 'searching');
                        isProcessing.quickplay = true;
                        // ğŸ›¡ï¸ Ğ‘Ğ›ĞĞšĞ˜Ğ Ğ£Ğ•Ğœ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¸Ğ³Ñ€Ñ‹ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ°
                        setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                        
                        // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
                        const remainingSeconds = data.secondsLeft || 20;
                        const playersFound = data.playersFound || 1;
                        const totalNeeded = data.totalNeeded || 2;
                        
                        // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞºÑ€Ğ°Ğ½ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ñ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ğ¾Ğ¼
                        showWaiting(`Ğ˜Ñ‰ĞµĞ¼ ÑĞ¾Ğ¿ĞµÑ€Ğ½Ğ¸ĞºĞ¾Ğ² (${playersFound}/${totalNeeded})...`, true, remainingSeconds);
                        log(`ğŸ”„ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ¿Ğ¾Ğ¸ÑĞº: ${playersFound}/${totalNeeded}, Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ ${remainingSeconds}Ñ`);
                    } else if (data.activeMatch) {
                        // Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¸Ğ³Ñ€Ñ‹
                        localStorage.setItem('uiState', 'in-match');
                        currentMatch = data.activeMatch;
                        matchId = data.activeMatch.matchId;
                        activeMatches.add(matchId);
                        // ğŸ›¡ï¸ Ğ‘Ğ›ĞĞšĞ˜Ğ Ğ£Ğ•Ğœ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¸Ğ³Ñ€Ñ‹ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ¼Ğ°Ñ‚Ñ‡Ğ°
                        setButtons({ showAuth: false, showUser: false, showConnect: false, connect: false, quickplay: true, balance: true, logs: true });
                        renderMatch(data.activeMatch);
                        log('ğŸ”„ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¼Ğ°Ñ‚Ñ‡');
                        
                        // ğŸ”„ ĞŸĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ WebSocket Ğº ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ğµ Ğ¼Ğ°Ñ‚Ñ‡Ğ°
                        if (socket && matchId) {
                            socket.emit('match:join', { matchId });
                            console.log('[F5 Restore] Rejoined match room:', matchId);
                        }
                    }
                }
            } catch (e) {
                console.log('checkActiveMatchOrQueue error:', e);
            }
        }

        function showProfileModal() {
            document.getElementById('profileModal').classList.add('show');
            initAvatars();
            loadProfile();
        }

        function initAvatars() {
            const maleGrid = document.getElementById('maleAvatars');
            const femaleGrid = document.getElementById('femaleAvatars');
            
            if (maleGrid && maleGrid.children.length === 0) {
                for (let i = 1; i <= 5; i++) {
                    const div = document.createElement('div');
                    div.className = 'avatar-item';
                    div.onclick = function() { selectAvatar('male' + i, this); };
                    div.innerHTML = '<img src="' + API_URL + '/avatars/male' + i + '.svg" alt="male' + i + '">';
                    maleGrid.appendChild(div);
                }
            }
            
            if (femaleGrid && femaleGrid.children.length === 0) {
                for (let i = 1; i <= 5; i++) {
                    const div = document.createElement('div');
                    div.className = 'avatar-item';
                    div.onclick = function() { selectAvatar('female' + i, this); };
                    div.innerHTML = '<img src="' + API_URL + '/avatars/female' + i + '.svg" alt="female' + i + '">';
                    femaleGrid.appendChild(div);
                }
            }
        }

        function hideProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }

        async function loadProfile() {
            if (!token) return;
            
            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': token }
                });
                const data = await res.json();
                
                currentProfile = {
                    displayName: data.displayName || data.username || '',
                    gender: data.gender || '',
                    avatarUrl: data.avatarUrl || '',
                    isGuest: data.isGuest
                };
                
                // Fill form
                document.getElementById('profileDisplayName').value = currentProfile.displayName;
                document.getElementById('profileGender').value = currentProfile.gender;
                
                // Filter avatars by gender if set
                filterAvatarsByGender(currentProfile.gender);
                
                // Show avatar
                const avatarImg = document.getElementById('profileCurrentAvatar');
                if (currentProfile.avatarUrl) {
                    avatarImg.src = currentProfile.avatarUrl;
                    avatarImg.style.display = 'block';
                } else {
                    // Default avatar based on gender
                    const defaultAvatar = currentProfile.gender === 'female' ? `${API_URL}/avatars/female1.svg` : `${API_URL}/avatars/male1.svg`;
                    avatarImg.src = defaultAvatar;
                    avatarImg.style.display = 'block';
                }
                
                // Show/hide link email section
                const linkSection = document.getElementById('linkEmailSection');
                if (currentProfile.isGuest) {
                    linkSection.style.display = 'block';
                } else {
                    linkSection.style.display = 'none';
                }
                
            } catch (e) {
                console.error('Failed to load profile:', e);
            }
        }

        function switchAvatarTab(tab, clickedTab) {
            // Update tab buttons
            document.querySelectorAll('.avatar-tab').forEach(t => t.classList.remove('active'));
            clickedTab.classList.add('active');
            
            // Show/hide grids
            document.getElementById('maleAvatars').classList.add('hidden');
            document.getElementById('femaleAvatars').classList.add('hidden');
            document.getElementById('customAvatar').classList.add('hidden');
            
            document.getElementById(tab + 'Avatars')?.classList.remove('hidden');
            if (tab === 'custom') {
                document.getElementById('customAvatar').classList.remove('hidden');
            }
        }

        function selectAvatar(avatarId, clickedElement) {
            selectedAvatarId = avatarId;
            
            // Update UI
            document.querySelectorAll('.avatar-item').forEach(item => item.classList.remove('selected'));
            if (clickedElement) clickedElement.classList.add('selected');
            
            // Preview
            document.getElementById('profileCurrentAvatar').src = API_URL + '/avatars/' + avatarId + '.svg';
            
            // Auto-set gender based on avatar selection (always update)
            const newGender = avatarId.startsWith('male') ? 'male' : 'female';
            document.getElementById('profileGender').value = newGender;
        }

        function filterAvatarsByGender(gender) {
            // If gender is set, show only corresponding avatars
            if (gender === 'male') {
                document.getElementById('maleAvatars').classList.remove('hidden');
                document.getElementById('femaleAvatars').classList.add('hidden');
                // Update tabs
                document.querySelectorAll('.avatar-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.avatar-tab:nth-child(1)')?.classList.add('active');
            } else if (gender === 'female') {
                document.getElementById('maleAvatars').classList.add('hidden');
                document.getElementById('femaleAvatars').classList.remove('hidden');
                // Update tabs
                document.querySelectorAll('.avatar-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.avatar-tab:nth-child(2)')?.classList.add('active');
            }
            // If no gender, show both (default behavior)
        }

        // Listen for gender change
        document.addEventListener('DOMContentLoaded', function() {
            const genderSelect = document.getElementById('profileGender');
            if (genderSelect) {
                genderSelect.addEventListener('change', function() {
                    filterAvatarsByGender(this.value);
                });
            }
        });

        async function saveProfile() {
            const displayName = document.getElementById('profileDisplayName').value.trim();
            const gender = document.getElementById('profileGender').value;
            
            let avatarUrl = currentProfile.avatarUrl || null;
            // If selected a preset avatar (not custom upload)
            if (selectedAvatarId && selectedAvatarId !== 'custom') {
                avatarUrl = `${API_URL}/avatars/${selectedAvatarId}.svg`;
            }
            // Convert empty string to null for server
            if (avatarUrl === '') avatarUrl = null;
            
            try {
                const res = await fetch(`${API_URL}/auth/profile`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ displayName, gender, avatarUrl })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    log('âœ… ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½');
                    
                    // Update local profile
                    currentProfile.displayName = displayName;
                    currentProfile.gender = gender;
                    currentProfile.avatarUrl = avatarUrl;
                    // Save displayName to localStorage for F5 recovery
                    localStorage.setItem('displayName', displayName);
                    
                    // Update UI
                    updateUserInfoAfterProfileUpdate();
                    hideProfileModal();
                } else {
                    const err = await res.json();
                    log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (err.message || 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ'));
                }
            } catch (e) {
                log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸');
            }
        }

        async function linkEmail() {
            const email = document.getElementById('linkEmail').value.trim();
            const password = document.getElementById('linkPassword').value;
            
            if (!email || !password || password.length < 6) {
                log('âŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ email Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ (Ğ¼Ğ¸Ğ½. 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/auth/link-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    log('âœ… ' + data.message);
                    hideProfileModal();
                } else {
                    log('âŒ ' + (data.message || 'ĞÑˆĞ¸Ğ±ĞºĞ°'));
                }
            } catch (e) {
                log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸');
            }
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Resize and compress image before storing
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize to max 200x200 for small avatar
                    const maxSize = 200;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compress to JPEG with 60% quality
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    
                    const profileImg = document.getElementById('profileCurrentAvatar');
                    profileImg.src = compressedDataUrl;
                    profileImg.style.display = 'block';
                    currentProfile.avatarUrl = compressedDataUrl;
                    selectedAvatarId = 'custom';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updateUserInfo() {
            // Update mini avatar in header
            const miniAvatar = document.getElementById('userAvatar');
            if (miniAvatar && currentProfile.avatarUrl) {
                miniAvatar.src = currentProfile.avatarUrl;
                miniAvatar.style.display = 'inline-block';
            }
        }

        function updateUserInfoAfterLogin() {
            // Show user info section
            const userInfo = document.getElementById('userInfo');
            if (userInfo) userInfo.style.display = 'flex';
            
            // Update email display
            const emailDisplay = document.getElementById('userEmail');
            if (emailDisplay) {
                emailDisplay.textContent = currentProfile.displayName || userId.slice(0, 8);
            }
            
            // Update avatar
            updateUserInfo();
        }

        function updateUserInfoAfterProfileUpdate() {
            // Update display name
            const emailDisplay = document.getElementById('userEmail');
            if (emailDisplay && currentProfile.displayName) {
                emailDisplay.textContent = currentProfile.displayName;
            }
            
            // Update mini avatar in header
            const miniAvatar = document.getElementById('userAvatar');
            if (miniAvatar && currentProfile.avatarUrl) {
                miniAvatar.src = currentProfile.avatarUrl;
                miniAvatar.style.display = 'inline-block';
            }
            
            // Re-render chat to show new avatar
            renderChatMessages();
        }

        // ğŸ‘¤ ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°
        async function showPublicProfile(targetUserId, displayName) {
            sounds.click();
            
            // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹
            const modal = document.getElementById('statsModal');
            const body = document.getElementById('statsModalBody');
            modal.classList.add('show');
            body.innerHTML = `<div style="text-align:center;padding:20px;">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ ${displayName}...</div>`;
            
            try {
                // Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ
                const r = await fetch(`${API_URL}/auth/public-profile/${targetUserId}`, {
                    headers: token ? { "Authorization": "Bearer " + token } : {}
                });
                
                if (!r.ok) {
                    body.innerHTML = `<div style="text-align:center;padding:20px;color:#ff6b6b;">âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</div>`;
                    return;
                }
                
                const data = await r.json();
                
                body.innerHTML = `
                    <div style="text-align:center;padding:20px;">
                        <div style="font-size:3em;margin-bottom:10px;">${data.avatarUrl ? `<img src="${data.avatarUrl}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">` : 'ğŸ‘¤'}</div>
                        <div style="font-size:1.5em;font-weight:bold;color:#ffd700;margin-bottom:5px;">${data.displayName || 'Ğ˜Ğ³Ñ€Ğ¾Ğº'}</div>
                        <div style="color:#aaa;margin-bottom:20px;">ID: ${data.id?.slice(0,8)}...</div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:20px;">
                            <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;">
                                <div style="font-size:1.8em;font-weight:bold;color:#00ff88;">${data.stats?.totalMatches || 0}</div>
                                <div style="font-size:0.9em;color:#aaa;">Ğ’ÑĞµĞ³Ğ¾ Ğ¸Ğ³Ñ€</div>
                            </div>
                            <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;">
                                <div style="font-size:1.8em;font-weight:bold;color:#ffd700;">${data.stats?.wins || 0}</div>
                                <div style="font-size:0.9em;color:#aaa;">ĞŸĞ¾Ğ±ĞµĞ´</div>
                            </div>
                        </div>
                        
                        <div style="margin-top:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:10px;">
                            <div style="color:#aaa;margin-bottom:10px;">Ğ’Ğ¸Ğ½Ñ€ĞµĞ¹Ñ‚</div>
                            <div style="font-size:1.5em;font-weight:bold;color:${(data.stats?.winRate || 0) > 50 ? '#00ff88' : '#ff6b6b'};">${data.stats?.winRate || 0}%</div>
                        </div>
                    </div>
                `;
            } catch (e) {
                body.innerHTML = `<div style="text-align:center;padding:20px;color:#ff6b6b;">âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ${e.message}</div>`;
            }
        }

        // Stats Modal Functions
        async function showStatsModal() {
            sounds.click();
            if (!token) {
                log('âŒ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ');
                return;
            }
            document.getElementById('statsModal').classList.add('show');
            const body = document.getElementById('statsModalBody');
            body.innerHTML = '<div style="text-align:center;padding:20px;">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>';
            try {
                const r = await fetch(`${API_URL}/auth/stats`, { headers: { "Authorization": "Bearer " + token } });
                const s = await r.json();
                const winColor = s.winRate >= 50 ? '#4ade80' : (s.winRate >= 30 ? '#ffd700' : '#f87171');
                body.innerHTML = `
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;">
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:2em;font-weight:bold;color:#ffd700;margin-bottom:5px;">${s.totalMatches}</div>
                            <div style="font-size:0.9em;opacity:0.8;">Ğ’ÑĞµĞ³Ğ¾ Ğ¼Ğ°Ñ‚Ñ‡ĞµĞ¹</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:2em;font-weight:bold;color:${winColor};margin-bottom:5px;">${s.winRate}%</div>
                            <div style="font-size:0.9em;opacity:0.8;">Ğ’Ğ¸Ğ½Ñ€ĞµĞ¹Ñ‚</div>
                            <div style="width:100%;height:10px;background:rgba(255,255,255,0.1);border-radius:5px;overflow:hidden;margin-top:8px;">
                                <div style="height:100%;background:linear-gradient(90deg,#4ade80,#ffd700);width:${s.winRate}%"></div>
                            </div>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:2em;font-weight:bold;color:#4ade80;margin-bottom:5px;">${s.wins}</div>
                            <div style="font-size:0.9em;opacity:0.8;">ĞŸĞ¾Ğ±ĞµĞ´</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:2em;font-weight:bold;color:#f87171;margin-bottom:5px;">${s.losses}</div>
                            <div style="font-size:0.9em;opacity:0.8;">ĞŸĞ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹</div>
                        </div>
                    </div>
                    <div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.2);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>ğŸ”¥ Ğ¡ĞµÑ€Ğ¸Ñ:</span><strong>${s.winStreak} (Ğ¼Ğ°ĞºÑ: ${s.maxWinStreak})</strong></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>ğŸ’° Ğ’Ñ‹Ğ¸Ğ³Ñ€Ğ°Ğ½Ğ¾:</span><strong style="color:#4ade80">${s.totalWonVp.toLocaleString()} VP</strong></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>ğŸ’¸ ĞŸÑ€Ğ¾Ğ¸Ğ³Ñ€Ğ°Ğ½Ğ¾:</span><strong style="color:#f87171">${s.totalLostVp.toLocaleString()} VP</strong></div>
                        <div style="display:flex;justify-content:space-between;"><span>ğŸ¯ ĞœĞ°ĞºÑ. Ğ²Ñ‹Ğ¸Ğ³Ñ€Ñ‹Ñˆ:</span><strong style="color:#ffd700">${s.biggestWinVp.toLocaleString()} VP</strong></div>
                    </div>`;
            } catch (e) {
                body.innerHTML = '<div style="color:#f87171;text-align:center;">âŒ ĞÑˆĞ¸Ğ±ĞºĞ°</div>';
            }
        }
        
        function hideStatsModal() {
            document.getElementById('statsModal').classList.remove('show');
        }

        async function showAuditModal() {
            sounds.click();
            if (!token) { log('âŒ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ'); return; }
            document.getElementById('auditModal').classList.add('show');
            const body = document.getElementById('auditModalBody');
            body.innerHTML = '<div style="text-align:center;padding:20px;">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>';
            try {
                const r = await fetch(`${API_URL}/auth/audit`, { headers: { "Authorization": "Bearer " + token } });
                const data = await r.json();
                if (data.count === 0) {
                    body.innerHTML = '<div style="text-align:center;padding:20px;opacity:0.7;">ĞĞµÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸</div>';
                    return;
                }
                let html = `<div style="max-height:400px;overflow-y:auto;">`;
                data.logs.forEach(log => {
                    const date = new Date(log.createdAt).toLocaleString();
                    const payload = JSON.stringify(log.payload || {});
                    html += `
                        <div style="background:rgba(255,255,255,0.05);padding:12px;margin-bottom:8px;border-radius:8px;font-size:0.9em;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                                <strong style="color:#ffd700;">${log.eventType}</strong>
                                <span style="opacity:0.6;font-size:0.8em;">${date}</span>
                            </div>
                            ${log.matchId ? `<div style="opacity:0.7;font-size:0.85em;">Match: ${log.matchId}</div>` : ''}
                            <div style="opacity:0.7;font-size:0.85em;word-break:break-all;">${payload}</div>
                        </div>`;
                });
                html += '</div>';
                body.innerHTML = html;
            } catch (e) {
                body.innerHTML = '<div style="color:#f87171;text-align:center;">âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸</div>';
            }
        }

        function hideAuditModal() {
            document.getElementById('auditModal').classList.remove('show');
        }

        async function showReconcileModal() {
            sounds.click();
            if (!token) { log('âŒ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ'); return; }
            document.getElementById('reconcileModal').classList.add('show');
            const body = document.getElementById('reconcileModalBody');
            body.innerHTML = '<div style="text-align:center;padding:20px;">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>';
            try {
                const r = await fetch(`${API_URL}/wallet/reconcile`, { headers: { "Authorization": "Bearer " + token } });
                const d = await r.json();
                const statusColor = d.isBalanced ? '#4ade80' : '#f87171';
                const statusIcon = d.isBalanced ? 'âœ…' : 'âš ï¸';
                body.innerHTML = `
                    <div style="text-align:center;margin-bottom:20px;">
                        <div style="font-size:3em;margin-bottom:10px;">${statusIcon}</div>
                        <div style="font-size:1.2em;font-weight:bold;color:${statusColor};">
                            ${d.isBalanced ? 'Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ² Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞµ' : 'ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ñ€Ğ°ÑÑ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ!'}
                        </div>
                        ${!d.isBalanced ? `<div style="color:#f87171;margin-top:10px;">Ğ Ğ°Ğ·Ğ½Ğ¸Ñ†Ğ°: ${d.discrepancy} VP</div>` : ''}
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;">
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:1.8em;font-weight:bold;color:#4ade80;">${d.actualBalance.toLocaleString()}</div>
                            <div style="font-size:0.85em;opacity:0.8;">Ğ¤Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:1.8em;font-weight:bold;color:#ffd700;">${d.expectedBalance.toLocaleString()}</div>
                            <div style="font-size:0.85em;opacity:0.8;">ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ</div>
                        </div>
                    </div>
                    <div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.2);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>ğŸ’° Ğ’ÑĞµĞ³Ğ¾ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ğ°Ğ½Ğ¾:</span><strong style="color:#4ade80">${d.stats.totalWon.toLocaleString()} VP</strong></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>ğŸ’¸ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸Ğ³Ñ€Ğ°Ğ½Ğ¾:</span><strong style="color:#f87171">${d.stats.totalLost.toLocaleString()} VP</strong></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>ğŸ“Š Ğ§Ğ¸ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ:</span><strong style="color:${d.stats.netProfit >= 0 ? '#4ade80' : '#f87171'}">${d.stats.netProfit >= 0 ? '+' : ''}${d.stats.netProfit.toLocaleString()} VP</strong></div>
                        <div style="display:flex;justify-content:space-between;"><span>â„ï¸ Ğ—Ğ°Ğ¼Ğ¾Ñ€Ğ¾Ğ¶ĞµĞ½Ğ¾:</span><strong>${d.frozenBalance.toLocaleString()} VP</strong></div>
                    </div>`;
            } catch (e) {
                body.innerHTML = '<div style="color:#f87171;text-align:center;">âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸</div>';
            }
        }

        function hideReconcileModal() {
            document.getElementById('reconcileModal').classList.remove('show');
        }
        
        function hidePublicProfileModal() {
            document.getElementById('publicProfileModal').classList.remove('show');
        }
    </script>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="loginTitle">ğŸ”‘ Ğ’Ñ…Ğ¾Ğ´</h3>
                <button class="modal-close" onclick="hideLoginModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="loginEmailLabel">Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" onkeydown="handleEnter(event, 'login')">
                </div>
                <div class="form-group">
                    <label id="loginPasswordLabel">ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ</label>
                    <div class="password-field">
                        <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="handleEnter(event, 'login')">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)">ğŸ‘ï¸</button>
                    </div>
                </div>
                <button class="btn btn-success btn-full" id="loginSubmitBtn" onclick="doLogin()">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
                <div class="form-links">
                    <a href="#" id="forgotPasswordLink" onclick="showForgotModal(); hideLoginModal(); return false;">Ğ—Ğ°Ğ±Ñ‹Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ?</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal-overlay" id="registerModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ğŸ“ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</h3>
                <button class="modal-close" onclick="hideRegisterModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com" onkeydown="handleEnter(event, 'register')">
                </div>
                <div class="form-group">
                    <label>Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ</label>
                    <input type="text" id="registerUsername" placeholder="Username">
                </div>
                <div class="form-group">
                    <label id="linkPasswordLabel">ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ (Ğ¼Ğ¸Ğ½. 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)</label>
                    <div class="password-field">
                        <input type="password" id="registerPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="handleEnter(event, 'register')">
                        <button type="button" class="password-toggle" onclick="togglePassword('registerPassword', this)">ğŸ‘ï¸</button>
                    </div>
                </div>
                <button class="btn btn-success btn-full" onclick="doRegister()">Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="profileModalTitle">ğŸ‘¤ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</h3>
                <button class="modal-close" onclick="hideProfileModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="profile-section">
                    <div class="avatar-preview-large" id="profileAvatarPreview">
                        <img id="profileCurrentAvatar" src="" alt="avatar">
                    </div>
                    <div class="profile-info">
                        <div class="form-group">
                            <label id="profileDisplayNameLabel">ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼Ğ¾Ğµ Ğ¸Ğ¼Ñ</label>
                            <input type="text" id="profileDisplayName" placeholder="Ğ’Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ" maxlength="100">
                        </div>
                        <div class="form-group">
                            <label id="profileGenderLabel">ĞŸĞ¾Ğ»</label>
                            <select id="profileGender">
                                <option value="" id="genderNotSpecified">ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½</option>
                                <option value="male" id="genderMale">ĞœÑƒĞ¶ÑĞºĞ¾Ğ¹</option>
                                <option value="female" id="genderFemale">Ğ–ĞµĞ½ÑĞºĞ¸Ğ¹</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="avatar-section" id="avatarSection">
                    <label id="profileAvatarLabel">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€ĞºÑƒ</label>
                    <div class="avatar-tabs">
                        <button class="avatar-tab active" id="avatarTabMale" onclick="switchAvatarTab('male', this)">ĞœÑƒĞ¶ÑĞºĞ¸Ğµ</button>
                        <button class="avatar-tab" id="avatarTabFemale" onclick="switchAvatarTab('female', this)">Ğ–ĞµĞ½ÑĞºĞ¸Ğµ</button>
                        <button class="avatar-tab" id="avatarTabCustom" onclick="switchAvatarTab('custom', this)">Ğ¡Ğ²Ğ¾Ñ</button>
                    </div>
                    <div class="avatar-grid" id="maleAvatars"></div>
                    <div class="avatar-grid hidden" id="femaleAvatars"></div>
                    <div class="avatar-grid hidden" id="customAvatar">
                        <div class="upload-area" onclick="document.getElementById('avatarUpload').click()">
                            <span>ğŸ“· ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ¾Ñ‚Ğ¾</span>
                            <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                        </div>
                    </div>
                </div>
                
                <div class="profile-actions">
                    <button class="btn btn-success btn-full" id="profileSaveBtn" onclick="saveProfile()">ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
                </div>
                
                <div class="profile-link-email" id="linkEmailSection" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <p id="profileGuestText">Ğ’Ñ‹ Ğ²Ğ¾ÑˆĞ»Ğ¸ ĞºĞ°Ğº Ğ³Ğ¾ÑÑ‚ÑŒ. ĞŸÑ€Ğ¸Ğ²ÑĞ¶Ğ¸Ñ‚Ğµ email Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°:</p>
                    <div class="form-group">
                        <input type="email" id="linkEmail" placeholder="your@email.com" onkeydown="handleEnter(event, 'linkEmail')">
                    </div>
                    <div class="form-group">
                        <div class="password-field">
                            <input type="password" id="linkPassword" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ (Ğ¼Ğ¸Ğ½. 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)" onkeydown="handleEnter(event, 'linkEmail')">
                            <button type="button" class="password-toggle" onclick="togglePassword('linkPassword', this)">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-full" id="linkEmailBtn" onclick="linkEmail()">ğŸ”— ĞŸÑ€Ğ¸Ğ²ÑĞ·Ğ°Ñ‚ÑŒ email</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal-overlay" id="forgotModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ğŸ” Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ</h3>
                <button class="modal-close" onclick="hideForgotModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p class="form-info">Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ email Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğ° ÑĞ±Ñ€Ğ¾Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ</p>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="forgotEmail" placeholder="your@email.com">
                </div>
                <button class="btn btn-success btn-full" onclick="doForgotPassword()">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
            </div>
        </div>
    </div>
    <!-- Stats Modal -->
    <div class="modal-overlay" id="statsModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</h3>
                <button class="modal-close" onclick="hideStatsModal()">Ã—</button>
            </div>
            <div class="modal-body" id="statsModalBody">
                <div class="stats-loading">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
            </div>
        </div>
    </div>

    <!-- Audit Modal -->
    <div class="modal-overlay" id="auditModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ğŸ“œ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹</h3>
                <button class="modal-close" onclick="hideAuditModal()">Ã—</button>
            </div>
            <div class="modal-body" id="auditModalBody">
                <div class="stats-loading">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
            </div>
        </div>
    </div>

    <!-- Reconcile Modal -->
    <div class="modal-overlay" id="reconcileModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>âš–ï¸ Ğ¡Ğ²ĞµÑ€ĞºĞ° Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°</h3>
                <button class="modal-close" onclick="hideReconcileModal()">Ã—</button>
            </div>
            <div class="modal-body" id="reconcileModalBody">
                <div class="stats-loading">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
            </div>
        </div>
    </div>

    <!-- Public Profile Modal (for viewing other players) -->
    <div class="modal-overlay" id="publicProfileModal" onclick="closeModal(event)">
        <div class="modal modal-small" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ğŸ‘¤ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°</h3>
                <button class="modal-close" onclick="hidePublicProfileModal()">Ã—</button>
            </div>
            <div class="modal-body" id="publicProfileBody">
                <div class="public-profile">
                    <div class="profile-avatar-large" id="publicProfileAvatar"></div>
                    <h3 id="publicProfileName"></h3>
                    <div class="public-stats" id="publicProfileStats"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>